<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>å¿«é€Ÿè¨ºæ–·èˆ‡ä¿®å¾©</title>
  <style>
    body {
      font-family: monospace;
      padding: 20px;
      background: #1a1a1a;
      color: #e0e0e0;
    }
    .box {
      margin: 20px 0;
      padding: 20px;
      background: #2a2a2a;
      border-radius: 8px;
      border-left: 4px solid #4CAF50;
    }
    .error { border-left-color: #f44336; }
    .warning { border-left-color: #ff9800; }
    button {
      padding: 12px 24px;
      margin: 5px;
      cursor: pointer;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 14px;
    }
    button:hover { background: #45a049; }
    pre { background: #1a1a1a; padding: 10px; border-radius: 4px; }
    .success { color: #4CAF50; }
    .error-text { color: #f44336; }
  </style>
</head>
<body>
  <h1>ğŸ” å¿«é€Ÿè¨ºæ–·èˆ‡ä¿®å¾©</h1>
  <div id="result"></div>

  <script>
    const DB_NAME = 'VenturoOfflineDB';

    async function diagnose() {
      let html = '';

      // === 1. æª¢æŸ¥ç™»å…¥ç‹€æ…‹ ===
      html += '<div class="box">';
      html += '<h2>ğŸ“‹ æ­¥é©Ÿ 1ï¼šç™»å…¥ç‹€æ…‹</h2>';

      const authStore = localStorage.getItem('auth-store');
      const localAuthStore = localStorage.getItem('local-auth-store');

      if (!authStore && !localAuthStore) {
        html += '<pre class="error-text">âŒ æ‰¾ä¸åˆ°ç™»å…¥è³‡æ–™ï¼</pre>';
        html += '<p><strong>å•é¡Œï¼šä½ é‚„æ²’ç™»å…¥ç³»çµ±</strong></p>';
        html += '<button onclick="location.href=\'/login\'">å‰å¾€ç™»å…¥é </button>';
        html += '</div>';
        document.getElementById('result').innerHTML = html;
        return;
      }

      let user = null;
      if (authStore) {
        try {
          const parsed = JSON.parse(authStore);
          user = parsed.state?.user;
          html += '<pre class="success">âœ… æ‰¾åˆ° auth-store</pre>';
          html += `<pre>User ID: ${user?.id || 'âŒ ç¼ºå¤±'}\n`;
          html += `Name: ${user?.display_name || 'âŒ ç¼ºå¤±'}\n`;
          html += `Workspace ID: ${user?.workspace_id || 'âŒ ç¼ºå¤±'}</pre>`;
        } catch (e) {
          html += `<pre class="error-text">âŒ auth-store è§£æå¤±æ•—: ${e.message}</pre>`;
        }
      }

      if (!user?.workspace_id) {
        html += '<div class="box error">';
        html += '<h3>âš ï¸ ç™¼ç¾å•é¡Œï¼šç¼ºå°‘ workspace_id</h3>';
        html += '<p>é€™æœƒå°è‡´æ‰€æœ‰ä»£è¾¦äº‹é …éƒ½çœ‹ä¸åˆ°</p>';
        html += '<button onclick="fixWorkspace()">ğŸ”§ è‡ªå‹•ä¿®å¾©</button>';
        html += '<button onclick="relogin()">ğŸ”„ é‡æ–°ç™»å…¥</button>';
        html += '</div>';
      }

      html += '</div>';

      // === 2. æª¢æŸ¥ IndexedDB ===
      html += '<div class="box">';
      html += '<h2>ğŸ“‹ æ­¥é©Ÿ 2ï¼šIndexedDB è³‡æ–™</h2>';

      try {
        const db = await new Promise((resolve, reject) => {
          const req = indexedDB.open(DB_NAME);
          req.onsuccess = () => resolve(req.result);
          req.onerror = () => reject(req.error);
        });

        const tx = db.transaction('todos', 'readonly');
        const store = tx.objectStore('todos');
        const todos = await store.getAll();

        const activeTodos = todos.filter(t => !t._deleted);

        html += `<pre class="success">âœ… IndexedDB é€£ç·šæˆåŠŸ</pre>`;
        html += `<pre>ç¸½ä»£è¾¦äº‹é …: ${todos.length}\n`;
        html += `æ´»å‹•ä¸­: ${activeTodos.length}</pre>`;

        if (user?.id) {
          const visible = activeTodos.filter(t => {
            const isCreator = t.creator === user.id;
            const isAssignee = t.assignee === user.id;
            const inVisibility = t.visibility?.includes(user.id);
            return isCreator || isAssignee || inVisibility;
          });

          html += `<pre>å¯è¦‹çš„: <span class="${visible.length > 0 ? 'success' : 'error-text'}">${visible.length}</span></pre>`;

          if (visible.length === 0 && activeTodos.length > 0) {
            html += '<div class="box error">';
            html += '<h3>âš ï¸ ç™¼ç¾å•é¡Œï¼šæ‰€æœ‰ä»£è¾¦äº‹é …éƒ½ä¸å¯è¦‹</h3>';
            html += '<p>åŸå› ï¼švisibility åˆ—è¡¨ä¸åŒ…å«ä½ çš„ user_id</p>';
            html += '<button onclick="fixVisibility()">ğŸ”§ ä¿®å¾©å¯è¦‹æ€§</button>';
            html += '</div>';
          } else if (visible.length > 0) {
            html += '<h3 class="success">âœ… å¯è¦‹çš„ä»£è¾¦äº‹é …ï¼š</h3>';
            html += '<ul>';
            visible.slice(0, 5).forEach(t => {
              html += `<li>${t.title} (${t.status})</li>`;
            });
            html += '</ul>';
            if (visible.length > 5) {
              html += `<p>... é‚„æœ‰ ${visible.length - 5} å€‹</p>`;
            }
          }
        }

      } catch (error) {
        html += `<pre class="error-text">âŒ IndexedDB éŒ¯èª¤: ${error.message}</pre>`;
        html += '<button onclick="clearAll()">æ¸…ç©ºè³‡æ–™é‡æ–°åŒæ­¥</button>';
      }

      html += '</div>';

      document.getElementById('result').innerHTML = html;
    }

    async function fixWorkspace() {
      try {
        const db = await new Promise(resolve => {
          const req = indexedDB.open('VenturoOfflineDB');
          req.onsuccess = () => resolve(req.result);
        });

        const tx = db.transaction('employees', 'readonly');
        const store = tx.objectStore('employees');
        const employees = await store.getAll();

        if (employees.length === 0) {
          alert('âŒ IndexedDB ä¸­æ²’æœ‰å“¡å·¥è³‡æ–™ï¼Œè«‹é‡æ–°ç™»å…¥');
          location.href = '/login';
          return;
        }

        const authStore = localStorage.getItem('auth-store');
        const parsed = JSON.parse(authStore);
        const user = parsed.state.user;

        const employee = employees.find(e => e.id === user.id) || employees[0];

        if (employee.workspace_id) {
          parsed.state.user.workspace_id = employee.workspace_id;
          localStorage.setItem('auth-store', JSON.stringify(parsed));
          alert('âœ… å·²ä¿®å¾© workspace_idï¼\n\né‡æ–°æ•´ç†é é¢...');
          location.reload();
        } else {
          alert('âŒ å“¡å·¥è³‡æ–™ä¹Ÿæ²’æœ‰ workspace_idï¼Œè«‹è¯çµ¡ç®¡ç†å“¡');
        }
      } catch (error) {
        alert('ä¿®å¾©å¤±æ•—: ' + error.message);
      }
    }

    async function fixVisibility() {
      const authStore = localStorage.getItem('auth-store');
      const parsed = JSON.parse(authStore);
      const userId = parsed.state.user.id;

      try {
        const db = await new Promise(resolve => {
          const req = indexedDB.open('VenturoOfflineDB');
          req.onsuccess = () => resolve(req.result);
        });

        const tx = db.transaction('todos', 'readwrite');
        const store = tx.objectStore('todos');
        const todos = await store.getAll();

        let fixed = 0;
        for (const todo of todos) {
          if (!todo.visibility?.includes(userId)) {
            todo.visibility = todo.visibility || [];
            todo.visibility.push(userId);
            await store.put(todo);
            fixed++;
          }
        }

        alert(`âœ… å·²ä¿®å¾© ${fixed} å€‹ä»£è¾¦äº‹é …ï¼\n\né‡æ–°æ•´ç†é é¢...`);
        location.reload();

      } catch (error) {
        alert('ä¿®å¾©å¤±æ•—: ' + error.message);
      }
    }

    function relogin() {
      if (confirm('ç¢ºå®šè¦é‡æ–°ç™»å…¥å—ï¼Ÿ')) {
        location.href = '/login';
      }
    }

    function clearAll() {
      if (confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰æœ¬åœ°è³‡æ–™å—ï¼Ÿ\n\né€™æœƒç™»å‡ºä¸¦è¦æ±‚é‡æ–°ç™»å…¥ã€‚')) {
        localStorage.clear();
        indexedDB.deleteDatabase('VenturoOfflineDB');
        location.href = '/login';
      }
    }

    // åŸ·è¡Œè¨ºæ–·
    diagnose();
  </script>
</body>
</html>
