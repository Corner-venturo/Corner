<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Venturo Schema æ ¸å°å·¥å…·</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #f5f5f5;
      padding: 20px;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 8px;
      padding: 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #C19A6B;
      margin-bottom: 10px;
    }
    .subtitle {
      color: #666;
      margin-bottom: 30px;
    }
    .controls {
      margin-bottom: 20px;
      display: flex;
      gap: 10px;
    }
    button {
      background: #C19A6B;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }
    button:hover {
      background: #A88555;
    }
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }
    .stat-card {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 6px;
      border-left: 4px solid #C19A6B;
    }
    .stat-label {
      font-size: 12px;
      color: #666;
      margin-bottom: 5px;
    }
    .stat-value {
      font-size: 24px;
      font-weight: bold;
      color: #333;
    }
    .table-grid {
      display: grid;
      gap: 20px;
    }
    .table-card {
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      overflow: hidden;
    }
    .table-header {
      background: #f8f9fa;
      padding: 15px;
      border-bottom: 2px solid #e0e0e0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .table-name {
      font-weight: bold;
      font-size: 16px;
      color: #333;
    }
    .badge {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
    }
    .badge-ok {
      background: #d4edda;
      color: #155724;
    }
    .badge-warning {
      background: #fff3cd;
      color: #856404;
    }
    .badge-error {
      background: #f8d7da;
      color: #721c24;
    }
    .field-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 10px;
      padding: 15px;
    }
    .field-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px;
      background: #f8f9fa;
      border-radius: 4px;
      font-size: 13px;
    }
    .field-status {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .status-ok { background: #28a745; }
    .status-missing { background: #dc3545; }
    .status-extra { background: #ffc107; }
    .field-name {
      flex: 1;
      font-family: 'Monaco', 'Courier New', monospace;
    }
    .legend {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 6px;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
    }
    .filter-section {
      margin-bottom: 20px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 6px;
    }
    .filter-section label {
      margin-right: 15px;
      font-size: 14px;
    }
    .filter-section input[type="checkbox"] {
      margin-right: 5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ” Venturo Schema æ ¸å°å·¥å…·</h1>
    <p class="subtitle">æ¯”å°å‰ç«¯éœ€è¦çš„æ¬„ä½ vs Supabase å¯¦éš›æ¬„ä½</p>

    <div class="controls">
      <button onclick="loadData()">ğŸ”„ é‡æ–°æª¢æŸ¥</button>
      <button onclick="exportReport()">ğŸ“¥ åŒ¯å‡ºå ±å‘Š</button>
    </div>

    <div class="stats">
      <div class="stat-card">
        <div class="stat-label">ç¸½è¡¨æ ¼æ•¸</div>
        <div class="stat-value" id="total-tables">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">ç¼ºå°‘çš„è¡¨æ ¼</div>
        <div class="stat-value" id="missing-tables" style="color: #dc3545;">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">ç¼ºå°‘çš„æ¬„ä½</div>
        <div class="stat-value" id="missing-fields" style="color: #ffc107;">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">å®Œå…¨åŒ¹é…</div>
        <div class="stat-value" id="perfect-match" style="color: #28a745;">0</div>
      </div>
    </div>

    <div class="filter-section">
      <label><input type="checkbox" id="filter-ok" checked> é¡¯ç¤ºæ­£å¸¸è¡¨æ ¼</label>
      <label><input type="checkbox" id="filter-warning" checked> é¡¯ç¤ºæœ‰å·®ç•°è¡¨æ ¼</label>
      <label><input type="checkbox" id="filter-error" checked> é¡¯ç¤ºç¼ºå°‘è¡¨æ ¼</label>
    </div>

    <div class="legend">
      <div class="legend-item">
        <div class="field-status status-ok"></div>
        <span>Supabase æœ‰æ­¤æ¬„ä½</span>
      </div>
      <div class="legend-item">
        <div class="field-status status-missing"></div>
        <span>Supabase ç¼ºå°‘æ­¤æ¬„ä½</span>
      </div>
      <div class="legend-item">
        <div class="field-status status-extra"></div>
        <span>Supabase å¤šå‡ºçš„æ¬„ä½</span>
      </div>
    </div>

    <div id="results" class="table-grid"></div>
  </div>

  <script type="module">
    // å‰ç«¯å¯¦éš›ä½¿ç”¨çš„å‹åˆ¥å®šç¾©
    const FRONTEND_SCHEMA = {
      employees: {
        fields: ['id', 'employee_number', 'english_name', 'display_name', 'email', 'password_hash', 'personal_info', 'job_info', 'salary_info', 'permissions', 'attendance', 'contracts', 'status', 'avatar', 'is_active', 'last_login_at', 'created_at', 'updated_at'],
        module: 'äººè³‡ç³»çµ±'
      },
      tours: {
        fields: ['id', 'code', 'name', 'departure_date', 'return_date', 'status', 'location', 'price', 'max_participants', 'current_participants', 'contract_status', 'total_revenue', 'total_cost', 'profit', 'quote_id', 'quote_cost_structure', 'description', 'archived', 'is_active', 'created_at', 'updated_at'],
        module: 'æ—…éŠåœ˜ç®¡ç†'
      },
      orders: {
        fields: ['id', 'code', 'order_number', 'tour_id', 'tour_name', 'customer_id', 'contact_person', 'sales_person', 'assistant', 'member_count', 'payment_status', 'status', 'total_amount', 'paid_amount', 'remaining_amount', 'notes', 'is_active', 'created_at', 'updated_at'],
        module: 'è¨‚å–®ç®¡ç†'
      },
      members: {
        fields: ['id', 'order_id', 'tour_id', 'name', 'name_en', 'gender', 'birthday', 'id_number', 'passport_number', 'passport_expiry', 'phone', 'email', 'emergency_contact', 'emergency_phone', 'dietary_restrictions', 'medical_conditions', 'room_preference', 'assigned_room', 'reservation_code', 'is_child_no_bed', 'add_ons', 'refunds', 'notes', 'is_active', 'created_at', 'updated_at'],
        module: 'åœ˜å“¡ç®¡ç†'
      },
      customers: {
        fields: ['id', 'code', 'name', 'phone', 'email', 'address', 'notes', 'is_vip', 'is_active', 'created_at', 'updated_at'],
        module: 'å®¢æˆ¶ç®¡ç†'
      },
      quotes: {
        fields: ['id', 'code', 'customer_id', 'customer_name', 'name', 'destination', 'start_date', 'end_date', 'days', 'nights', 'number_of_people', 'group_size', 'accommodation_days', 'status', 'total_amount', 'version', 'valid_until', 'notes', 'created_by', 'created_by_name', 'converted_to_tour', 'tour_id', 'categories', 'versions', 'is_active', 'created_at', 'updated_at'],
        module: 'å ±åƒ¹å–®'
      },
      suppliers: {
        fields: ['id', 'code', 'name', 'type', 'contact_person', 'phone', 'email', 'address', 'bank_account', 'tax_id', 'notes', 'is_active', 'created_at', 'updated_at'],
        module: 'ä¾›æ‡‰å•†ç®¡ç†'
      },
      todos: {
        fields: ['id', 'title', 'priority', 'deadline', 'status', 'creator', 'assignee', 'visibility', 'related_items', 'sub_tasks', 'notes', 'enabled_quick_actions', 'needs_creator_notification', 'type', 'parent_id', 'project_id', 'is_active', 'created_at', 'updated_at'],
        module: 'å¾…è¾¦äº‹é …'
      },
      tour_addons: {
        fields: ['id', 'tour_id', 'name', 'price', 'description', 'is_active', 'created_at', 'updated_at'],
        module: 'åœ˜é«”åŠ è³¼',
        missing: true
      },
      tour_refunds: {
        fields: ['id', 'tour_id', 'order_id', 'order_number', 'member_name', 'reason', 'amount', 'status', 'applied_date', 'processed_date', 'notes', 'created_at', 'updated_at'],
        module: 'åœ˜é«”é€€è²»',
        missing: true
      },
    };

    // Supabase å¯¦éš› schemaï¼ˆå¾ types.tsï¼‰
    const SUPABASE_SCHEMA = {
      employees: ['id', 'employee_number', 'english_name', 'display_name', 'email', 'password_hash', 'personal_info', 'job_info', 'salary_info', 'permissions', 'attendance', 'contracts', 'status', 'avatar', 'is_active', 'last_login_at', 'created_at', 'updated_at'],
      tours: ['id', 'code', 'name', 'departure_date', 'return_date', 'status', 'location', 'price', 'max_participants', 'current_participants', 'contract_status', 'total_revenue', 'total_cost', 'profit', 'quote_id', 'quote_cost_structure', 'description', 'is_active', 'created_at', 'updated_at'],
      orders: ['id', 'code', 'order_number', 'tour_id', 'tour_name', 'customer_id', 'contact_person', 'sales_person', 'assistant', 'member_count', 'payment_status', 'status', 'total_amount', 'paid_amount', 'remaining_amount', 'notes', 'is_active', 'created_at', 'updated_at'],
      members: ['id', 'order_id', 'name', 'name_en', 'gender', 'birthday', 'id_number', 'passport_number', 'passport_expiry', 'phone', 'email', 'emergency_contact', 'emergency_phone', 'dietary_restrictions', 'medical_conditions', 'room_preference', 'assigned_room', 'reservation_code', 'is_child_no_bed', 'add_ons', 'refunds', 'notes', 'is_active', 'created_at', 'updated_at'],
      customers: ['id', 'code', 'name', 'phone', 'email', 'address', 'notes', 'is_vip', 'is_active', 'created_at', 'updated_at'],
      quotes: ['id', 'code', 'customer_id', 'customer_name', 'name', 'destination', 'start_date', 'end_date', 'days', 'nights', 'number_of_people', 'group_size', 'accommodation_days', 'status', 'total_amount', 'version', 'valid_until', 'notes', 'created_by', 'created_by_name', 'converted_to_tour', 'tour_id', 'categories', 'versions', 'is_active', 'created_at', 'updated_at'],
      suppliers: ['id', 'code', 'name', 'type', 'contact_person', 'phone', 'email', 'address', 'bank_account', 'tax_id', 'notes', 'is_active', 'created_at', 'updated_at'],
      todos: ['id', 'title', 'priority', 'deadline', 'status', 'creator', 'assignee', 'visibility', 'related_items', 'sub_tasks', 'notes', 'enabled_quick_actions', 'needs_creator_notification', 'type', 'parent_id', 'project_id', 'is_active', 'created_at', 'updated_at'],
    };

    function loadData() {
      const results = document.getElementById('results');
      results.innerHTML = '';

      let totalTables = 0;
      let missingTables = 0;
      let missingFieldsCount = 0;
      let perfectMatch = 0;

      Object.entries(FRONTEND_SCHEMA).forEach(([tableName, tableInfo]) => {
        totalTables++;
        const frontendFields = tableInfo.fields;
        const supabaseFields = SUPABASE_SCHEMA[tableName] || [];
        const isMissingTable = tableInfo.missing || supabaseFields.length === 0;

        if (isMissingTable) {
          missingTables++;
        }

        // è¨ˆç®—å·®ç•°
        const missingInSupabase = frontendFields.filter(f => !supabaseFields.includes(f));
        const extraInSupabase = supabaseFields.filter(f => !frontendFields.includes(f));

        if (missingInSupabase.length === 0 && extraInSupabase.length === 0 && !isMissingTable) {
          perfectMatch++;
        }

        missingFieldsCount += missingInSupabase.length;

        // æ±ºå®šç‹€æ…‹
        let status = 'ok';
        let statusText = 'å®Œå…¨åŒ¹é…';
        if (isMissingTable) {
          status = 'error';
          statusText = 'âŒ è¡¨æ ¼ä¸å­˜åœ¨';
        } else if (missingInSupabase.length > 0 || extraInSupabase.length > 0) {
          status = 'warning';
          statusText = `âš ï¸ ${missingInSupabase.length} å€‹æ¬„ä½ç¼ºå¤±`;
        }

        // å»ºç«‹å¡ç‰‡
        const card = document.createElement('div');
        card.className = 'table-card';
        card.dataset.status = status;

        let fieldsHTML = '';

        if (isMissingTable) {
          fieldsHTML = `
            <div style="padding: 15px; color: #721c24; background: #f8d7da;">
              âŒ <strong>æ­¤è¡¨æ ¼åœ¨ Supabase ä¸­ä¸å­˜åœ¨</strong><br>
              <small>éœ€è¦çš„æ¬„ä½ï¼š${frontendFields.join(', ')}</small>
            </div>
          `;
        } else {
          fieldsHTML = frontendFields.map(field => {
            const inSupabase = supabaseFields.includes(field);
            return `
              <div class="field-item">
                <div class="field-status ${inSupabase ? 'status-ok' : 'status-missing'}"></div>
                <span class="field-name">${field}</span>
              </div>
            `;
          }).join('');

          if (extraInSupabase.length > 0) {
            fieldsHTML += '<div style="grid-column: 1/-1; padding: 10px; background: #fff3cd; margin-top: 10px; border-radius: 4px; font-size: 13px;">';
            fieldsHTML += '<strong>âš ï¸ Supabase å¤šå‡ºçš„æ¬„ä½ï¼š</strong> ' + extraInSupabase.join(', ');
            fieldsHTML += '</div>';
          }
        }

        card.innerHTML = `
          <div class="table-header">
            <div>
              <div class="table-name">${tableName}</div>
              <div style="font-size: 12px; color: #666; margin-top: 4px;">${tableInfo.module}</div>
            </div>
            <span class="badge badge-${status}">${statusText}</span>
          </div>
          <div class="field-list">
            ${fieldsHTML}
          </div>
        `;

        results.appendChild(card);
      });

      // æ›´æ–°çµ±è¨ˆ
      document.getElementById('total-tables').textContent = totalTables;
      document.getElementById('missing-tables').textContent = missingTables;
      document.getElementById('missing-fields').textContent = missingFieldsCount;
      document.getElementById('perfect-match').textContent = perfectMatch;

      applyFilters();
    }

    function applyFilters() {
      const showOk = document.getElementById('filter-ok').checked;
      const showWarning = document.getElementById('filter-warning').checked;
      const showError = document.getElementById('filter-error').checked;

      document.querySelectorAll('.table-card').forEach(card => {
        const status = card.dataset.status;
        const shouldShow =
          (status === 'ok' && showOk) ||
          (status === 'warning' && showWarning) ||
          (status === 'error' && showError);

        card.style.display = shouldShow ? 'block' : 'none';
      });
    }

    function exportReport() {
      let report = '# Venturo Schema æª¢æŸ¥å ±å‘Š\n\n';
      report += `æª¢æŸ¥æ—¥æœŸ: ${new Date().toLocaleString('zh-TW')}\n\n`;

      report += '## çµ±è¨ˆ\n\n';
      report += `- ç¸½è¡¨æ ¼æ•¸: ${document.getElementById('total-tables').textContent}\n`;
      report += `- ç¼ºå°‘çš„è¡¨æ ¼: ${document.getElementById('missing-tables').textContent}\n`;
      report += `- ç¼ºå°‘çš„æ¬„ä½: ${document.getElementById('missing-fields').textContent}\n`;
      report += `- å®Œå…¨åŒ¹é…: ${document.getElementById('perfect-match').textContent}\n\n`;

      report += '## è©³ç´°åˆ—è¡¨\n\n';

      Object.entries(FRONTEND_SCHEMA).forEach(([tableName, tableInfo]) => {
        const frontendFields = tableInfo.fields;
        const supabaseFields = SUPABASE_SCHEMA[tableName] || [];
        const missing = frontendFields.filter(f => !supabaseFields.includes(f));

        report += `### ${tableName} (${tableInfo.module})\n\n`;

        if (tableInfo.missing || supabaseFields.length === 0) {
          report += 'âŒ **è¡¨æ ¼ä¸å­˜åœ¨æ–¼ Supabase**\n\n';
        } else if (missing.length > 0) {
          report += `âš ï¸ **ç¼ºå°‘ ${missing.length} å€‹æ¬„ä½**:\n`;
          missing.forEach(f => {
            report += `- ${f}\n`;
          });
          report += '\n';
        } else {
          report += 'âœ… å®Œå…¨åŒ¹é…\n\n';
        }
      });

      const blob = new Blob([report], { type: 'text/markdown' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'schema-report.md';
      a.click();
    }

    // äº‹ä»¶ç›£è½
    document.getElementById('filter-ok').addEventListener('change', applyFilters);
    document.getElementById('filter-warning').addEventListener('change', applyFilters);
    document.getElementById('filter-error').addEventListener('change', applyFilters);

    // åˆå§‹è¼‰å…¥
    loadData();
  </script>
</body>
</html>
