<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>檢查 Supabase channel_members</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      max-width: 1200px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      margin-bottom: 20px;
    }
    button {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 15px 30px;
      font-size: 16px;
      border-radius: 5px;
      cursor: pointer;
      margin: 10px 5px;
    }
    button:hover {
      background: #2563eb;
    }
    .section {
      margin: 20px 0;
      padding: 15px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 5px;
    }
    .section h2 {
      margin-top: 0;
      color: #1f2937;
      font-size: 18px;
    }
    pre {
      background: #1f2937;
      color: #e5e7eb;
      padding: 15px;
      border-radius: 5px;
      overflow-x: auto;
      font-size: 12px;
      max-height: 400px;
      overflow-y: auto;
    }
    .success {
      background: #dcfce7;
      color: #166534;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
    }
    .warning {
      background: #fef3c7;
      color: #92400e;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
    }
    .error {
      background: #fee2e2;
      color: #991b1b;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 10px 0;
    }
    th, td {
      border: 1px solid #e5e7eb;
      padding: 8px;
      text-align: left;
      font-size: 12px;
    }
    th {
      background: #f3f4f6;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>🔍 檢查 Supabase channel_members 表格</h1>

    <button onclick="checkChannelMembers()">📊 查詢所有頻道成員</button>
    <button onclick="checkChannels()">📋 查詢所有頻道</button>
    <button onclick="checkEmployees()">👥 查詢所有員工</button>

    <div id="results"></div>
  </div>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

    const SUPABASE_URL = 'https://pfqvdacxowpgfamuvnsn.supabase.co'
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBmcXZkYWN4b3dwZ2ZhbXV2bnNuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxMDgzMjAsImV4cCI6MjA3NDY4NDMyMH0.LIMG0qmHixTPcbdzJrh4h0yTp8mh3FlggeZ6Bi_NwtI'

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

    function log(title, data, type = 'info') {
      const resultsDiv = document.getElementById('results')
      const section = document.createElement('div')
      section.className = 'section'

      const heading = document.createElement('h2')
      heading.textContent = title
      section.appendChild(heading)

      if (type === 'error') {
        const errorDiv = document.createElement('div')
        errorDiv.className = 'error'
        errorDiv.textContent = typeof data === 'string' ? data : JSON.stringify(data, null, 2)
        section.appendChild(errorDiv)
      } else if (type === 'success') {
        const successDiv = document.createElement('div')
        successDiv.className = 'success'
        successDiv.textContent = typeof data === 'string' ? data : JSON.stringify(data, null, 2)
        section.appendChild(successDiv)
      } else if (type === 'warning') {
        const warningDiv = document.createElement('div')
        warningDiv.className = 'warning'
        warningDiv.textContent = typeof data === 'string' ? data : JSON.stringify(data, null, 2)
        section.appendChild(warningDiv)
      } else if (type === 'table') {
        const table = document.createElement('table')
        if (data.length > 0) {
          // Header
          const thead = document.createElement('thead')
          const headerRow = document.createElement('tr')
          Object.keys(data[0]).forEach(key => {
            const th = document.createElement('th')
            th.textContent = key
            headerRow.appendChild(th)
          })
          thead.appendChild(headerRow)
          table.appendChild(thead)

          // Body
          const tbody = document.createElement('tbody')
          data.forEach(row => {
            const tr = document.createElement('tr')
            Object.values(row).forEach(value => {
              const td = document.createElement('td')
              td.textContent = typeof value === 'object' ? JSON.stringify(value) : value
              tr.appendChild(td)
            })
            tbody.appendChild(tr)
          })
          table.appendChild(tbody)
        }
        section.appendChild(table)
      } else {
        const pre = document.createElement('pre')
        pre.textContent = JSON.stringify(data, null, 2)
        section.appendChild(pre)
      }

      resultsDiv.appendChild(section)
    }

    async function checkChannelMembers() {
      document.getElementById('results').innerHTML = ''

      try {
        log('1️⃣ 查詢 channel_members 表格', '正在查詢...', 'info')

        const { data: members, error, count } = await supabase
          .from('channel_members')
          .select('*', { count: 'exact' })
          .order('created_at', { ascending: false })

        if (error) {
          log('❌ 查詢失敗', error, 'error')
          return
        }

        if (!members || members.length === 0) {
          log('⚠️ channel_members 表格是空的', '目前沒有任何頻道成員資料', 'warning')
        } else {
          log(`✅ 找到 ${count} 筆頻道成員資料`, members, 'success')
          log('📋 成員列表', members, 'table')
        }

        // 統計每個頻道的成員數
        if (members && members.length > 0) {
          const channelStats = members.reduce((acc, member) => {
            const channelId = member.channel_id
            if (!acc[channelId]) {
              acc[channelId] = { count: 0, roles: {} }
            }
            acc[channelId].count++
            acc[channelId].roles[member.role] = (acc[channelId].roles[member.role] || 0) + 1
            return acc
          }, {})

          log('📊 各頻道成員統計', channelStats)
        }

      } catch (error) {
        log('❌ 查詢過程發生錯誤', error.message, 'error')
      }
    }

    async function checkChannels() {
      try {
        log('2️⃣ 查詢 channels 表格', '正在查詢...', 'info')

        const { data: channels, error, count } = await supabase
          .from('channels')
          .select('id, name, type, created_by, created_at', { count: 'exact' })
          .order('created_at', { ascending: false })
          .limit(20)

        if (error) {
          log('❌ 查詢頻道失敗', error, 'error')
          return
        }

        log(`✅ 找到 ${count} 個頻道`, `顯示最新 ${channels.length} 個`, 'success')
        log('📋 頻道列表', channels, 'table')

      } catch (error) {
        log('❌ 查詢頻道發生錯誤', error.message, 'error')
      }
    }

    async function checkEmployees() {
      try {
        log('3️⃣ 查詢 employees 表格', '正在查詢...', 'info')

        const { data: employees, error, count } = await supabase
          .from('employees')
          .select('id, employee_number, display_name, english_name, status, roles', { count: 'exact' })
          .limit(20)

        if (error) {
          log('❌ 查詢員工失敗', error, 'error')
          return
        }

        log(`✅ 找到 ${count} 位員工`, `顯示前 ${employees.length} 位`, 'success')
        log('📋 員工列表', employees, 'table')

      } catch (error) {
        log('❌ 查詢員工發生錯誤', error.message, 'error')
      }
    }

    // 匯出到全域
    window.checkChannelMembers = checkChannelMembers
    window.checkChannels = checkChannels
    window.checkEmployees = checkEmployees
  </script>
</body>
</html>
