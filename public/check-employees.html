<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>æª¢æŸ¥å“¡å·¥è³‡æ–™</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      max-width: 1000px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      border-radius: 8px;
      padding: 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 { color: #C19A6B; margin-bottom: 10px; }
    .info { color: #666; margin-bottom: 30px; font-size: 14px; }
    button {
      background: #C19A6B;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      margin-bottom: 20px;
    }
    button:hover { background: #A88555; }
    .log {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      padding: 15px;
      font-family: monospace;
      font-size: 12px;
      white-space: pre-wrap;
      max-height: 600px;
      overflow-y: auto;
    }
    .success { color: #28a745; }
    .error { color: #dc3545; }
    .warning { color: #ffc107; }
    .info-text { color: #17a2b8; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    th, td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid #dee2e6;
    }
    th {
      background: #f8f9fa;
      font-weight: 600;
    }
    .badge {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
    }
    .badge-success { background: #d4edda; color: #155724; }
    .badge-warning { background: #fff3cd; color: #856404; }
    .badge-danger { background: #f8d7da; color: #721c24; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ‘¥ å“¡å·¥è³‡æ–™æª¢æŸ¥</h1>
    <p class="info">æª¢æŸ¥ç‚ºä»€éº¼æ¥­å‹™äººå“¡/åŠ©ç†ä¸‹æ‹‰é¸å–®æ²’æœ‰é¸é …</p>

    <button onclick="checkEmployees()">ğŸ” æª¢æŸ¥å“¡å·¥è³‡æ–™</button>
    <button onclick="addSampleEmployee()">â• æ–°å¢æ¸¬è©¦å“¡å·¥</button>

    <div id="log" class="log"></div>
  </div>

  <script type="module">
    import { openDB } from 'https://cdn.jsdelivr.net/npm/idb@8/+esm';

    window.checkEmployees = async () => {
      const log = document.getElementById('log');
      log.innerHTML = '<span class="info-text">ğŸ” æ­£åœ¨æª¢æŸ¥å“¡å·¥è³‡æ–™...</span>\n\n';

      try {
        const db = await openDB('VenturoOfflineDB', 1);
        const allEmployees = await db.getAll('employees');

        log.innerHTML += `<span class="info-text">ğŸ“Š ç¸½å…±æ‰¾åˆ° ${allEmployees.length} ç­†å“¡å·¥è³‡æ–™</span>\n\n`;

        if (allEmployees.length === 0) {
          log.innerHTML += '<span class="error">âŒ æ²’æœ‰ä»»ä½•å“¡å·¥è³‡æ–™ï¼</span>\n';
          log.innerHTML += '<span class="warning">ğŸ’¡ é€™å°±æ˜¯ç‚ºä»€éº¼ä¸‹æ‹‰é¸å–®æ˜¯ç©ºçš„</span>\n';
          log.innerHTML += '<span class="info-text">ğŸ“Œ è«‹é»æ“Šã€Œæ–°å¢æ¸¬è©¦å“¡å·¥ã€æŒ‰éˆ•ä¾†å»ºç«‹ç¯„ä¾‹è³‡æ–™</span>\n';
          return;
        }

        // æª¢æŸ¥å¯ç”¨å“¡å·¥ï¼ˆä¸‹æ‹‰é¸å–®æœƒé¡¯ç¤ºçš„ï¼‰
        const availableEmployees = allEmployees.filter(emp =>
          !emp._deleted && emp.status !== 'inactive'
        );

        log.innerHTML += `<span class="success">âœ… å¯ç”¨å“¡å·¥: ${availableEmployees.length} ä½</span>\n`;
        log.innerHTML += `<span class="warning">âš ï¸ å·²åˆªé™¤/åœç”¨: ${allEmployees.length - availableEmployees.length} ä½</span>\n\n`;

        // å»ºç«‹è¡¨æ ¼
        let tableHTML = '<table><thead><tr>';
        tableHTML += '<th>å§“å</th><th>è‹±æ–‡å</th><th>å“¡å·¥ç·¨è™Ÿ</th><th>ç‹€æ…‹</th><th>å¯ç”¨æ–¼ä¸‹æ‹‰é¸å–®</th>';
        tableHTML += '</tr></thead><tbody>';

        allEmployees.forEach(emp => {
          const isAvailable = !emp._deleted && emp.status !== 'inactive';
          const statusBadge = isAvailable
            ? '<span class="badge badge-success">âœ… å¯ç”¨</span>'
            : '<span class="badge badge-danger">âŒ ä¸å¯ç”¨</span>';

          tableHTML += '<tr>';
          tableHTML += `<td>${emp.display_name || emp.name || '(ç„¡åç¨±)'}</td>`;
          tableHTML += `<td>${emp.english_name || '-'}</td>`;
          tableHTML += `<td>${emp.employee_number || '-'}</td>`;
          tableHTML += `<td>${emp.status || '(æœªè¨­å®š)'}</td>`;
          tableHTML += `<td>${statusBadge}</td>`;
          tableHTML += '</tr>';
        });

        tableHTML += '</tbody></table>';

        log.innerHTML += tableHTML;

        // é¡¯ç¤ºä¸‹æ‹‰é¸å–®æœƒç”¨çš„æ ¼å¼
        if (availableEmployees.length > 0) {
          log.innerHTML += '\n\n<span class="info-text">ğŸ“‹ ä¸‹æ‹‰é¸å–®é¸é …ï¼ˆå‰ç«¯æ ¼å¼ï¼‰ï¼š</span>\n';
          availableEmployees.forEach((emp, index) => {
            const label = `${emp.display_name || emp.name} (${emp.english_name || 'ç„¡è‹±æ–‡å'})`;
            log.innerHTML += `<span class="success">${index + 1}. ${label}</span>\n`;
          });
        }

        // æª¢æŸ¥å•é¡Œ
        log.innerHTML += '\n\n<span class="info-text">ğŸ”§ å•é¡Œè¨ºæ–·ï¼š</span>\n';

        if (availableEmployees.length === 0) {
          log.innerHTML += '<span class="error">âŒ æ‰€æœ‰å“¡å·¥éƒ½è¢«æ¨™è¨˜ç‚ºåˆªé™¤æˆ–åœç”¨</span>\n';
          log.innerHTML += '<span class="warning">ğŸ’¡ è«‹åˆ°äººè³‡ç³»çµ±æ–°å¢å“¡å·¥ï¼Œæˆ–é‡æ–°å•Ÿç”¨ç¾æœ‰å“¡å·¥</span>\n';
        } else if (availableEmployees.some(emp => !emp.display_name && !emp.name)) {
          log.innerHTML += '<span class="warning">âš ï¸ éƒ¨åˆ†å“¡å·¥ç¼ºå°‘ display_name æˆ– name</span>\n';
        } else if (availableEmployees.some(emp => !emp.english_name)) {
          log.innerHTML += '<span class="warning">âš ï¸ éƒ¨åˆ†å“¡å·¥ç¼ºå°‘ english_nameï¼ˆä¸‹æ‹‰é¸å–®æœƒé¡¯ç¤ºã€Œç„¡è‹±æ–‡åã€ï¼‰</span>\n';
        } else {
          log.innerHTML += '<span class="success">âœ… è³‡æ–™çœ‹èµ·ä¾†æ­£å¸¸ï¼</span>\n';
          log.innerHTML += '<span class="info-text">ğŸ’¡ å¦‚æœä¸‹æ‹‰é¸å–®é‚„æ˜¯ç©ºçš„ï¼Œè«‹é‡æ–°æ•´ç†é é¢</span>\n';
        }

      } catch (error) {
        log.innerHTML += `<span class="error">âŒ æª¢æŸ¥å¤±æ•—: ${error.message}</span>\n`;
      }
    };

    window.addSampleEmployee = async () => {
      const log = document.getElementById('log');
      log.innerHTML = '<span class="info-text">â• æ­£åœ¨æ–°å¢æ¸¬è©¦å“¡å·¥...</span>\n\n';

      try {
        const db = await openDB('VenturoOfflineDB', 1);

        const sampleEmployees = [
          {
            id: crypto.randomUUID(),
            employee_number: 'EMP001',
            name: 'ç‹å°æ˜',
            display_name: 'ç‹å°æ˜',
            english_name: 'William Wang',
            email: 'william@example.com',
            status: 'active',
            is_active: true,
            permissions: ['tours', 'orders'],
            personal_info: {},
            job_info: {},
            salary_info: {},
            attendance: { leave_records: [], overtime_records: [] },
            contracts: [],
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString(),
          },
          {
            id: crypto.randomUUID(),
            employee_number: 'EMP002',
            name: 'æç¾éº—',
            display_name: 'æç¾éº—',
            english_name: 'Mary Li',
            email: 'mary@example.com',
            status: 'active',
            is_active: true,
            permissions: ['tours', 'orders'],
            personal_info: {},
            job_info: {},
            salary_info: {},
            attendance: { leave_records: [], overtime_records: [] },
            contracts: [],
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString(),
          },
          {
            id: crypto.randomUUID(),
            employee_number: 'EMP003',
            name: 'å¼µå¤§è¯',
            display_name: 'å¼µå¤§è¯',
            english_name: 'David Chang',
            email: 'david@example.com',
            status: 'active',
            is_active: true,
            permissions: ['tours', 'orders'],
            personal_info: {},
            job_info: {},
            salary_info: {},
            attendance: { leave_records: [], overtime_records: [] },
            contracts: [],
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString(),
          },
        ];

        for (const emp of sampleEmployees) {
          await db.put('employees', emp);
          log.innerHTML += `<span class="success">âœ… å·²æ–°å¢: ${emp.display_name} (${emp.english_name})</span>\n`;
        }

        log.innerHTML += '\n<span class="success">âœ… æ¸¬è©¦å“¡å·¥æ–°å¢å®Œæˆï¼</span>\n';
        log.innerHTML += '<span class="info-text">ğŸ’¡ è«‹é‡æ–°æ•´ç†æ—…éŠåœ˜é é¢ï¼Œä¸‹æ‹‰é¸å–®æ‡‰è©²å°±æœ‰é¸é …äº†</span>\n';

      } catch (error) {
        log.innerHTML += `<span class="error">âŒ æ–°å¢å¤±æ•—: ${error.message}</span>\n`;
      }
    };

    // è‡ªå‹•åŸ·è¡Œæª¢æŸ¥
    window.addEventListener('load', () => {
      window.checkEmployees();
    });
  </script>
</body>
</html>
