<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>檢查員工資料</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      max-width: 1000px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      border-radius: 8px;
      padding: 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 { color: #C19A6B; margin-bottom: 10px; }
    .info { color: #666; margin-bottom: 30px; font-size: 14px; }
    button {
      background: #C19A6B;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      margin-bottom: 20px;
    }
    button:hover { background: #A88555; }
    .log {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      padding: 15px;
      font-family: monospace;
      font-size: 12px;
      white-space: pre-wrap;
      max-height: 600px;
      overflow-y: auto;
    }
    .success { color: #28a745; }
    .error { color: #dc3545; }
    .warning { color: #ffc107; }
    .info-text { color: #17a2b8; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    th, td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid #dee2e6;
    }
    th {
      background: #f8f9fa;
      font-weight: 600;
    }
    .badge {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
    }
    .badge-success { background: #d4edda; color: #155724; }
    .badge-warning { background: #fff3cd; color: #856404; }
    .badge-danger { background: #f8d7da; color: #721c24; }
  </style>
</head>
<body>
  <div class="container">
    <h1>👥 員工資料檢查</h1>
    <p class="info">檢查為什麼業務人員/助理下拉選單沒有選項</p>

    <button onclick="checkEmployees()">🔍 檢查員工資料</button>
    <button onclick="addSampleEmployee()">➕ 新增測試員工</button>

    <div id="log" class="log"></div>
  </div>

  <script type="module">
    import { openDB } from 'https://cdn.jsdelivr.net/npm/idb@8/+esm';

    window.checkEmployees = async () => {
      const log = document.getElementById('log');
      log.innerHTML = '<span class="info-text">🔍 正在檢查員工資料...</span>\n\n';

      try {
        const db = await openDB('VenturoOfflineDB', 1);
        const allEmployees = await db.getAll('employees');

        log.innerHTML += `<span class="info-text">📊 總共找到 ${allEmployees.length} 筆員工資料</span>\n\n`;

        if (allEmployees.length === 0) {
          log.innerHTML += '<span class="error">❌ 沒有任何員工資料！</span>\n';
          log.innerHTML += '<span class="warning">💡 這就是為什麼下拉選單是空的</span>\n';
          log.innerHTML += '<span class="info-text">📌 請點擊「新增測試員工」按鈕來建立範例資料</span>\n';
          return;
        }

        // 檢查可用員工（下拉選單會顯示的）
        const availableEmployees = allEmployees.filter(emp =>
          !emp._deleted && emp.status !== 'inactive'
        );

        log.innerHTML += `<span class="success">✅ 可用員工: ${availableEmployees.length} 位</span>\n`;
        log.innerHTML += `<span class="warning">⚠️ 已刪除/停用: ${allEmployees.length - availableEmployees.length} 位</span>\n\n`;

        // 建立表格
        let tableHTML = '<table><thead><tr>';
        tableHTML += '<th>姓名</th><th>英文名</th><th>員工編號</th><th>狀態</th><th>可用於下拉選單</th>';
        tableHTML += '</tr></thead><tbody>';

        allEmployees.forEach(emp => {
          const isAvailable = !emp._deleted && emp.status !== 'inactive';
          const statusBadge = isAvailable
            ? '<span class="badge badge-success">✅ 可用</span>'
            : '<span class="badge badge-danger">❌ 不可用</span>';

          tableHTML += '<tr>';
          tableHTML += `<td>${emp.display_name || emp.name || '(無名稱)'}</td>`;
          tableHTML += `<td>${emp.english_name || '-'}</td>`;
          tableHTML += `<td>${emp.employee_number || '-'}</td>`;
          tableHTML += `<td>${emp.status || '(未設定)'}</td>`;
          tableHTML += `<td>${statusBadge}</td>`;
          tableHTML += '</tr>';
        });

        tableHTML += '</tbody></table>';

        log.innerHTML += tableHTML;

        // 顯示下拉選單會用的格式
        if (availableEmployees.length > 0) {
          log.innerHTML += '\n\n<span class="info-text">📋 下拉選單選項（前端格式）：</span>\n';
          availableEmployees.forEach((emp, index) => {
            const label = `${emp.display_name || emp.name} (${emp.english_name || '無英文名'})`;
            log.innerHTML += `<span class="success">${index + 1}. ${label}</span>\n`;
          });
        }

        // 檢查問題
        log.innerHTML += '\n\n<span class="info-text">🔧 問題診斷：</span>\n';

        if (availableEmployees.length === 0) {
          log.innerHTML += '<span class="error">❌ 所有員工都被標記為刪除或停用</span>\n';
          log.innerHTML += '<span class="warning">💡 請到人資系統新增員工，或重新啟用現有員工</span>\n';
        } else if (availableEmployees.some(emp => !emp.display_name && !emp.name)) {
          log.innerHTML += '<span class="warning">⚠️ 部分員工缺少 display_name 或 name</span>\n';
        } else if (availableEmployees.some(emp => !emp.english_name)) {
          log.innerHTML += '<span class="warning">⚠️ 部分員工缺少 english_name（下拉選單會顯示「無英文名」）</span>\n';
        } else {
          log.innerHTML += '<span class="success">✅ 資料看起來正常！</span>\n';
          log.innerHTML += '<span class="info-text">💡 如果下拉選單還是空的，請重新整理頁面</span>\n';
        }

      } catch (error) {
        log.innerHTML += `<span class="error">❌ 檢查失敗: ${error.message}</span>\n`;
      }
    };

    window.addSampleEmployee = async () => {
      const log = document.getElementById('log');
      log.innerHTML = '<span class="info-text">➕ 正在新增測試員工...</span>\n\n';

      try {
        const db = await openDB('VenturoOfflineDB', 1);

        const sampleEmployees = [
          {
            id: crypto.randomUUID(),
            employee_number: 'EMP001',
            name: '王小明',
            display_name: '王小明',
            english_name: 'William Wang',
            email: 'william@example.com',
            status: 'active',
            is_active: true,
            permissions: ['tours', 'orders'],
            personal_info: {},
            job_info: {},
            salary_info: {},
            attendance: { leave_records: [], overtime_records: [] },
            contracts: [],
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString(),
          },
          {
            id: crypto.randomUUID(),
            employee_number: 'EMP002',
            name: '李美麗',
            display_name: '李美麗',
            english_name: 'Mary Li',
            email: 'mary@example.com',
            status: 'active',
            is_active: true,
            permissions: ['tours', 'orders'],
            personal_info: {},
            job_info: {},
            salary_info: {},
            attendance: { leave_records: [], overtime_records: [] },
            contracts: [],
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString(),
          },
          {
            id: crypto.randomUUID(),
            employee_number: 'EMP003',
            name: '張大華',
            display_name: '張大華',
            english_name: 'David Chang',
            email: 'david@example.com',
            status: 'active',
            is_active: true,
            permissions: ['tours', 'orders'],
            personal_info: {},
            job_info: {},
            salary_info: {},
            attendance: { leave_records: [], overtime_records: [] },
            contracts: [],
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString(),
          },
        ];

        for (const emp of sampleEmployees) {
          await db.put('employees', emp);
          log.innerHTML += `<span class="success">✅ 已新增: ${emp.display_name} (${emp.english_name})</span>\n`;
        }

        log.innerHTML += '\n<span class="success">✅ 測試員工新增完成！</span>\n';
        log.innerHTML += '<span class="info-text">💡 請重新整理旅遊團頁面，下拉選單應該就有選項了</span>\n';

      } catch (error) {
        log.innerHTML += `<span class="error">❌ 新增失敗: ${error.message}</span>\n`;
      }
    };

    // 自動執行檢查
    window.addEventListener('load', () => {
      window.checkEmployees();
    });
  </script>
</body>
</html>
