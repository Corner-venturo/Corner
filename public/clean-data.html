<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Venturo è³‡æ–™æ¸…ç†å·¥å…·</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      border-radius: 8px;
      padding: 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #C19A6B;
      margin-bottom: 30px;
    }
    .section {
      margin-bottom: 30px;
      padding: 20px;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
    }
    button {
      background: #C19A6B;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      margin-right: 10px;
    }
    button:hover {
      background: #A88555;
    }
    button.danger {
      background: #dc3545;
    }
    button.danger:hover {
      background: #c82333;
    }
    .log {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      padding: 15px;
      margin-top: 15px;
      max-height: 300px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 12px;
      white-space: pre-wrap;
    }
    .success { color: #28a745; }
    .error { color: #dc3545; }
    .warning { color: #ffc107; }
    .info { color: #17a2b8; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ”§ Venturo è³‡æ–™æ¸…ç†å·¥å…·</h1>

    <!-- æ¸…ç†ç„¡æ•ˆæ—…éŠåœ˜ -->
    <div class="section">
      <h2>ğŸ—‘ï¸ æ¸…ç†ç„¡æ•ˆæ—…éŠåœ˜</h2>
      <p>ç§»é™¤ departure_date ç„¡æ•ˆæˆ–ç©ºç™½çš„æ—…éŠåœ˜è³‡æ–™</p>
      <button onclick="scanInvalidTours()">1. æƒæç„¡æ•ˆè³‡æ–™</button>
      <button class="danger" onclick="cleanInvalidTours()">2. æ°¸ä¹…åˆªé™¤</button>
      <div id="tour-log" class="log"></div>
    </div>

    <!-- æª¢æŸ¥å“¡å·¥è³‡æ–™ -->
    <div class="section">
      <h2>ğŸ‘¥ æª¢æŸ¥å“¡å·¥è³‡æ–™</h2>
      <p>æŸ¥çœ‹ç³»çµ±ä¸­çš„å“¡å·¥è³‡æ–™ç‹€æ…‹</p>
      <button onclick="checkEmployees()">æª¢æŸ¥å“¡å·¥è³‡æ–™</button>
      <div id="employee-log" class="log"></div>
    </div>
  </div>

  <script type="module">
    import { openDB } from 'https://cdn.jsdelivr.net/npm/idb@8/+esm';

    let invalidToursCache = [];

    // æƒæç„¡æ•ˆæ—…éŠåœ˜
    window.scanInvalidTours = async () => {
      const log = document.getElementById('tour-log');
      log.innerHTML = '<span class="info">ğŸ” æ­£åœ¨æƒæ...</span>\n';

      try {
        const db = await openDB('VenturoOfflineDB', 1);
        const allTours = await db.getAll('tours');

        log.innerHTML += `<span class="info">ğŸ“Š ç¸½å…±æ‰¾åˆ° ${allTours.length} ç­†æ—…éŠåœ˜è³‡æ–™</span>\n\n`;

        // æ‰¾å‡ºç„¡æ•ˆçš„
        invalidToursCache = allTours.filter(tour => {
          if (!tour.departure_date) return true;
          const date = new Date(tour.departure_date);
          return isNaN(date.getTime());
        });

        if (invalidToursCache.length === 0) {
          log.innerHTML += '<span class="success">âœ… æ²’æœ‰æ‰¾åˆ°ç„¡æ•ˆçš„æ—…éŠåœ˜è³‡æ–™</span>\n';
          return;
        }

        log.innerHTML += `<span class="warning">âš ï¸ æ‰¾åˆ° ${invalidToursCache.length} ç­†ç„¡æ•ˆè³‡æ–™ï¼š</span>\n\n`;
        invalidToursCache.forEach((tour, index) => {
          log.innerHTML += `<span class="error">${index + 1}. ID: ${tour.id}</span>\n`;
          log.innerHTML += `   åç¨±: ${tour.name || '(ç„¡åç¨±)'}\n`;
          log.innerHTML += `   å‡ºç™¼æ—¥æœŸ: ${tour.departure_date || '(ç©ºç™½)'}\n`;
          log.innerHTML += `   å»ºç«‹æ™‚é–“: ${tour.created_at || '(æœªçŸ¥)'}\n\n`;
        });

        log.innerHTML += '<span class="warning">âš ï¸ è«‹é»æ“Šã€Œæ°¸ä¹…åˆªé™¤ã€æŒ‰éˆ•ä¾†æ¸…é™¤é€™äº›è³‡æ–™</span>\n';

      } catch (error) {
        log.innerHTML += `<span class="error">âŒ æƒæå¤±æ•—: ${error.message}</span>\n`;
      }
    };

    // æ¸…ç†ç„¡æ•ˆæ—…éŠåœ˜
    window.cleanInvalidTours = async () => {
      if (invalidToursCache.length === 0) {
        alert('è«‹å…ˆåŸ·è¡Œã€Œæƒæç„¡æ•ˆè³‡æ–™ã€');
        return;
      }

      const confirmed = confirm(`ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤ ${invalidToursCache.length} ç­†ç„¡æ•ˆè³‡æ–™å—ï¼Ÿ\n\næ­¤æ“ä½œç„¡æ³•å¾©åŸï¼`);
      if (!confirmed) return;

      const log = document.getElementById('tour-log');
      log.innerHTML += '\n<span class="info">ğŸ—‘ï¸ é–‹å§‹åˆªé™¤...</span>\n';

      try {
        const db = await openDB('VenturoOfflineDB', 1);

        for (const tour of invalidToursCache) {
          await db.delete('tours', tour.id);
          log.innerHTML += `<span class="success">âœ… å·²åˆªé™¤: ${tour.name || tour.id}</span>\n`;
        }

        log.innerHTML += `\n<span class="success">âœ… æˆåŠŸåˆªé™¤ ${invalidToursCache.length} ç­†è³‡æ–™ï¼</span>\n`;
        log.innerHTML += '<span class="info">ğŸ’¡ è«‹é—œé–‰æ­¤é é¢ï¼Œå›åˆ°æ—…éŠåœ˜é é¢é‡æ–°æ•´ç†</span>\n';

        invalidToursCache = [];

      } catch (error) {
        log.innerHTML += `<span class="error">âŒ åˆªé™¤å¤±æ•—: ${error.message}</span>\n`;
      }
    };

    // æª¢æŸ¥å“¡å·¥è³‡æ–™
    window.checkEmployees = async () => {
      const log = document.getElementById('employee-log');
      log.innerHTML = '<span class="info">ğŸ” æ­£åœ¨æª¢æŸ¥å“¡å·¥è³‡æ–™...</span>\n\n';

      try {
        const db = await openDB('VenturoOfflineDB', 1);
        const allEmployees = await db.getAll('employees');

        log.innerHTML += `<span class="info">ğŸ“Š ç¸½å…±æ‰¾åˆ° ${allEmployees.length} ç­†å“¡å·¥è³‡æ–™</span>\n\n`;

        if (allEmployees.length === 0) {
          log.innerHTML += '<span class="warning">âš ï¸ æ²’æœ‰ä»»ä½•å“¡å·¥è³‡æ–™ï¼</span>\n';
          log.innerHTML += '<span class="info">ğŸ’¡ è«‹å…ˆåˆ°ã€Œäººè³‡ç³»çµ±ã€æ–°å¢å“¡å·¥</span>\n';
          return;
        }

        // çµ±è¨ˆç‹€æ…‹
        const active = allEmployees.filter(emp => !emp._deleted && emp.status !== 'inactive');
        const inactive = allEmployees.filter(emp => emp.status === 'inactive');
        const deleted = allEmployees.filter(emp => emp._deleted);

        log.innerHTML += `<span class="success">âœ… å¯ç”¨å“¡å·¥: ${active.length} ä½</span>\n`;
        log.innerHTML += `<span class="warning">âš ï¸ åœç”¨å“¡å·¥: ${inactive.length} ä½</span>\n`;
        log.innerHTML += `<span class="error">âŒ å·²åˆªé™¤: ${deleted.length} ä½</span>\n\n`;

        // é¡¯ç¤ºå¯ç”¨å“¡å·¥åˆ—è¡¨
        if (active.length > 0) {
          log.innerHTML += '<span class="info">ğŸ“‹ å¯ç”¨å“¡å·¥åˆ—è¡¨ï¼š</span>\n\n';
          active.forEach((emp, index) => {
            log.innerHTML += `<span class="success">${index + 1}. ${emp.display_name || emp.name || '(ç„¡åç¨±)'}</span>\n`;
            log.innerHTML += `   è‹±æ–‡å: ${emp.english_name || '(æœªè¨­å®š)'}\n`;
            log.innerHTML += `   å“¡å·¥ç·¨è™Ÿ: ${emp.employee_number || '(æœªè¨­å®š)'}\n`;
            log.innerHTML += `   ç‹€æ…‹: ${emp.status || '(æœªè¨­å®š)'}\n\n`;
          });
        }

        // é¡¯ç¤ºå•é¡Œå“¡å·¥
        if (inactive.length > 0 || deleted.length > 0) {
          log.innerHTML += '\n<span class="warning">âš ï¸ ä»¥ä¸‹å“¡å·¥ç„¡æ³•åœ¨ä¸‹æ‹‰é¸å–®ä¸­ä½¿ç”¨ï¼š</span>\n\n';

          [...inactive, ...deleted].forEach((emp, index) => {
            const reason = emp._deleted ? 'å·²åˆªé™¤' : 'å·²åœç”¨';
            log.innerHTML += `<span class="warning">${index + 1}. ${emp.display_name || emp.name || '(ç„¡åç¨±)'} - ${reason}</span>\n`;
          });
        }

      } catch (error) {
        log.innerHTML += `<span class="error">âŒ æª¢æŸ¥å¤±æ•—: ${error.message}</span>\n`;
      }
    };

    // è‡ªå‹•åŸ·è¡Œæƒæ
    window.addEventListener('load', () => {
      window.scanInvalidTours();
      window.checkEmployees();
    });
  </script>
</body>
</html>
