<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ä»£è¾¦äº‹é …é™¤éŒ¯å·¥å…·</title>
  <style>
    body {
      font-family: 'Courier New', monospace;
      padding: 20px;
      max-width: 1400px;
      margin: 0 auto;
      background: #1a1a1a;
      color: #e0e0e0;
    }
    .section {
      margin: 20px 0;
      padding: 15px;
      background: #2a2a2a;
      border-radius: 8px;
      border-left: 4px solid #4CAF50;
    }
    .error {
      border-left-color: #f44336;
    }
    .warning {
      border-left-color: #ff9800;
    }
    h1, h2 { color: #4CAF50; margin-top: 0; }
    pre {
      background: #1a1a1a;
      padding: 10px;
      overflow-x: auto;
      border-radius: 4px;
    }
    .highlight { color: #ffeb3b; font-weight: bold; }
    .success { color: #4CAF50; }
    .error-text { color: #f44336; }
    button {
      padding: 12px 24px;
      margin: 5px;
      cursor: pointer;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 14px;
    }
    button:hover { background: #45a049; }
    .todo-item {
      margin: 8px 0;
      padding: 12px;
      background: #1a1a1a;
      border-left: 3px solid #2196F3;
      border-radius: 4px;
    }
    .invisible { border-left-color: #f44336; opacity: 0.7; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 10px 0;
    }
    th, td {
      padding: 8px;
      text-align: left;
      border-bottom: 1px solid #444;
    }
    th { background: #1a1a1a; color: #4CAF50; }
    .copy-btn {
      background: #2196F3;
      padding: 4px 8px;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <h1>ğŸ” ä»£è¾¦äº‹é …é™¤éŒ¯å·¥å…·</h1>

  <div class="section">
    <h2>æ­¥é©Ÿ 1ï¼šç•¶å‰ç™»å…¥ç‹€æ…‹</h2>
    <div id="auth-status"></div>
    <button onclick="copyToClipboard('auth-status')">ğŸ“‹ è¤‡è£½</button>
  </div>

  <div class="section">
    <h2>æ­¥é©Ÿ 2ï¼šIndexedDB è³‡æ–™</h2>
    <div id="db-status"></div>
    <button onclick="copyToClipboard('db-status')">ğŸ“‹ è¤‡è£½</button>
  </div>

  <div class="section">
    <h2>æ­¥é©Ÿ 3ï¼šä»£è¾¦äº‹é …åˆ†æ</h2>
    <div id="todos-analysis"></div>
    <button onclick="copyToClipboard('todos-analysis')">ğŸ“‹ è¤‡è£½</button>
  </div>

  <div class="section">
    <h2>æ­¥é©Ÿ 4ï¼šå¯è¦‹æ€§å•é¡Œè¨ºæ–·</h2>
    <div id="visibility-issues"></div>
  </div>

  <div class="section">
    <h2>ğŸ”§ ä¿®å¾©å·¥å…·</h2>
    <button onclick="fixAllVisibility()">ä¿®å¾©æ‰€æœ‰ä»£è¾¦äº‹é …çš„å¯è¦‹æ€§</button>
    <button onclick="clearAndReload()">æ¸…ç©ºè³‡æ–™é‡æ–°åŒæ­¥</button>
    <button onclick="location.reload()">ğŸ”„ é‡æ–°æª¢æŸ¥</button>
  </div>

  <script>
    const DB_NAME = 'VenturoOfflineDB';

    function copyToClipboard(elementId) {
      const element = document.getElementById(elementId);
      const text = element.innerText;
      navigator.clipboard.writeText(text).then(() => {
        alert('å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
      });
    }

    async function openDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME);
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
      });
    }

    async function getAllFromStore(storeName) {
      try {
        const db = await openDB();
        return new Promise((resolve, reject) => {
          const tx = db.transaction(storeName, 'readonly');
          const store = tx.objectStore(storeName);
          const request = store.getAll();
          request.onsuccess = () => resolve(request.result);
          request.onerror = () => reject(request.error);
        });
      } catch (error) {
        console.error(`è®€å– ${storeName} å¤±æ•—:`, error);
        return null;
      }
    }

    async function diagnose() {
      console.log('ğŸ” é–‹å§‹è¨ºæ–·...');

      // === æ­¥é©Ÿ 1ï¼šæª¢æŸ¥ç™»å…¥ç‹€æ…‹ ===
      let currentUserId = null;
      let currentUserName = null;
      let authSource = null;

      const authStore = localStorage.getItem('auth-store');
      const localAuthStore = localStorage.getItem('local-auth-store');

      let authHtml = '<table>';
      authHtml += '<tr><th>å„²å­˜ä½ç½®</th><th>ç‹€æ…‹</th><th>å…§å®¹</th></tr>';

      if (authStore) {
        try {
          const parsed = JSON.parse(authStore);
          currentUserId = parsed.state?.user?.id;
          currentUserName = parsed.state?.user?.display_name;
          authSource = 'auth-store';
          authHtml += `<tr><td>auth-store</td><td class="success">âœ“ æœ‰è³‡æ–™</td><td>`;
          authHtml += `User ID: ${currentUserId || '<span class="error-text">ç¼ºå¤±</span>'}<br>`;
          authHtml += `Name: ${currentUserName || '<span class="error-text">ç¼ºå¤±</span>'}<br>`;
          authHtml += `Workspace ID: ${parsed.state?.user?.workspace_id || '<span class="error-text">ç¼ºå¤±</span>'}`;
          authHtml += `</td></tr>`;
        } catch (e) {
          authHtml += `<tr><td>auth-store</td><td class="error-text">âœ— è§£æå¤±æ•—</td><td>${e.message}</td></tr>`;
        }
      } else {
        authHtml += `<tr><td>auth-store</td><td class="error-text">âœ— ç„¡è³‡æ–™</td><td>-</td></tr>`;
      }

      if (localAuthStore) {
        try {
          const parsed = JSON.parse(localAuthStore);
          if (!currentUserId) {
            currentUserId = parsed.state?.currentProfile?.id;
            currentUserName = parsed.state?.currentProfile?.name;
            authSource = 'local-auth-store';
          }
          authHtml += `<tr><td>local-auth-store</td><td class="success">âœ“ æœ‰è³‡æ–™</td><td>`;
          authHtml += `Profile ID: ${parsed.state?.currentProfile?.id || 'ç„¡'}<br>`;
          authHtml += `Name: ${parsed.state?.currentProfile?.name || 'ç„¡'}`;
          authHtml += `</td></tr>`;
        } catch (e) {
          authHtml += `<tr><td>local-auth-store</td><td class="error-text">âœ— è§£æå¤±æ•—</td><td>${e.message}</td></tr>`;
        }
      } else {
        authHtml += `<tr><td>local-auth-store</td><td class="error-text">âœ— ç„¡è³‡æ–™</td><td>-</td></tr>`;
      }

      authHtml += '</table>';

      if (currentUserId) {
        authHtml += `<pre class="success">âœ… ç•¶å‰ç™»å…¥ç”¨æˆ¶\nID: ${currentUserId}\nåç¨±: ${currentUserName}\nä¾†æº: ${authSource}</pre>`;
      } else {
        authHtml += `<pre class="error-text">âŒ æ‰¾ä¸åˆ°ç™»å…¥ç”¨æˆ¶ï¼é€™æ˜¯ä¸»è¦å•é¡Œã€‚</pre>`;
      }

      document.getElementById('auth-status').innerHTML = authHtml;

      // === æ­¥é©Ÿ 2ï¼šæª¢æŸ¥ IndexedDB ===
      let dbHtml = '<table>';
      dbHtml += '<tr><th>è³‡æ–™è¡¨</th><th>æ•¸é‡</th><th>ç‹€æ…‹</th></tr>';

      const employees = await getAllFromStore('employees');
      const todos = await getAllFromStore('todos');

      dbHtml += `<tr><td>employees</td><td>${employees?.length || 0}</td><td>${employees ? '<span class="success">âœ“</span>' : '<span class="error-text">âœ— è®€å–å¤±æ•—</span>'}</td></tr>`;
      dbHtml += `<tr><td>todos</td><td>${todos?.length || 0}</td><td>${todos ? '<span class="success">âœ“</span>' : '<span class="error-text">âœ— è®€å–å¤±æ•—</span>'}</td></tr>`;
      dbHtml += '</table>';

      if (!employees || employees.length === 0) {
        dbHtml += '<pre class="error-text">âŒ IndexedDB ä¸­æ²’æœ‰å“¡å·¥è³‡æ–™ï¼å¯èƒ½å°šæœªåŒæ­¥ã€‚</pre>';
      }

      if (!todos || todos.length === 0) {
        dbHtml += '<pre class="error-text">âŒ IndexedDB ä¸­æ²’æœ‰ä»£è¾¦äº‹é …ï¼å¯èƒ½å°šæœªåŒæ­¥ã€‚</pre>';
      }

      document.getElementById('db-status').innerHTML = dbHtml;

      // === æ­¥é©Ÿ 3ï¼šåˆ†æä»£è¾¦äº‹é … ===
      if (!todos || !currentUserId) {
        document.getElementById('todos-analysis').innerHTML = '<pre class="error-text">ç„¡æ³•åˆ†æï¼ˆç¼ºå°‘è³‡æ–™ï¼‰</pre>';
        document.getElementById('visibility-issues').innerHTML = '<pre class="error-text">ç„¡æ³•è¨ºæ–·ï¼ˆç¼ºå°‘è³‡æ–™ï¼‰</pre>';
        return;
      }

      const activeTodos = todos.filter(t => !t._deleted);
      const visibleTodos = [];
      const invisibleTodos = [];

      activeTodos.forEach(todo => {
        const isCreator = todo.creator === currentUserId;
        const isAssignee = todo.assignee === currentUserId;
        const inVisibility = todo.visibility?.includes(currentUserId);

        if (isCreator || isAssignee || inVisibility) {
          visibleTodos.push(todo);
        } else {
          invisibleTodos.push({
            ...todo,
            reason: `Creator: ${todo.creator} (${isCreator ? 'âœ“' : 'âœ—'})\nAssignee: ${todo.assignee || 'ç„¡'} (${isAssignee ? 'âœ“' : 'âœ—'})\nVisibility: ${JSON.stringify(todo.visibility)} (${inVisibility ? 'âœ“' : 'âœ—'})`
          });
        }
      });

      let analysisHtml = `<pre>`;
      analysisHtml += `ç¸½ä»£è¾¦äº‹é …: ${activeTodos.length}\n`;
      analysisHtml += `<span class="success">å¯è¦‹: ${visibleTodos.length}</span>\n`;
      analysisHtml += `<span class="error-text">ä¸å¯è¦‹: ${invisibleTodos.length}</span>\n`;
      analysisHtml += `</pre>`;

      if (visibleTodos.length > 0) {
        analysisHtml += '<h3 class="success">âœ… å¯è¦‹çš„ä»£è¾¦äº‹é …</h3>';
        visibleTodos.slice(0, 10).forEach(todo => {
          analysisHtml += `<div class="todo-item">`;
          analysisHtml += `<strong>${todo.title}</strong> (${todo.status})<br>`;
          analysisHtml += `<small>Created: ${new Date(todo.created_at).toLocaleString()}</small>`;
          analysisHtml += `</div>`;
        });
        if (visibleTodos.length > 10) {
          analysisHtml += `<p>... é‚„æœ‰ ${visibleTodos.length - 10} å€‹</p>`;
        }
      }

      document.getElementById('todos-analysis').innerHTML = analysisHtml;

      // === æ­¥é©Ÿ 4ï¼šå¯è¦‹æ€§å•é¡Œ ===
      let issuesHtml = '';

      if (invisibleTodos.length === 0) {
        issuesHtml = '<pre class="success">âœ… æ²’æœ‰å¯è¦‹æ€§å•é¡Œï¼æ‰€æœ‰ä»£è¾¦äº‹é …éƒ½æ­£å¸¸é¡¯ç¤ºã€‚</pre>';
      } else {
        issuesHtml = `<pre class="error-text">âŒ ç™¼ç¾ ${invisibleTodos.length} å€‹ä»£è¾¦äº‹é …çœ‹ä¸åˆ°ï¼</pre>`;
        issuesHtml += '<h3>ä¸å¯è¦‹çš„ä»£è¾¦äº‹é …ï¼š</h3>';

        invisibleTodos.forEach(todo => {
          issuesHtml += `<div class="todo-item invisible">`;
          issuesHtml += `<strong>${todo.title}</strong> (${todo.status})<br>`;
          issuesHtml += `<pre>${todo.reason}</pre>`;
          issuesHtml += `<small>ä½ çš„ User ID: ${currentUserId}</small>`;
          issuesHtml += `</div>`;
        });

        issuesHtml += `<h3>ğŸ”§ å•é¡ŒåŸå› èˆ‡è§£æ±ºæ–¹æ¡ˆï¼š</h3>`;
        issuesHtml += `<pre>`;
        issuesHtml += `å•é¡Œï¼šä»£è¾¦äº‹é …çš„ visibility åˆ—è¡¨ä¸åŒ…å«ä½ çš„ user_id\n\n`;
        issuesHtml += `è§£æ±ºæ–¹æ¡ˆï¼š\n`;
        issuesHtml += `1. é»æ“Šä¸Šæ–¹ã€Œä¿®å¾©æ‰€æœ‰ä»£è¾¦äº‹é …çš„å¯è¦‹æ€§ã€æŒ‰éˆ•\n`;
        issuesHtml += `2. æˆ–åŸ·è¡Œä»¥ä¸‹ SQLï¼ˆéœ€è¦è³‡æ–™åº«æ¬Šé™ï¼‰ï¼š\n\n`;
        issuesHtml += `UPDATE todos\nSET visibility = array_append(visibility, '${currentUserId}')\nWHERE NOT (visibility @> ARRAY['${currentUserId}']::uuid[]);`;
        issuesHtml += `</pre>`;
      }

      document.getElementById('visibility-issues').innerHTML = issuesHtml;
    }

    async function fixAllVisibility() {
      if (!confirm('ç¢ºå®šè¦ä¿®å¾©æ‰€æœ‰ä»£è¾¦äº‹é …çš„å¯è¦‹æ€§å—ï¼Ÿ')) return;

      const authStore = localStorage.getItem('auth-store');
      if (!authStore) {
        alert('æ‰¾ä¸åˆ°ç™»å…¥è³‡è¨Šï¼');
        return;
      }

      const parsed = JSON.parse(authStore);
      const currentUserId = parsed.state?.user?.id;
      if (!currentUserId) {
        alert('æ‰¾ä¸åˆ° user.idï¼');
        return;
      }

      try {
        const db = await openDB();
        const tx = db.transaction('todos', 'readwrite');
        const store = tx.objectStore('todos');
        const allTodos = await store.getAll();

        let fixed = 0;
        for (const todo of allTodos) {
          if (!todo.visibility) {
            todo.visibility = [currentUserId];
            await store.put(todo);
            fixed++;
          } else if (!todo.visibility.includes(currentUserId)) {
            todo.visibility.push(currentUserId);
            await store.put(todo);
            fixed++;
          }
        }

        alert(`âœ… å·²ä¿®å¾© ${fixed} å€‹ä»£è¾¦äº‹é …ï¼\n\nè«‹é‡æ–°æ•´ç†ä»£è¾¦äº‹é …é é¢ã€‚`);
        location.reload();

      } catch (error) {
        console.error('ä¿®å¾©å¤±æ•—:', error);
        alert('ä¿®å¾©å¤±æ•—: ' + error.message);
      }
    }

    async function clearAndReload() {
      if (!confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰æœ¬åœ°è³‡æ–™ä¸¦é‡æ–°åŒæ­¥å—ï¼Ÿ\n\né€™æœƒç™»å‡ºä¸¦è¦æ±‚é‡æ–°ç™»å…¥ã€‚')) return;

      try {
        localStorage.clear();
        await indexedDB.deleteDatabase(DB_NAME);
        alert('âœ… å·²æ¸…ç©ºæœ¬åœ°è³‡æ–™ï¼\n\nå³å°‡è·³è½‰åˆ°ç™»å…¥é ...');
        location.href = '/login';
      } catch (error) {
        alert('æ¸…ç©ºå¤±æ•—: ' + error.message);
      }
    }

    // é é¢è¼‰å…¥æ™‚åŸ·è¡Œè¨ºæ–·
    diagnose();
  </script>
</body>
</html>
