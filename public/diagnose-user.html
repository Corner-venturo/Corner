<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>診斷用戶和員工資料</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      max-width: 900px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      margin-bottom: 20px;
    }
    button {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 15px 30px;
      font-size: 16px;
      border-radius: 5px;
      cursor: pointer;
      margin: 10px 5px;
    }
    button:hover {
      background: #2563eb;
    }
    button.success {
      background: #10b981;
    }
    button.success:hover {
      background: #059669;
    }
    .section {
      margin: 20px 0;
      padding: 15px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 5px;
    }
    .section h2 {
      margin-top: 0;
      color: #1f2937;
      font-size: 18px;
    }
    pre {
      background: #1f2937;
      color: #e5e7eb;
      padding: 15px;
      border-radius: 5px;
      overflow-x: auto;
      font-size: 12px;
    }
    .error {
      background: #fee2e2;
      color: #991b1b;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
    }
    .success {
      background: #dcfce7;
      color: #166534;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
    }
    .warning {
      background: #fef3c7;
      color: #92400e;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>🔍 診斷用戶和員工資料</h1>

    <button onclick="diagnoseAll()">🚀 開始完整診斷</button>
    <button onclick="createEmployeeForUser()" class="success">✨ 為當前用戶建立員工資料</button>

    <div id="results"></div>
  </div>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

    const SUPABASE_URL = 'https://pfqvdacxowpgfamuvnsn.supabase.co'
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBmcXZkYWN4b3dwZ2ZhbXV2bnNuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxMDgzMjAsImV4cCI6MjA3NDY4NDMyMH0.LIMG0qmHixTPcbdzJrh4h0yTp8mh3FlggeZ6Bi_NwtI'

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

    function log(title, data, type = 'info') {
      const resultsDiv = document.getElementById('results')
      const section = document.createElement('div')
      section.className = 'section'

      const heading = document.createElement('h2')
      heading.textContent = title
      section.appendChild(heading)

      if (type === 'error') {
        const errorDiv = document.createElement('div')
        errorDiv.className = 'error'
        errorDiv.textContent = typeof data === 'string' ? data : JSON.stringify(data, null, 2)
        section.appendChild(errorDiv)
      } else if (type === 'success') {
        const successDiv = document.createElement('div')
        successDiv.className = 'success'
        successDiv.textContent = typeof data === 'string' ? data : JSON.stringify(data, null, 2)
        section.appendChild(successDiv)
      } else if (type === 'warning') {
        const warningDiv = document.createElement('div')
        warningDiv.className = 'warning'
        warningDiv.textContent = typeof data === 'string' ? data : JSON.stringify(data, null, 2)
        section.appendChild(warningDiv)
      } else {
        const pre = document.createElement('pre')
        pre.textContent = JSON.stringify(data, null, 2)
        section.appendChild(pre)
      }

      resultsDiv.appendChild(section)
    }

    async function diagnoseAll() {
      document.getElementById('results').innerHTML = ''

      try {
        // 1. 檢查當前用戶
        log('1️⃣ 檢查當前登入用戶', '正在查詢...', 'info')
        const { data: { user }, error: userError } = await supabase.auth.getUser()

        if (userError) {
          log('❌ 用戶查詢失敗', userError, 'error')
          return
        }

        if (!user) {
          log('⚠️ 未登入', '請先登入系統', 'warning')
          return
        }

        log('✅ 當前用戶資訊', {
          id: user.id,
          email: user.email,
          user_metadata: user.user_metadata
        }, 'success')

        // 2. 檢查 employees 表格中是否有對應的員工
        log('2️⃣ 查詢 employees 表格', '正在查詢...', 'info')
        const { data: employees, error: empError } = await supabase
          .from('employees')
          .select('*')
          .eq('email', user.email)

        if (empError) {
          log('❌ 查詢員工失敗', empError, 'error')
        } else if (employees && employees.length > 0) {
          log('✅ 找到員工資料', employees[0], 'success')
          window.currentEmployee = employees[0]
        } else {
          log('⚠️ 未找到員工資料', `email: ${user.email} 沒有對應的員工記錄`, 'warning')
        }

        // 3. 查詢所有員工（檢查表格是否有資料）
        log('3️⃣ 查詢所有員工', '正在查詢...', 'info')
        const { data: allEmployees, error: allEmpError, count } = await supabase
          .from('employees')
          .select('id, employee_number, english_name, display_name, email, status', { count: 'exact' })
          .limit(10)

        if (allEmpError) {
          log('❌ 查詢所有員工失敗', allEmpError, 'error')
        } else {
          log(`✅ 員工表格共有 ${count} 筆資料`, allEmployees, 'success')
        }

        // 4. 檢查 user_metadata 是否有 employee_id
        log('4️⃣ 檢查 user_metadata', '檢查中...', 'info')
        if (user.user_metadata && user.user_metadata.employee_id) {
          log('✅ user_metadata 有 employee_id', {
            employee_id: user.user_metadata.employee_id
          }, 'success')

          // 驗證這個 employee_id 是否存在
          const { data: linkedEmployee, error: linkedError } = await supabase
            .from('employees')
            .select('*')
            .eq('id', user.user_metadata.employee_id)
            .single()

          if (linkedError) {
            log('⚠️ employee_id 無效', `employee_id ${user.user_metadata.employee_id} 在 employees 表格中不存在`, 'warning')
          } else {
            log('✅ employee_id 有效', linkedEmployee, 'success')
          }
        } else {
          log('⚠️ user_metadata 沒有 employee_id', '需要建立員工資料並關聯', 'warning')
        }

        // 5. 儲存當前用戶以供後續使用
        window.currentUser = user

      } catch (error) {
        log('❌ 診斷過程發生錯誤', error.message, 'error')
      }
    }

    async function createEmployeeForUser() {
      if (!window.currentUser) {
        alert('請先執行診斷以載入用戶資料')
        return
      }

      const user = window.currentUser

      try {
        log('🔨 為用戶建立員工資料', `email: ${user.email}`, 'info')

        // 生成員工編號
        const englishName = prompt('請輸入英文名稱 (例如: william):', user.email.split('@')[0])
        if (!englishName) return

        const displayName = prompt('請輸入顯示名稱 (例如: William):', englishName.charAt(0).toUpperCase() + englishName.slice(1))
        if (!displayName) return

        // 建立員工
        const { data: newEmployee, error: createError } = await supabase
          .from('employees')
          .insert({
            email: user.email,
            english_name: englishName.toLowerCase(),
            display_name: displayName,
            employee_number: `${englishName.toLowerCase()}01`,
            status: 'active',
            permissions: ['READ_ALL', 'WRITE_OWN'],
            salary_info: {
              base_salary: 0,
              allowances: [],
              salary_history: []
            },
            attendance: {
              leave_records: [],
              overtime_records: []
            },
            contracts: []
          })
          .select()
          .single()

        if (createError) {
          log('❌ 建立員工失敗', createError, 'error')
          return
        }

        log('✅ 員工建立成功', newEmployee, 'success')

        // 更新 user_metadata
        log('🔗 更新 user_metadata', '正在關聯員工資料...', 'info')
        const { error: updateError } = await supabase.auth.updateUser({
          data: { employee_id: newEmployee.id }
        })

        if (updateError) {
          log('⚠️ 更新 user_metadata 失敗', updateError, 'warning')
          log('📝 手動更新說明', '請在 Supabase Dashboard 的 Authentication > Users 中手動更新 user_metadata', 'info')
        } else {
          log('✅ user_metadata 更新成功', { employee_id: newEmployee.id }, 'success')
        }

        alert('✅ 員工資料建立完成！請重新整理頁面並測試建立頻道。')

      } catch (error) {
        log('❌ 建立過程發生錯誤', error.message, 'error')
      }
    }

    // 匯出到全域
    window.diagnoseAll = diagnoseAll
    window.createEmployeeForUser = createEmployeeForUser
    window.supabase = supabase
  </script>
</body>
</html>
