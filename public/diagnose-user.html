<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>è¨ºæ–·ç”¨æˆ¶å’Œå“¡å·¥è³‡æ–™</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      max-width: 900px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      margin-bottom: 20px;
    }
    button {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 15px 30px;
      font-size: 16px;
      border-radius: 5px;
      cursor: pointer;
      margin: 10px 5px;
    }
    button:hover {
      background: #2563eb;
    }
    button.success {
      background: #10b981;
    }
    button.success:hover {
      background: #059669;
    }
    .section {
      margin: 20px 0;
      padding: 15px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 5px;
    }
    .section h2 {
      margin-top: 0;
      color: #1f2937;
      font-size: 18px;
    }
    pre {
      background: #1f2937;
      color: #e5e7eb;
      padding: 15px;
      border-radius: 5px;
      overflow-x: auto;
      font-size: 12px;
    }
    .error {
      background: #fee2e2;
      color: #991b1b;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
    }
    .success {
      background: #dcfce7;
      color: #166534;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
    }
    .warning {
      background: #fef3c7;
      color: #92400e;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ” è¨ºæ–·ç”¨æˆ¶å’Œå“¡å·¥è³‡æ–™</h1>

    <button onclick="diagnoseAll()">ğŸš€ é–‹å§‹å®Œæ•´è¨ºæ–·</button>
    <button onclick="createEmployeeForUser()" class="success">âœ¨ ç‚ºç•¶å‰ç”¨æˆ¶å»ºç«‹å“¡å·¥è³‡æ–™</button>

    <div id="results"></div>
  </div>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

    const SUPABASE_URL = 'https://pfqvdacxowpgfamuvnsn.supabase.co'
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBmcXZkYWN4b3dwZ2ZhbXV2bnNuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxMDgzMjAsImV4cCI6MjA3NDY4NDMyMH0.LIMG0qmHixTPcbdzJrh4h0yTp8mh3FlggeZ6Bi_NwtI'

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

    function log(title, data, type = 'info') {
      const resultsDiv = document.getElementById('results')
      const section = document.createElement('div')
      section.className = 'section'

      const heading = document.createElement('h2')
      heading.textContent = title
      section.appendChild(heading)

      if (type === 'error') {
        const errorDiv = document.createElement('div')
        errorDiv.className = 'error'
        errorDiv.textContent = typeof data === 'string' ? data : JSON.stringify(data, null, 2)
        section.appendChild(errorDiv)
      } else if (type === 'success') {
        const successDiv = document.createElement('div')
        successDiv.className = 'success'
        successDiv.textContent = typeof data === 'string' ? data : JSON.stringify(data, null, 2)
        section.appendChild(successDiv)
      } else if (type === 'warning') {
        const warningDiv = document.createElement('div')
        warningDiv.className = 'warning'
        warningDiv.textContent = typeof data === 'string' ? data : JSON.stringify(data, null, 2)
        section.appendChild(warningDiv)
      } else {
        const pre = document.createElement('pre')
        pre.textContent = JSON.stringify(data, null, 2)
        section.appendChild(pre)
      }

      resultsDiv.appendChild(section)
    }

    async function diagnoseAll() {
      document.getElementById('results').innerHTML = ''

      try {
        // 1. æª¢æŸ¥ç•¶å‰ç”¨æˆ¶
        log('1ï¸âƒ£ æª¢æŸ¥ç•¶å‰ç™»å…¥ç”¨æˆ¶', 'æ­£åœ¨æŸ¥è©¢...', 'info')
        const { data: { user }, error: userError } = await supabase.auth.getUser()

        if (userError) {
          log('âŒ ç”¨æˆ¶æŸ¥è©¢å¤±æ•—', userError, 'error')
          return
        }

        if (!user) {
          log('âš ï¸ æœªç™»å…¥', 'è«‹å…ˆç™»å…¥ç³»çµ±', 'warning')
          return
        }

        log('âœ… ç•¶å‰ç”¨æˆ¶è³‡è¨Š', {
          id: user.id,
          email: user.email,
          user_metadata: user.user_metadata
        }, 'success')

        // 2. æª¢æŸ¥ employees è¡¨æ ¼ä¸­æ˜¯å¦æœ‰å°æ‡‰çš„å“¡å·¥
        log('2ï¸âƒ£ æŸ¥è©¢ employees è¡¨æ ¼', 'æ­£åœ¨æŸ¥è©¢...', 'info')
        const { data: employees, error: empError } = await supabase
          .from('employees')
          .select('*')
          .eq('email', user.email)

        if (empError) {
          log('âŒ æŸ¥è©¢å“¡å·¥å¤±æ•—', empError, 'error')
        } else if (employees && employees.length > 0) {
          log('âœ… æ‰¾åˆ°å“¡å·¥è³‡æ–™', employees[0], 'success')
          window.currentEmployee = employees[0]
        } else {
          log('âš ï¸ æœªæ‰¾åˆ°å“¡å·¥è³‡æ–™', `email: ${user.email} æ²’æœ‰å°æ‡‰çš„å“¡å·¥è¨˜éŒ„`, 'warning')
        }

        // 3. æŸ¥è©¢æ‰€æœ‰å“¡å·¥ï¼ˆæª¢æŸ¥è¡¨æ ¼æ˜¯å¦æœ‰è³‡æ–™ï¼‰
        log('3ï¸âƒ£ æŸ¥è©¢æ‰€æœ‰å“¡å·¥', 'æ­£åœ¨æŸ¥è©¢...', 'info')
        const { data: allEmployees, error: allEmpError, count } = await supabase
          .from('employees')
          .select('id, employee_number, english_name, display_name, email, status', { count: 'exact' })
          .limit(10)

        if (allEmpError) {
          log('âŒ æŸ¥è©¢æ‰€æœ‰å“¡å·¥å¤±æ•—', allEmpError, 'error')
        } else {
          log(`âœ… å“¡å·¥è¡¨æ ¼å…±æœ‰ ${count} ç­†è³‡æ–™`, allEmployees, 'success')
        }

        // 4. æª¢æŸ¥ user_metadata æ˜¯å¦æœ‰ employee_id
        log('4ï¸âƒ£ æª¢æŸ¥ user_metadata', 'æª¢æŸ¥ä¸­...', 'info')
        if (user.user_metadata && user.user_metadata.employee_id) {
          log('âœ… user_metadata æœ‰ employee_id', {
            employee_id: user.user_metadata.employee_id
          }, 'success')

          // é©—è­‰é€™å€‹ employee_id æ˜¯å¦å­˜åœ¨
          const { data: linkedEmployee, error: linkedError } = await supabase
            .from('employees')
            .select('*')
            .eq('id', user.user_metadata.employee_id)
            .single()

          if (linkedError) {
            log('âš ï¸ employee_id ç„¡æ•ˆ', `employee_id ${user.user_metadata.employee_id} åœ¨ employees è¡¨æ ¼ä¸­ä¸å­˜åœ¨`, 'warning')
          } else {
            log('âœ… employee_id æœ‰æ•ˆ', linkedEmployee, 'success')
          }
        } else {
          log('âš ï¸ user_metadata æ²’æœ‰ employee_id', 'éœ€è¦å»ºç«‹å“¡å·¥è³‡æ–™ä¸¦é—œè¯', 'warning')
        }

        // 5. å„²å­˜ç•¶å‰ç”¨æˆ¶ä»¥ä¾›å¾ŒçºŒä½¿ç”¨
        window.currentUser = user

      } catch (error) {
        log('âŒ è¨ºæ–·éç¨‹ç™¼ç”ŸéŒ¯èª¤', error.message, 'error')
      }
    }

    async function createEmployeeForUser() {
      if (!window.currentUser) {
        alert('è«‹å…ˆåŸ·è¡Œè¨ºæ–·ä»¥è¼‰å…¥ç”¨æˆ¶è³‡æ–™')
        return
      }

      const user = window.currentUser

      try {
        log('ğŸ”¨ ç‚ºç”¨æˆ¶å»ºç«‹å“¡å·¥è³‡æ–™', `email: ${user.email}`, 'info')

        // ç”Ÿæˆå“¡å·¥ç·¨è™Ÿ
        const englishName = prompt('è«‹è¼¸å…¥è‹±æ–‡åç¨± (ä¾‹å¦‚: william):', user.email.split('@')[0])
        if (!englishName) return

        const displayName = prompt('è«‹è¼¸å…¥é¡¯ç¤ºåç¨± (ä¾‹å¦‚: William):', englishName.charAt(0).toUpperCase() + englishName.slice(1))
        if (!displayName) return

        // å»ºç«‹å“¡å·¥
        const { data: newEmployee, error: createError } = await supabase
          .from('employees')
          .insert({
            email: user.email,
            english_name: englishName.toLowerCase(),
            display_name: displayName,
            employee_number: `${englishName.toLowerCase()}01`,
            status: 'active',
            permissions: ['READ_ALL', 'WRITE_OWN'],
            salary_info: {
              base_salary: 0,
              allowances: [],
              salary_history: []
            },
            attendance: {
              leave_records: [],
              overtime_records: []
            },
            contracts: []
          })
          .select()
          .single()

        if (createError) {
          log('âŒ å»ºç«‹å“¡å·¥å¤±æ•—', createError, 'error')
          return
        }

        log('âœ… å“¡å·¥å»ºç«‹æˆåŠŸ', newEmployee, 'success')

        // æ›´æ–° user_metadata
        log('ğŸ”— æ›´æ–° user_metadata', 'æ­£åœ¨é—œè¯å“¡å·¥è³‡æ–™...', 'info')
        const { error: updateError } = await supabase.auth.updateUser({
          data: { employee_id: newEmployee.id }
        })

        if (updateError) {
          log('âš ï¸ æ›´æ–° user_metadata å¤±æ•—', updateError, 'warning')
          log('ğŸ“ æ‰‹å‹•æ›´æ–°èªªæ˜', 'è«‹åœ¨ Supabase Dashboard çš„ Authentication > Users ä¸­æ‰‹å‹•æ›´æ–° user_metadata', 'info')
        } else {
          log('âœ… user_metadata æ›´æ–°æˆåŠŸ', { employee_id: newEmployee.id }, 'success')
        }

        alert('âœ… å“¡å·¥è³‡æ–™å»ºç«‹å®Œæˆï¼è«‹é‡æ–°æ•´ç†é é¢ä¸¦æ¸¬è©¦å»ºç«‹é »é“ã€‚')

      } catch (error) {
        log('âŒ å»ºç«‹éç¨‹ç™¼ç”ŸéŒ¯èª¤', error.message, 'error')
      }
    }

    // åŒ¯å‡ºåˆ°å…¨åŸŸ
    window.diagnoseAll = diagnoseAll
    window.createEmployeeForUser = createEmployeeForUser
    window.supabase = supabase
  </script>
</body>
</html>
