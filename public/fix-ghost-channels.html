<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ”¥ ç·Šæ€¥ä¿®å¾©ï¼šæ¸…é™¤å¹½éˆé »é“</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 700px;
      margin: 50px auto;
      padding: 20px;
      background: #1a1a1a;
      color: #fff;
    }
    .card {
      background: #2a2a2a;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.3);
    }
    h1 {
      color: #ff6b6b;
      margin-top: 0;
    }
    button {
      background: #ff6b6b;
      color: white;
      border: none;
      padding: 14px 28px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      margin-top: 20px;
      width: 100%;
    }
    button:hover {
      background: #ff5252;
    }
    button:disabled {
      background: #555;
      cursor: not-allowed;
    }
    .success {
      background: #2a7a2a;
      color: white;
      padding: 16px;
      border-radius: 6px;
      margin-top: 20px;
    }
    .error {
      background: #7a2a2a;
      color: white;
      padding: 16px;
      border-radius: 6px;
      margin-top: 20px;
    }
    .info {
      background: #2a4a7a;
      color: white;
      padding: 16px;
      border-radius: 6px;
      margin-bottom: 20px;
    }
    pre {
      background: #1a1a1a;
      padding: 12px;
      border-radius: 6px;
      overflow-x: auto;
      font-size: 12px;
    }
    .warning {
      background: #7a5a2a;
      color: white;
      padding: 16px;
      border-radius: 6px;
      margin: 20px 0;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>ğŸ”¥ ç·Šæ€¥ä¿®å¾©ï¼šæ¸…é™¤å¹½éˆé »é“</h1>

    <div class="info">
      <strong>å•é¡Œç¾è±¡ï¼š</strong>
      <ul style="margin: 10px 0 0 0; padding-left: 20px;">
        <li>å·¥ä½œç©ºé–“é é¢ç„¡æ³•è¼‰å…¥æˆ–å¡ä½</li>
        <li>é »é“é‡è¤‡é¡¯ç¤º</li>
        <li>Console å‡ºç¾å¤§é‡ 500 éŒ¯èª¤</li>
      </ul>
    </div>

    <div class="warning">
      <strong>âš ï¸ æ­¤å·¥å…·æœƒåšä»¥ä¸‹æ“ä½œï¼š</strong>
      <ol style="margin: 10px 0 0 0; padding-left: 20px;">
        <li>æ¸…ç©º localStorage çš„æ‰€æœ‰ channels</li>
        <li>æ¸…ç©º IndexedDB çš„æ‰€æœ‰ channels</li>
        <li>æ¸…ç©º localStorage çš„ channelGroups å’Œ bulletins</li>
        <li>è‡ªå‹•é‡æ–°è¼‰å…¥é é¢</li>
      </ol>
      <p style="margin-top: 10px;"><strong>é‡è¦ï¼š</strong>ä¸‹æ¬¡é–‹å•Ÿå·¥ä½œç©ºé–“æ™‚ï¼Œæœƒå¾ Supabase é‡æ–°åŒæ­¥æ­£ç¢ºçš„è³‡æ–™ã€‚</p>
    </div>

    <button id="fixBtn" onclick="emergencyFix()">ğŸš¨ ç«‹å³ä¿®å¾©</button>

    <div id="result"></div>
  </div>

  <script>
    async function emergencyFix() {
      const btn = document.getElementById('fixBtn');
      const result = document.getElementById('result');

      btn.disabled = true;
      btn.textContent = 'ä¿®å¾©ä¸­...';

      try {
        // Step 1: æ¸…ç† localStorage
        console.log('ğŸ”§ Step 1: æ¸…ç† localStorage...');
        const storageKey = 'channels-storage';
        const rawData = localStorage.getItem(storageKey);

        let before = { channels: 0, channelGroups: 0, bulletins: 0 };

        if (rawData) {
          const data = JSON.parse(rawData);
          before = {
            channels: data.state?.channels?.length || 0,
            channelGroups: data.state?.channelGroups?.length || 0,
            bulletins: data.state?.bulletins?.length || 0
          };

          // æ¸…ç©ºæ‰€æœ‰é »é“ç›¸é—œè³‡æ–™
          const cleaned = {
            state: {
              workspaces: data.state?.workspaces || [],
              currentWorkspace: data.state?.currentWorkspace || null,
              selectedChannel: null,
              channels: [],
              channelGroups: [],
              bulletins: [],
              loading: false,
              error: null,
              searchQuery: '',
              channelFilter: 'all'
            },
            version: data.version || 0
          };

          localStorage.setItem(storageKey, JSON.stringify(cleaned));
          console.log('âœ… localStorage å·²æ¸…ç†');
        }

        // Step 2: æ¸…ç† IndexedDB
        console.log('ğŸ”§ Step 2: æ¸…ç† IndexedDB...');
        const dbName = 'local-db';
        const dbPromise = indexedDB.open(dbName);

        await new Promise((resolve, reject) => {
          dbPromise.onsuccess = async (event) => {
            try {
              const db = event.target.result;

              // æ¸…ç©º channels è¡¨
              if (db.objectStoreNames.contains('channels')) {
                const transaction = db.transaction(['channels'], 'readwrite');
                const store = transaction.objectStore('channels');
                const clearRequest = store.clear();

                clearRequest.onsuccess = () => {
                  console.log('âœ… IndexedDB channels å·²æ¸…ç†');
                };
              }

              // æ¸…ç©º channel_groups è¡¨
              if (db.objectStoreNames.contains('channel_groups')) {
                const transaction = db.transaction(['channel_groups'], 'readwrite');
                const store = transaction.objectStore('channel_groups');
                store.clear();
                console.log('âœ… IndexedDB channel_groups å·²æ¸…ç†');
              }

              db.close();
              resolve();
            } catch (err) {
              reject(err);
            }
          };

          dbPromise.onerror = () => {
            console.warn('âš ï¸ ç„¡æ³•é–‹å•Ÿ IndexedDBï¼Œè·³é');
            resolve(); // ç¹¼çºŒåŸ·è¡Œ
          };
        });

        result.innerHTML = `
          <div class="success">
            <strong>âœ… ä¿®å¾©å®Œæˆï¼</strong>
            <pre style="background: rgba(255,255,255,0.1); margin-top: 10px;">æ¸…ç†å‰ï¼š
- localStorage channels: ${before.channels} å€‹
- localStorage channelGroups: ${before.channelGroups} å€‹
- localStorage bulletins: ${before.bulletins} å€‹
- IndexedDB channels: å·²æ¸…ç©º
- IndexedDB channel_groups: å·²æ¸…ç©º

æ¸…ç†å¾Œï¼šå…¨éƒ¨æ¸…ç©º âœ¨</pre>
            <p style="margin-top: 16px; font-size: 14px;">
              <strong>ğŸ“ ä¸‹ä¸€æ­¥ï¼š</strong><br>
              é é¢å°‡åœ¨ 2 ç§’å¾Œè‡ªå‹•é‡æ–°è¼‰å…¥...<br>
              è«‹é‡æ–°é–‹å•Ÿå·¥ä½œç©ºé–“ï¼Œç³»çµ±æœƒå¾ Supabase é‡æ–°åŒæ­¥æ­£ç¢ºçš„è³‡æ–™ã€‚
            </p>
          </div>
        `;

        setTimeout(() => {
          window.location.href = '/workspace';
        }, 2000);

      } catch (error) {
        console.error('ä¿®å¾©å¤±æ•—:', error);
        result.innerHTML = `
          <div class="error">
            <strong>âŒ ä¿®å¾©å¤±æ•—ï¼š</strong><br>${error.message}
            <pre style="background: rgba(255,255,255,0.1); margin-top: 10px;">${error.stack}</pre>
            <p style="margin-top: 10px;">è«‹é‡æ–°æ•´ç†é é¢å¾Œå†è©¦ä¸€æ¬¡ï¼Œæˆ–è¯ç¹«æŠ€è¡“æ”¯æ´ã€‚</p>
          </div>
        `;
        btn.disabled = false;
        btn.textContent = 'ğŸš¨ ç«‹å³ä¿®å¾©';
      }
    }
  </script>
</body>
</html>
