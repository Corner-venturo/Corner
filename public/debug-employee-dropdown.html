<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>Debug å“¡å·¥ä¸‹æ‹‰é¸å–®</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      max-width: 1200px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      border-radius: 8px;
      padding: 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 { color: #C19A6B; margin-bottom: 10px; }
    button {
      background: #C19A6B;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      margin-right: 10px;
      margin-bottom: 20px;
    }
    button:hover { background: #A88555; }
    .section {
      margin-bottom: 30px;
      padding: 20px;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
    }
    .section h2 {
      margin-top: 0;
      color: #333;
      font-size: 18px;
    }
    pre {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 4px;
      overflow-x: auto;
      font-size: 12px;
    }
    .success { color: #28a745; }
    .error { color: #dc3545; }
    .warning { color: #ffc107; }
    .info { color: #17a2b8; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid #dee2e6;
      font-size: 13px;
    }
    th {
      background: #f8f9fa;
      font-weight: 600;
    }
    .badge {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
    }
    .badge-success { background: #d4edda; color: #155724; }
    .badge-danger { background: #f8d7da; color: #721c24; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ› Debug å“¡å·¥ä¸‹æ‹‰é¸å–®</h1>
    <p style="color: #666; margin-bottom: 30px;">ä¸€æ­¥æ­¥æª¢æŸ¥ç‚ºä»€éº¼ä¸‹æ‹‰é¸å–®æ²’æœ‰å“¡å·¥é¸é …</p>

    <button onclick="runDiagnosis()">ğŸ” é–‹å§‹è¨ºæ–·</button>
    <button onclick="fixCommonIssues()">ğŸ”§ å˜—è©¦è‡ªå‹•ä¿®æ­£</button>

    <div id="step1" class="section" style="display:none;">
      <h2>æ­¥é©Ÿ 1ï¸âƒ£ï¼šæª¢æŸ¥ IndexedDB ä¸­çš„å“¡å·¥è³‡æ–™</h2>
      <div id="step1-content"></div>
    </div>

    <div id="step2" class="section" style="display:none;">
      <h2>æ­¥é©Ÿ 2ï¸âƒ£ï¼šæª¢æŸ¥å“¡å·¥è³‡æ–™æ ¼å¼</h2>
      <div id="step2-content"></div>
    </div>

    <div id="step3" class="section" style="display:none;">
      <h2>æ­¥é©Ÿ 3ï¸âƒ£ï¼šæ¨¡æ“¬å‰ç«¯ç¯©é¸é‚è¼¯</h2>
      <div id="step3-content"></div>
    </div>

    <div id="step4" class="section" style="display:none;">
      <h2>æ­¥é©Ÿ 4ï¸âƒ£ï¼šç”Ÿæˆä¸‹æ‹‰é¸å–®é¸é …</h2>
      <div id="step4-content"></div>
    </div>

    <div id="conclusion" class="section" style="display:none;">
      <h2>ğŸ“Š è¨ºæ–·çµæœ</h2>
      <div id="conclusion-content"></div>
    </div>
  </div>

  <script type="module">
    import { openDB } from 'https://cdn.jsdelivr.net/npm/idb@8/+esm';

    let diagnosisResult = {
      totalEmployees: 0,
      validEmployees: 0,
      issues: [],
      employeeData: [],
    };

    window.runDiagnosis = async () => {
      // é¡¯ç¤ºæ‰€æœ‰æ­¥é©Ÿ
      ['step1', 'step2', 'step3', 'step4', 'conclusion'].forEach(id => {
        document.getElementById(id).style.display = 'block';
      });

      try {
        const db = await openDB('VenturoOfflineDB', 1);

        // === æ­¥é©Ÿ 1ï¼šè®€å–å“¡å·¥è³‡æ–™ ===
        const allEmployees = await db.getAll('employees');
        diagnosisResult.totalEmployees = allEmployees.length;
        diagnosisResult.employeeData = allEmployees;

        const step1Content = document.getElementById('step1-content');
        step1Content.innerHTML = `
          <p><strong>æ‰¾åˆ° ${allEmployees.length} ç­†å“¡å·¥è³‡æ–™</strong></p>
          ${allEmployees.length === 0 ? '<p class="error">âŒ æ²’æœ‰å“¡å·¥è³‡æ–™ï¼é€™å°±æ˜¯å•é¡Œæ‰€åœ¨ã€‚</p>' : ''}
        `;

        if (allEmployees.length === 0) {
          diagnosisResult.issues.push('æ²’æœ‰å“¡å·¥è³‡æ–™');
          showConclusion();
          return;
        }

        // === æ­¥é©Ÿ 2ï¼šæª¢æŸ¥è³‡æ–™æ ¼å¼ ===
        const step2Content = document.getElementById('step2-content');
        let formatIssues = [];

        const formatTable = '<table><thead><tr><th>æ¬„ä½</th><th>å¿…è¦æ€§</th><th>ç¼ºå¤±æ•¸é‡</th></tr></thead><tbody>' +
          ['display_name', 'english_name', 'status', '_deleted'].map(field => {
            const missing = allEmployees.filter(emp => !emp[field] && field !== '_deleted').length;
            const isCritical = field === 'display_name' || field === 'english_name';

            if (missing > 0 && isCritical) {
              formatIssues.push(`${missing} ä½å“¡å·¥ç¼ºå°‘ ${field}`);
            }

            return `<tr>
              <td><code>${field}</code></td>
              <td>${isCritical ? 'å¿…è¦' : 'é¸å¡«'}</td>
              <td>${missing > 0 ? `<span class="error">${missing}</span>` : '<span class="success">0</span>'}</td>
            </tr>`;
          }).join('') +
          '</tbody></table>';

        step2Content.innerHTML = formatTable;
        if (formatIssues.length > 0) {
          step2Content.innerHTML += '<p class="warning">âš ï¸ ' + formatIssues.join(', ') + '</p>';
          diagnosisResult.issues.push(...formatIssues);
        }

        // === æ­¥é©Ÿ 3ï¼šæ¨¡æ“¬å‰ç«¯ç¯©é¸ ===
        const step3Content = document.getElementById('step3-content');

        // é€™æ˜¯å‰ç«¯å¯¦éš›çš„ç¯©é¸é‚è¼¯
        const filteredEmployees = allEmployees.filter(emp =>
          !emp._deleted && emp.status !== 'inactive'
        );

        diagnosisResult.validEmployees = filteredEmployees.length;

        let filterResultHTML = `<p><strong>ç¯©é¸çµæœï¼š${filteredEmployees.length} / ${allEmployees.length} ä½å“¡å·¥é€šéç¯©é¸</strong></p>`;

        if (filteredEmployees.length === 0) {
          filterResultHTML += '<p class="error">âŒ æ‰€æœ‰å“¡å·¥éƒ½è¢«ç¯©é¸æ‰äº†ï¼</p>';
          filterResultHTML += '<p>å¯èƒ½åŸå› ï¼š</p><ul>';

          const deletedCount = allEmployees.filter(emp => emp._deleted).length;
          const inactiveCount = allEmployees.filter(emp => emp.status === 'inactive').length;

          if (deletedCount > 0) {
            filterResultHTML += `<li class="error">${deletedCount} ä½å“¡å·¥è¢«æ¨™è¨˜ç‚ºå·²åˆªé™¤ (_deleted = true)</li>`;
            diagnosisResult.issues.push(`${deletedCount} ä½å“¡å·¥è¢«æ¨™è¨˜ç‚ºå·²åˆªé™¤`);
          }
          if (inactiveCount > 0) {
            filterResultHTML += `<li class="error">${inactiveCount} ä½å“¡å·¥ç‹€æ…‹æ˜¯ inactive</li>`;
            diagnosisResult.issues.push(`${inactiveCount} ä½å“¡å·¥ç‹€æ…‹æ˜¯ inactive`);
          }

          filterResultHTML += '</ul>';
        } else {
          filterResultHTML += '<table><thead><tr><th>å§“å</th><th>è‹±æ–‡å</th><th>ç‹€æ…‹</th><th>_deleted</th></tr></thead><tbody>';
          filteredEmployees.forEach(emp => {
            filterResultHTML += `<tr>
              <td>${emp.display_name || emp.name || '(ç„¡)'}</td>
              <td>${emp.english_name || '(ç„¡)'}</td>
              <td><span class="badge badge-success">${emp.status || 'active'}</span></td>
              <td><span class="badge badge-success">${emp._deleted ? 'true' : 'false'}</span></td>
            </tr>`;
          });
          filterResultHTML += '</tbody></table>';
        }

        step3Content.innerHTML = filterResultHTML;

        // === æ­¥é©Ÿ 4ï¼šç”Ÿæˆé¸é … ===
        const step4Content = document.getElementById('step4-content');

        if (filteredEmployees.length === 0) {
          step4Content.innerHTML = '<p class="error">âŒ ç„¡æ³•ç”Ÿæˆé¸é …ï¼ˆæ²’æœ‰æœ‰æ•ˆå“¡å·¥ï¼‰</p>';
        } else {
          const employeeOptions = filteredEmployees.map(emp => ({
            value: emp.display_name,
            label: `${emp.display_name} (${emp.english_name})`,
            data: emp
          }));

          let optionsHTML = '<p class="success">âœ… æˆåŠŸç”Ÿæˆ ' + employeeOptions.length + ' å€‹é¸é …ï¼š</p>';
          optionsHTML += '<pre>' + JSON.stringify(employeeOptions, null, 2) + '</pre>';

          step4Content.innerHTML = optionsHTML;
        }

        // === é¡¯ç¤ºçµè«– ===
        showConclusion();

      } catch (error) {
        alert('è¨ºæ–·å¤±æ•—ï¼š' + error.message);
      }
    };

    function showConclusion() {
      const conclusionContent = document.getElementById('conclusion-content');

      let html = '';

      if (diagnosisResult.issues.length === 0 && diagnosisResult.validEmployees > 0) {
        html += '<p class="success" style="font-size: 18px; font-weight: bold;">âœ… è³‡æ–™çœ‹èµ·ä¾†æ­£å¸¸ï¼</p>';
        html += '<p>ä¸‹æ‹‰é¸å–®æ‡‰è©²è¦æœ‰ ' + diagnosisResult.validEmployees + ' å€‹é¸é …ã€‚</p>';
        html += '<hr style="margin: 20px 0;">';
        html += '<p><strong>å¦‚æœä¸‹æ‹‰é¸å–®é‚„æ˜¯ç©ºçš„ï¼Œå¯èƒ½åŸå› ï¼š</strong></p>';
        html += '<ol>';
        html += '<li>ğŸ”„ å‰ç«¯æ²’æœ‰è¼‰å…¥å“¡å·¥è³‡æ–™ â†’ <strong>é‡æ–°æ•´ç†é é¢</strong></li>';
        html += '<li>ğŸ› Combobox çµ„ä»¶æœ‰å•é¡Œ â†’ æª¢æŸ¥ç€è¦½å™¨ Console</li>';
        html += '<li>â±ï¸ è³‡æ–™é‚„åœ¨è¼‰å…¥ä¸­ â†’ ç­‰å¹¾ç§’å¾Œå†è©¦</li>';
        html += '</ol>';
      } else {
        html += '<p class="error" style="font-size: 18px; font-weight: bold;">âŒ æ‰¾åˆ°å•é¡Œäº†ï¼</p>';
        html += '<p><strong>å•é¡Œåˆ—è¡¨ï¼š</strong></p><ul>';
        diagnosisResult.issues.forEach(issue => {
          html += '<li class="error">' + issue + '</li>';
        });
        html += '</ul>';
        html += '<hr style="margin: 20px 0;">';
        html += '<p><strong>å»ºè­°ä¿®æ­£æ–¹å¼ï¼š</strong></p>';
        html += '<button onclick="fixCommonIssues()" style="margin: 0;">ğŸ”§ è‡ªå‹•ä¿®æ­£å•é¡Œ</button>';
      }

      conclusionContent.innerHTML = html;
    }

    window.fixCommonIssues = async () => {
      if (!confirm('ç¢ºå®šè¦è‡ªå‹•ä¿®æ­£å“¡å·¥è³‡æ–™å•é¡Œå—ï¼Ÿ\n\nå°‡æœƒï¼š\n1. ç§»é™¤ _deleted æ¨™è¨˜\n2. è¨­å®š status ç‚º active\n3. è£œå……ç¼ºå°‘çš„æ¬„ä½')) {
        return;
      }

      try {
        const db = await openDB('VenturoOfflineDB', 1);
        const allEmployees = await db.getAll('employees');
        let fixedCount = 0;

        for (const emp of allEmployees) {
          let needsUpdate = false;
          const updates = { ...emp };

          // ç§»é™¤ _deleted
          if (emp._deleted) {
            delete updates._deleted;
            needsUpdate = true;
          }

          // è¨­å®š status ç‚º active
          if (emp.status === 'inactive' || !emp.status) {
            updates.status = 'active';
            needsUpdate = true;
          }

          // è£œå…… display_name
          if (!emp.display_name && emp.name) {
            updates.display_name = emp.name;
            needsUpdate = true;
          }

          // è£œå…… english_name
          if (!emp.english_name) {
            updates.english_name = emp.employee_number || emp.name || 'Employee';
            needsUpdate = true;
          }

          if (needsUpdate) {
            await db.put('employees', updates);
            fixedCount++;
          }
        }

        alert(`âœ… ä¿®æ­£å®Œæˆï¼\n\nå·²æ›´æ–° ${fixedCount} ä½å“¡å·¥çš„è³‡æ–™\n\nè«‹é‡æ–°æ•´ç†æ—…éŠåœ˜é é¢`);

        // é‡æ–°è¨ºæ–·
        runDiagnosis();

      } catch (error) {
        alert('ä¿®æ­£å¤±æ•—ï¼š' + error.message);
      }
    };
  </script>
</body>
</html>
