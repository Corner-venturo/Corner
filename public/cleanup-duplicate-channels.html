<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ¸…ç†é‡è¤‡é »é“è³‡æ–™</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 600px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .card {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      margin-top: 0;
    }
    button {
      background: #ff6b6b;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      margin-top: 20px;
      width: 100%;
    }
    button:hover {
      background: #ff5252;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .success {
      background: #4caf50;
      color: white;
      padding: 12px;
      border-radius: 6px;
      margin-top: 20px;
    }
    .info {
      background: #2196f3;
      color: white;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 20px;
    }
    pre {
      background: #f5f5f5;
      padding: 12px;
      border-radius: 6px;
      overflow-x: auto;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>ğŸ§¹ æ¸…ç†é‡è¤‡é »é“è³‡æ–™</h1>

    <div class="info">
      <strong>é€™å€‹å·¥å…·æœƒæ¸…ç†ï¼š</strong>
      <ul style="margin: 10px 0 0 0; padding-left: 20px;">
        <li>localStorage ä¸­èˆŠçš„ channels å¿«å–</li>
        <li>localStorage ä¸­èˆŠçš„ channelGroups å¿«å–</li>
        <li>localStorage ä¸­èˆŠçš„ bulletins å¿«å–</li>
      </ul>
      <p style="margin: 10px 0 0 0;">
        æ¸…ç†å¾Œè«‹é‡æ–°æ•´ç†é é¢ï¼Œç³»çµ±æœƒå¾ IndexedDB é‡æ–°è¼‰å…¥æ­£ç¢ºè³‡æ–™ã€‚
      </p>
    </div>

    <button id="cleanupBtn" onclick="cleanup()">åŸ·è¡Œæ¸…ç†</button>

    <div id="result"></div>
  </div>

  <script>
    async function cleanup() {
      const btn = document.getElementById('cleanupBtn');
      const result = document.getElementById('result');

      btn.disabled = true;
      btn.textContent = 'æ¸…ç†ä¸­...';

      try {
        // è®€å–ç¾æœ‰çš„ channels-storage
        const storageKey = 'channels-storage';
        const rawData = localStorage.getItem(storageKey);

        if (!rawData) {
          result.innerHTML = '<div class="info">æ²’æœ‰æ‰¾åˆ° localStorage è³‡æ–™ï¼Œå¯èƒ½å·²ç¶“æ¸…ç†éäº†ã€‚</div>';
          btn.disabled = false;
          btn.textContent = 'åŸ·è¡Œæ¸…ç†';
          return;
        }

        const data = JSON.parse(rawData);
        const before = {
          channels: data.state?.channels?.length || 0,
          channelGroups: data.state?.channelGroups?.length || 0,
          bulletins: data.state?.bulletins?.length || 0
        };

        // æ¸…ç†ï¼šåªä¿ç•™ workspaces, currentWorkspace, selectedChannel
        const cleaned = {
          state: {
            workspaces: data.state?.workspaces || [],
            currentWorkspace: data.state?.currentWorkspace || null,
            selectedChannel: data.state?.selectedChannel || null,
            // ç§»é™¤ channels, channelGroups, bulletins
            loading: false,
            error: null,
            searchQuery: '',
            channelFilter: 'all'
          },
          version: data.version || 0
        };

        // å¯«å› localStorage
        localStorage.setItem(storageKey, JSON.stringify(cleaned));

        result.innerHTML = `
          <div class="success">
            <strong>âœ… æ¸…ç†å®Œæˆï¼</strong>
            <pre style="background: rgba(255,255,255,0.2); margin-top: 10px;">æ¸…ç†å‰ï¼š
- channels: ${before.channels} å€‹
- channelGroups: ${before.channelGroups} å€‹
- bulletins: ${before.bulletins} å€‹

æ¸…ç†å¾Œï¼š
- channels: 0 å€‹ï¼ˆå·²ç§»é™¤ï¼‰
- channelGroups: 0 å€‹ï¼ˆå·²ç§»é™¤ï¼‰
- bulletins: 0 å€‹ï¼ˆå·²ç§»é™¤ï¼‰</pre>
            <p style="margin-top: 10px;"><strong>è«‹é‡æ–°æ•´ç†é é¢ä»¥å¥—ç”¨è®Šæ›´ã€‚</strong></p>
          </div>
        `;

        setTimeout(() => {
          window.location.reload();
        }, 2000);

      } catch (error) {
        result.innerHTML = `<div style="background: #f44336; color: white; padding: 12px; border-radius: 6px; margin-top: 20px;">
          <strong>âŒ æ¸…ç†å¤±æ•—ï¼š</strong><br>${error.message}
        </div>`;
        btn.disabled = false;
        btn.textContent = 'åŸ·è¡Œæ¸…ç†';
      }
    }
  </script>
</body>
</html>
