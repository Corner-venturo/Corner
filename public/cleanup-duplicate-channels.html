<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>清理重複頻道資料</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 600px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .card {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      margin-top: 0;
    }
    button {
      background: #ff6b6b;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      margin-top: 20px;
      width: 100%;
    }
    button:hover {
      background: #ff5252;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .success {
      background: #4caf50;
      color: white;
      padding: 12px;
      border-radius: 6px;
      margin-top: 20px;
    }
    .info {
      background: #2196f3;
      color: white;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 20px;
    }
    pre {
      background: #f5f5f5;
      padding: 12px;
      border-radius: 6px;
      overflow-x: auto;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>🧹 清理重複頻道資料</h1>

    <div class="info">
      <strong>這個工具會清理：</strong>
      <ul style="margin: 10px 0 0 0; padding-left: 20px;">
        <li>localStorage 中舊的 channels 快取</li>
        <li>localStorage 中舊的 channelGroups 快取</li>
        <li>localStorage 中舊的 bulletins 快取</li>
      </ul>
      <p style="margin: 10px 0 0 0;">
        清理後請重新整理頁面，系統會從 IndexedDB 重新載入正確資料。
      </p>
    </div>

    <button id="cleanupBtn" onclick="cleanup()">執行清理</button>

    <div id="result"></div>
  </div>

  <script>
    async function cleanup() {
      const btn = document.getElementById('cleanupBtn');
      const result = document.getElementById('result');

      btn.disabled = true;
      btn.textContent = '清理中...';

      try {
        // 讀取現有的 channels-storage
        const storageKey = 'channels-storage';
        const rawData = localStorage.getItem(storageKey);

        if (!rawData) {
          result.innerHTML = '<div class="info">沒有找到 localStorage 資料，可能已經清理過了。</div>';
          btn.disabled = false;
          btn.textContent = '執行清理';
          return;
        }

        const data = JSON.parse(rawData);
        const before = {
          channels: data.state?.channels?.length || 0,
          channelGroups: data.state?.channelGroups?.length || 0,
          bulletins: data.state?.bulletins?.length || 0
        };

        // 清理：只保留 workspaces, currentWorkspace, selectedChannel
        const cleaned = {
          state: {
            workspaces: data.state?.workspaces || [],
            currentWorkspace: data.state?.currentWorkspace || null,
            selectedChannel: data.state?.selectedChannel || null,
            // 移除 channels, channelGroups, bulletins
            loading: false,
            error: null,
            searchQuery: '',
            channelFilter: 'all'
          },
          version: data.version || 0
        };

        // 寫回 localStorage
        localStorage.setItem(storageKey, JSON.stringify(cleaned));

        result.innerHTML = `
          <div class="success">
            <strong>✅ 清理完成！</strong>
            <pre style="background: rgba(255,255,255,0.2); margin-top: 10px;">清理前：
- channels: ${before.channels} 個
- channelGroups: ${before.channelGroups} 個
- bulletins: ${before.bulletins} 個

清理後：
- channels: 0 個（已移除）
- channelGroups: 0 個（已移除）
- bulletins: 0 個（已移除）</pre>
            <p style="margin-top: 10px;"><strong>請重新整理頁面以套用變更。</strong></p>
          </div>
        `;

        setTimeout(() => {
          window.location.reload();
        }, 2000);

      } catch (error) {
        result.innerHTML = `<div style="background: #f44336; color: white; padding: 12px; border-radius: 6px; margin-top: 20px;">
          <strong>❌ 清理失敗：</strong><br>${error.message}
        </div>`;
        btn.disabled = false;
        btn.textContent = '執行清理';
      }
    }
  </script>
</body>
</html>
