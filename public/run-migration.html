<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Âü∑Ë°å Migration - Venturo</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: monospace;
      max-width: 1000px;
      margin: 40px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 { color: #333; }
    button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 16px;
      cursor: pointer;
      border-radius: 4px;
      margin: 10px 5px;
    }
    button:hover { background: #45a049; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    #log {
      background: #1e1e1e;
      color: #00ff00;
      padding: 20px;
      border-radius: 4px;
      max-height: 500px;
      overflow-y: auto;
      font-size: 14px;
      line-height: 1.5;
      margin-top: 20px;
    }
    .success { color: #4CAF50; }
    .error { color: #f44336; }
    .warning { color: #ff9800; }
    .info { color: #2196F3; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üóÑÔ∏è Venturo Migration Âü∑Ë°åÂô®</h1>
    <p>ÈÄôÂÄãÂ∑•ÂÖ∑ÊúÉÁõ¥Êé•ÈÄèÈÅé Supabase JS Client Âü∑Ë°åË≥áÊñôÂ∫´ migration„ÄÇ</p>

    <button id="runBtn" onclick="runMigration()">‚ñ∂Ô∏è Âü∑Ë°å Migration</button>
    <button onclick="clearLog()">üóëÔ∏è Ê∏ÖÈô§Êó•Ë™å</button>

    <div id="log"></div>
  </div>

  <script>
    const SUPABASE_URL = 'https://pfqvdacxowpgfamuvnsn.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBmcXZkYWN4b3dwZ2ZhbXV2bnNuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxMDgzMjAsImV4cCI6MjA3NDY4NDMyMH0.LIMG0qmHixTPcbdzJrh4h0yTp8mh3FlggeZ6Bi_NwtI';

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const timestamp = new Date().toLocaleTimeString();
      logDiv.innerHTML += `<div class="${type}">[${timestamp}] ${message}</div>`;
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    function clearLog() {
      document.getElementById('log').innerHTML = '';
    }

    async function runMigration() {
      const btn = document.getElementById('runBtn');
      btn.disabled = true;
      clearLog();

      log('ÈñãÂßãÂü∑Ë°å migration...', 'info');

      // Migration SQL statementsÔºàÂàÜÊÆµÂü∑Ë°åÔºâ
      const statements = [
        // 1. Êõ¥Êñ∞ payment_requests ‰∏ªË°®
        `ALTER TABLE public.payment_requests
         ADD COLUMN IF NOT EXISTS request_date DATE DEFAULT CURRENT_DATE,
         ADD COLUMN IF NOT EXISTS total_amount NUMERIC(12, 2) DEFAULT 0,
         ADD COLUMN IF NOT EXISTS tour_code TEXT,
         ADD COLUMN IF NOT EXISTS tour_name TEXT,
         ADD COLUMN IF NOT EXISTS budget_warning BOOLEAN DEFAULT false,
         ADD COLUMN IF NOT EXISTS created_by UUID,
         ADD COLUMN IF NOT EXISTS workspace_id UUID;`,

        // 2. Êõ¥Êñ∞ payment_request_items Â≠êË°®
        `ALTER TABLE public.payment_request_items
         ADD COLUMN IF NOT EXISTS item_number TEXT DEFAULT '001',
         ADD COLUMN IF NOT EXISTS supplier_id UUID,
         ADD COLUMN IF NOT EXISTS supplier_name TEXT DEFAULT 'Êú™ÊåáÂÆö',
         ADD COLUMN IF NOT EXISTS payment_method TEXT DEFAULT 'transfer',
         ADD COLUMN IF NOT EXISTS custom_request_date DATE,
         ADD COLUMN IF NOT EXISTS sort_order INTEGER DEFAULT 0,
         ADD COLUMN IF NOT EXISTS workspace_id UUID,
         ADD COLUMN IF NOT EXISTS updated_at TIMESTAMPTZ DEFAULT NOW();`,

        // 3. ÈáçÂëΩÂêçÊ¨Ñ‰Ωç
        `DO $$
         BEGIN
           IF EXISTS(SELECT 1 FROM information_schema.columns WHERE table_name='payment_request_items' AND column_name='requestid') THEN
             ALTER TABLE public.payment_request_items RENAME COLUMN requestid TO request_id;
           END IF;
           IF EXISTS(SELECT 1 FROM information_schema.columns WHERE table_name='payment_request_items' AND column_name='itemname') THEN
             ALTER TABLE public.payment_request_items RENAME COLUMN itemname TO description;
           END IF;
           IF EXISTS(SELECT 1 FROM information_schema.columns WHERE table_name='payment_request_items' AND column_name='totalprice') THEN
             ALTER TABLE public.payment_request_items RENAME COLUMN totalprice TO subtotal;
           END IF;
           IF EXISTS(SELECT 1 FROM information_schema.columns WHERE table_name='payment_request_items' AND column_name='createdat') THEN
             ALTER TABLE public.payment_request_items RENAME COLUMN createdat TO created_at;
           END IF;
         END $$;`,

        // 4. Âª∫Á´ãÁ¥¢Âºï
        `CREATE INDEX IF NOT EXISTS idx_payment_requests_workspace_id ON public.payment_requests(workspace_id);
         CREATE INDEX IF NOT EXISTS idx_payment_requests_tour_id ON public.payment_requests(tour_id);
         CREATE INDEX IF NOT EXISTS idx_payment_requests_status ON public.payment_requests(status);
         CREATE INDEX IF NOT EXISTS idx_payment_requests_request_date ON public.payment_requests(request_date);`,

        `CREATE INDEX IF NOT EXISTS idx_payment_request_items_request_id ON public.payment_request_items(request_id);
         CREATE INDEX IF NOT EXISTS idx_payment_request_items_workspace_id ON public.payment_request_items(workspace_id);
         CREATE INDEX IF NOT EXISTS idx_payment_request_items_supplier_id ON public.payment_request_items(supplier_id);
         CREATE INDEX IF NOT EXISTS idx_payment_request_items_payment_method ON public.payment_request_items(payment_method);
         CREATE INDEX IF NOT EXISTS idx_payment_request_items_custom_date ON public.payment_request_items(custom_request_date);`,

        // 5. Âª∫Á´ãËß∏ÁôºÂô®ÂáΩÊï∏
        `CREATE OR REPLACE FUNCTION update_payment_request_total()
         RETURNS TRIGGER AS $$
         BEGIN
           UPDATE public.payment_requests
           SET
             total_amount = (
               SELECT COALESCE(SUM(subtotal), 0)
               FROM public.payment_request_items
               WHERE request_id = COALESCE(NEW.request_id, OLD.request_id)
             ),
             updated_at = NOW()
           WHERE id = COALESCE(NEW.request_id, OLD.request_id);
           RETURN COALESCE(NEW, OLD);
         END;
         $$ LANGUAGE plpgsql;`,

        `CREATE OR REPLACE FUNCTION update_updated_at_column()
         RETURNS TRIGGER AS $$
         BEGIN
           NEW.updated_at = NOW();
           RETURN NEW;
         END;
         $$ LANGUAGE plpgsql;`,

        // 6. Âª∫Á´ãËß∏ÁôºÂô®
        `DROP TRIGGER IF EXISTS trigger_update_payment_request_total_on_insert ON public.payment_request_items;
         DROP TRIGGER IF EXISTS trigger_update_payment_request_total_on_update ON public.payment_request_items;
         DROP TRIGGER IF EXISTS trigger_update_payment_request_total_on_delete ON public.payment_request_items;
         DROP TRIGGER IF EXISTS trigger_payment_requests_updated_at ON public.payment_requests;
         DROP TRIGGER IF EXISTS trigger_payment_request_items_updated_at ON public.payment_request_items;`,

        `CREATE TRIGGER trigger_update_payment_request_total_on_insert
           AFTER INSERT ON public.payment_request_items
           FOR EACH ROW EXECUTE FUNCTION update_payment_request_total();
         CREATE TRIGGER trigger_update_payment_request_total_on_update
           AFTER UPDATE OF subtotal ON public.payment_request_items
           FOR EACH ROW EXECUTE FUNCTION update_payment_request_total();
         CREATE TRIGGER trigger_update_payment_request_total_on_delete
           AFTER DELETE ON public.payment_request_items
           FOR EACH ROW EXECUTE FUNCTION update_payment_request_total();
         CREATE TRIGGER trigger_payment_requests_updated_at
           BEFORE UPDATE ON public.payment_requests
           FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
         CREATE TRIGGER trigger_payment_request_items_updated_at
           BEFORE UPDATE ON public.payment_request_items
           FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();`,
      ];

      let successCount = 0;
      let failCount = 0;

      for (let i = 0; i < statements.length; i++) {
        const sql = statements[i];
        log(`[${i + 1}/${statements.length}] Âü∑Ë°å SQL...`, 'info');

        try {
          const { error } = await supabase.rpc('exec_sql', { query: sql });

          if (error) {
            throw error;
          }

          log(`  ‚úÖ ÊàêÂäü`, 'success');
          successCount++;
        } catch (error) {
          log(`  ‚ùå Â§±Êïó: ${error.message}`, 'error');
          failCount++;
        }
      }

      log('', 'info');
      log('='.repeat(50), 'info');
      log(`‚úÖ ÊàêÂäü: ${successCount} ÂÄã`, 'success');
      log(`‚ùå Â§±Êïó: ${failCount} ÂÄã`, failCount > 0 ? 'error' : 'info');
      log('='.repeat(50), 'info');

      if (failCount === 0) {
        log('', 'info');
        log('üéâ Migration Âü∑Ë°åÂÆåÊàêÔºÅ', 'success');
        log('‚úÖ payment_requests Ë°®Â∑≤Êõ¥Êñ∞', 'success');
        log('‚úÖ payment_request_items Ë°®Â∑≤Êõ¥Êñ∞', 'success');
        log('‚úÖ Ëá™ÂãïËß∏ÁôºÂô®Â∑≤Âª∫Á´ã', 'success');
        log('‚úÖ Á¥¢ÂºïÂ∑≤Âª∫Á´ã', 'success');
      }

      btn.disabled = false;
    }
  </script>
</body>
</html>
