<!DOCTYPE html>
<html>
<head>
  <title>æ¸…ç©º IndexedDB</title>
  <meta charset="UTF-8">
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 600px;
      margin: 50px auto;
      padding: 30px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    .card {
      background: white;
      border-radius: 15px;
      padding: 40px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    h1 {
      color: #333;
      margin-top: 0;
    }
    button {
      background: #667eea;
      color: white;
      border: none;
      padding: 15px 40px;
      font-size: 18px;
      border-radius: 8px;
      cursor: pointer;
      width: 100%;
      margin: 10px 0;
      transition: all 0.3s;
    }
    button:hover {
      background: #5568d3;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }
    #status {
      margin-top: 20px;
      padding: 15px;
      border-radius: 8px;
      display: none;
    }
    .success { background: #d4edda; color: #155724; display: block; }
    .error { background: #f8d7da; color: #721c24; display: block; }
    .info { background: #d1ecf1; color: #0c5460; display: block; }
    .step {
      background: #f8f9fa;
      padding: 15px;
      margin: 15px 0;
      border-radius: 8px;
      border-left: 4px solid #667eea;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>ğŸ”§ æ¸…ç©ºæœ¬åœ°è³‡æ–™</h1>

    <div class="step">
      <strong>ç‚ºä»€éº¼éœ€è¦æ¸…ç©ºï¼Ÿ</strong>
      <p>æœ¬åœ°å¿«å–çš„è³‡æ–™æ ¼å¼å·²æ›´æ–°ï¼Œéœ€è¦æ¸…ç©ºå¾Œé‡æ–°å¾é›²ç«¯ä¸‹è¼‰ã€‚</p>
    </div>

    <button onclick="clearData()">æ¸…ç©ºä¸¦é‡æ–°è¼‰å…¥</button>
    <button onclick="checkStatus()" style="background: #6c757d;">æª¢æŸ¥ç‹€æ…‹</button>

    <div id="status"></div>
  </div>

  <script>
    const status = document.getElementById('status');

    async function clearData() {
      status.className = 'info';
      status.style.display = 'block';
      status.textContent = 'â³ æ¸…ç©ºä¸­...';

      try {
        const deleteReq = indexedDB.deleteDatabase('VenturoOfflineDB');

        deleteReq.onsuccess = () => {
          status.className = 'success';
          status.innerHTML = 'âœ… æ¸…ç©ºæˆåŠŸï¼<br>â³ 2 ç§’å¾Œè‡ªå‹•è·³è½‰åˆ°ç™»å…¥é ...';
          setTimeout(() => {
            window.location.href = '/login';
          }, 2000);
        };

        deleteReq.onerror = () => {
          status.className = 'error';
          status.innerHTML = 'âŒ æ¸…ç©ºå¤±æ•—: ' + deleteReq.error + '<br><br>è«‹é—œé–‰æ‰€æœ‰åˆ†é å¾Œé‡è©¦';
        };

        deleteReq.onblocked = () => {
          status.className = 'error';
          status.innerHTML = 'âš ï¸ è³‡æ–™åº«è¢«å…¶ä»–åˆ†é é–ä½ï¼<br><br>è«‹é—œé–‰æ‰€æœ‰æ­¤ç¶²ç«™çš„åˆ†é ï¼Œåªä¿ç•™é€™ä¸€å€‹ï¼Œç„¶å¾Œé‡è©¦ã€‚';
        };

      } catch (error) {
        status.className = 'error';
        status.style.display = 'block';
        status.textContent = 'âŒ éŒ¯èª¤: ' + error.message;
      }
    }

    async function checkStatus() {
      status.className = 'info';
      status.style.display = 'block';
      status.textContent = 'â³ æª¢æŸ¥ä¸­...';

      try {
        const dbs = await indexedDB.databases();
        const hasVenturo = dbs.some(db => db.name === 'VenturoOfflineDB');

        if (hasVenturo) {
          // æª¢æŸ¥è³‡æ–™æ ¼å¼
          const request = indexedDB.open('VenturoOfflineDB', 1);
          request.onsuccess = (e) => {
            const db = e.target.result;
            const tx = db.transaction('employees', 'readonly');
            const store = tx.objectStore('employees');
            const getAllReq = store.getAll();

            getAllReq.onsuccess = () => {
              const employees = getAllReq.result;
              if (employees.length === 0) {
                status.className = 'info';
                status.innerHTML = 'ğŸ“­ è³‡æ–™åº«å­˜åœ¨ä½†ç‚ºç©º<br>å¯ä»¥ç›´æ¥è·³è½‰åˆ°ç™»å…¥é ';
              } else {
                const firstEmp = employees[0];
                const isSnakeCase = 'employee_number' in firstEmp;
                const isCamelCase = 'employeeNumber' in firstEmp;

                if (isSnakeCase) {
                  status.className = 'success';
                  status.innerHTML = 'âœ… è³‡æ–™æ ¼å¼æ­£ç¢ºï¼ˆsnake_caseï¼‰<br>ğŸ‘¥ å“¡å·¥æ•¸é‡: ' + employees.length + '<br><br>å¯ä»¥ç›´æ¥å»ç™»å…¥äº†ï¼';
                } else if (isCamelCase) {
                  status.className = 'error';
                  status.innerHTML = 'âŒ è³‡æ–™æ ¼å¼éŒ¯èª¤ï¼ˆèˆŠçš„ camelCaseï¼‰<br><br>è«‹é»æ“Šã€Œæ¸…ç©ºä¸¦é‡æ–°è¼‰å…¥ã€æŒ‰éˆ•';
                } else {
                  status.className = 'error';
                  status.innerHTML = 'âš ï¸ ç„¡æ³•è­˜åˆ¥è³‡æ–™æ ¼å¼<br><br>å»ºè­°æ¸…ç©ºé‡æ–°ä¸‹è¼‰';
                }
              }
              db.close();
            };
          };
        } else {
          status.className = 'success';
          status.innerHTML = 'âœ… VenturoOfflineDB ä¸å­˜åœ¨<br><br>å¯ä»¥è·³è½‰åˆ°ç™»å…¥é ï¼Œç³»çµ±æœƒè‡ªå‹•ä¸‹è¼‰è³‡æ–™';
        }
      } catch (e) {
        status.className = 'error';
        status.style.display = 'block';
        status.textContent = 'âŒ æª¢æŸ¥å¤±æ•—: ' + e.message;
      }
    }

    // è‡ªå‹•æª¢æŸ¥
    window.onload = () => checkStatus();
  </script>
</body>
</html>
