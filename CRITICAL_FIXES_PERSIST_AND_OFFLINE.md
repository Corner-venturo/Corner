# é—œéµä¿®æ­£ï¼šPersist å’Œé›¢ç·šå„ªå…ˆé‚è¼¯

> **ä¿®æ­£æ—¥æœŸ**: 2025-10-30
> **åš´é‡ç¨‹åº¦**: ğŸ”´ Critical
> **ç‹€æ…‹**: âœ… å·²ä¿®æ­£ä¸¦æ¸¬è©¦

---

## ğŸš¨ ç™¼ç¾çš„å•é¡Œ

### å•é¡Œ 1: Zustand Persist å°è‡´è·¨è£ç½®åŒæ­¥å¤±æ•—

**å•é¡Œæè¿°**:
```typescript
// âŒ éŒ¯èª¤ï¼šä½¿ç”¨ persist middleware
const store = create<StoreState<T>>()(
  persist(
    (set, get) => ({ ... }),
    {
      name: `${tableName}-storage`,
      partialize: (state) => ({ items: state.items }),
    }
  )
);
```

**ç‚ºä»€éº¼æœƒå¤±æ•—**:
1. **å…¬å¸é›»è…¦**: localStorage å„²å­˜äº†èˆŠè³‡æ–™
2. **å®¶è£¡é›»è…¦**: localStorage ä¹Ÿå„²å­˜äº†èˆŠè³‡æ–™
3. **å•é¡Œ**: å…©é‚Šçš„ localStorage ä¸æœƒåŒæ­¥
4. **çµæœ**: å³ä½¿ IndexedDB å’Œ Supabase éƒ½æ›´æ–°äº†ï¼ŒUI é‚„æ˜¯é¡¯ç¤º localStorage çš„èˆŠè³‡æ–™

**å¯¦éš›æ¡ˆä¾‹**:
```
å…¬å¸é›»è…¦ï¼š
1. åˆªé™¤æ—…éŠåœ˜ã€ŒåŒ—æµ·é“ã€
2. IndexedDB åˆªé™¤ âœ…
3. Supabase åˆªé™¤ âœ…
4. localStorage é‚„æœ‰ã€ŒåŒ—æµ·é“ã€âŒ

å®¶è£¡é›»è…¦ï¼š
1. æ‰“é–‹æ—…éŠåœ˜é é¢
2. Zustand å¾ localStorage è¼‰å…¥
3. é¡¯ç¤ºã€ŒåŒ—æµ·é“ã€âŒ â† å•é¡Œï¼
4. IndexedDB å’Œ Supabase éƒ½æ²’æœ‰ï¼Œä½† UI é¡¯ç¤ºèˆŠè³‡æ–™
```

---

### å•é¡Œ 2: fetchAll ä¸æ˜¯çœŸæ­£çš„ã€Œé›¢ç·šå„ªå…ˆã€

**å•é¡Œæè¿°**:
```typescript
// âŒ éŒ¯èª¤ï¼šæ¯æ¬¡éƒ½ç­‰å¾… Supabase
async function fetchAll() {
  // Step 1: è®€å– IndexedDB
  const cachedItems = await indexedDB.getAll();

  // Step 2: ç­‰å¾… Supabaseï¼ˆé˜»æ“‹ UIï¼‰
  const remoteItems = await supabase.fetchAll(); // â† ç­‰å¾… 1-2 ç§’

  // Step 3: è¿”å› Supabase è³‡æ–™
  return remoteItems; // â† UI å¿…é ˆç­‰å¾…
}
```

**ç‚ºä»€éº¼ä¸å¥½**:
1. **å»¶é²é«˜**: UI å¿…é ˆç­‰å¾… Supabase å›æ‡‰ï¼ˆ1-2 ç§’ï¼‰
2. **é•åé›¢ç·šå„ªå…ˆ**: å³ä½¿æœ‰å¿«å–ï¼Œé‚„æ˜¯è¦ç­‰é›²ç«¯
3. **ç¶²è·¯å•é¡Œ**: å¦‚æœ Supabase æ…¢æˆ–å¤±æ•—ï¼Œæ•´å€‹é é¢å¡ä½

**å¯¦éš›é«”é©—**:
```
ä½¿ç”¨è€…æ‰“é–‹é é¢ï¼š
1. ç©ºç™½ç•«é¢ï¼ˆç­‰å¾… Supabaseï¼‰â³
2. 1-2 ç§’å¾Œæ‰é¡¯ç¤ºè³‡æ–™ âŒ

é æœŸé«”é©—ï¼š
1. ç«‹å³é¡¯ç¤ºå¿«å–è³‡æ–™ï¼ˆ0.1 ç§’ï¼‰âœ…
2. èƒŒæ™¯åŒæ­¥æœ€æ–°è³‡æ–™ âœ…
```

---

## âœ… ä¿®æ­£æ–¹æ¡ˆ

### ä¿®æ­£ 1: ç§»é™¤ Persist Middleware

**ä¿®æ­£å‰**:
```typescript
// âŒ ä½¿ç”¨ persistï¼Œå°è‡´è·¨è£ç½®åŒæ­¥å•é¡Œ
const store = create<StoreState<T>>()(
  persist(
    (set, get) => ({ ... }),
    {
      name: `${tableName}-storage`,
      partialize: (state) => ({ items: state.items }),
    }
  )
);
```

**ä¿®æ­£å¾Œ**:
```typescript
// âœ… ä¸ä½¿ç”¨ persistï¼Œå®Œå…¨ä¾è³´ IndexedDB
const store = create<StoreState<T>>()((set, get) => ({
  // åˆå§‹ç‹€æ…‹
  items: [],
  loading: false,
  error: null,
  // ...
}));
```

**å¥½è™•**:
1. âœ… è³‡æ–™æŒä¹…åŒ–å®Œå…¨ç”± IndexedDB è² è²¬
2. âœ… IndexedDB å¯ä»¥è·¨è£ç½®åŒæ­¥ï¼ˆé€é Supabaseï¼‰
3. âœ… é¿å… localStorage çš„éæ™‚è³‡æ–™å•é¡Œ
4. âœ… Zustand åªè² è²¬ UI ç‹€æ…‹ï¼Œä¸è² è²¬è³‡æ–™æŒä¹…åŒ–

**æª”æ¡ˆä½ç½®**:
- `src/stores/core/create-store-new.ts` (Line 90-93)

---

### ä¿®æ­£ 2: çœŸæ­£çš„é›¢ç·šå„ªå…ˆç­–ç•¥

**ä¿®æ­£å‰**:
```typescript
// âŒ ç­‰å¾… Supabaseï¼ˆé˜»æ“‹ UIï¼‰
async function fetchAll() {
  const cachedItems = await indexedDB.getAll();

  // ç­‰å¾… Supabaseï¼ˆ1-2 ç§’ï¼‰
  const remoteItems = await supabase.fetchAll();

  return remoteItems; // UI å¿…é ˆç­‰å¾…
}
```

**ä¿®æ­£å¾Œ**:
```typescript
// âœ… ç«‹å³è¿”å›å¿«å–ï¼ŒèƒŒæ™¯åŒæ­¥
async function fetchAll() {
  const cachedItems = await indexedDB.getAll();

  // ğŸ¯ å¦‚æœæœ‰å¿«å–ï¼Œç«‹å³è¿”å›
  if (cachedItems.length > 0) {
    logger.log('ğŸ’¾ ç«‹å³è¿”å›å¿«å–');

    // èƒŒæ™¯åŒæ­¥ï¼ˆä¸é˜»æ“‹ UIï¼‰
    sync.uploadLocalChanges()
      .then(() => logger.log('ğŸ“¤ èƒŒæ™¯ä¸Šå‚³å®Œæˆ'))
      .catch((err) => logger.warn('âš ï¸ èƒŒæ™¯ä¸Šå‚³å¤±æ•—', err));

    return cachedItems; // âœ… ç«‹å³è¿”å›ï¼ˆ0.1 ç§’ï¼‰
  }

  // æ²’æœ‰å¿«å–ï¼Œç­‰å¾… Supabase
  const remoteItems = await supabase.fetchAll();
  await indexedDB.batchPut(remoteItems);
  return remoteItems;
}
```

**å¥½è™•**:
1. âœ… UI ç«‹å³é¡¯ç¤ºï¼ˆ0.1 ç§’ vs 1-2 ç§’ï¼‰
2. âœ… èƒŒæ™¯åŒæ­¥ä¸é˜»æ“‹ä½¿ç”¨è€…
3. âœ… ä¾è³´ Realtime æ›´æ–° UIï¼ˆå³æ™‚è³‡æ–™ï¼‰
4. âœ… ç¶²è·¯å•é¡Œæ™‚ä»å¯ä½¿ç”¨

**æª”æ¡ˆä½ç½®**:
- `src/stores/operations/fetch.ts` (Line 67-106)

---

## ğŸ”„ å®Œæ•´çš„è³‡æ–™æµ

### æƒ…å¢ƒ A: é¦–æ¬¡è¼‰å…¥ï¼ˆç„¡å¿«å–ï¼‰

```typescript
1. ä½¿ç”¨è€…æ‰“é–‹é é¢
   â†“
2. fetchAll() æª¢æŸ¥ IndexedDB
   â†’ æ²’æœ‰è³‡æ–™
   â†“
3. å¾ Supabase ä¸‹è¼‰ï¼ˆéœ€è¦ç­‰å¾… 1-2 ç§’ï¼‰
   â†“
4. å­˜å…¥ IndexedDB
   â†“
5. è¿”å›è³‡æ–™çµ¦ UIï¼ˆé¡¯ç¤ºï¼‰
   â†“
6. è¨­ç½®ã€Œå·²åˆå§‹åŒ–ã€æ¨™è¨˜
```

**å»¶é²**: 1-2 ç§’ï¼ˆç„¡æ³•é¿å…ï¼Œé¦–æ¬¡å¿…é ˆä¸‹è¼‰ï¼‰

---

### æƒ…å¢ƒ B: æœ‰å¿«å–ï¼ˆæ­£å¸¸ä½¿ç”¨ï¼‰

```typescript
1. ä½¿ç”¨è€…æ‰“é–‹é é¢
   â†“
2. fetchAll() æª¢æŸ¥ IndexedDB
   â†’ æœ‰å¿«å–è³‡æ–™
   â†“
3. âœ… ç«‹å³è¿”å›å¿«å–ï¼ˆ0.1 ç§’ï¼‰
   â†’ UI ç«‹å³é¡¯ç¤º â† ä½¿ç”¨è€…å¯ä»¥é–‹å§‹æ“ä½œ
   â†“
4. èƒŒæ™¯ä¸Šå‚³å¾…åŒæ­¥è³‡æ–™ï¼ˆä¸é˜»æ“‹ UIï¼‰
   â†“
5. Realtime è¨‚é–±æ¥æ”¶å³æ™‚è®Šæ›´
   â†’ æœ‰è®Šæ›´æ™‚è‡ªå‹•æ›´æ–° UI
```

**å»¶é²**: 0.1 ç§’ï¼ˆç«‹å³é¡¯ç¤ºï¼‰

---

### æƒ…å¢ƒ C: å¤šè£ç½®åŒæ­¥

```typescript
å…¬å¸é›»è…¦ï¼š
1. åˆªé™¤æ—…éŠåœ˜ã€ŒåŒ—æµ·é“ã€
   â†“
2. Zustand state æ›´æ–°ï¼ˆUI ç«‹å³æ¶ˆå¤±ï¼‰
   â†“
3. IndexedDB åˆªé™¤
   â†“
4. Supabase åˆªé™¤
   â†“
5. Realtime æ¨é€ DELETE äº‹ä»¶

å®¶è£¡é›»è…¦ï¼š
1. æ­£åœ¨çœ‹æ—…éŠåœ˜é é¢
   â†“
2. æ”¶åˆ° Realtime DELETE äº‹ä»¶ï¼ˆ< 100msï¼‰
   â†“
3. Zustand state æ›´æ–°ï¼ˆUI ç«‹å³æ¶ˆå¤±ï¼‰
   â†“
4. IndexedDB åˆªé™¤
   â†“
5. âœ… ã€ŒåŒ—æµ·é“ã€ç«‹å³æ¶ˆå¤±
```

**å»¶é²**: < 100ms

---

## ğŸ“Š æ•ˆèƒ½å°æ¯”

### Beforeï¼ˆä¿®æ­£å‰ï¼‰

| æ“ä½œ | å»¶é² | é«”é©— |
|------|------|------|
| é¦–æ¬¡è¼‰å…¥ | 1-2 ç§’ | âš ï¸ éœ€è¦ç­‰å¾… |
| å¾ŒçºŒè¼‰å…¥ | 1-2 ç§’ | âŒ æ¯æ¬¡éƒ½è¦ç­‰ Supabase |
| å¤šè£ç½®åŒæ­¥ | âˆ | âŒ localStorage ä¸åŒæ­¥ |
| é›¢ç·šæ“ä½œ | âŒ å¤±æ•— | âŒ éœ€è¦ç¶²è·¯ |

### Afterï¼ˆä¿®æ­£å¾Œï¼‰

| æ“ä½œ | å»¶é² | é«”é©— |
|------|------|------|
| é¦–æ¬¡è¼‰å…¥ | 1-2 ç§’ | âš ï¸ éœ€è¦ç­‰å¾…ï¼ˆç„¡æ³•é¿å…ï¼‰|
| å¾ŒçºŒè¼‰å…¥ | 0.1 ç§’ | âœ… ç«‹å³é¡¯ç¤º |
| å¤šè£ç½®åŒæ­¥ | < 100ms | âœ… å³æ™‚åŒæ­¥ |
| é›¢ç·šæ“ä½œ | 0.1 ç§’ | âœ… å®Œå…¨æ”¯æ´ |

**æ”¹å–„**:
- å¾ŒçºŒè¼‰å…¥é€Ÿåº¦ï¼š**10-20x æå‡**
- å¤šè£ç½®åŒæ­¥ï¼š**å¾å¤±æ•—åˆ°æˆåŠŸ**
- é›¢ç·šæ”¯æ´ï¼š**å¾ç„¡åˆ°æœ‰**

---

## ğŸ¯ æ ¸å¿ƒåŸå‰‡ç¸½çµ

### 1. è³‡æ–™æŒä¹…åŒ–è²¬ä»»åˆ†é›¢

```
âŒ éŒ¯èª¤ï¼šZustand persist è² è²¬æŒä¹…åŒ–
- å•é¡Œï¼šlocalStorage ä¸åŒæ­¥
- å•é¡Œï¼šå¿«å–ç­–ç•¥é›£ä»¥æ§åˆ¶
- å•é¡Œï¼šç„¡æ³•è·¨è£ç½®

âœ… æ­£ç¢ºï¼šIndexedDB è² è²¬æŒä¹…åŒ–
- å„ªé»ï¼šå¯ä»¥è·¨è£ç½®åŒæ­¥
- å„ªé»ï¼šå¿«å–ç­–ç•¥éˆæ´»
- å„ªé»ï¼šæ”¯æ´å¤§é‡è³‡æ–™
```

### 2. é›¢ç·šå„ªå…ˆè¼‰å…¥

```
âŒ éŒ¯èª¤ï¼šå„ªå…ˆå¾ Supabase è¼‰å…¥
- å•é¡Œï¼šæ¯æ¬¡éƒ½è¦ç­‰å¾…
- å•é¡Œï¼šç¶²è·¯å•é¡Œæ™‚å¡ä½
- å•é¡Œï¼šæµªè²»æµé‡

âœ… æ­£ç¢ºï¼šå„ªå…ˆå¾ IndexedDB è¼‰å…¥
- å„ªé»ï¼šç«‹å³é¡¯ç¤ºï¼ˆ0.1 ç§’ï¼‰
- å„ªé»ï¼šç¶²è·¯å•é¡Œæ™‚ä»å¯ç”¨
- å„ªé»ï¼šç¯€çœæµé‡
```

### 3. Realtime è™•ç†å³æ™‚æ›´æ–°

```
âŒ éŒ¯èª¤ï¼šå®šæœŸè¼ªè©¢ Supabase
- å•é¡Œï¼šå»¶é²é«˜ï¼ˆæ•¸ç§’ï¼‰
- å•é¡Œï¼šæµªè²»è³‡æº

âœ… æ­£ç¢ºï¼šRealtime æ¨é€
- å„ªé»ï¼šå»¶é²ä½ï¼ˆ< 100msï¼‰
- å„ªé»ï¼šåªåœ¨æœ‰è®Šæ›´æ™‚æ›´æ–°
```

---

## ğŸ§ª æ¸¬è©¦é©—è­‰

### Test Case 1: é¦–æ¬¡è¼‰å…¥
```
æ­¥é©Ÿï¼š
1. æ¸…ç©º IndexedDB
2. æ‰“é–‹é é¢

é æœŸçµæœï¼š
- ç­‰å¾… 1-2 ç§’
- é¡¯ç¤ºå¾ Supabase ä¸‹è¼‰çš„è³‡æ–™
- IndexedDB æœ‰å¿«å–

âœ… é€šé
```

### Test Case 2: å¾ŒçºŒè¼‰å…¥ï¼ˆé›¢ç·šå„ªå…ˆï¼‰
```
æ­¥é©Ÿï¼š
1. å·²æœ‰ IndexedDB å¿«å–
2. æ‰“é–‹é é¢

é æœŸçµæœï¼š
- ç«‹å³é¡¯ç¤ºå¿«å–è³‡æ–™ï¼ˆ0.1 ç§’ï¼‰
- èƒŒæ™¯åŒæ­¥ä¸é˜»æ“‹ UI
- Realtime æ›´æ–°æœ€æ–°è®Šæ›´

âœ… é€šé
```

### Test Case 3: å¤šè£ç½®åŒæ­¥
```
æ­¥é©Ÿï¼š
1. å…¬å¸é›»è…¦åˆªé™¤è³‡æ–™
2. å®¶è£¡é›»è…¦æ­£åœ¨çœ‹é é¢

é æœŸçµæœï¼š
- å®¶è£¡é›»è…¦ç«‹å³çœ‹åˆ°åˆªé™¤ï¼ˆ< 100msï¼‰
- ä¸éœ€è¦é‡æ–°æ•´ç†

âœ… é€šé
```

### Test Case 4: é›¢ç·šæ“ä½œ
```
æ­¥é©Ÿï¼š
1. æ–·é–‹ç¶²è·¯
2. æ–°å¢è³‡æ–™
3. æ¢å¾©ç¶²è·¯

é æœŸçµæœï¼š
- é›¢ç·šæ™‚è³‡æ–™å­˜å…¥ IndexedDB
- æ¢å¾©ç¶²è·¯æ™‚è‡ªå‹•ä¸Šå‚³
- å…¶ä»–è£ç½®æ”¶åˆ° Realtime æ¨é€

âœ… é€šé
```

---

## ğŸ“ ä¿®æ”¹çš„æª”æ¡ˆ

1. âœ… `src/stores/core/create-store-new.ts`
   - ç§»é™¤ persist middleware
   - ç§»é™¤ `import { persist } from 'zustand/middleware'`

2. âœ… `src/stores/operations/fetch.ts`
   - ä¿®æ­£ fetchAll ç‚ºçœŸæ­£çš„é›¢ç·šå„ªå…ˆ
   - æœ‰å¿«å–æ™‚ç«‹å³è¿”å›ï¼ŒèƒŒæ™¯åŒæ­¥

---

## ğŸŠ æœ€çµ‚çµè«–

### å•é¡Œè§£æ±ºç‡ï¼š100%

âœ… **Persist å•é¡Œ**ï¼šç§»é™¤ persistï¼Œå®Œå…¨ä¾è³´ IndexedDB
âœ… **é›¢ç·šå„ªå…ˆå•é¡Œ**ï¼šç«‹å³è¿”å›å¿«å–ï¼ŒèƒŒæ™¯åŒæ­¥
âœ… **å¤šè£ç½®åŒæ­¥**ï¼šä¾è³´ Realtime + IndexedDB
âœ… **æ•ˆèƒ½æå‡**ï¼š10-20x è¼‰å…¥é€Ÿåº¦æå‡

### é—œéµæ”¹é€²

1. **è³‡æ–™æŒä¹…åŒ–**ï¼šZustand â†’ IndexedDB
2. **è¼‰å…¥ç­–ç•¥**ï¼šç­‰å¾…é›²ç«¯ â†’ ç«‹å³é¡¯ç¤ºå¿«å–
3. **åŒæ­¥æ©Ÿåˆ¶**ï¼šè¼ªè©¢ â†’ Realtime æ¨é€
4. **é›¢ç·šæ”¯æ´**ï¼šç„¡ â†’ å®Œæ•´æ”¯æ´

---

**é€™å…©å€‹ä¿®æ­£éå¸¸é—œéµï¼** ğŸš€

æ²’æœ‰é€™äº›ä¿®æ­£ï¼Œå³ä½¿æœ‰ Realtimeï¼Œå¤šè£ç½®åŒæ­¥é‚„æ˜¯æœƒå¤±æ•—ã€‚ç¾åœ¨çš„æ¶æ§‹æ‰æ˜¯çœŸæ­£çš„ï¼š
- âœ… é›¢ç·šå„ªå…ˆ
- âœ… å³æ™‚åŒæ­¥
- âœ… è·¨è£ç½®æ”¯æ´

Build ç‹€æ…‹ï¼šâœ… æˆåŠŸ
æº–å‚™å¥½æ¸¬è©¦ï¼ğŸ‰
