# Venturo é›¢ç·šå„ªå…ˆåŒæ­¥ç­–ç•¥

> **æ ¸å¿ƒæ¦‚å¿µ**ï¼šå…ˆæœ¬åœ°å¾Œé ç«¯ï¼Œé˜²æ­¢é‡è¤‡è¼‰å…¥ï¼Œçµ±ä¸€å…¨æ‡‰ç”¨æ¶æ§‹

---

## ğŸ¯ æ ¸å¿ƒé‚è¼¯æµç¨‹

### 1. è³‡æ–™è¼‰å…¥é †åºï¼ˆé›¢ç·šå„ªå…ˆï¼‰

```
ä½¿ç”¨è€…é–‹å•Ÿæ‡‰ç”¨/é é¢
  â†“
[æ­¥é©Ÿ 1] ç«‹å³å¾ IndexedDB è¼‰å…¥å¿«å–è³‡æ–™ â†’ é¡¯ç¤º UIï¼ˆç§’é–‹é«”é©—ï¼‰
  â†“
[æ­¥é©Ÿ 2] æª¢æŸ¥ç¶²è·¯ç‹€æ…‹
  â†“
  â”œâ”€ é›¢ç·š â†’ ä½¿ç”¨å¿«å–è³‡æ–™ï¼ŒçµæŸ
  â”‚
  â””â”€ ç·šä¸Š â†’ èƒŒæ™¯åŒæ­¥é ç«¯è³‡æ–™
       â†“
     [æ­¥é©Ÿ 3] å¾ Supabase æŸ¥è©¢æœ€æ–°è³‡æ–™
       â†“
     [æ­¥é©Ÿ 4] åˆä½µæœ¬åœ° + é ç«¯è³‡æ–™ï¼ˆè¡çªè§£æ±ºï¼‰
       â†“
     [æ­¥é©Ÿ 5] æ›´æ–° IndexedDB å¿«å–
       â†“
     [æ­¥é©Ÿ 6] æ›´æ–° UI ç‹€æ…‹
```

---

## ğŸ”„ è¡çªè§£æ±ºç­–ç•¥

### ç­–ç•¥ 1: Server-Authorityï¼ˆä¼ºæœå™¨å„ªå…ˆï¼‰

**é©ç”¨å ´æ™¯**ï¼šå¤šäººå”ä½œè³‡æ–™

| è³‡æ–™é¡å‹ | åŸå›  |
|---------|------|
| å·¥ä½œç©ºé–“ | åœ˜éšŠå…±äº«ï¼Œä»¥ä¼ºæœå™¨ç‚ºæº– |
| é »é“åˆ—è¡¨ | å¤šäººå¯è¦‹ï¼Œé¿å…æœ¬åœ°éæœŸè³‡æ–™ |
| è¨Šæ¯ | å³æ™‚é€šè¨Šï¼Œå¿…é ˆåŒæ­¥ |
| æˆå“¡åˆ—è¡¨ | æ¬Šé™ç›¸é—œï¼Œä»¥ä¼ºæœå™¨ç‚ºæº– |

**é‚è¼¯**ï¼š
```typescript
é ç«¯è³‡æ–™ > æœ¬åœ°è³‡æ–™ï¼ˆç›´æ¥è¦†è“‹ï¼‰
```

### ç­–ç•¥ 2: Last-Write-Winsï¼ˆæœ€å¾Œå¯«å…¥å‹å‡ºï¼‰

**é©ç”¨å ´æ™¯**ï¼šå€‹äººè³‡æ–™

| è³‡æ–™é¡å‹ | åŸå›  |
|---------|------|
| å€‹äººè¨­å®š | æ¯”è¼ƒæ™‚é–“æˆ³ï¼Œæ–°çš„å„ªå…ˆ |
| è‰ç¨¿å…§å®¹ | ä¿ç•™æœ€æ–°ç·¨è¼¯ |

**é‚è¼¯**ï¼š
```typescript
æ¯”è¼ƒ updated_at æ™‚é–“æˆ³
  â†“
æœ¬åœ°.updated_at > é ç«¯.updated_at â†’ ä½¿ç”¨æœ¬åœ°
å¦å‰‡ â†’ ä½¿ç”¨é ç«¯
```

### ç­–ç•¥ 3: Local-Firstï¼ˆæœ¬åœ°å„ªå…ˆï¼‰

**é©ç”¨å ´æ™¯**ï¼šæœªç™¼å¸ƒçš„æœ¬åœ°è³‡æ–™

| è³‡æ–™é¡å‹ | åŸå›  |
|---------|------|
| é›¢ç·šå»ºç«‹çš„é …ç›® | å°šæœªä¸Šå‚³ï¼Œä¿ç•™æœ¬åœ° |
| å¾…åŒæ­¥çš„è®Šæ›´ | ç­‰å¾…ä¸Šå‚³ |

**é‚è¼¯**ï¼š
```typescript
æœ¬åœ°è³‡æ–™ + é ç«¯æ–°å¢çš„è³‡æ–™ï¼ˆä¸è¡çªï¼‰
```

---

## ğŸ›¡ï¸ é˜²é‡è¤‡æ©Ÿåˆ¶

### å•é¡Œï¼šRealtime è¨‚é–±æœƒé‡è¤‡è§¸ç™¼

**åŸå› **ï¼š
1. `loadChannels()` è¢«å¤šè™•èª¿ç”¨
2. Realtime `onInsert` æ²’æœ‰æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨
3. ç¶²è·¯å»¶é²å¯èƒ½å°è‡´é‡è¤‡æ¨é€

**è§£æ±ºæ–¹æ¡ˆ**ï¼š

```typescript
// âŒ éŒ¯èª¤ï¼šç›´æ¥ push
onInsert: (item) => {
  set(state => ({
    items: [...state.items, item]  // å¯èƒ½é‡è¤‡
  }));
}

// âœ… æ­£ç¢ºï¼šæª¢æŸ¥æ˜¯å¦å­˜åœ¨
onInsert: (item) => {
  set(state => {
    // é˜²é‡è¤‡æª¢æŸ¥
    const exists = state.items.some(i => i.id === item.id);
    if (exists) {
      console.warn('[Realtime] é‡è¤‡é …ç›®ï¼Œå¿½ç•¥:', item.id);
      return state;  // ä¸æ›´æ–°ç‹€æ…‹
    }

    return {
      items: [...state.items, item]
    };
  });
}
```

---

## ğŸ“¦ é€šç”¨ Store Factory

### å»ºç«‹çµ±ä¸€çš„åŒæ­¥ Store

æ‰€æœ‰ Store éƒ½æ‡‰è©²ä½¿ç”¨ç›¸åŒçš„é‚è¼¯ï¼š

```typescript
import { createSyncedStore } from '@/lib/sync/create-synced-store';

// ç¯„ä¾‹ï¼šå»ºç«‹ Channels Store
const useChannelsStore = createSyncedStore<Channel>({
  tableName: 'channels',           // IndexedDB è¡¨å
  supabaseTable: 'channels',       // Supabase è¡¨å
  strategy: 'server-authority',    // åŒæ­¥ç­–ç•¥
  enableRealtime: true,            // å•Ÿç”¨ Realtime
  realtimeFilter: 'workspace_id=eq.xxx',  // éæ¿¾æ¢ä»¶
});

// ä½¿ç”¨
const { items, load, create, update, delete } = useChannelsStore();

// è¼‰å…¥è³‡æ–™ï¼ˆé›¢ç·šå„ªå…ˆï¼‰
await load(channel => channel.workspace_id === 'xxx');
```

---

## ğŸ—ï¸ æ‡‰ç”¨å•Ÿå‹•è¼‰å…¥é †åº

### åˆ†å±¤è¼‰å…¥ç­–ç•¥

```
æ‡‰ç”¨å•Ÿå‹•
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬ 1 å±¤ï¼ˆç«‹å³ï¼Œ0msï¼‰ï¼šèªè­‰èˆ‡è¨­å®š       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ - auth-store      èªè­‰è³‡è¨Šï¼ˆtokenï¼‰   â”‚
â”‚ - user-store      ä½¿ç”¨è€…è³‡æ–™          â”‚
â”‚ - theme-store     ä¸»é¡Œè¨­å®š            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬ 2 å±¤ï¼ˆå¿«é€Ÿï¼Œ~200msï¼‰ï¼šå·¥ä½œç©ºé–“åŸºç¤ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ - workspaces      å·¥ä½œç©ºé–“åˆ—è¡¨        â”‚
â”‚ - channel_groups  é »é“ç¾¤çµ„            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬ 3 å±¤ï¼ˆèƒŒæ™¯ï¼Œ~500msï¼‰ï¼šé »é“èˆ‡æˆå“¡   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ - channels        é »é“åˆ—è¡¨            â”‚
â”‚ - members         æˆå“¡åˆ—è¡¨            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬ 4 å±¤ï¼ˆæ‡¶è¼‰å…¥ï¼‰ï¼šå…§å®¹èˆ‡æ¥­å‹™è³‡æ–™     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ - messages        åƒ…è¼‰å…¥ç•¶å‰é »é“      â”‚
â”‚ - accounting      æŒ‰éœ€è¼‰å…¥            â”‚
â”‚ - calendar        æŒ‰éœ€è¼‰å…¥            â”‚
â”‚ - templates       æŒ‰éœ€è¼‰å…¥            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š éœ€è¦æ”¹é€ çš„ Stores

### âœ… éœ€è¦é›¢ç·šå„ªå…ˆé‚è¼¯ï¼ˆ10 å€‹ï¼‰

```
1. channels-store.ts       â†’ Server-Authority
2. chat-store.ts           â†’ Server-Authority
3. members-store.ts        â†’ Server-Authority
4. widgets-store.ts        â†’ Server-Authority
5. canvas-store.ts         â†’ Last-Write-Wins
6. accounting-store.ts     â†’ Server-Authority
7. calendar-store.ts       â†’ Server-Authority
8. manifestation-store.ts  â†’ Last-Write-Wins
9. template-store.ts       â†’ Server-Authority
10. timebox-store.ts       â†’ Last-Write-Wins
```

### âšª åƒ…æœ¬åœ°ï¼ˆä¸éœ€åŒæ­¥ï¼Œ4 å€‹ï¼‰

```
11. auth-store.ts          â†’ åƒ…å­˜ token
12. user-store.ts          â†’ æœ¬åœ°è¨­å®š
13. theme-store.ts         â†’ æœ¬åœ°åå¥½
14. home-settings-store.ts â†’ æœ¬åœ°è¨­å®š
```

---

## ğŸ”§ å¯¦ä½œé—œéµé»

### 1. çµ±ä¸€ä½¿ç”¨ `createSyncedStore`

```typescript
// èˆŠæ–¹å¼ï¼ˆå„è‡ªå¯¦ä½œï¼‰
const useChannelsStore = create<State>((set) => ({
  channels: [],
  loadChannels: async () => {
    const { data } = await supabase.from('channels').select('*');
    set({ channels: data });
  }
}));

// æ–°æ–¹å¼ï¼ˆçµ±ä¸€ Factoryï¼‰
const useChannelsStore = createSyncedStore<Channel>({
  tableName: 'channels',
  supabaseTable: 'channels',
  strategy: 'server-authority',
  enableRealtime: true,
});
```

### 2. Realtime è¨‚é–±è‡ªå‹•é˜²é‡è¤‡

```typescript
// Factory å…§å»ºé˜²é‡è¤‡é‚è¼¯
subscribeRealtime: (filter) => {
  realtimeManager.subscribe({
    handlers: {
      onInsert: (item) => {
        set(state => {
          // ğŸ”¥ è‡ªå‹•æª¢æŸ¥é‡è¤‡
          const exists = state.items.some(i => i.id === item.id);
          if (exists) return state;
          return { items: [...state.items, item] };
        });
      }
    }
  });
}
```

### 3. çµ±ä¸€çš„è¼‰å…¥å…¥å£

```typescript
// åœ¨ app å•Ÿå‹•æ™‚æˆ–é é¢è¼‰å…¥æ™‚
const channelsStore = useChannelsStore();

// é›¢ç·šå„ªå…ˆè¼‰å…¥ï¼ˆæœ¬åœ° â†’ é ç«¯ï¼‰
await channelsStore.load();

// è¨‚é–± Realtimeï¼ˆèƒŒæ™¯åŒæ­¥ï¼‰
channelsStore.subscribeRealtime();
```

---

## ğŸ¯ ç¸½çµ

### æ ¸å¿ƒåŸå‰‡

1. âœ… **å…ˆæœ¬åœ°å¾Œé ç«¯**ï¼šç«‹å³é¡¯ç¤ºå¿«å–ï¼ŒèƒŒæ™¯åŒæ­¥
2. âœ… **é˜²æ­¢é‡è¤‡**ï¼šRealtime è¨‚é–±æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨
3. âœ… **çµ±ä¸€æ¶æ§‹**ï¼šæ‰€æœ‰ Store ä½¿ç”¨ç›¸åŒé‚è¼¯
4. âœ… **è¡çªè§£æ±º**ï¼šæ ¹æ“šè³‡æ–™é¡å‹é¸æ“‡ç­–ç•¥
5. âœ… **åˆ†å±¤è¼‰å…¥**ï¼šé‡è¦è³‡æ–™å„ªå…ˆï¼Œæ¥­å‹™è³‡æ–™æ‡¶è¼‰å…¥

### æœªä¾† APP åŒ–å„ªå‹¢

- âš¡ **ç§’é–‹é«”é©—**ï¼šæœ¬åœ°è³‡æ–™ç«‹å³é¡¯ç¤º
- ğŸŒ **é›¢ç·šå¯ç”¨**ï¼šæ²’ç¶²è·¯ä¹Ÿèƒ½æŸ¥çœ‹è³‡æ–™
- ğŸ”„ **èƒŒæ™¯åŒæ­¥**ï¼šä¸é˜»å¡ UIï¼Œè‡ªå‹•æ›´æ–°
- ğŸ“± **çœæµé‡**ï¼šåªä¸‹è¼‰è®Šæ›´çš„è³‡æ–™
- ğŸ›¡ï¸ **å®¹éŒ¯æ€§**ï¼šç¶²è·¯ç•°å¸¸ä¸å½±éŸ¿ä½¿ç”¨

---

**å»ºç«‹æ—¥æœŸ**ï¼š2025-10-30
**ç‰ˆæœ¬**ï¼šv1.0
