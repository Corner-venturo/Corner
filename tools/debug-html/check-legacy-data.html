<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>æª¢æŸ¥èˆŠè³‡æ–™</title>
  <style>
    body {
      font-family: monospace;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 20px;
      border-radius: 8px;
      max-width: 1000px;
      margin: 0 auto;
    }
    button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin: 10px 5px;
    }
    button:hover { background: #45a049; }
    pre {
      background: #f4f4f4;
      padding: 15px;
      border-radius: 4px;
      overflow-x: auto;
      white-space: pre-wrap;
    }
    .error { color: red; }
    .success { color: green; }
    .warning { color: orange; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ” æª¢æŸ¥èˆŠè³‡æ–™</h1>
    <button onclick="checkData()">æª¢æŸ¥ localStorage</button>
    <button onclick="checkIndexedDB()">æª¢æŸ¥ IndexedDB</button>
    <div id="output"></div>
  </div>

  <script>
    function log(msg, type = 'info') {
      const output = document.getElementById('output');
      const pre = document.createElement('pre');
      pre.className = type;
      pre.textContent = msg;
      output.appendChild(pre);
    }

    function checkData() {
      document.getElementById('output').innerHTML = '';

      const stored = localStorage.getItem('channels-storage');
      if (!stored) {
        log('âŒ æ‰¾ä¸åˆ° channels-storage', 'error');
        return;
      }

      const data = JSON.parse(stored);

      log('=== localStorage è³‡æ–™ ===\n', 'success');

      // æª¢æŸ¥ç¾¤çµ„
      const groups = data.state?.channelGroups || [];
      log(`é »é“ç¾¤çµ„ (${groups.length} å€‹):`);
      groups.forEach(g => {
        log(`  - ${g.name} (ID: ${g.id}, created: ${g.created_at})`);
      });

      // æª¢æŸ¥é »é“
      const channels = data.state?.channels || [];
      log(`\né »é“ (${channels.length} å€‹):`);
      channels.forEach(ch => {
        const groupName = groups.find(g => g.id === ch.group_id)?.name || 'æœªåˆ†çµ„';
        log(`  - ${ch.name} (type: ${ch.type}, group: ${groupName}, ID: ${ch.id})`);
      });

      // æª¢æŸ¥ DM
      const dms = data.state?.directMessages || [];
      log(`\nç›´æ¥è¨Šæ¯ (${dms.length} å€‹):`);
      dms.forEach(dm => {
        log(`  - participants: ${dm.participant_ids.join(', ')} (ID: ${dm.id})`);
      });

      // æª¢æŸ¥é¸ä¸­ç‹€æ…‹
      log('\né¸ä¸­ç‹€æ…‹:');
      log(`  selectedChannel: ${data.state?.selectedChannel?.name || 'null'}`);
      log(`  selectedDirectMessage: ${data.state?.selectedDirectMessage?.id || 'null'}`);

      // æª¢æŸ¥å•é¡Œ
      log('\nâš ï¸ æ½›åœ¨å•é¡Œ:', 'warning');
      const partnerGroups = groups.filter(g => g.name === 'å¤¥ä¼´');
      if (partnerGroups.length > 0) {
        log(`  - ç™¼ç¾ ${partnerGroups.length} å€‹ã€Œå¤¥ä¼´ã€ç¾¤çµ„`, 'error');
      }

      const directChannels = channels.filter(ch => ch.type === 'direct');
      if (directChannels.length > 0) {
        log(`  - ç™¼ç¾ ${directChannels.length} å€‹ type='direct' çš„é »é“`, 'error');
      }

      if (partnerGroups.length === 0 && directChannels.length === 0) {
        log('  âœ… æ²’æœ‰ç™¼ç¾èˆŠç‰ˆè³‡æ–™', 'success');
      }
    }

    async function checkIndexedDB() {
      document.getElementById('output').innerHTML = '';

      try {
        const db = await new Promise((resolve, reject) => {
          const request = indexedDB.open('VenturoOfflineDB');
          request.onsuccess = () => resolve(request.result);
          request.onerror = () => reject(request.error);
        });

        log('=== IndexedDB è³‡æ–™ ===\n', 'success');
        log(`è³‡æ–™åº«ç‰ˆæœ¬: ${db.version}`);
        log(`å¯ç”¨è¡¨æ ¼: ${Array.from(db.objectStoreNames).join(', ')}\n`);

        // æª¢æŸ¥ channel_groups
        if (db.objectStoreNames.contains('channel_groups')) {
          const groups = await new Promise((resolve, reject) => {
            const tx = db.transaction('channel_groups', 'readonly');
            const request = tx.objectStore('channel_groups').getAll();
            request.onsuccess = () => resolve(request.result || []);
            request.onerror = () => reject(request.error);
          });

          log(`channel_groups (${groups.length} å€‹):`);
          groups.forEach(g => {
            log(`  - ${g.name} (ID: ${g.id})`);
          });

          const partnerGroups = groups.filter(g => g.name === 'å¤¥ä¼´');
          if (partnerGroups.length > 0) {
            log(`  âš ï¸ ç™¼ç¾ ${partnerGroups.length} å€‹ã€Œå¤¥ä¼´ã€ç¾¤çµ„`, 'error');
          }
        }

        // æª¢æŸ¥ channels
        if (db.objectStoreNames.contains('channels')) {
          const channels = await new Promise((resolve, reject) => {
            const tx = db.transaction('channels', 'readonly');
            const request = tx.objectStore('channels').getAll();
            request.onsuccess = () => resolve(request.result || []);
            request.onerror = () => reject(request.error);
          });

          log(`\nchannels (${channels.length} å€‹):`);
          channels.forEach(ch => {
            log(`  - ${ch.name} (type: ${ch.type}, ID: ${ch.id})`);
          });

          const directChannels = channels.filter(ch => ch.type === 'direct');
          if (directChannels.length > 0) {
            log(`  âš ï¸ ç™¼ç¾ ${directChannels.length} å€‹ direct é¡å‹é »é“`, 'error');
          }
        }

        // æª¢æŸ¥ direct_messages
        if (db.objectStoreNames.contains('direct_messages')) {
          const dms = await new Promise((resolve, reject) => {
            const tx = db.transaction('direct_messages', 'readonly');
            const request = tx.objectStore('direct_messages').getAll();
            request.onsuccess = () => resolve(request.result || []);
            request.onerror = () => reject(request.error);
          });

          log(`\ndirect_messages (${dms.length} å€‹):`);
          dms.forEach(dm => {
            log(`  - participants: ${dm.participant_ids.join(', ')} (ID: ${dm.id})`);
          });
        } else {
          log('\nâš ï¸ direct_messages è¡¨æ ¼ä¸å­˜åœ¨ï¼ˆéœ€è¦å‡ç´šè³‡æ–™åº«ï¼‰', 'warning');
        }

        db.close();

      } catch (error) {
        log(`âŒ éŒ¯èª¤: ${error.message}`, 'error');
      }
    }
  </script>
</body>
</html>
