<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>æ¸…ç†èˆŠç‰ˆç›´æ¥è¨Šæ¯é »é“</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 { color: #333; margin-bottom: 20px; }
    .warning {
      background: #fff3cd;
      border: 1px solid #ffc107;
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 20px;
    }
    button {
      background: #d4a574;
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      width: 100%;
      margin: 10px 0;
    }
    button:hover { background: #c49563; }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    #result {
      margin-top: 20px;
      padding: 15px;
      border-radius: 6px;
      white-space: pre-wrap;
      font-family: monospace;
      font-size: 13px;
      max-height: 500px;
      overflow-y: auto;
    }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
    .info { background: #d1ecf1; color: #0c5460; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ§¹ æ¸…ç†èˆŠç‰ˆç›´æ¥è¨Šæ¯é »é“</h1>

    <div class="warning">
      <strong>âš ï¸ æ³¨æ„ï¼š</strong>
      <p>æ­¤å·¥å…·æœƒæ¸…ç†ä»¥ä¸‹é …ç›®ï¼š</p>
      <ul>
        <li>æ‰€æœ‰ã€Œå¤¥ä¼´ã€ç¾¤çµ„ï¼ˆChannelGroupï¼‰</li>
        <li>æ‰€æœ‰ type='direct' çš„èˆŠå¼é »é“</li>
        <li>IndexedDB å’Œ localStorage ä¸­çš„å°æ‡‰è³‡æ–™</li>
      </ul>
      <p><strong>æ­¤æ“ä½œç„¡æ³•å¾©åŸï¼è«‹å…ˆå‚™ä»½é‡è¦è³‡æ–™ã€‚</strong></p>
    </div>

    <button onclick="analyzeData()">ğŸ“Š åˆ†æç¾æœ‰è³‡æ–™</button>
    <button onclick="cleanupData()">ğŸ—‘ï¸ åŸ·è¡Œæ¸…ç†</button>

    <div id="result"></div>
  </div>

  <script>
    function showResult(message, type = 'info') {
      const div = document.getElementById('result');
      div.className = type;
      div.textContent = message;
    }

    async function analyzeData() {
      showResult('ğŸ” åˆ†æä¸­...', 'info');

      try {
        // 1. æª¢æŸ¥ localStorage
        const stored = localStorage.getItem('channels-storage');
        if (!stored) {
          showResult('âŒ æ‰¾ä¸åˆ° channels-storage è³‡æ–™', 'error');
          return;
        }

        const data = JSON.parse(stored);
        const groups = data.state?.channelGroups || [];
        const channels = data.state?.channels || [];

        let report = 'ğŸ“Š åˆ†æå ±å‘Š\n\n';

        // åˆ†æã€Œå¤¥ä¼´ã€ç¾¤çµ„
        const partnerGroups = groups.filter(g => g.name === 'å¤¥ä¼´');
        report += `=== é »é“ç¾¤çµ„ ===\n`;
        report += `ç¸½ç¾¤çµ„æ•¸: ${groups.length}\n`;
        report += `ã€Œå¤¥ä¼´ã€ç¾¤çµ„æ•¸: ${partnerGroups.length}\n`;
        if (partnerGroups.length > 0) {
          report += `\nå°‡åˆªé™¤çš„ã€Œå¤¥ä¼´ã€ç¾¤çµ„:\n`;
          partnerGroups.forEach(g => {
            report += `  - ID: ${g.id}, å»ºç«‹æ™‚é–“: ${g.created_at}\n`;
          });
        }

        // åˆ†æ direct é¡å‹é »é“
        const directChannels = channels.filter(ch => ch.type === 'direct');
        report += `\n=== é »é“ ===\n`;
        report += `ç¸½é »é“æ•¸: ${channels.length}\n`;
        report += `Direct é¡å‹é »é“æ•¸: ${directChannels.length}\n`;
        if (directChannels.length > 0) {
          report += `\nå°‡åˆªé™¤çš„ Direct é »é“:\n`;
          directChannels.forEach(ch => {
            report += `  - ${ch.name} (ID: ${ch.id})\n`;
          });
        }

        // 2. æª¢æŸ¥ IndexedDB
        const db = await new Promise((resolve, reject) => {
          const request = indexedDB.open('VenturoOfflineDB', 2);
          request.onsuccess = () => resolve(request.result);
          request.onerror = () => reject(request.error);
        });

        // æª¢æŸ¥ channel_groups è¡¨
        if (db.objectStoreNames.contains('channel_groups')) {
          const dbGroups = await new Promise((resolve, reject) => {
            const tx = db.transaction('channel_groups', 'readonly');
            const request = tx.objectStore('channel_groups').getAll();
            request.onsuccess = () => resolve(request.result || []);
            request.onerror = () => reject(request.error);
          });
          const dbPartnerGroups = dbGroups.filter(g => g.name === 'å¤¥ä¼´');
          report += `\n=== IndexedDB - channel_groups ===\n`;
          report += `ç¸½æ•¸: ${dbGroups.length}\n`;
          report += `ã€Œå¤¥ä¼´ã€ç¾¤çµ„æ•¸: ${dbPartnerGroups.length}\n`;
        }

        // æª¢æŸ¥ channels è¡¨
        if (db.objectStoreNames.contains('channels')) {
          const dbChannels = await new Promise((resolve, reject) => {
            const tx = db.transaction('channels', 'readonly');
            const request = tx.objectStore('channels').getAll();
            request.onsuccess = () => resolve(request.result || []);
            request.onerror = () => reject(request.error);
          });
          const dbDirectChannels = dbChannels.filter(ch => ch.type === 'direct');
          report += `\n=== IndexedDB - channels ===\n`;
          report += `ç¸½æ•¸: ${dbChannels.length}\n`;
          report += `Direct é¡å‹æ•¸: ${dbDirectChannels.length}\n`;
        }

        db.close();

        report += `\n\n=== æ‘˜è¦ ===\n`;
        report += `å³å°‡åˆªé™¤:\n`;
        report += `  - ${partnerGroups.length} å€‹ã€Œå¤¥ä¼´ã€ç¾¤çµ„\n`;
        report += `  - ${directChannels.length} å€‹ Direct é¡å‹é »é“\n`;
        report += `\nç¢ºèªç„¡èª¤å¾Œï¼Œé»æ“Šã€ŒåŸ·è¡Œæ¸…ç†ã€æŒ‰éˆ•`;

        showResult(report, 'info');

      } catch (error) {
        showResult(`âŒ éŒ¯èª¤: ${error.message}\n\n${error.stack}`, 'error');
        console.error('åˆ†æå¤±æ•—:', error);
      }
    }

    async function cleanupData() {
      if (!confirm('âš ï¸ ç¢ºå®šè¦æ¸…ç†æ‰€æœ‰èˆŠç‰ˆç›´æ¥è¨Šæ¯è³‡æ–™å—ï¼Ÿ\n\næ­¤æ“ä½œç„¡æ³•å¾©åŸï¼')) {
        return;
      }

      showResult('ğŸ—‘ï¸ æ¸…ç†ä¸­...', 'info');

      try {
        let report = 'ğŸ‰ æ¸…ç†å ±å‘Š\n\n';
        let totalDeleted = 0;

        // 1. æ¸…ç† localStorage
        const stored = localStorage.getItem('channels-storage');
        if (stored) {
          const data = JSON.parse(stored);
          const originalGroupCount = (data.state?.channelGroups || []).length;
          const originalChannelCount = (data.state?.channels || []).length;

          // ç§»é™¤ã€Œå¤¥ä¼´ã€ç¾¤çµ„
          data.state.channelGroups = (data.state?.channelGroups || [])
            .filter(g => g.name !== 'å¤¥ä¼´');

          // ç§»é™¤ direct é¡å‹é »é“
          data.state.channels = (data.state?.channels || [])
            .filter(ch => ch.type !== 'direct');

          // æ¸…é™¤é¸ä¸­ç‹€æ…‹ï¼ˆå¦‚æœé¸ä¸­çš„æ˜¯è¢«åˆªé™¤çš„é …ç›®ï¼‰
          if (data.state.selectedChannel && data.state.selectedChannel.type === 'direct') {
            data.state.selectedChannel = null;
            data.state.currentChannel = null;
          }

          localStorage.setItem('channels-storage', JSON.stringify(data));

          const deletedGroups = originalGroupCount - data.state.channelGroups.length;
          const deletedChannels = originalChannelCount - data.state.channels.length;

          report += `localStorage æ¸…ç†:\n`;
          report += `  - åˆªé™¤ ${deletedGroups} å€‹ç¾¤çµ„\n`;
          report += `  - åˆªé™¤ ${deletedChannels} å€‹é »é“\n`;
          totalDeleted += deletedGroups + deletedChannels;
        }

        // 2. æ¸…ç† IndexedDB
        const db = await new Promise((resolve, reject) => {
          const request = indexedDB.open('VenturoOfflineDB', 2);
          request.onsuccess = () => resolve(request.result);
          request.onerror = () => reject(request.error);
        });

        // æ¸…ç† channel_groups è¡¨
        if (db.objectStoreNames.contains('channel_groups')) {
          const groups = await new Promise((resolve, reject) => {
            const tx = db.transaction('channel_groups', 'readonly');
            const request = tx.objectStore('channel_groups').getAll();
            request.onsuccess = () => resolve(request.result || []);
            request.onerror = () => reject(request.error);
          });

          const groupsToDelete = groups.filter(g => g.name === 'å¤¥ä¼´');
          for (const group of groupsToDelete) {
            const tx = db.transaction('channel_groups', 'readwrite');
            await new Promise((resolve, reject) => {
              const request = tx.objectStore('channel_groups').delete(group.id);
              request.onsuccess = () => resolve();
              request.onerror = () => reject(request.error);
            });
          }

          report += `\nIndexedDB channel_groups:\n`;
          report += `  - åˆªé™¤ ${groupsToDelete.length} å€‹ã€Œå¤¥ä¼´ã€ç¾¤çµ„\n`;
        }

        // æ¸…ç† channels è¡¨
        if (db.objectStoreNames.contains('channels')) {
          const channels = await new Promise((resolve, reject) => {
            const tx = db.transaction('channels', 'readonly');
            const request = tx.objectStore('channels').getAll();
            request.onsuccess = () => resolve(request.result || []);
            request.onerror = () => reject(request.error);
          });

          const channelsToDelete = channels.filter(ch => ch.type === 'direct');
          for (const channel of channelsToDelete) {
            const tx = db.transaction('channels', 'readwrite');
            await new Promise((resolve, reject) => {
              const request = tx.objectStore('channels').delete(channel.id);
              request.onsuccess = () => resolve();
              request.onerror = () => reject(request.error);
            });
          }

          report += `\nIndexedDB channels:\n`;
          report += `  - åˆªé™¤ ${channelsToDelete.length} å€‹ Direct é »é“\n`;
        }

        db.close();

        report += `\n\nâœ… æ¸…ç†å®Œæˆï¼\n`;
        report += `ç¸½å…±æ¸…ç†äº† ${totalDeleted} å€‹é …ç›®\n\n`;
        report += `è«‹é‡æ–°æ•´ç†é é¢ (F5) ä»¥æŸ¥çœ‹çµæœ`;

        showResult(report, 'success');

      } catch (error) {
        showResult(`âŒ éŒ¯èª¤: ${error.message}\n\n${error.stack}`, 'error');
        console.error('æ¸…ç†å¤±æ•—:', error);
      }
    }
  </script>
</body>
</html>
