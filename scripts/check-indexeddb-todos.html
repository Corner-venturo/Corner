<!DOCTYPE html>
<html>
<head>
  <title>æª¢æŸ¥ IndexedDB ä»£è¾¦äº‹é …</title>
  <style>
    body {
      font-family: monospace;
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }
    .section {
      margin: 20px 0;
      padding: 15px;
      background: #f5f5f5;
      border-radius: 8px;
    }
    .todo-item {
      margin: 10px 0;
      padding: 10px;
      background: white;
      border-left: 4px solid #4CAF50;
    }
    .todo-item.invisible {
      border-left-color: #f44336;
      opacity: 0.6;
    }
    button {
      padding: 10px 20px;
      margin: 5px;
      cursor: pointer;
    }
    pre {
      background: white;
      padding: 10px;
      overflow-x: auto;
    }
  </style>
</head>
<body>
  <h1>ğŸ“‹ æª¢æŸ¥ IndexedDB ä»£è¾¦äº‹é …</h1>

  <div class="section">
    <h2>1ï¸âƒ£ ç•¶å‰ç™»å…¥ç”¨æˆ¶</h2>
    <div id="current-user"></div>
  </div>

  <div class="section">
    <h2>2ï¸âƒ£ ä»£è¾¦äº‹é …çµ±è¨ˆ</h2>
    <div id="stats"></div>
  </div>

  <div class="section">
    <h2>3ï¸âƒ£ å¯è¦‹çš„ä»£è¾¦äº‹é …</h2>
    <div id="visible-todos"></div>
  </div>

  <div class="section">
    <h2>4ï¸âƒ£ çœ‹ä¸åˆ°çš„ä»£è¾¦äº‹é …</h2>
    <div id="invisible-todos"></div>
  </div>

  <div class="section">
    <button onclick="fixVisibility()">ğŸ”§ ä¿®æ­£æ‰€æœ‰ä»£è¾¦äº‹é …çš„å¯è¦‹æ€§</button>
    <button onclick="location.reload()">ğŸ”„ é‡æ–°æª¢æŸ¥</button>
  </div>

  <script>
    const DB_NAME = 'venturo-db';
    const DB_VERSION = 1;

    async function openDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
      });
    }

    async function getAllFromStore(storeName) {
      const db = await openDB();
      return new Promise((resolve, reject) => {
        const tx = db.transaction(storeName, 'readonly');
        const store = tx.objectStore(storeName);
        const request = store.getAll();
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
      });
    }

    async function updateItem(storeName, item) {
      const db = await openDB();
      return new Promise((resolve, reject) => {
        const tx = db.transaction(storeName, 'readwrite');
        const store = tx.objectStore(storeName);
        const request = store.put(item);
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
      });
    }

    async function checkTodos() {
      try {
        // å¾ localStorage å–å¾—ç•¶å‰ç”¨æˆ¶ï¼ˆæ”¯æ´å¤šç¨®æ ¼å¼ï¼‰
        let currentUserId = null;
        let userName = null;

        // æ–¹æ³• 1: auth-store (èˆŠæ ¼å¼)
        const authData = localStorage.getItem('auth-store');
        if (authData) {
          const parsed = JSON.parse(authData);
          currentUserId = parsed.state?.user?.id;
          userName = parsed.state?.user?.display_name || parsed.state?.user?.email;
        }

        // æ–¹æ³• 2: local-auth-store (æ–°æ ¼å¼)
        if (!currentUserId) {
          const localAuthData = localStorage.getItem('local-auth-store');
          if (localAuthData) {
            const parsed = JSON.parse(localAuthData);
            currentUserId = parsed.state?.currentProfile?.id || parsed.state?.activeProfile?.id;
            userName = parsed.state?.currentProfile?.name || parsed.state?.activeProfile?.name;
          }
        }

        // æ–¹æ³• 3: å¾ IndexedDB çš„ employees è¡¨æŸ¥æ‰¾
        if (!currentUserId) {
          try {
            const employees = await getAllFromStore('employees');
            if (employees && employees.length > 0) {
              // å‡è¨­ç¬¬ä¸€å€‹å“¡å·¥å°±æ˜¯ç•¶å‰ç”¨æˆ¶
              currentUserId = employees[0].id;
              userName = employees[0].display_name;
              console.log('å¾ IndexedDB æ¨æ¸¬ç•¶å‰ç”¨æˆ¶:', userName);
            }
          } catch (e) {
            console.log('ç„¡æ³•å¾ IndexedDB è®€å–å“¡å·¥è³‡æ–™:', e);
          }
        }

        document.getElementById('current-user').innerHTML = currentUserId
          ? `<pre>User ID: ${currentUserId}\nUser Name: ${userName || 'æœªçŸ¥'}</pre>`
          : '<pre style="color: red;">âŒ æ‰¾ä¸åˆ°ç•¶å‰ç™»å…¥ç”¨æˆ¶</pre>';

        // å–å¾—æ‰€æœ‰ä»£è¾¦äº‹é …
        const todos = await getAllFromStore('todos');

        // çµ±è¨ˆ
        const stats = {
          total: todos.length,
          visible: 0,
          invisible: 0,
          pending: 0,
          in_progress: 0,
          completed: 0
        };

        const visibleTodos = [];
        const invisibleTodos = [];

        todos.forEach(todo => {
          // çµ±è¨ˆç‹€æ…‹
          if (todo.status === 'pending') stats.pending++;
          if (todo.status === 'in_progress') stats.in_progress++;
          if (todo.status === 'completed') stats.completed++;

          // æª¢æŸ¥å¯è¦‹æ€§
          if (currentUserId) {
            const isCreator = todo.creator === currentUserId;
            const isAssignee = todo.assignee === currentUserId;
            const inVisibility = todo.visibility?.includes(currentUserId);

            if (isCreator || isAssignee || inVisibility) {
              stats.visible++;
              visibleTodos.push(todo);
            } else {
              stats.invisible++;
              invisibleTodos.push(todo);
            }
          }
        });

        // é¡¯ç¤ºçµ±è¨ˆ
        document.getElementById('stats').innerHTML = `
          <pre>
ç¸½æ•¸: ${stats.total}
å¯è¦‹: ${stats.visible}
ä¸å¯è¦‹: ${stats.invisible}

ç‹€æ…‹åˆ†ä½ˆ:
- å¾…è¾¦: ${stats.pending}
- é€²è¡Œä¸­: ${stats.in_progress}
- å·²å®Œæˆ: ${stats.completed}
          </pre>
        `;

        // é¡¯ç¤ºå¯è¦‹çš„ä»£è¾¦äº‹é …
        document.getElementById('visible-todos').innerHTML = visibleTodos.length > 0
          ? visibleTodos.map(todo => `
            <div class="todo-item">
              <strong>${todo.title}</strong> (${todo.status})<br>
              <small>
                Creator: ${todo.creator === currentUserId ? 'âœ“ ä½ ' : todo.creator}<br>
                Assignee: ${todo.assignee === currentUserId ? 'âœ“ ä½ ' : (todo.assignee || 'ç„¡')}<br>
                Visibility: ${JSON.stringify(todo.visibility)}
              </small>
            </div>
          `).join('')
          : '<p>æ²’æœ‰å¯è¦‹çš„ä»£è¾¦äº‹é …</p>';

        // é¡¯ç¤ºä¸å¯è¦‹çš„ä»£è¾¦äº‹é …
        document.getElementById('invisible-todos').innerHTML = invisibleTodos.length > 0
          ? invisibleTodos.map(todo => `
            <div class="todo-item invisible">
              <strong>${todo.title}</strong> (${todo.status})<br>
              <small>
                Creator: ${todo.creator}<br>
                Assignee: ${todo.assignee || 'ç„¡'}<br>
                Visibility: ${JSON.stringify(todo.visibility)}
              </small>
            </div>
          `).join('')
          : '<p style="color: green;">âœ… æ‰€æœ‰ä»£è¾¦äº‹é …éƒ½å¯è¦‹ï¼</p>';

      } catch (error) {
        console.error('æª¢æŸ¥å¤±æ•—:', error);
        alert('æª¢æŸ¥å¤±æ•—: ' + error.message);
      }
    }

    async function fixVisibility() {
      if (!confirm('ç¢ºå®šè¦ä¿®æ­£æ‰€æœ‰ä»£è¾¦äº‹é …çš„å¯è¦‹æ€§å—ï¼Ÿ\né€™æœƒå°‡ä½ çš„ user_id åŠ å…¥æ‰€æœ‰ä»£è¾¦äº‹é …çš„ visibility åˆ—è¡¨ã€‚')) {
        return;
      }

      try {
        // å–å¾—ç•¶å‰ç”¨æˆ¶ IDï¼ˆæ”¯æ´å¤šç¨®æ ¼å¼ï¼‰
        let currentUserId = null;

        const authData = localStorage.getItem('auth-store');
        if (authData) {
          const parsed = JSON.parse(authData);
          currentUserId = parsed.state?.user?.id;
        }

        if (!currentUserId) {
          const localAuthData = localStorage.getItem('local-auth-store');
          if (localAuthData) {
            const parsed = JSON.parse(localAuthData);
            currentUserId = parsed.state?.currentProfile?.id || parsed.state?.activeProfile?.id;
          }
        }

        if (!currentUserId) {
          const employees = await getAllFromStore('employees');
          if (employees && employees.length > 0) {
            currentUserId = employees[0].id;
          }
        }

        if (!currentUserId) {
          alert('æ‰¾ä¸åˆ°ç•¶å‰ç™»å…¥ç”¨æˆ¶');
          return;
        }

        const todos = await getAllFromStore('todos');
        let fixed = 0;

        for (const todo of todos) {
          // ç¢ºä¿ visibility åŒ…å«ç•¶å‰ç”¨æˆ¶
          if (!todo.visibility) {
            todo.visibility = [currentUserId];
            await updateItem('todos', todo);
            fixed++;
          } else if (!todo.visibility.includes(currentUserId)) {
            todo.visibility.push(currentUserId);
            await updateItem('todos', todo);
            fixed++;
          }
        }

        alert(`âœ… å·²ä¿®æ­£ ${fixed} å€‹ä»£è¾¦äº‹é …çš„å¯è¦‹æ€§`);
        location.reload();

      } catch (error) {
        console.error('ä¿®æ­£å¤±æ•—:', error);
        alert('ä¿®æ­£å¤±æ•—: ' + error.message);
      }
    }

    // é é¢è¼‰å…¥æ™‚åŸ·è¡Œæª¢æŸ¥
    checkTodos();
  </script>
</body>
</html>
