# RLS Audit Report — 2026-02-18

## 1. workspace_id 表的 `IS NULL` 共用資料條件

有 workspace_id 且資料中存在 NULL 值的表，SELECT policy 需要包含 `workspace_id IS NULL` 條件才能讀到共用資料。

| 表名 | NULL 筆數 | SELECT policy 有 IS NULL | 狀態 |
|------|-----------|-------------------------|------|
| attractions | 2,414 | ✅ 有 | ✅ 通過 |
| cities | 3 | ✅ 有 | ✅ 通過 |
| countries | 0 | ✅ 有（預防性） | ✅ 通過 |
| regions | 0 | ✅ 有（預防性） | ✅ 通過 |
| ref_airports | 6,072 | ✅ 有 | ✅ 通過 |
| image_library | 0 | ✅ 有（預防性） | ✅ 通過 |
| tour_folder_templates | 12 | ✅ 有（via `workspace_id IS NULL OR ...`） | ✅ 通過 |
| members | 0 | ✅ 有（via `workspace_id IS NULL`） | ✅ 通過 |
| quote_items | 0 | ✅ 有（via `workspace_id IS NULL`） | ✅ 通過 |

✅ **結論：所有有共用資料的表都已正確處理 `workspace_id IS NULL` 條件。**

---

## 2. RLS 啟用狀態

```sql
SELECT tablename, rowsecurity FROM pg_tables WHERE schemaname = 'public' AND rowsecurity = false;
```

| 表名 | 狀態 |
|------|------|
| _migrations | ✅ 例外，不需 RLS |

✅ **結論：除了 `_migrations`，所有表都已啟用 RLS。**

---

## 3. INSERT/UPDATE/DELETE Policy 檢查

### ❌ RLS 啟用但完全沒有 Policy 的表（37 張 — 所有操作都會被拒絕）

| 表名 | 風險等級 |
|------|----------|
| assigned_itineraries | ⚠️ |
| badge_definitions | ⚠️ |
| customer_group_members | ⚠️ |
| friends | ⚠️ |
| heroic_summon_history | ⚠️ |
| heroic_summon_results | ⚠️ |
| itinerary_days | ❌ 高（行程核心表） |
| itinerary_items | ❌ 高（行程核心表） |
| journal_lines | ❌ 高（會計分錄） |
| private_messages | ⚠️ |
| quote_regions | ⚠️ |
| social_group_members | ⚠️ |
| social_groups | ⚠️ |
| split_bill_expenses | ⚠️ |
| split_bill_members | ⚠️ |
| split_bill_projects | ⚠️ |
| split_bill_splits | ⚠️ |
| tour_destinations | ⚠️ |
| tour_leaders | ⚠️ |
| traveler_expense_splits | ⚠️ |
| traveler_expenses | ⚠️ |
| traveler_friends | ⚠️ |
| traveler_profiles | ⚠️ |
| traveler_settlements | ⚠️ |
| traveler_split_group_members | ⚠️ |
| traveler_split_groups | ⚠️ |
| traveler_tour_cache | ⚠️ |
| traveler_trip_accommodations | ⚠️ |
| traveler_trip_briefings | ⚠️ |
| traveler_trip_flights | ⚠️ |
| traveler_trip_invitations | ⚠️ |
| traveler_trip_itinerary_items | ⚠️ |
| traveler_trip_members | ⚠️ |
| traveler_trips | ⚠️ |
| trip_members | ⚠️ |
| trip_members_v2 | ⚠️ |
| user_points_transactions | ⚠️ |

> **注意**：這些表 RLS 啟用但沒有任何 policy，意味著所有操作（包括 SELECT）都會被拒絕。如果目前透過 service_role 存取則不受影響，但前端直接呼叫會失敗。

#### 高優先修復 SQL（核心業務表）：

```sql
-- itinerary_days
CREATE POLICY "itinerary_days_select" ON itinerary_days FOR SELECT USING (
  is_super_admin() OR workspace_id::text = get_current_user_workspace()::text
);
CREATE POLICY "itinerary_days_insert" ON itinerary_days FOR INSERT WITH CHECK (
  is_super_admin() OR workspace_id::text = get_current_user_workspace()::text
);
CREATE POLICY "itinerary_days_update" ON itinerary_days FOR UPDATE USING (
  is_super_admin() OR workspace_id::text = get_current_user_workspace()::text
);
CREATE POLICY "itinerary_days_delete" ON itinerary_days FOR DELETE USING (
  is_super_admin() OR workspace_id::text = get_current_user_workspace()::text
);

-- itinerary_items
CREATE POLICY "itinerary_items_select" ON itinerary_items FOR SELECT USING (
  is_super_admin() OR workspace_id::text = get_current_user_workspace()::text
);
CREATE POLICY "itinerary_items_insert" ON itinerary_items FOR INSERT WITH CHECK (
  is_super_admin() OR workspace_id::text = get_current_user_workspace()::text
);
CREATE POLICY "itinerary_items_update" ON itinerary_items FOR UPDATE USING (
  is_super_admin() OR workspace_id::text = get_current_user_workspace()::text
);
CREATE POLICY "itinerary_items_delete" ON itinerary_items FOR DELETE USING (
  is_super_admin() OR workspace_id::text = get_current_user_workspace()::text
);

-- journal_lines
CREATE POLICY "journal_lines_select" ON journal_lines FOR SELECT USING (
  is_super_admin() OR workspace_id::text = get_current_user_workspace()::text
);
CREATE POLICY "journal_lines_insert" ON journal_lines FOR INSERT WITH CHECK (
  is_super_admin() OR workspace_id::text = get_current_user_workspace()::text
);
CREATE POLICY "journal_lines_update" ON journal_lines FOR UPDATE USING (
  is_super_admin() OR workspace_id::text = get_current_user_workspace()::text
);
CREATE POLICY "journal_lines_delete" ON journal_lines FOR DELETE USING (
  is_super_admin() OR workspace_id::text = get_current_user_workspace()::text
);
```

### ⚠️ 只有部分 Policy 的表（缺少某些操作）

| 表名 | 現有 Policy | 缺少 |
|------|------------|------|
| activities | SELECT | INSERT, UPDATE, DELETE |
| api_usage | SELECT | INSERT, UPDATE, DELETE |
| api_usage_log | SELECT | INSERT, UPDATE, DELETE |
| badges | SELECT | INSERT, UPDATE, DELETE |
| brochure_versions | SELECT, INSERT, DELETE | UPDATE |
| casual_trips | SELECT | INSERT, UPDATE, DELETE |
| channel_threads | SELECT | INSERT, UPDATE, DELETE |
| cron_execution_logs | SELECT | INSERT, UPDATE, DELETE |
| expense_monthly_stats | SELECT | INSERT, UPDATE, DELETE |
| expense_streaks | SELECT | INSERT, UPDATE, DELETE |
| itinerary_versions | SELECT, INSERT, DELETE | UPDATE |
| manifestation_records | SELECT | INSERT, UPDATE, DELETE |
| michelin_restaurants | SELECT | INSERT, UPDATE, DELETE |
| personal_expenses | SELECT | INSERT, UPDATE, DELETE |
| premium_experiences | SELECT | INSERT, UPDATE, DELETE |
| region_stats | SELECT | INSERT, UPDATE, DELETE |
| restaurants | SELECT | INSERT, UPDATE, DELETE |
| social_group_tags | SELECT | INSERT, UPDATE, DELETE |
| supplier_request_responses | SELECT, INSERT | UPDATE, DELETE |
| supplier_users | SELECT, INSERT, UPDATE | DELETE |
| syncqueue | SELECT | INSERT, UPDATE, DELETE |
| timebox_blocks | SELECT | INSERT, UPDATE, DELETE |
| timebox_boxes | SELECT | INSERT, UPDATE, DELETE |
| timebox_scheduled_boxes | SELECT | INSERT, UPDATE, DELETE |
| timebox_schedules | SELECT | INSERT, UPDATE, DELETE |
| timebox_weeks | SELECT | INSERT, UPDATE, DELETE |
| tour_table_assignments | SELECT, INSERT, DELETE | UPDATE |
| traveler_conversation_members | SELECT, INSERT, UPDATE | DELETE |
| workout_sets | SELECT | INSERT, UPDATE, DELETE |

> 大部分只有 SELECT 的表可能是唯讀的（view-like tables、reference data、stats）。
> 需要特別注意的是 **timebox_*** 系列和 **personal_expenses** — 如果前端有寫入需求則需要加 policy。

#### 修復 SQL（需要寫入的表）：

```sql
-- brochure_versions 缺 UPDATE
CREATE POLICY "brochure_versions_update" ON brochure_versions FOR UPDATE USING (
  EXISTS (SELECT 1 FROM brochure_documents d WHERE d.id = brochure_versions.document_id 
    AND (d.workspace_id = get_current_user_workspace() OR is_super_admin()))
);

-- itinerary_versions 缺 UPDATE
CREATE POLICY "itinerary_versions_update" ON itinerary_versions FOR UPDATE USING (
  EXISTS (SELECT 1 FROM itinerary_documents d WHERE d.id = itinerary_versions.document_id 
    AND (d.workspace_id = get_current_user_workspace() OR is_super_admin()))
);

-- tour_table_assignments 缺 UPDATE
CREATE POLICY "tour_table_assignments_update" ON tour_table_assignments FOR UPDATE USING (
  table_id IN (SELECT id FROM tour_tables WHERE workspace_id IN (
    SELECT workspace_id FROM profiles WHERE id = auth.uid()
  ))
);
```

---

## 4. Online API 路由 — 引用不存在的表

以下表在 Online API 中被引用，但 **資料庫中不存在**：

| 不存在的表 | 引用的 API 路由 | 前端入口 | 狀態 |
|-----------|----------------|---------|------|
| `conversations` | `/api/conversations/*`, `/api/communities/*`, `/api/trips/[id]/group-chat`, `/api/driver-tasks/[id]/conversation` | 無導航入口（MobileNav 中 explore 已被註解） | ⚠️ API 存在但表不存在 |
| `conversation_members` | 同上 | 同上 | ⚠️ |
| `messages`（Online用的） | 同上（注意：ERP 的 `messages` 表存在但結構不同） | 同上 | ⚠️ |
| `communities` | `/api/communities/*` | 無前端入口 | ⚠️ |
| `community_members` | `/api/communities/*` | 無前端入口 | ⚠️ |
| `posts` | `/api/posts/*` | `/profile/posts` 頁面存在但導航未開放 | ⚠️ |
| `post_comments` | `/api/posts/[id]/comments` | 同上 | ⚠️ |
| `post_likes` | `/api/posts/[id]/like` | 同上 | ⚠️ |
| `expense_splits` | `/api/splits/*` | `/explore/[id]/splits` 頁面存在 | ⚠️ |
| `expense_split_members` | `/api/splits/*` | 同上 | ⚠️ |
| `users` | `/api/communities/[id]/join` | 無前端入口 | ⚠️ |

> **注意**：`friends` 表存在但 Online API 引用的 `users` 表不存在。
> 
> 這些 API 路由目前不會造成安全問題（呼叫會直接回錯誤），但應該清理或建表。

---

## 5. ERP conversations 表引用

### 分析

`syncToOnline.ts` 在 `syncTripToOnline()` 函數中引用了 `conversations` 表：
- 第 113-125 行：查詢/建立行程群組聊天室
- 也引用了不存在的 `messages` 表（用於發送系統訊息）

### UI 入口

- `TourConfirmationSheetPage.tsx` 第 248 行呼叫 `syncTripToOnline(tour.id)`
- 這是確認單交接流程的一部分，**有 UI 入口**（確認單頁面的交接按鈕）

### 狀態

❌ **需要處理**：`syncTripToOnline` 會嘗試寫入不存在的 `conversations` 表，執行時會失敗。

目前程式碼有 try-catch 保護，conversation 建立失敗不會阻擋整個同步流程（有 `logger.warn`），但功能不完整。

### 建議

選項 A：建立 `conversations` 和 `conversation_members` 表（如果要啟用聊天功能）

```sql
CREATE TABLE conversations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  type TEXT NOT NULL DEFAULT 'direct',
  trip_id UUID REFERENCES online_trips(id),
  name TEXT,
  status TEXT DEFAULT 'active',
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

ALTER TABLE conversations ENABLE ROW LEVEL SECURITY;

-- 如果暫不啟用，加 service_role only policy
CREATE POLICY "conversations_service_role" ON conversations FOR ALL USING (auth.role() = 'service_role');
```

選項 B（建議）：移除 `syncToOnline.ts` 中 conversations 相關程式碼（第 109-136 行），等到要啟用聊天功能時再加回

---

## 6. 其他安全觀察

### ❌ 過於寬鬆的 Policy（`true` 作為條件）

| 表名 | Policy | 問題 |
|------|--------|------|
| ai_messages | `Allow all for ai_messages` — ALL, qual=true | 任何認證用戶可讀寫所有 AI 訊息 |
| pnr_passengers | ALL, qual=true | 任何認證用戶可讀寫所有旅客資料 |
| pnr_remarks | ALL, qual=true | 同上 |
| pnr_segments | ALL, qual=true | 同上 |
| pnr_ssr_elements | ALL, qual=true | 同上 |
| vendor_costs | ALL operations, qual=true | 任何認證用戶可讀寫所有供應商成本 |

```sql
-- 修復建議：加上 workspace_id 隔離
-- ai_messages（需先確認是否有 workspace_id 欄位）
DROP POLICY "Allow all for ai_messages" ON ai_messages;
CREATE POLICY "ai_messages_select" ON ai_messages FOR SELECT USING (
  is_super_admin() OR workspace_id::text = get_current_user_workspace()::text
);
-- ... 同理 INSERT/UPDATE/DELETE

-- vendor_costs
DROP POLICY "vendor_costs_select" ON vendor_costs;
DROP POLICY "vendor_costs_insert" ON vendor_costs;
DROP POLICY "vendor_costs_update" ON vendor_costs;
DROP POLICY "vendor_costs_delete" ON vendor_costs;
CREATE POLICY "vendor_costs_select" ON vendor_costs FOR SELECT USING (
  is_super_admin() OR workspace_id::text = get_current_user_workspace()::text
);
CREATE POLICY "vendor_costs_insert" ON vendor_costs FOR INSERT WITH CHECK (
  is_super_admin() OR workspace_id::text = get_current_user_workspace()::text
);
CREATE POLICY "vendor_costs_update" ON vendor_costs FOR UPDATE USING (
  is_super_admin() OR workspace_id::text = get_current_user_workspace()::text
);
CREATE POLICY "vendor_costs_delete" ON vendor_costs FOR DELETE USING (
  is_super_admin() OR workspace_id::text = get_current_user_workspace()::text
);
```

### ⚠️ `auth.role() = 'authenticated'` 的 ALL Policy（無 workspace 隔離）

這些表任何登入用戶都可以讀寫所有 workspace 的資料：

- accounting_accounts, accounting_categories, accounting_entries, accounting_transactions
- accounts, advance_items, advance_lists, budgets
- categories, cost_templates, cover_templates, daily_templates
- customer_badges, customer_travel_cards, disbursement_requests
- expense_categories, features_templates, flight_templates
- hotel_templates, hotels, leader_templates
- online_trip_members, pricing_templates, quote_categories
- quote_versions, receipt_payment_items, ref_airlines
- ref_booking_classes, ref_ssr_codes, ref_status_codes
- shared_order_lists, supplier_categories, supplier_payment_accounts
- supplier_price_list, supplier_service_areas, system_settings
- templates, tour_custom_cost_fields, tour_custom_cost_values
- tour_departure_data, tour_member_fields, tour_members
- tour_refunds, tour_request_items, tour_request_member_vouchers
- tour_request_messages, tour_room_assignments, tour_rooms
- tour_vehicle_assignments, tour_vehicles, transactions
- travel_card_templates, traveler_badges, user_badges
- user_roles, voucher_entries, workspace_items, workspaces

> 如果這些表有 workspace_id 欄位，應該改用 workspace 隔離 policy。
> 如果是 reference data（如 ref_airlines），只讀就夠了。

---

## 總結

| 類別 | 狀態 | 數量 |
|------|------|------|
| ✅ workspace_id IS NULL 條件 | 通過 | 9/9 表 |
| ✅ RLS 啟用 | 通過 | 只有 _migrations 例外 |
| ❌ 無任何 Policy 的表 | 需修復 | 37 張表 |
| ⚠️ 只有部分 Policy | 需評估 | 29 張表 |
| ❌ 過於寬鬆 (qual=true) | 需修復 | 6 張表 |
| ⚠️ authenticated-only 無隔離 | 需評估 | ~50 張表 |
| ⚠️ Online API 引用不存在的表 | 需清理 | 10 張表 |
| ❌ ERP conversations 引用 | 需處理 | 1 處 |
