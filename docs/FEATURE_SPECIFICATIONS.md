# VENTURO 5.0 åŠŸèƒ½è¦æ ¼è¡¨

**ç‰ˆæœ¬**: 1.0.0
**æ—¥æœŸ**: 2025-01-07
**ç›®çš„**: çµ±ä¸€å„åŠŸèƒ½çš„æ¬„ä½ã€APIã€ä¸²æ¥è¦ç¯„

---

## ğŸ“‹ åŠŸèƒ½æ¨¡çµ„ç¸½è¦½

VENTURO ç³»çµ±å…±æœ‰ **19 å€‹æ ¸å¿ƒåŠŸèƒ½æ¨¡çµ„**ï¼š

| # | åŠŸèƒ½æ¨¡çµ„ | è·¯å¾‘ | ç‹€æ…‹ | å„ªå…ˆç´š |
|---|---------|------|------|--------|
| 1 | ğŸ  å·¥ä½œå€ (Workspace) | `/workspace` | âœ… å·²å¯¦ä½œ | P0 |
| 2 | âœ… å¾…è¾¦äº‹é … (Todos) | `/todos` | âœ… å·²å¯¦ä½œ | P0 |
| 3 | ğŸ—“ï¸ è¡Œäº‹æ›† (Calendar) | `/calendar` | âœ… å·²å¯¦ä½œ | P0 |
| 4 | â° æ™‚é–“ç›’ (Timebox) | `/timebox` | âœ… å·²å¯¦ä½œ | P1 |
| 5 | ğŸ¨ æ—…éŠåœ˜ (Tours) | `/tours` | âš ï¸ éœ€ä¿®æ­£ | P0 |
| 6 | ğŸ“ è¡Œç¨‹è¡¨ (Itinerary) | `/itinerary` | âœ… å·²å¯¦ä½œ | P0 |
| 7 | ğŸ“‹ è¨‚å–® (Orders) | `/orders` | âš ï¸ éœ€ä¿®æ­£ | P0 |
| 8 | ğŸ’° å ±åƒ¹å–® (Quotes) | `/quotes` | âš ï¸ éœ€ä¿®æ­£ | P0 |
| 9 | ğŸ‘¥ å®¢æˆ¶ç®¡ç† (Customers) | `/customers` | âš ï¸ éœ€ä¿®æ­£ | P1 |
| 10 | ğŸ’³ è²¡å‹™ç®¡ç† (Finance) | `/finance` | âš ï¸ éœ€ä¿®æ­£ | P0 |
| 11 | ğŸ“Š æœƒè¨ˆç³»çµ± (Accounting) | `/accounting` | âš ï¸ éœ€ä¿®æ­£ | P0 |
| 12 | ğŸ‘” äººäº‹ç®¡ç† (HR) | `/hr` | âš ï¸ éœ€ä¿®æ­£ | P1 |
| 13 | ğŸŒ ç°½è­‰ç®¡ç† (Visas) | `/visas` | âš ï¸ éœ€ä¿®æ­£ | P2 |
| 14 | ğŸ—‚ï¸ åŸºç¤è³‡æ–™ (Database) | `/database` | âš ï¸ éœ€ä¿®æ­£ | P1 |
| 15 | ğŸ“„ æ¨¡æ¿ç³»çµ± (Templates) | `/templates` | âœ… å·²å¯¦ä½œ | P1 |
| 16 | ğŸ‘¤ æª”æ¡ˆç®¡ç† (Profile) | `/profile-manager` | âš ï¸ éœ€ä¿®æ­£ | P2 |
| 17 | ğŸ“š å°è¦½ (Guide) | `/guide` | âœ… å·²å¯¦ä½œ | P2 |
| 18 | âš™ï¸ ç³»çµ±è¨­å®š (Settings) | `/settings` | âœ… å·²å¯¦ä½œ | P1 |
| 19 | ğŸ” ç™»å…¥ç³»çµ± (Auth) | `/login` | âœ… å·²å¯¦ä½œ | P0 |

**å„ªå…ˆç´šèªªæ˜**ï¼š
- P0ï¼šæ ¸å¿ƒåŠŸèƒ½ï¼Œå¿…é ˆå„ªå…ˆä¿®å¾©
- P1ï¼šé‡è¦åŠŸèƒ½ï¼Œæ¬¡è¦å„ªå…ˆ
- P2ï¼šè¼”åŠ©åŠŸèƒ½ï¼Œæœ€å¾Œè™•ç†

---

## ğŸ“– åŠŸèƒ½è¦æ ¼è¡¨æ ¼ç¯„æœ¬

æ¯å€‹åŠŸèƒ½çš„è¦æ ¼è¡¨æ ¼åŒ…å«ä»¥ä¸‹ç« ç¯€ï¼š

### 1. åŸºæœ¬è³‡è¨Š
- åŠŸèƒ½åç¨±
- è·¯å¾‘
- ç‹€æ…‹
- è² è²¬äºº
- æ›´æ–°æ—¥æœŸ

### 2. åŠŸèƒ½èªªæ˜
- ç”¨é€”æè¿°
- ä¸»è¦ä½¿ç”¨è€…
- æ¥­å‹™æµç¨‹

### 3. è³‡æ–™æ¨¡å‹
- è³‡æ–™è¡¨åç¨±
- æ¬„ä½å®šç¾©ï¼ˆæ¬„ä½åã€å‹åˆ¥ã€å¿…å¡«ã€èªªæ˜ï¼‰
- é—œè¯é—œä¿‚

### 4. UI çµ„ä»¶
- é é¢çµ„ä»¶æ¸…å–®
- çµ„ä»¶æª”æ¡ˆè·¯å¾‘
- ä½¿ç”¨çš„ UI å…ƒä»¶

### 5. è³‡æ–™å±¤æ¶æ§‹
- Hookï¼ˆæ¥­å‹™é‚è¼¯å±¤ï¼‰
- Serviceï¼ˆAPI å±¤ï¼‰
- Storeï¼ˆç‹€æ…‹ç®¡ç†å±¤ï¼‰
- Databaseï¼ˆè³‡æ–™æŒä¹…å±¤ï¼‰

### 6. API ç«¯é»ï¼ˆPhase 3ï¼‰
- API è·¯å¾‘
- HTTP æ–¹æ³•
- è«‹æ±‚/å›æ‡‰æ ¼å¼

### 7. æ¬Šé™æ§åˆ¶
- å¯æ“ä½œè§’è‰²
- ç‰¹æ®Šé™åˆ¶

### 8. å·²çŸ¥å•é¡Œ
- æ¬„ä½å‘½åä¸ä¸€è‡´
- è³‡æ–™çµæ§‹è¡çª
- åŠŸèƒ½ç¼ºå¤±

---

## ğŸ  ç¯„ä¾‹ï¼šå·¥ä½œå€ (Workspace) åŠŸèƒ½è¦æ ¼

### 1. åŸºæœ¬è³‡è¨Š

| é …ç›® | å…§å®¹ |
|------|------|
| **åŠŸèƒ½åç¨±** | å·¥ä½œå€ (Workspace) |
| **è·¯å¾‘** | `/workspace` |
| **ç‹€æ…‹** | âœ… å·²å®Œæˆå¯¦ä½œ |
| **æ›´æ–°æ—¥æœŸ** | 2025-01-07 |

### 2. åŠŸèƒ½èªªæ˜

**ç”¨é€”æè¿°**ï¼š
- åœ˜éšŠå”ä½œä¸­å¿ƒ
- é »é“å¼è¨Šæ¯ç³»çµ±
- å€‹äºº Canvas ç­†è¨˜
- ä»»å‹™çœ‹æ¿æ•´åˆ

**ä¸»è¦ä½¿ç”¨è€…**ï¼š
- å…¨é«”å“¡å·¥

**æ¥­å‹™æµç¨‹**ï¼š
1. ä½¿ç”¨è€…é€²å…¥å·¥ä½œå€
2. æŸ¥çœ‹/åˆ‡æ›é »é“
3. ç™¼é€è¨Šæ¯ã€é™„ä»¶
4. ä½¿ç”¨å€‹äºº Canvas è¨˜éŒ„
5. æŸ¥çœ‹ä»»å‹™åˆ—è¡¨

### 3. è³‡æ–™æ¨¡å‹

#### 3.1 é »é“ (Channel)

| æ¬„ä½å | å‹åˆ¥ | å¿…å¡« | èªªæ˜ |
|--------|------|------|------|
| `id` | string (UUID) | âœ… | é »é“å”¯ä¸€è­˜åˆ¥ç¢¼ |
| `name` | string | âœ… | é »é“åç¨± |
| `description` | string | âŒ | é »é“èªªæ˜ |
| `type` | 'public' \| 'private' | âœ… | é »é“é¡å‹ |
| `creatorId` | string (UUID) | âœ… | å»ºç«‹è€… IDï¼ˆé—œè¯ Userï¼‰ |
| `memberIds` | string[] | âœ… | æˆå“¡ ID åˆ—è¡¨ |
| `createdAt` | string (ISO 8601) | âœ… | å»ºç«‹æ™‚é–“ |
| `updatedAt` | string (ISO 8601) | âœ… | æ›´æ–°æ™‚é–“ |

#### 3.2 è¨Šæ¯ (Message)

| æ¬„ä½å | å‹åˆ¥ | å¿…å¡« | èªªæ˜ |
|--------|------|------|------|
| `id` | string (UUID) | âœ… | è¨Šæ¯å”¯ä¸€è­˜åˆ¥ç¢¼ |
| `channelId` | string (UUID) | âœ… | æ‰€å±¬é »é“ ID |
| `senderId` | string (UUID) | âœ… | ç™¼é€è€… IDï¼ˆé—œè¯ Userï¼‰ |
| `content` | string | âœ… | è¨Šæ¯å…§å®¹ |
| `attachments` | Attachment[] | âŒ | é™„ä»¶åˆ—è¡¨ |
| `createdAt` | string (ISO 8601) | âœ… | ç™¼é€æ™‚é–“ |
| `updatedAt` | string (ISO 8601) | âœ… | æ›´æ–°æ™‚é–“ |
| `isEdited` | boolean | âœ… | æ˜¯å¦å·²ç·¨è¼¯ |

#### 3.3 Canvas ç­†è¨˜ (CanvasNote)

| æ¬„ä½å | å‹åˆ¥ | å¿…å¡« | èªªæ˜ |
|--------|------|------|------|
| `id` | string (UUID) | âœ… | ç­†è¨˜å”¯ä¸€è­˜åˆ¥ç¢¼ |
| `userId` | string (UUID) | âœ… | æ“æœ‰è€… ID |
| `title` | string | âœ… | ç­†è¨˜æ¨™é¡Œ |
| `content` | string | âœ… | ç­†è¨˜å…§å®¹ï¼ˆHTMLï¼‰ |
| `position` | { x: number, y: number } | âŒ | Canvas ä½ç½® |
| `createdAt` | string (ISO 8601) | âœ… | å»ºç«‹æ™‚é–“ |
| `updatedAt` | string (ISO 8601) | âœ… | æ›´æ–°æ™‚é–“ |

**é—œè¯é—œä¿‚**ï¼š
```
User (1) ----< (N) Channel (å»ºç«‹)
User (N) ----< (N) Channel (æˆå“¡)
Channel (1) ----< (N) Message
User (1) ----< (N) Message
User (1) ----< (N) CanvasNote
```

### 4. UI çµ„ä»¶

| çµ„ä»¶åç¨± | æª”æ¡ˆè·¯å¾‘ | èªªæ˜ |
|----------|---------|------|
| WorkspacePage | `src/app/workspace/page.tsx` | å·¥ä½œå€ä¸»é  |
| ChannelList | `src/components/workspace/channel-list.tsx` | é »é“åˆ—è¡¨ |
| ChannelView | `src/components/workspace/channel-view.tsx` | é »é“è¨Šæ¯è¦–åœ– |
| CanvasView | `src/components/workspace/canvas-view.tsx` | Canvas ç­†è¨˜è¦–åœ– |
| WorkspaceTaskList | `src/components/workspace/workspace-task-list.tsx` | ä»»å‹™åˆ—è¡¨ |
| CreateChannelDialog | `src/components/workspace/create-channel-dialog.tsx` | å»ºç«‹é »é“å°è©±æ¡† |

### 5. è³‡æ–™å±¤æ¶æ§‹

**ç›®å‰å¯¦ä½œ**ï¼š
```typescript
// Store å±¤ï¼ˆZustandï¼‰
src/stores/workspace-store.ts

// åŠŸèƒ½ï¼š
- channels: Channel[]              // é »é“åˆ—è¡¨
- currentChannelId: string | null  // ç•¶å‰é »é“
- messages: Message[]              // è¨Šæ¯åˆ—è¡¨
- canvasNotes: CanvasNote[]        // Canvas ç­†è¨˜

// Actions:
- createChannel(data)
- switchChannel(id)
- sendMessage(content)
- updateCanvasNote(id, data)
```

**æœªä¾† Phase 3 æ¶æ§‹**ï¼š
```
UI (WorkspacePage)
  â†“
Hook (useWorkspace)
  â†“
Service (WorkspaceService)
  â†“
API (/api/channels, /api/messages)
  â†“
Supabase (channels, messages, canvas_notes)
```

### 6. API ç«¯é»ï¼ˆPhase 3ï¼‰

| ç«¯é» | æ–¹æ³• | èªªæ˜ |
|------|------|------|
| `/api/channels` | GET | å–å¾—æ‰€æœ‰é »é“ |
| `/api/channels` | POST | å»ºç«‹æ–°é »é“ |
| `/api/channels/:id` | GET | å–å¾—é »é“è©³æƒ… |
| `/api/channels/:id` | PATCH | æ›´æ–°é »é“ |
| `/api/channels/:id` | DELETE | åˆªé™¤é »é“ |
| `/api/channels/:id/messages` | GET | å–å¾—é »é“è¨Šæ¯ |
| `/api/messages` | POST | ç™¼é€è¨Šæ¯ |
| `/api/canvas-notes` | GET | å–å¾—å€‹äºº Canvas |
| `/api/canvas-notes` | POST | å»ºç«‹ç­†è¨˜ |
| `/api/canvas-notes/:id` | PATCH | æ›´æ–°ç­†è¨˜ |

### 7. æ¬Šé™æ§åˆ¶

| æ“ä½œ | å…è¨±è§’è‰² | èªªæ˜ |
|------|---------|------|
| æŸ¥çœ‹å…¬é–‹é »é“ | æ‰€æœ‰äºº | - |
| æŸ¥çœ‹ç§äººé »é“ | é »é“æˆå“¡ | - |
| å»ºç«‹é »é“ | æ‰€æœ‰äºº | - |
| ç™¼é€è¨Šæ¯ | é »é“æˆå“¡ | - |
| ç·¨è¼¯é »é“ | é »é“å»ºç«‹è€…ã€ç®¡ç†å“¡ | - |
| åˆªé™¤é »é“ | é »é“å»ºç«‹è€…ã€ç®¡ç†å“¡ | - |
| Canvas ç­†è¨˜ | æœ¬äºº | å®Œå…¨ç§äºº |

### 8. å·²çŸ¥å•é¡Œ

- âœ… ç„¡å·²çŸ¥å•é¡Œï¼ˆæ–°å¯¦ä½œï¼Œæ¶æ§‹å®Œæ•´ï¼‰

---

---

## âœ… å¾…è¾¦äº‹é … (Todos) åŠŸèƒ½è¦æ ¼

### 1. åŸºæœ¬è³‡è¨Š

| é …ç›® | å…§å®¹ |
|------|------|
| **åŠŸèƒ½åç¨±** | å¾…è¾¦äº‹é … (Todos) |
| **è·¯å¾‘** | `/todos` |
| **ç‹€æ…‹** | âœ… å·²å®Œæˆå¯¦ä½œ |
| **æ›´æ–°æ—¥æœŸ** | 2025-01-07 |

### 2. åŠŸèƒ½èªªæ˜

**ç”¨é€”æè¿°**ï¼š
- ä»»å‹™ç®¡ç†ä¸­å¿ƒ
- æ”¯æ´å€‹äººå¾…è¾¦èˆ‡å°ˆæ¡ˆå¾…è¾¦
- å­ä»»å‹™åˆ†è§£
- é—œè¯å…¶ä»–æ¥­å‹™ï¼ˆæ—…éŠåœ˜ã€å ±åƒ¹å–®ã€è¨‚å–®ç­‰ï¼‰
- å¿«é€Ÿæ“ä½œï¼ˆå»ºç«‹æ”¶æ¬¾ã€å ±åƒ¹ã€åˆ†çµ„ç­‰ï¼‰
- å”ä½œèˆ‡é€šçŸ¥æ©Ÿåˆ¶

**ä¸»è¦ä½¿ç”¨è€…**ï¼š
- å…¨é«”å“¡å·¥

**æ¥­å‹™æµç¨‹**ï¼š
1. ä½¿ç”¨è€…å»ºç«‹å¾…è¾¦äº‹é …
2. è¨­å®šå„ªå…ˆç´šï¼ˆ1-5æ˜Ÿï¼‰ã€æˆªæ­¢æ—¥æœŸ
3. å¯æŒ‡æ´¾çµ¦å…¶ä»–äººæˆ–åˆ†äº«å”ä½œ
4. æ–°å¢å­ä»»å‹™ã€å‚™è¨»
5. é—œè¯æ¥­å‹™é …ç›®ï¼ˆæ—…éŠåœ˜ã€å ±åƒ¹å–®ç­‰ï¼‰
6. ä½¿ç”¨å¿«é€Ÿæ“ä½œå»ºç«‹ç›¸é—œå–®æ“š
7. å®Œæˆå¾Œæ¨™è¨˜å®Œæˆæˆ–å–æ¶ˆ

### 3. è³‡æ–™æ¨¡å‹

#### 3.1 å¾…è¾¦äº‹é … (Todo)

| æ¬„ä½å | å‹åˆ¥ | å¿…å¡« | èªªæ˜ |
|--------|------|------|------|
| `id` | string (UUID) | âœ… | å¾…è¾¦å”¯ä¸€è­˜åˆ¥ç¢¼ |
| `title` | string | âœ… | ä»»å‹™æ¨™é¡Œ |
| `description` | string | âŒ | ä»»å‹™æè¿° |
| `priority` | 1 \| 2 \| 3 \| 4 \| 5 | âœ… | æ˜Ÿç´šç·Šæ€¥åº¦ |
| `deadline` | string (ISO 8601) | âŒ | æˆªæ­¢æ—¥æœŸ |
| `status` | 'pending' \| 'in_progress' \| 'completed' \| 'cancelled' | âœ… | ä»»å‹™ç‹€æ…‹ |
| `completed` | boolean | âŒ | å®Œæˆæ¨™è¨˜ï¼ˆå°é½Šè³‡æ–™åº«ï¼‰ |
| `completedAt` | string (ISO 8601) | âŒ | å®Œæˆæ™‚é–“ï¼ˆç”¨æ–¼é›¢ç·šè¡çªè§£æ±ºï¼‰ |
| `type` | 'personal' \| 'project' | âŒ | å¾…è¾¦é¡å‹ï¼ˆé è¨­ personalï¼‰ |
| `parentId` | string (UUID) | âŒ | çˆ¶ä»»å‹™ IDï¼ˆå­ä»»å‹™ç”¨ï¼‰ |
| `projectId` | string (UUID) | âŒ | é—œè¯å°ˆæ¡ˆ IDï¼ˆæ—…éŠåœ˜/å ±åƒ¹å–®ï¼‰ |
| `projectType` | 'tour' \| 'quote' | âŒ | å°ˆæ¡ˆé¡å‹ |
| `creator` | string (UUID) | âœ… | å»ºç«‹è€… IDï¼ˆé—œè¯ Userï¼‰ |
| `assignee` | string (UUID) | âŒ | è¢«æŒ‡æ´¾è€… IDï¼ˆé—œè¯ Userï¼‰ |
| `sharedWith` | string[] | âœ… | å”ä½œè€… ID åˆ—è¡¨ |
| `visibility` | string[] | âœ… | å¯è¦‹äººå“¡ ID åˆ—è¡¨ |
| `lastModifiedBy` | string (UUID) | âŒ | æœ€å¾Œä¿®æ”¹è€… ID |
| `relatedItems` | RelatedItem[] | âœ… | é—œè¯æ¥­å‹™é …ç›®åˆ—è¡¨ |
| `subTasks` | SubTask[] | âœ… | å­ä»»å‹™åˆ—è¡¨ |
| `notes` | Note[] | âœ… | å‚™è¨»åˆ—è¡¨ |
| `enabledQuickActions` | QuickAction[] | âœ… | å•Ÿç”¨çš„å¿«é€Ÿæ“ä½œ |
| `needsCreatorNotification` | boolean | âŒ | éœ€é€šçŸ¥å»ºç«‹è€… |
| `createdAt` | string (ISO 8601) | âœ… | å»ºç«‹æ™‚é–“ |
| `updatedAt` | string (ISO 8601) | âœ… | æ›´æ–°æ™‚é–“ |

#### 3.2 é—œè¯é …ç›® (RelatedItem)

| æ¬„ä½å | å‹åˆ¥ | å¿…å¡« | èªªæ˜ |
|--------|------|------|------|
| `type` | 'group' \| 'quote' \| 'order' \| 'invoice' \| 'receipt' \| 'tour' \| 'payment' \| 'visa' | âœ… | é—œè¯é¡å‹ |
| `id` | string (UUID) | âœ… | é—œè¯é …ç›® ID |
| `title` | string | âœ… | é—œè¯é …ç›®æ¨™é¡Œ |

#### 3.3 å­ä»»å‹™ (SubTask)

| æ¬„ä½å | å‹åˆ¥ | å¿…å¡« | èªªæ˜ |
|--------|------|------|------|
| `id` | string (UUID) | âœ… | å­ä»»å‹™ ID |
| `title` | string | âœ… | å­ä»»å‹™æ¨™é¡Œ |
| `done` | boolean | âœ… | å®Œæˆç‹€æ…‹ |
| `completedAt` | string (ISO 8601) | âŒ | å®Œæˆæ™‚é–“ |

#### 3.4 å‚™è¨» (Note)

| æ¬„ä½å | å‹åˆ¥ | å¿…å¡« | èªªæ˜ |
|--------|------|------|------|
| `timestamp` | string (ISO 8601) | âœ… | æ™‚é–“æˆ³è¨˜ |
| `content` | string | âœ… | å‚™è¨»å…§å®¹ |
| `userId` | string (UUID) | âœ… | ç•™è¨€è€… ID |

#### 3.5 å¿«é€Ÿæ“ä½œé¡å‹ (QuickAction)

```typescript
type QuickAction = 'receipt' | 'invoice' | 'group' | 'quote' | 'assign';
```

**é—œè¯é—œä¿‚**ï¼š
```
User (1) ----< (N) Todo (å»ºç«‹è€…)
User (1) ----< (N) Todo (æŒ‡æ´¾è€…)
User (N) ----< (N) Todo (åˆ†äº«å”ä½œ)
Tour (1) ----< (N) Todo (å°ˆæ¡ˆé—œè¯)
Quote (1) ----< (N) Todo (å°ˆæ¡ˆé—œè¯)
Todo (1) ----< (N) Todo (çˆ¶å­ä»»å‹™)
```

### 4. UI çµ„ä»¶

| çµ„ä»¶åç¨± | æª”æ¡ˆè·¯å¾‘ | èªªæ˜ |
|----------|---------|------|
| TodosPage | `src/app/todos/page.tsx` | å¾…è¾¦äº‹é …ä¸»é  |
| TodoCardGroups | `src/components/todos/todo-card-groups.tsx` | å¡ç‰‡åˆ†çµ„è¦–åœ– |
| TodoExpandedView | `src/components/todos/todo-expanded-view.tsx` | å¾…è¾¦è©³ç´°è¦–åœ– |
| QuickReceipt | `src/components/todos/quick-actions/quick-receipt.tsx` | å¿«é€Ÿå»ºç«‹æ”¶æ¬¾ |
| QuickDisbursement | `src/components/todos/quick-actions/quick-disbursement.tsx` | å¿«é€Ÿå»ºç«‹æ’¥æ¬¾ |
| QuickGroup | `src/components/todos/quick-actions/quick-group.tsx` | å¿«é€Ÿå»ºç«‹åˆ†çµ„ |
| EnhancedTable | `src/components/ui/enhanced-table.tsx` | åˆ—è¡¨è¦–åœ–è¡¨æ ¼ |
| StarRating | `src/components/ui/star-rating.tsx` | å„ªå…ˆç´šæ˜Ÿç´šçµ„ä»¶ |

### 5. è³‡æ–™å±¤æ¶æ§‹

**ç›®å‰å¯¦ä½œï¼ˆPhase 1ï¼‰**ï¼š
```typescript
// Store å±¤ï¼ˆZustandï¼‰
src/stores/create-store.ts (å·¥å» å‡½æ•¸)
export const useTodoStore = createStore<Todo>('todos', 'TD');

// Hook å±¤ï¼ˆæ¥­å‹™é‚è¼¯ï¼‰
src/features/todos/hooks/useTodos.ts
- createTodo(data)
- updateTodo(id, data)
- deleteTodo(id)
- toggleTodo(id)
- loadTodos(userId)
- getTodosByUser(userId)
- getTodosByStatus(completed)
- getTodosByPriority(priority)
- getOverdueTodos()
- getTodayTodos()
- getUpcomingTodos(days)

// Service å±¤ï¼ˆè³‡æ–™é©—è­‰ï¼‰
src/features/todos/services/todo.service.ts
- validate(data): æ¨™é¡Œä¸èƒ½ç‚ºç©ºã€æ—¥æœŸæ ¼å¼æª¢æŸ¥
- toggleTodo(id)
- getTodosByUser(userId)
- getOverdueTodos()
```

**æœªä¾† Phase 3 æ¶æ§‹**ï¼š
```
UI (TodosPage)
  â†“
Hook (useTodos)
  â†“
Service (TodoService)
  â†“
API (/api/todos)
  â†“
Supabase (todos è¡¨)
```

### 6. API ç«¯é»ï¼ˆPhase 3ï¼‰

| ç«¯é» | æ–¹æ³• | èªªæ˜ |
|------|------|------|
| `/api/todos` | GET | å–å¾—å¾…è¾¦åˆ—è¡¨ï¼ˆå¯ç¯©é¸ userId, statusï¼‰ |
| `/api/todos` | POST | å»ºç«‹æ–°å¾…è¾¦ |
| `/api/todos/:id` | GET | å–å¾—å¾…è¾¦è©³æƒ… |
| `/api/todos/:id` | PATCH | æ›´æ–°å¾…è¾¦ |
| `/api/todos/:id` | DELETE | åˆªé™¤å¾…è¾¦ |
| `/api/todos/:id/toggle` | POST | åˆ‡æ›å®Œæˆç‹€æ…‹ |
| `/api/todos/:id/subtasks` | POST | æ–°å¢å­ä»»å‹™ |
| `/api/todos/:id/notes` | POST | æ–°å¢å‚™è¨» |

### 7. æ¬Šé™æ§åˆ¶

| æ“ä½œ | å…è¨±è§’è‰² | èªªæ˜ |
|------|---------|------|
| æŸ¥çœ‹å¾…è¾¦ | å»ºç«‹è€…ã€æŒ‡æ´¾è€…ã€åˆ†äº«è€… | æ ¹æ“š visibility æ¬„ä½ |
| å»ºç«‹å¾…è¾¦ | æ‰€æœ‰äºº | - |
| ç·¨è¼¯å¾…è¾¦ | å»ºç«‹è€…ã€æŒ‡æ´¾è€… | - |
| åˆªé™¤å¾…è¾¦ | å»ºç«‹è€… | åƒ…å»ºç«‹è€…å¯åˆªé™¤ |
| æ¨™è¨˜å®Œæˆ | å»ºç«‹è€…ã€æŒ‡æ´¾è€… | - |
| æ–°å¢å‚™è¨» | å»ºç«‹è€…ã€æŒ‡æ´¾è€…ã€åˆ†äº«è€… | å¯è¦‹å³å¯ç•™è¨€ |
| æ–°å¢å­ä»»å‹™ | å»ºç«‹è€…ã€æŒ‡æ´¾è€… | - |

### 8. å·²çŸ¥å•é¡Œ

#### 8.1 æ¬„ä½å‘½åå•é¡Œ
- âœ… å·²çµ±ä¸€ä½¿ç”¨ camelCase
- âœ… ç„¡ snake_case æ··ç”¨

#### 8.2 è³‡æ–™çµæ§‹å•é¡Œ
- âš ï¸ `completed` å’Œ `status` é›™é‡ç‹€æ…‹å¯èƒ½é€ æˆä¸ä¸€è‡´
  - å»ºè­°ï¼šçµ±ä¸€ç”¨ `status`ï¼Œç§»é™¤ `completed`ï¼ˆä½†éœ€ä¿ç•™ä»¥ç›¸å®¹è³‡æ–™åº«ï¼‰

#### 8.3 åŠŸèƒ½ç¼ºå¤±
- âš ï¸ å¿«é€Ÿæ“ä½œåŠŸèƒ½å°šæœªå®Œæ•´å¯¦ä½œ
  - `QuickReceipt` å·²å¯¦ä½œ
  - `QuickDisbursement` å·²å¯¦ä½œ
  - `QuickGroup` å·²å¯¦ä½œ
  - `QuickQuote`ã€`QuickAssign` å¾…å¯¦ä½œ

#### 8.4 é›¢ç·šè¡çªè™•ç†
- âš ï¸ `completedAt` æ¬„ä½è¨­è¨ˆç”¨æ–¼è¡çªè§£æ±ºï¼Œä½†å°šæœªå¯¦ä½œå®Œæ•´é‚è¼¯
- âš ï¸ å¤šäººåŒæ™‚ç·¨è¼¯åŒä¸€å¾…è¾¦çš„è¡çªè™•ç†ç­–ç•¥æœªå®šç¾©

#### 8.5 é€šçŸ¥æ©Ÿåˆ¶
- âš ï¸ `needsCreatorNotification` æ¬„ä½å·²æº–å‚™ï¼Œä½†é€šçŸ¥ç³»çµ±å°šæœªå¯¦ä½œ

### 9. ä¿®å¾©å»ºè­°

**å„ªå…ˆä¿®å¾©ï¼ˆP0ï¼‰**ï¼š
1. é‡æ¸… `completed` vs `status` çš„ä½¿ç”¨é‚è¼¯
2. çµ±ä¸€ã€Œçµæ¡ˆã€çš„è‹±æ–‡åç¨±ï¼ˆç›®å‰æ··ç”¨ 'completed'ï¼‰

**æ¬¡è¦ä¿®å¾©ï¼ˆP1ï¼‰**ï¼š
3. å®Œæˆå¿«é€Ÿæ“ä½œåŠŸèƒ½ï¼ˆQuickQuoteã€QuickAssignï¼‰
4. å¯¦ä½œé€šçŸ¥æ©Ÿåˆ¶

**æœªä¾†å„ªåŒ–ï¼ˆP2ï¼‰**ï¼š
5. å¯¦ä½œé›¢ç·šè¡çªè§£æ±ºç­–ç•¥
6. æ”¯æ´æ‹–æ‹‰æ’åº
7. æ”¯æ´æ‰¹æ¬¡æ“ä½œ

---

---

## ğŸ¨ æ—…éŠåœ˜ (Tours) åŠŸèƒ½è¦æ ¼

### 1. åŸºæœ¬è³‡è¨Š

| é …ç›® | å…§å®¹ |
|------|------|
| **åŠŸèƒ½åç¨±** | æ—…éŠåœ˜ç®¡ç† (Tours) |
| **è·¯å¾‘** | `/tours` |
| **ç‹€æ…‹** | âš ï¸ éœ€ä¿®æ­£ï¼ˆæ¬„ä½ä¸ä¸€è‡´ã€ç‹€æ…‹å‘½åå•é¡Œï¼‰ |
| **æ›´æ–°æ—¥æœŸ** | 2025-01-07 |

### 2. åŠŸèƒ½èªªæ˜

**ç”¨é€”æè¿°**ï¼š
- æ—…è¡Œç¤¾æ ¸å¿ƒæ¥­å‹™ç®¡ç†ç³»çµ±
- åœ˜é«”è³‡è¨Šå»ºç«‹èˆ‡ç®¡ç†
- è¨‚å–®ã€åœ˜å“¡ã€æ”¶æ¬¾ã€æˆæœ¬æ•´åˆ
- åŠ è³¼ã€é€€è²»è™•ç†
- åœ˜å‹™æ“ä½œèˆ‡æ–‡ä»¶ç®¡ç†
- è²¡å‹™è©¦ç®—èˆ‡å ±è¡¨

**ä¸»è¦ä½¿ç”¨è€…**ï¼š
- æ¥­å‹™äººå“¡ï¼ˆå»ºç«‹èˆ‡ç®¡ç†æ—…éŠåœ˜ï¼‰
- åŠ©ç†ï¼ˆåœ˜å“¡åå–®ã€æ–‡ä»¶ç¢ºèªï¼‰
- æœƒè¨ˆï¼ˆæ”¶æ¬¾ã€æˆæœ¬ï¼‰
- ç®¡ç†å±¤ï¼ˆè²¡å‹™å ±è¡¨ï¼‰

**æ¥­å‹™æµç¨‹**ï¼š
1. å¾å ±åƒ¹å–®è½‰æ›æˆ–ç›´æ¥å»ºç«‹æ—…éŠåœ˜
2. è‡ªå‹•ç”Ÿæˆåœ˜è™Ÿï¼ˆåœ°å€ç¢¼+æ—¥æœŸ+åºè™Ÿï¼‰
3. å»ºç«‹è¨‚å–®ï¼Œåˆ†é…çµ¦æ¥­å‹™èˆ‡åŠ©ç†
4. åœ˜å“¡è³‡æ–™ç™»è¨˜ï¼ˆè­·ç…§ã€ç°½è­‰ï¼‰
5. æˆ¿é–“åˆ†é…ã€åŠ è³¼è™•ç†
6. æ”¶æ¬¾è¨˜éŒ„ã€æˆæœ¬æ”¯å‡º
7. æ–‡ä»¶ç¢ºèªã€ç°½ç´„
8. åœ˜å‹™æŒ‡æ´¾èˆ‡åŸ·è¡Œ
9. çµæ¡ˆèˆ‡è²¡å‹™çµç®—

### 3. è³‡æ–™æ¨¡å‹

#### 3.1 æ—…éŠåœ˜ (Tour)

| æ¬„ä½å | å‹åˆ¥ | å¿…å¡« | èªªæ˜ |
|--------|------|------|------|
| `id` | string (UUID) | âœ… | æ—…éŠåœ˜å”¯ä¸€è­˜åˆ¥ç¢¼ |
| `code` | string | âœ… | åœ˜è™Ÿï¼ˆå¦‚ TYO250107001ï¼‰ |
| `name` | string | âœ… | æ—…éŠåœ˜åç¨± |
| `departureDate` | string (ISO 8601) | âœ… | å‡ºç™¼æ—¥æœŸ |
| `returnDate` | string (ISO 8601) | âœ… | è¿”å›æ—¥æœŸ |
| `status` | 'ææ¡ˆ' \| 'é€²è¡Œä¸­' \| 'å¾…çµæ¡ˆ' \| 'çµæ¡ˆ' \| 'ç‰¹æ®Šåœ˜' | âœ… | æ—…éŠåœ˜ç‹€æ…‹ |
| `location` | string | âœ… | ç›®çš„åœ° |
| `price` | number | âœ… | æ¯äººåƒ¹æ ¼ |
| `maxParticipants` | number | âœ… | æœ€å¤§åƒèˆ‡äººæ•¸ |
| `currentParticipants` | number | âŒ | ç•¶å‰åƒèˆ‡äººæ•¸ |
| `contractStatus` | 'æœªç°½ç½²' \| 'å·²ç°½ç½²' | âœ… | åˆç´„ç‹€æ…‹ |
| `totalRevenue` | number | âœ… | ç¸½æ”¶å…¥ |
| `totalCost` | number | âœ… | ç¸½æˆæœ¬ |
| `profit` | number | âœ… | åˆ©æ½¤ |
| `quoteId` | string (UUID) | âŒ | é—œè¯çš„å ±åƒ¹å–® ID |
| `quoteCostStructure` | QuoteCategory[] | âŒ | å ±åƒ¹æˆæœ¬çµæ§‹å¿«ç…§ |
| `isSpecial` | boolean | âŒ | æ˜¯å¦ç‚ºç‰¹æ®Šåœ˜ |
| `createdAt` | string (ISO 8601) | âœ… | å»ºç«‹æ™‚é–“ |
| `updatedAt` | string (ISO 8601) | âœ… | æ›´æ–°æ™‚é–“ |

#### 3.2 åŠ è³¼é …ç›® (TourAddOn)

| æ¬„ä½å | å‹åˆ¥ | å¿…å¡« | èªªæ˜ |
|--------|------|------|------|
| `id` | string (UUID) | âœ… | åŠ è³¼é …ç›® ID |
| `tourId` | string (UUID) | âœ… | æ‰€å±¬æ—…éŠåœ˜ ID |
| `name` | string | âœ… | åŠ è³¼é …ç›®åç¨± |
| `price` | number | âœ… | åƒ¹æ ¼ |
| `description` | string | âŒ | èªªæ˜ |
| `isActive` | boolean | âœ… | æ˜¯å¦å•Ÿç”¨ |
| `createdAt` | string (ISO 8601) | âœ… | å»ºç«‹æ™‚é–“ |
| `updatedAt` | string (ISO 8601) | âœ… | æ›´æ–°æ™‚é–“ |

#### 3.3 é€€è²»é …ç›® (TourRefund)

| æ¬„ä½å | å‹åˆ¥ | å¿…å¡« | èªªæ˜ |
|--------|------|------|------|
| `id` | string (UUID) | âœ… | é€€è²»é …ç›® ID |
| `tourId` | string (UUID) | âœ… | æ‰€å±¬æ—…éŠåœ˜ ID |
| `orderId` | string (UUID) | âœ… | è¨‚å–® ID |
| `orderNumber` | string | âœ… | è¨‚å–®è™Ÿç¢¼ |
| `memberName` | string | âœ… | åœ˜å“¡å§“å |
| `reason` | string | âœ… | é€€è²»åŸå›  |
| `amount` | number | âœ… | é€€è²»é‡‘é¡ |
| `status` | 'ç”³è«‹ä¸­' \| 'å·²æ ¸å‡†' \| 'å·²é€€æ¬¾' \| 'å·²æ‹’çµ•' | âœ… | é€€è²»ç‹€æ…‹ |
| `appliedDate` | string (ISO 8601) | âœ… | ç”³è«‹æ—¥æœŸ |
| `processedDate` | string (ISO 8601) | âŒ | è™•ç†æ—¥æœŸ |
| `notes` | string | âŒ | å‚™è¨» |
| `createdAt` | string (ISO 8601) | âœ… | å»ºç«‹æ™‚é–“ |
| `updatedAt` | string (ISO 8601) | âœ… | æ›´æ–°æ™‚é–“ |

#### 3.4 åœ˜è™Ÿç”Ÿæˆè¦å‰‡

**æ ¼å¼**ï¼š
- ä¸€èˆ¬åœ˜ï¼š`{åœ°å€ç¢¼}{YYMMDD}{åºè™Ÿ}`
  - ç¯„ä¾‹ï¼š`TYO250107001`ï¼ˆæ±äº¬ã€2025/01/07ã€ç¬¬1åœ˜ï¼‰
- ç‰¹æ®Šåœ˜ï¼š`SPC{YYMMDD}{åºè™Ÿ}`
  - ç¯„ä¾‹ï¼š`SPC250107001`

**åœ°å€ç¢¼å°ç…§è¡¨**ï¼š
| åœ°å€ | ä»£ç¢¼ |
|------|------|
| Tokyo æ±äº¬ | TYO |
| Osaka å¤§é˜ª | OSA |
| Kyoto äº¬éƒ½ | KYO |
| Okinawa æ²–ç¹© | OKA |
| Hokkaido åŒ—æµ·é“ | CTS |
| Fukuoka ç¦å²¡ | FUK |
| å…¶ä»– | UNK |

**é—œè¯é—œä¿‚**ï¼š
```
Quote (1) ----< (1) Tour (è½‰æ›)
Tour (1) ----< (N) Order (è¨‚å–®)
Order (1) ----< (N) Member (åœ˜å“¡)
Tour (1) ----< (N) TourAddOn (åŠ è³¼)
Tour (1) ----< (N) TourRefund (é€€è²»)
Tour (1) ----< (N) Payment (æ”¶æ¬¾)
Tour (1) ----< (N) Cost (æˆæœ¬)
Tour (1) ----< (N) Document (æ–‡ä»¶)
Tour (1) ----< (N) Task (ä»»å‹™)
```

### 4. UI çµ„ä»¶

| çµ„ä»¶åç¨± | æª”æ¡ˆè·¯å¾‘ | èªªæ˜ |
|----------|---------|------|
| ToursPage | `src/app/tours/page.tsx` | æ—…éŠåœ˜ä¸»é  |
| TourCard | `src/components/tours/tour-card.tsx` | æ—…éŠåœ˜å¡ç‰‡ |
| TourOverview | `src/components/tours/tour-overview.tsx` | ç¸½è¦½è¦–åœ– |
| TourMembers | `src/components/tours/tour-members.tsx` | åœ˜å“¡åå–® |
| TourOperations | `src/components/tours/tour-operations.tsx` | åœ˜å‹™ç®¡ç† |
| TourAddOns | `src/components/tours/tour-add-ons.tsx` | åŠ è³¼ç®¡ç† |
| TourRefunds | `src/components/tours/tour-refunds.tsx` | é€€è²»ç®¡ç† |
| TourPayments | `src/components/tours/tour-payments.tsx` | æ”¶æ¬¾è¨˜éŒ„ |
| TourCosts | `src/components/tours/tour-costs.tsx` | æˆæœ¬æ”¯å‡º |
| TourDocuments | `src/components/tours/tour-documents.tsx` | æ–‡ä»¶ç¢ºèª |
| TourTaskAssignment | `src/components/tours/tour-task-assignment.tsx` | ä»»å‹™æŒ‡æ´¾ |
| RoomAllocation | `src/components/tours/room-allocation.tsx` | æˆ¿é–“åˆ†é… |
| ExpandableOrderTable | `src/components/orders/expandable-order-table.tsx` | è¨‚å–®å¯å±•é–‹è¡¨æ ¼ |

### 5. è³‡æ–™å±¤æ¶æ§‹

**ç›®å‰å¯¦ä½œï¼ˆPhase 1ï¼‰**ï¼š
```typescript
// Store å±¤ï¼ˆZustandï¼‰
src/stores/create-store.ts (å·¥å» å‡½æ•¸)
export const useTourStore = createStore<Tour>('tours', 'TR');

// Hook å±¤ï¼ˆæ¥­å‹™é‚è¼¯ï¼‰
src/features/tours/hooks/useTours-advanced.ts
- useTours(params): åˆ—è¡¨æŸ¥è©¢
  - data, totalCount, loading, error
  - create, update, delete, refresh

- useTourDetails(tourId): å–®å€‹è©³æƒ…
  - tour, financials, loading, error
  - updateStatus, generateCode, refresh

// Service å±¤ï¼ˆè³‡æ–™é©—è­‰ï¼‰
src/features/tours/services/tour.service.ts
- validate(data):
  - åç¨±é•·åº¦æª¢æŸ¥
  - äººæ•¸ > 0
  - åƒ¹æ ¼ >= 0
  - å‡ºç™¼æ—¥ä¸èƒ½éå»
  - è¿”å›æ—¥ >= å‡ºç™¼æ—¥

- generateTourCode(location, date, isSpecial): ç”Ÿæˆåœ˜è™Ÿ
- isTourCodeExists(code): æª¢æŸ¥åœ˜è™Ÿé‡è¤‡
- calculateFinancialSummary(tourId): è²¡å‹™æ‘˜è¦
- canCancelTour(tourId): æª¢æŸ¥å¯å¦å–æ¶ˆ
- updateTourStatus(tourId, status, reason): æ›´æ–°ç‹€æ…‹
```

**æœªä¾† Phase 3 æ¶æ§‹**ï¼š
```
UI (ToursPage)
  â†“
Hook (useTours)
  â†“
Service (TourService)
  â†“
API (/api/tours)
  â†“
Supabase (tours, tour_addons, tour_refunds è¡¨)
```

### 6. API ç«¯é»ï¼ˆPhase 3ï¼‰

| ç«¯é» | æ–¹æ³• | èªªæ˜ |
|------|------|------|
| `/api/tours` | GET | å–å¾—æ—…éŠåœ˜åˆ—è¡¨ï¼ˆåˆ†é ã€ç¯©é¸ï¼‰ |
| `/api/tours` | POST | å»ºç«‹æ–°æ—…éŠåœ˜ |
| `/api/tours/:id` | GET | å–å¾—æ—…éŠåœ˜è©³æƒ… |
| `/api/tours/:id` | PATCH | æ›´æ–°æ—…éŠåœ˜ |
| `/api/tours/:id` | DELETE | åˆªé™¤æ—…éŠåœ˜ |
| `/api/tours/:id/status` | PATCH | æ›´æ–°æ—…éŠåœ˜ç‹€æ…‹ |
| `/api/tours/:id/financials` | GET | å–å¾—è²¡å‹™æ‘˜è¦ |
| `/api/tours/:id/addons` | GET/POST | åŠ è³¼é …ç›® |
| `/api/tours/:id/refunds` | GET/POST | é€€è²»é …ç›® |
| `/api/tours/generate-code` | POST | ç”Ÿæˆåœ˜è™Ÿ |

### 7. æ¬Šé™æ§åˆ¶

| æ“ä½œ | å…è¨±è§’è‰² | èªªæ˜ |
|------|---------|------|
| æŸ¥çœ‹æ—…éŠåœ˜ | æ‰€æœ‰äºº | - |
| å»ºç«‹æ—…éŠåœ˜ | æ¥­å‹™ã€ç®¡ç†å“¡ | - |
| ç·¨è¼¯æ—…éŠåœ˜ | æ¥­å‹™ã€ç®¡ç†å“¡ | - |
| åˆªé™¤æ—…éŠåœ˜ | ç®¡ç†å“¡ | éœ€æª¢æŸ¥ç„¡è¨‚å–® |
| æŸ¥çœ‹è²¡å‹™ | æ¥­å‹™ï¼ˆè‡ªå·±çš„ï¼‰ã€ç®¡ç†å±¤ã€æœƒè¨ˆ | - |
| ç®¡ç†åŠ è³¼/é€€è²» | æ¥­å‹™ã€åŠ©ç†ã€ç®¡ç†å“¡ | - |
| çµæ¡ˆ | ç®¡ç†å“¡ã€æœƒè¨ˆ | - |

### 8. å·²çŸ¥å•é¡Œ

#### 8.1 æ¬„ä½å‘½åå•é¡Œ
- âœ… å¤§éƒ¨åˆ†æ¬„ä½å·²çµ±ä¸€ä½¿ç”¨ camelCase
- âš ï¸ ç„¡ snake_case å•é¡Œ

#### 8.2 ç‹€æ…‹å‘½åæ··äº‚ï¼ˆåš´é‡ï¼‰
- âŒ **ç‹€æ…‹å€¼ä½¿ç”¨ä¸­æ–‡**ï¼š`'ææ¡ˆ' | 'é€²è¡Œä¸­' | 'å¾…çµæ¡ˆ' | 'çµæ¡ˆ' | 'ç‰¹æ®Šåœ˜'`
- **å•é¡Œ**ï¼š
  1. ä¸­æ–‡ä¸åˆ©æ–¼åœ‹éš›åŒ–
  2. é›£ä»¥åœ¨ç¨‹å¼ç¢¼ä¸­ä½¿ç”¨ï¼ˆéœ€è¦å­—ä¸²æ¯”å°ï¼‰
  3. èˆ‡å…¶ä»–æ¨¡çµ„ä¸ä¸€è‡´ï¼ˆOrders ç”¨è‹±æ–‡ï¼‰
  4. 'çµæ¡ˆ' é‡è¤‡å‡ºç¾åœ¨ç¨‹å¼ç¢¼ä¸­ï¼ˆå–æ¶ˆå’Œå®Œæˆéƒ½å«çµæ¡ˆï¼‰

- **å»ºè­°æ”¹ç‚º**ï¼š
  ```typescript
  status: 'draft' | 'active' | 'pending_close' | 'closed' | 'special'
  ```

#### 8.3 ç‹€æ…‹é‚è¼¯é‡è¤‡
- âš ï¸ `isSpecial` æ¬„ä½èˆ‡ `status === 'ç‰¹æ®Šåœ˜'` é‡è¤‡
- **å»ºè­°**ï¼šç§»é™¤ `isSpecial`ï¼Œç”¨ `status === 'special'` åˆ¤æ–·

#### 8.4 è³‡æ–™è¨ˆç®—å•é¡Œ
- âš ï¸ `currentParticipants` æ‡‰è©²è‡ªå‹•è¨ˆç®—ï¼ˆå¾ Orders å’Œ Members çµ±è¨ˆï¼‰
- âš ï¸ `totalRevenue`, `totalCost`, `profit` æ‡‰è©²å‹•æ…‹è¨ˆç®—ï¼Œè€Œéå„²å­˜

#### 8.5 åˆç´„ç‹€æ…‹ä¸è¶³
- âš ï¸ `contractStatus` åªæœ‰ã€Œæœªç°½ç½²/å·²ç°½ç½²ã€ï¼Œç¼ºå°‘ã€Œå¾…ç°½ç½²ã€ã€ã€Œéƒ¨åˆ†ç°½ç½²ã€ç‹€æ…‹

#### 8.6 è²¡å‹™è¨ˆç®—é‚è¼¯å•é¡Œ
- âš ï¸ `calculateFinancialSummary` ä½¿ç”¨å‡è³‡æ–™ï¼ˆæˆæœ¬ = æ”¶å…¥ * 0.7ï¼‰
- éœ€æ•´åˆçœŸå¯¦çš„è¨‚å–®ã€æ”¶æ¬¾ã€æˆæœ¬è³‡æ–™

#### 8.7 åœ˜è™Ÿç”Ÿæˆé‡è¤‡æª¢æŸ¥
- âœ… å·²å¯¦ä½œ `isTourCodeExists` å’Œæ™‚é–“æˆ³å‚™æ¡ˆæ©Ÿåˆ¶

#### 8.8 ç¼ºå°‘å¿…è¦æ¬„ä½
- âš ï¸ ç¼ºå°‘ `description`ï¼ˆè¡Œç¨‹æè¿°ï¼‰
- âš ï¸ ç¼ºå°‘ `leadGuide`ï¼ˆé ˜éšŠï¼‰
- âš ï¸ ç¼ºå°‘ `notes`ï¼ˆå…§éƒ¨å‚™è¨»ï¼‰
- âš ï¸ ç¼ºå°‘ `cancellationReason`ï¼ˆå–æ¶ˆåŸå› ï¼‰
- âš ï¸ ç¼ºå°‘ `closedAt`ï¼ˆçµæ¡ˆæ™‚é–“ï¼‰

### 9. ä¿®å¾©å»ºè­°

**å„ªå…ˆä¿®å¾©ï¼ˆP0ï¼‰**ï¼š
1. **çµ±ä¸€ç‹€æ…‹å‘½åç‚ºè‹±æ–‡**ï¼š
   ```typescript
   status: 'draft' | 'active' | 'pending_close' | 'closed' | 'cancelled' | 'special'
   ```
2. **ç§»é™¤ `isSpecial` æ¬„ä½**ï¼Œæ”¹ç”¨ `status === 'special'`
3. **è²¡å‹™æ¬„ä½æ”¹ç‚ºå‹•æ…‹è¨ˆç®—**ï¼Œä¸å„²å­˜æ–¼ Tour è¡¨

**æ¬¡è¦ä¿®å¾©ï¼ˆP1ï¼‰**ï¼š
4. æ–°å¢å¿…è¦æ¬„ä½ï¼ˆdescription, leadGuide, notes, cancellationReason, closedAtï¼‰
5. æ“´å…… `contractStatus` ç‹€æ…‹
6. å¯¦ä½œçœŸå¯¦çš„è²¡å‹™è¨ˆç®—é‚è¼¯

**æœªä¾†å„ªåŒ–ï¼ˆP2ï¼‰**ï¼š
7. æ”¯æ´å¤šå¹£åˆ¥
8. åœ˜é«”è¤‡è£½åŠŸèƒ½
9. æ‰¹æ¬¡æ“ä½œï¼ˆæ‰¹æ¬¡çµæ¡ˆã€æ‰¹æ¬¡åŒ¯å‡ºï¼‰
10. åœ˜é«”ç¯„æœ¬

### 10. è³‡æ–™è¡¨å»ºè­°ï¼ˆPhase 3ï¼‰

```sql
CREATE TABLE tours (
  id UUID PRIMARY KEY,
  code VARCHAR(20) UNIQUE NOT NULL,
  name VARCHAR(255) NOT NULL,
  description TEXT,
  departure_date DATE NOT NULL,
  return_date DATE NOT NULL,
  status VARCHAR(20) NOT NULL, -- 'draft', 'active', 'pending_close', 'closed', 'cancelled', 'special'
  location VARCHAR(100) NOT NULL,
  price DECIMAL(10,2) NOT NULL,
  max_participants INTEGER NOT NULL,
  contract_status VARCHAR(20) NOT NULL, -- 'pending', 'partial', 'signed'
  lead_guide VARCHAR(100),
  quote_id UUID REFERENCES quotes(id),
  quote_cost_structure JSONB,
  notes TEXT,
  cancellation_reason TEXT,
  closed_at TIMESTAMP,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- è‡ªå‹•è¨ˆç®—æ¬„ä½é€é VIEW
CREATE VIEW tours_with_stats AS
SELECT
  t.*,
  COUNT(DISTINCT o.id) as order_count,
  SUM(o.member_count) as current_participants,
  SUM(p.amount) as total_revenue,
  SUM(c.amount) as total_cost,
  SUM(p.amount) - SUM(c.amount) as profit
FROM tours t
LEFT JOIN orders o ON o.tour_id = t.id
LEFT JOIN payments p ON p.tour_id = t.id
LEFT JOIN costs c ON c.tour_id = t.id
GROUP BY t.id;
```

---

## ğŸ“ è¡Œç¨‹è¡¨ (Itinerary) åŠŸèƒ½è¦æ ¼

### 1. åŸºæœ¬è³‡è¨Š

| é …ç›® | å…§å®¹ |
|------|------|
| **åŠŸèƒ½åç¨±** | è¡Œç¨‹è¡¨ç®¡ç† (Itinerary) |
| **è·¯å¾‘** | `/itinerary` |
| **ç‹€æ…‹** | âœ… å·²å®Œæˆå¯¦ä½œ |
| **æ›´æ–°æ—¥æœŸ** | 2025-01-07 |

### 2. åŠŸèƒ½èªªæ˜

**ç”¨é€”æè¿°**ï¼š
- æ—…éŠè¡Œç¨‹çš„è¦–è¦ºåŒ–å±•ç¤ºç³»çµ±
- æ”¯æ´é›»è…¦ç‰ˆå’Œæ‰‹æ©Ÿç‰ˆå³æ™‚é è¦½
- å¯ç”¢ç”Ÿå¤–éƒ¨åˆ†äº«é€£çµ
- èˆ‡æ—…éŠåœ˜ã€å ±åƒ¹å–®äº’ç›¸é—œè¯
- è‡ªå‹•å¸¶å…¥å¤©æ•¸ã€èˆªç­ã€é£¯åº—è³‡è¨Š

**ä¸»è¦ä½¿ç”¨è€…**ï¼š
- æ¥­å‹™äººå“¡ï¼ˆå»ºç«‹èˆ‡ç·¨è¼¯è¡Œç¨‹ï¼‰
- å®¢æˆ¶ï¼ˆç€è¦½å¤–éƒ¨åˆ†äº«é é¢ï¼‰
- ç®¡ç†å±¤ï¼ˆå¯©æ ¸è¡Œç¨‹å…§å®¹ï¼‰

**æ¥­å‹™æµç¨‹**ï¼š
1. å¾å ±åƒ¹å–®è½‰æ›æˆ–ç›´æ¥å»ºç«‹è¡Œç¨‹
2. è¼¸å…¥å°é¢è³‡è¨Šï¼ˆæ¨™é¡Œã€åœ–ç‰‡ã€åœ°é»ã€æ—¥æœŸï¼‰
3. è¨­å®šèˆªç­è³‡è¨Šï¼ˆå»å›ç¨‹ï¼‰
4. æ·»åŠ è¡Œç¨‹ç‰¹è‰²å’Œç²¾é¸æ™¯é»
5. å»ºç«‹é€æ—¥è¡Œç¨‹ï¼ˆæ™¯é»ã€é¤é£Ÿã€ä½å®¿ï¼‰
6. å³æ™‚é è¦½é›»è…¦ç‰ˆ/æ‰‹æ©Ÿç‰ˆæ•ˆæœ
7. ç™¼ä½ˆä¸¦ç”¢ç”Ÿåˆ†äº«é€£çµ
8. å®¢æˆ¶é€éå¤–éƒ¨é€£çµç€è¦½

### 3. è³‡æ–™æ¨¡å‹

#### 3.1 è¡Œç¨‹è¡¨ (Itinerary)

**æ ¸å¿ƒèªªæ˜**ï¼šè¡Œç¨‹è¡¨å¯¦éš›ä¸Šæ˜¯ **Tour è³‡æ–™çš„æ“´å……ç‰ˆæœ¬**ï¼Œåœ¨ Tour Store ä¸­å‚¨å­˜ï¼Œä½†åŒ…å«äº†å¤§é‡å±•ç¤ºç”¨æ¬„ä½ã€‚

| æ¬„ä½å | å‹åˆ¥ | å¿…å¡« | èªªæ˜ | âš ï¸ å•é¡Œ |
|--------|------|------|------|--------|
| `id` | string (UUID) | âœ… | è¡Œç¨‹å”¯ä¸€è­˜åˆ¥ç¢¼ | |
| `tourCode` | string | âœ… | è¡Œç¨‹ç·¨è™Ÿï¼ˆ25JFO21CIGï¼‰ | |
| `title` | string | âœ… | ä¸»æ¨™é¡Œï¼ˆæ¼«éŠç¦å²¡ï¼‰ | |
| `subtitle` | string | â“ | å‰¯æ¨™é¡Œï¼ˆåŠè‡ªç”±è¡Œï¼‰ | |
| `tagline` | string | â“ | æ¨™ç±¤æ–‡å­—ï¼ˆVenturo 2025ï¼‰ | |
| `description` | string | âœ… | è¡Œç¨‹æè¿° | |
| `country` | string | âœ… | åœ‹å®¶ | |
| `city` | string | âœ… | åŸå¸‚ | |
| `departureDate` | string (YYYY/MM/DD) | âœ… | å‡ºç™¼æ—¥æœŸ | |
| `coverImage` | string (URL) | âœ… | å°é¢åœ–ç‰‡ | |
| `status` | 'è‰ç¨¿' \| 'å·²ç™¼ä½ˆ' | âœ… | è¡Œç¨‹ç‹€æ…‹ | âš ï¸ **ä¸­æ–‡å€¼** |
| `outboundFlight` | FlightInfo | âœ… | å»ç¨‹èˆªç­ | |
| `returnFlight` | FlightInfo | âœ… | å›ç¨‹èˆªç­ | |
| `features` | Feature[] | âœ… | è¡Œç¨‹ç‰¹è‰²åˆ—è¡¨ | |
| `focusCards` | FocusCard[] | âœ… | ç²¾é¸æ™¯é»å¡ç‰‡ | |
| `leader` | LeaderInfo | âœ… | é ˜éšŠè³‡è¨Š | |
| `meetingInfo` | MeetingInfo | âœ… | é›†åˆè³‡è¨Š | |
| `itinerarySubtitle` | string | â“ | è¡Œç¨‹å‰¯æ¨™é¡Œ | |
| `dailyItinerary` | DailyItinerary[] | âœ… | é€æ—¥è¡Œç¨‹åˆ—è¡¨ | |
| `created_at` | string (ISO 8601) | âœ… | å»ºç«‹æ™‚é–“ | |
| `updated_at` | string (ISO 8601) | âœ… | æ›´æ–°æ™‚é–“ | |

#### 3.2 èˆªç­è³‡è¨Š (FlightInfo)

| æ¬„ä½å | å‹åˆ¥ | å¿…å¡« | èªªæ˜ |
|--------|------|------|------|
| `airline` | string | âœ… | èˆªç©ºå…¬å¸ï¼ˆä¸­è¯èˆªç©ºï¼‰ |
| `flightNumber` | string | âœ… | èˆªç­è™Ÿç¢¼ï¼ˆCI110ï¼‰ |
| `departureAirport` | string | âœ… | å‡ºç™¼æ©Ÿå ´ï¼ˆTPEï¼‰ |
| `departureTime` | string | âœ… | å‡ºç™¼æ™‚é–“ï¼ˆ06:50ï¼‰ |
| `departureDate` | string | âœ… | å‡ºç™¼æ—¥æœŸï¼ˆ10/21ï¼‰ |
| `arrivalAirport` | string | âœ… | æŠµé”æ©Ÿå ´ï¼ˆFUKï¼‰ |
| `arrivalTime` | string | âœ… | æŠµé”æ™‚é–“ï¼ˆ09:55ï¼‰ |
| `duration` | string | âœ… | é£›è¡Œæ™‚é–“ï¼ˆè‡ªå‹•è¨ˆç®—ï¼‰ |

#### 3.3 è¡Œç¨‹ç‰¹è‰² (Feature)

| æ¬„ä½å | å‹åˆ¥ | å¿…å¡« | èªªæ˜ |
|--------|------|------|------|
| `icon` | string | âœ… | åœ–ç¤ºåç¨±ï¼ˆIconBuildingï¼‰ |
| `title` | string | âœ… | ç‰¹è‰²æ¨™é¡Œ |
| `description` | string | âœ… | ç‰¹è‰²æè¿° |

**å¯ç”¨åœ–ç¤º**ï¼š
- `IconBuilding`: ğŸ¨ å»ºç¯‰/é£¯åº—
- `IconToolsKitchen2`: ğŸ½ï¸ é¤é£Ÿ
- `IconSparkles`: âœ¨ ç‰¹è‰²
- `IconCalendar`: ğŸ“… è¡Œç¨‹
- `IconPlane`: âœˆï¸ èˆªç­
- `IconMapPin`: ğŸ“ æ™¯é»

#### 3.4 ç²¾é¸æ™¯é» (FocusCard)

| æ¬„ä½å | å‹åˆ¥ | å¿…å¡« | èªªæ˜ |
|--------|------|------|------|
| `title` | string | âœ… | æ™¯é»åç¨± |
| `src` | string (URL) | âœ… | æ™¯é»åœ–ç‰‡ |

#### 3.5 é ˜éšŠè³‡è¨Š (LeaderInfo)

| æ¬„ä½å | å‹åˆ¥ | å¿…å¡« | èªªæ˜ |
|--------|------|------|------|
| `name` | string | âœ… | é ˜éšŠå§“å |
| `domesticPhone` | string | âœ… | åœ‹å…§é›»è©± |
| `overseasPhone` | string | âœ… | åœ‹å¤–é›»è©± |

#### 3.6 é›†åˆè³‡è¨Š (MeetingInfo)

| æ¬„ä½å | å‹åˆ¥ | å¿…å¡« | èªªæ˜ |
|--------|------|------|------|
| `time` | string | âœ… | é›†åˆæ™‚é–“ |
| `location` | string | âœ… | é›†åˆåœ°é» |

#### 3.7 é€æ—¥è¡Œç¨‹ (DailyItinerary)

| æ¬„ä½å | å‹åˆ¥ | å¿…å¡« | èªªæ˜ |
|--------|------|------|------|
| `dayLabel` | string | âœ… | æ—¥æœŸæ¨™ç±¤ï¼ˆDay 1ï¼‰ |
| `date` | string | âœ… | æ—¥æœŸï¼ˆ10/21 (äºŒ)ï¼‰ |
| `title` | string | âœ… | ç•¶æ—¥ä¸»é¡Œ |
| `highlight` | string | â“ | ç‰¹åˆ¥å®‰æ’ |
| `description` | string | â“ | ç•¶æ—¥æè¿° |
| `activities` | Activity[] | â“ | æ™¯é»æ´»å‹•åˆ—è¡¨ |
| `recommendations` | string[] | â“ | æ¨è–¦è¡Œç¨‹åˆ—è¡¨ |
| `meals` | Meals | âœ… | é¤é£Ÿå®‰æ’ |
| `accommodation` | string | â“ | ä½å®¿é£¯åº— |

#### 3.8 æ™¯é»æ´»å‹• (Activity)

| æ¬„ä½å | å‹åˆ¥ | å¿…å¡« | èªªæ˜ |
|--------|------|------|------|
| `icon` | string | âœ… | emoji åœ–ç¤ºï¼ˆğŸŒ‹ï¼‰ |
| `title` | string | âœ… | æ´»å‹•åç¨± |
| `description` | string | â“ | æ´»å‹•èªªæ˜ |

#### 3.9 é¤é£Ÿ (Meals)

| æ¬„ä½å | å‹åˆ¥ | å¿…å¡« | èªªæ˜ |
|--------|------|------|------|
| `breakfast` | string | âœ… | æ—©é¤å®‰æ’ |
| `lunch` | string | âœ… | åˆé¤å®‰æ’ |
| `dinner` | string | âœ… | æ™šé¤å®‰æ’ |

#### 3.10 èˆ‡å…¶ä»–æ¨¡çµ„çš„é—œè¯

```
Quote (1) ----< (1) Itinerary (å¾å ±åƒ¹å–®è½‰æ›)
Tour (1) ----< (N) Itinerary (åŒå€‹æ—…éŠåœ˜å¤šå€‹ç‰ˆæœ¬)
Itinerary (1) ----< (N) FlightInfo
Itinerary (1) ----< (N) Feature
Itinerary (1) ----< (N) FocusCard
Itinerary (1) ----< (N) DailyItinerary
DailyItinerary (1) ----< (N) Activity
```

### 4. UI çµ„ä»¶

| çµ„ä»¶åç¨± | æª”æ¡ˆè·¯å¾‘ | èªªæ˜ |
|----------|---------|------|
| ItineraryPage | `src/app/itinerary/page.tsx` | è¡Œç¨‹è¡¨ä¸»é  |
| NewItineraryPage | `src/app/itinerary/new/page.tsx` | æ–°å¢è¡Œç¨‹é ï¼ˆå·¦å³åˆ†å±ï¼‰ |
| EditItineraryPage | `src/app/itinerary/[slug]/page.tsx` | ç·¨è¼¯è¡Œç¨‹é  |
| TourForm | `src/components/editor/TourForm.tsx` | è¡Œç¨‹è¡¨å–®ç·¨è¼¯å™¨ |
| TourPreview | `src/components/editor/TourPreview.tsx` | è¡Œç¨‹å³æ™‚é è¦½ |
| PublishButton | `src/components/editor/PublishButton.tsx` | ç™¼ä½ˆæŒ‰éˆ• |

### 5. è³‡æ–™å±¤æ¶æ§‹

**ç›®å‰å¯¦ä½œï¼ˆPhase 1ï¼‰**ï¼š
```typescript
// Store å±¤ï¼ˆé‡ç”¨ Tour Storeï¼‰
src/stores/create-store.ts
export const useTourStore = createStore<Tour>('tours', 'TR');

// ç„¡ç¨ç«‹çš„ Hook å±¤ï¼Œç›´æ¥ä½¿ç”¨ useTourStore

// Service å±¤
src/features/tours/services/tour.service.ts
- validate(data): é©—è­‰è¡Œç¨‹è³‡æ–™
- generateTourCode(): ç”Ÿæˆè¡Œç¨‹ç·¨è™Ÿ
```

**æœªä¾† Phase 3 æ¶æ§‹**ï¼š
```
UI (ItineraryPage)
  â†“
Hook (useItineraries)
  â†“
Service (ItineraryService)
  â†“
API (/api/itineraries)
  â†“
Supabase (tours è¡¨ + itinerary_details è¡¨)
```

### 6. API ç«¯é»ï¼ˆPhase 3 è¦åŠƒï¼‰

| ç«¯é» | æ–¹æ³• | èªªæ˜ |
|------|------|------|
| `/api/itineraries` | GET | å–å¾—è¡Œç¨‹è¡¨åˆ—è¡¨ |
| `/api/itineraries` | POST | å»ºç«‹æ–°è¡Œç¨‹ |
| `/api/itineraries/:id` | GET | å–å¾—è¡Œç¨‹è©³æƒ… |
| `/api/itineraries/:id` | PATCH | æ›´æ–°è¡Œç¨‹ |
| `/api/itineraries/:id` | DELETE | åˆªé™¤è¡Œç¨‹ |
| `/api/itineraries/:id/publish` | POST | ç™¼ä½ˆè¡Œç¨‹ |
| `/api/itineraries/:id/duplicate` | POST | è¤‡è£½è¡Œç¨‹ |
| `/api/itineraries/from-quote/:quoteId` | POST | å¾å ±åƒ¹å–®å»ºç«‹è¡Œç¨‹ |

### 7. æ¬Šé™æ§åˆ¶

| æ“ä½œ | å…è¨±è§’è‰² | èªªæ˜ |
|------|---------|------|
| æŸ¥çœ‹è¡Œç¨‹ | æ‰€æœ‰äºº | - |
| å»ºç«‹è¡Œç¨‹ | æ¥­å‹™ã€ç®¡ç†å“¡ | - |
| ç·¨è¼¯è¡Œç¨‹ | æ¥­å‹™ã€ç®¡ç†å“¡ | - |
| åˆªé™¤è¡Œç¨‹ | ç®¡ç†å“¡ | - |
| ç™¼ä½ˆè¡Œç¨‹ | æ¥­å‹™ã€ç®¡ç†å“¡ | - |
| æŸ¥çœ‹åˆ†äº«é€£çµ | æ‰€æœ‰äººï¼ˆåŒ…å«å¤–éƒ¨ï¼‰ | å…¬é–‹åˆ†äº« |

### 8. å·²çŸ¥å•é¡Œ

#### 8.1 æ¬„ä½å‘½åå•é¡Œ

âœ… **å¤§éƒ¨åˆ†æ¬„ä½å·²ä½¿ç”¨ camelCase**

âš ï¸ **status ä½¿ç”¨ä¸­æ–‡**
```typescript
// ç¾ç‹€
status: 'è‰ç¨¿' | 'å·²ç™¼ä½ˆ'

// å»ºè­°
status: 'draft' | 'published'
```

#### 8.2 è³‡æ–™é‡è¤‡å•é¡Œ

âš ï¸ **è¡Œç¨‹è¡¨å’Œ Tour è³‡æ–™æ··åœ¨ä¸€èµ·**
- Tour Store åŒ…å«äº†æ—…éŠåœ˜çš„è²¡å‹™æ¬„ä½ï¼ˆprice, total_revenueï¼‰
- ä¹ŸåŒ…å«äº†è¡Œç¨‹å±•ç¤ºç”¨æ¬„ä½ï¼ˆdailyItinerary, featuresï¼‰
- **å»ºè­°**ï¼šåˆ†é›¢ç‚ºå…©å€‹è¡¨ï¼š
  - `tours`ï¼šæ—…éŠåœ˜æ¥­å‹™è³‡æ–™ï¼ˆäººæ•¸ã€åƒ¹æ ¼ã€è²¡å‹™ï¼‰
  - `itineraries`ï¼šè¡Œç¨‹å±•ç¤ºè³‡æ–™ï¼ˆå°é¢ã€é€æ—¥è¡Œç¨‹ï¼‰

#### 8.3 èˆªç­æ™‚é–“è¨ˆç®—

âœ… **duration å·²è‡ªå‹•è¨ˆç®—**
- æ ¹æ“š departureTime å’Œ arrivalTime
- è€ƒæ…®æ™‚å·®ï¼ˆtimezoneOffsetï¼‰

#### 8.4 åœ–ç‰‡è³‡æºç®¡ç†

âš ï¸ **åŸå¸‚åœ–ç‰‡ç¡¬ç·¨ç¢¼åœ¨ç¨‹å¼ä¸­**
```typescript
// src/components/editor/TourForm.tsx
const cityImages: Record<string, string> = {
  "æ±äº¬": "https://images.unsplash.com/...",
  "äº¬éƒ½": "https://images.unsplash.com/...",
  // ...
};
```
- **å»ºè­°**ï¼šç§»åˆ°è³‡æ–™åº«çš„ `city_images` è¡¨

#### 8.5 åˆ†äº«é€£çµå•é¡Œ

âš ï¸ **ngrok ç¶²å€ç¡¬ç·¨ç¢¼**
```typescript
// src/app/itinerary/page.tsx
const baseUrl = 'https://frisky-masonic-mellissa.ngrok-free.dev';
const shareUrl = `${baseUrl}/view/${itinerary.id}`;
```
- **å»ºè­°**ï¼šç§»åˆ°ç’°å¢ƒè®Šæ•¸ `NEXT_PUBLIC_BASE_URL`

### 9. ä¿®å¾©å»ºè­°

**å„ªå…ˆä¿®å¾©ï¼ˆP0ï¼‰**ï¼š
1. **çµ±ä¸€ status å‘½åç‚ºè‹±æ–‡**ï¼š
   ```typescript
   status: 'draft' | 'published'
   ```

2. **åˆ†é›¢ Tour å’Œ Itinerary è³‡æ–™**ï¼š
   - Tour: æ¥­å‹™è³‡æ–™ï¼ˆcode, name, departure_date, price, max_participantsï¼‰
   - Itinerary: å±•ç¤ºè³‡æ–™ï¼ˆtitle, subtitle, coverImage, dailyItineraryï¼‰

**æ¬¡è¦ä¿®å¾©ï¼ˆP1ï¼‰**ï¼š
3. åŸå¸‚åœ–ç‰‡ç§»åˆ°è³‡æ–™åº«
4. åˆ†äº«é€£çµä½¿ç”¨ç’°å¢ƒè®Šæ•¸
5. æ–°å¢ `author` æ¬„ä½ï¼ˆç›®å‰å¾ useAuthStore å–å¾—ï¼‰

**æœªä¾†å„ªåŒ–ï¼ˆP2ï¼‰**ï¼š
6. æ”¯æ´è¡Œç¨‹ç¯„æœ¬
7. å¤šèªè¨€ç‰ˆæœ¬
8. PDF åŒ¯å‡ºåŠŸèƒ½
9. è¡Œç¨‹æ¯”è¼ƒåŠŸèƒ½
10. SEO å„ªåŒ–ï¼ˆå¤–éƒ¨åˆ†äº«é ï¼‰

### 10. è³‡æ–™è¡¨å»ºè­°ï¼ˆPhase 3ï¼‰

```sql
-- è¡Œç¨‹è¡¨ï¼ˆèˆ‡ Tour åˆ†é›¢ï¼‰
CREATE TABLE itineraries (
  id UUID PRIMARY KEY,
  tour_id UUID REFERENCES tours(id),  -- é—œè¯æ—…éŠåœ˜
  tour_code VARCHAR(20) NOT NULL,
  title VARCHAR(255) NOT NULL,
  subtitle VARCHAR(255),
  tagline VARCHAR(255),
  description TEXT,
  country VARCHAR(100) NOT NULL,
  city VARCHAR(100) NOT NULL,
  departure_date DATE NOT NULL,
  cover_image TEXT,
  status VARCHAR(20) NOT NULL CHECK (status IN ('draft', 'published')),
  author_id UUID REFERENCES users(id),
  
  -- èˆªç­è³‡è¨Šï¼ˆJSONBï¼‰
  outbound_flight JSONB NOT NULL,
  return_flight JSONB NOT NULL,
  
  -- ç‰¹è‰²ã€æ™¯é»ã€é ˜éšŠã€é›†åˆï¼ˆJSONBï¼‰
  features JSONB,
  focus_cards JSONB,
  leader_info JSONB,
  meeting_info JSONB,
  
  -- é€æ—¥è¡Œç¨‹ï¼ˆJSONBï¼‰
  itinerary_subtitle VARCHAR(255),
  daily_itinerary JSONB NOT NULL,
  
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- åŸå¸‚åœ–ç‰‡å°ç…§è¡¨
CREATE TABLE city_images (
  id UUID PRIMARY KEY,
  country VARCHAR(100) NOT NULL,
  city VARCHAR(100) NOT NULL,
  image_url TEXT NOT NULL,
  created_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(country, city)
);

-- åˆ†äº«é€£çµè¨˜éŒ„
CREATE TABLE itinerary_shares (
  id UUID PRIMARY KEY,
  itinerary_id UUID REFERENCES itineraries(id),
  share_token VARCHAR(50) UNIQUE NOT NULL,
  view_count INTEGER DEFAULT 0,
  last_viewed_at TIMESTAMP,
  created_at TIMESTAMP DEFAULT NOW()
);

-- ç´¢å¼•
CREATE INDEX idx_itineraries_tour_id ON itineraries(tour_id);
CREATE INDEX idx_itineraries_status ON itineraries(status);
CREATE INDEX idx_itineraries_country_city ON itineraries(country, city);
CREATE INDEX idx_itinerary_shares_token ON itinerary_shares(share_token);
```

---

## ğŸ“‹ è¨‚å–® (Orders) åŠŸèƒ½è¦æ ¼

### 1. åŸºæœ¬è³‡è¨Š

| é …ç›® | å…§å®¹ |
|------|------|
| **åŠŸèƒ½åç¨±** | è¨‚å–®ç®¡ç† (Orders) |
| **è·¯å¾‘** | `/orders` |
| **ç‹€æ…‹** | âš ï¸ éœ€ä¿®æ­£ï¼ˆç‹€æ…‹æ··äº‚ã€æ¬„ä½ä¸ä¸€è‡´ï¼‰ |
| **æ›´æ–°æ—¥æœŸ** | 2025-01-07 |

### 2. åŠŸèƒ½èªªæ˜

**ç”¨é€”æè¿°**ï¼š
- æ—…éŠåœ˜è¨‚å–®ç®¡ç†
- å®¢æˆ¶è³‡æ–™ç™»è¨˜
- åœ˜å“¡åå–®ç®¡ç†
- æ”¶æ¬¾é€²åº¦è¿½è¹¤
- è¨‚å–®æ–‡ä»¶ç®¡ç†
- èˆ‡æ—…éŠåœ˜é—œè¯

**ä¸»è¦ä½¿ç”¨è€…**ï¼š
- æ¥­å‹™äººå“¡ï¼ˆå»ºç«‹è¨‚å–®ã€è¿½è¹¤æ”¶æ¬¾ï¼‰
- åŠ©ç†ï¼ˆåœ˜å“¡è³‡æ–™ã€æ–‡ä»¶è™•ç†ï¼‰
- æœƒè¨ˆï¼ˆæ”¶æ¬¾ç¢ºèªï¼‰

**æ¥­å‹™æµç¨‹**ï¼š
1. å®¢æˆ¶ç¢ºèªåƒåŠ æ—…éŠåœ˜
2. æ¥­å‹™å»ºç«‹è¨‚å–®ï¼ŒæŒ‡æ´¾æ¥­å‹™èˆ‡åŠ©ç†
3. ç™»è¨˜è¨‚å–®äººæ•¸ï¼Œç”Ÿæˆè¨‚å–®è™Ÿç¢¼
4. æ”¶å–è¨‚é‡‘/å°¾æ¬¾ï¼Œæ›´æ–°ä»˜æ¬¾ç‹€æ…‹
5. åœ˜å“¡å¡«å¯«å€‹äººè³‡æ–™ï¼ˆè­·ç…§ã€ç°½è­‰ï¼‰
6. ç¢ºèªæ–‡ä»¶å®Œæ•´æ€§
7. è¨‚å–®å®Œæˆæˆ–å–æ¶ˆ

### 3. è³‡æ–™æ¨¡å‹

#### 3.1 è¨‚å–® (Order)

| æ¬„ä½å | å‹åˆ¥ | å¿…å¡« | èªªæ˜ |
|--------|------|------|------|
| `id` | string (UUID) | âœ… | è¨‚å–®å”¯ä¸€è­˜åˆ¥ç¢¼ |
| `orderNumber` | string | âœ… | è¨‚å–®è™Ÿç¢¼ |
| `tourId` | string (UUID) | âœ… | é—œè¯æ—…éŠåœ˜ ID |
| `code` | string | âœ… | åœ˜è™Ÿï¼ˆå†—é¤˜ï¼Œä¾†è‡ª Tourï¼‰ |
| `tourName` | string | âœ… | æ—…éŠåœ˜åç¨±ï¼ˆå†—é¤˜ï¼‰ |
| `contactPerson` | string | âœ… | è¯çµ¡äºº |
| `salesPerson` | string | âœ… | æ¥­å‹™è² è²¬äºº |
| `assistant` | string | âœ… | åŠ©ç† |
| `memberCount` | number | âœ… | è¨‚å–®äººæ•¸ |
| `status` | 'é€²è¡Œä¸­' \| 'å·²å®Œæˆ' \| 'å·²å–æ¶ˆ' | âŒ | è¨‚å–®ç‹€æ…‹ï¼ˆå¯é¸ï¼‰ |
| `paymentStatus` | PaymentStatus | âœ… | ä»˜æ¬¾ç‹€æ…‹ |
| `totalAmount` | number | âœ… | è¨‚å–®ç¸½é¡ |
| `paidAmount` | number | âœ… | å·²ä»˜é‡‘é¡ |
| `remainingAmount` | number | âœ… | æœªä»˜é‡‘é¡ |
| `customerId` | string (UUID) | âŒ | å®¢æˆ¶ IDï¼ˆç›®å‰ç¼ºå¤±ï¼‰ |
| `createdAt` | string (ISO 8601) | âœ… | å»ºç«‹æ™‚é–“ |
| `updatedAt` | string (ISO 8601) | âœ… | æ›´æ–°æ™‚é–“ |

#### 3.2 ä»˜æ¬¾ç‹€æ…‹ (PaymentStatus)

```typescript
type PaymentStatus = 'æœªæ”¶æ¬¾' | 'éƒ¨åˆ†æ”¶æ¬¾' | 'å·²æ”¶æ¬¾' | 'å·²æ”¶æ¬¾' | 'å·²å®Œæˆ';
```

**å•é¡Œ**ï¼š`'å·²æ”¶æ¬¾'` é‡è¤‡å®šç¾©

#### 3.3 åœ˜å“¡ (Member)

| æ¬„ä½å | å‹åˆ¥ | å¿…å¡« | èªªæ˜ |
|--------|------|------|------|
| `id` | string (UUID) | âœ… | åœ˜å“¡å”¯ä¸€è­˜åˆ¥ç¢¼ |
| `orderId` | string (UUID) | âœ… | æ‰€å±¬è¨‚å–® ID |
| `name` | string | âœ… | ä¸­æ–‡å§“å |
| `nameEn` | string | âœ… | è‹±æ–‡æ‹¼éŸ³ |
| `birthday` | string (YYYY-MM-DD) | âœ… | ç”Ÿæ—¥ |
| `passportNumber` | string | âœ… | è­·ç…§è™Ÿç¢¼ |
| `passportExpiry` | string (YYYY-MM-DD) | âœ… | è­·ç…§åˆ°æœŸæ—¥ |
| `idNumber` | string | âœ… | èº«åˆ†è­‰å­—è™Ÿ |
| `gender` | 'M' \| 'F' \| '' | âœ… | æ€§åˆ¥ï¼ˆè‡ªå‹•åˆ¤æ–·ï¼‰ |
| `age` | number | âœ… | å¹´é½¡ï¼ˆè‡ªå‹•è¨ˆç®—ï¼‰ |
| `assignedRoom` | string | âŒ | åˆ†é…çš„æˆ¿é–“ |
| `isChildNoBed` | boolean | âŒ | å°å­©ä¸ä½”åºŠ |
| `reservationCode` | string | âŒ | è¨‚ä½ä»£è™Ÿ |
| `addOns` | string[] | âŒ | åŠ è³¼é …ç›® IDs |
| `refunds` | string[] | âŒ | é€€è²»é …ç›® IDs |
| `customFields` | Record<string, any> | âŒ | è‡ªå®šç¾©æ¬„ä½ |
| `isNew` | boolean | âŒ | æ–°å¢æ¨™è¨˜ |
| `createdAt` | string (ISO 8601) | âœ… | å»ºç«‹æ™‚é–“ |
| `updatedAt` | string (ISO 8601) | âœ… | æ›´æ–°æ™‚é–“ |

**é—œè¯é—œä¿‚**ï¼š
```
Tour (1) ----< (N) Order
Customer (1) ----< (N) Order
Order (1) ----< (N) Member
Order (1) ----< (N) Payment
```

### 4. UI çµ„ä»¶

| çµ„ä»¶åç¨± | æª”æ¡ˆè·¯å¾‘ | èªªæ˜ |
|----------|---------|------|
| OrdersPage | `src/app/orders/page.tsx` | è¨‚å–®ä¸»é  |
| ExpandableOrderTable | `src/components/orders/expandable-order-table.tsx` | å¯å±•é–‹è¨‚å–®è¡¨æ ¼ |
| OrderKanban | `src/components/orders/order-kanban.tsx` | çœ‹æ¿è¦–åœ– |
| OrderList | `src/components/orders/order-list.tsx` | åˆ—è¡¨è¦–åœ– |

### 5. è³‡æ–™å±¤æ¶æ§‹

**ç›®å‰å¯¦ä½œï¼ˆPhase 1ï¼‰**ï¼š
```typescript
// Store å±¤ï¼ˆZustandï¼‰
src/stores/create-store.ts (å·¥å» å‡½æ•¸)
export const useOrderStore = createStore<Order>('orders', 'OR');

// Hook å±¤ï¼ˆæ¥­å‹™é‚è¼¯ï¼‰
src/features/orders/hooks/useOrders.ts
- createOrder(data)
- updateOrder(id, data)
- deleteOrder(id)
- loadOrders()
- getOrdersByTour(tourId)
- getOrdersByStatus(status)
- getOrdersByCustomer(customerId)
- calculateTotalRevenue()
- getPendingOrders()
- getConfirmedOrders()

// Service å±¤ï¼ˆè³‡æ–™é©—è­‰ï¼‰
src/features/orders/services/order.service.ts
- validate(data): tourId å¿…å¡«ã€é‡‘é¡ >= 0
- getOrdersByTour(tourId)
- calculateTotalRevenue()
```

**æœªä¾† Phase 3 æ¶æ§‹**ï¼š
```
UI (OrdersPage)
  â†“
Hook (useOrders)
  â†“
Service (OrderService)
  â†“
API (/api/orders)
  â†“
Supabase (orders, members è¡¨)
```

### 6. API ç«¯é»ï¼ˆPhase 3ï¼‰

| ç«¯é» | æ–¹æ³• | èªªæ˜ |
|------|------|------|
| `/api/orders` | GET | å–å¾—è¨‚å–®åˆ—è¡¨ï¼ˆå¯ç¯©é¸ï¼‰ |
| `/api/orders` | POST | å»ºç«‹æ–°è¨‚å–® |
| `/api/orders/:id` | GET | å–å¾—è¨‚å–®è©³æƒ… |
| `/api/orders/:id` | PATCH | æ›´æ–°è¨‚å–® |
| `/api/orders/:id` | DELETE | åˆªé™¤è¨‚å–® |
| `/api/orders/:id/members` | GET/POST | åœ˜å“¡ç®¡ç† |
| `/api/orders/:id/payments` | GET/POST | æ”¶æ¬¾è¨˜éŒ„ |
| `/api/orders/tour/:tourId` | GET | å–å¾—æ—…éŠåœ˜çš„æ‰€æœ‰è¨‚å–® |

### 7. æ¬Šé™æ§åˆ¶

| æ“ä½œ | å…è¨±è§’è‰² | èªªæ˜ |
|------|---------|------|
| æŸ¥çœ‹è¨‚å–® | æ‰€æœ‰äºº | - |
| å»ºç«‹è¨‚å–® | æ¥­å‹™ã€ç®¡ç†å“¡ | - |
| ç·¨è¼¯è¨‚å–® | æ¥­å‹™ï¼ˆè² è²¬äººï¼‰ã€åŠ©ç†ã€ç®¡ç†å“¡ | - |
| åˆªé™¤è¨‚å–® | ç®¡ç†å“¡ | éœ€æª¢æŸ¥ç„¡åœ˜å“¡ |
| åœ˜å“¡è³‡æ–™ | æ¥­å‹™ã€åŠ©ç†ã€ç®¡ç†å“¡ | - |
| æ”¶æ¬¾ç¢ºèª | æœƒè¨ˆã€ç®¡ç†å“¡ | - |

### 8. å·²çŸ¥å•é¡Œ

#### 8.1 æ¬„ä½å‘½åå•é¡Œ
- âœ… å¤§éƒ¨åˆ†æ¬„ä½å·²ä½¿ç”¨ camelCase
- âš ï¸ ç„¡ snake_case å•é¡Œ

#### 8.2 ç‹€æ…‹æ··äº‚ï¼ˆåš´é‡ï¼‰
- âŒ **Order.status ä½¿ç”¨ä¸­æ–‡**ï¼š`'é€²è¡Œä¸­' | 'å·²å®Œæˆ' | 'å·²å–æ¶ˆ'`
- âŒ **PaymentStatus ä½¿ç”¨ä¸­æ–‡**ï¼š`'æœªæ”¶æ¬¾' | 'éƒ¨åˆ†æ”¶æ¬¾' | 'å·²æ”¶æ¬¾' | 'å·²å®Œæˆ'`
- âŒ **PaymentStatus é‡è¤‡å®šç¾©**ï¼š`'å·²æ”¶æ¬¾'` å‡ºç¾å…©æ¬¡
- âŒ **Order.status èˆ‡ PaymentStatus èªæ„é‡ç–Š**

**å»ºè­°æ”¹ç‚º**ï¼š
```typescript
// Order ç‹€æ…‹
status: 'pending' | 'confirmed' | 'completed' | 'cancelled'

// Payment ç‹€æ…‹
paymentStatus: 'unpaid' | 'partial' | 'paid' | 'refunded'
```

#### 8.3 å†—é¤˜æ¬„ä½å•é¡Œ
- âš ï¸ `code` å’Œ `tourName` æ˜¯å†—é¤˜æ¬„ä½ï¼ˆä¾†è‡ª Tourï¼‰
- **é¢¨éšª**ï¼šTour æ›´æ–°æ™‚ï¼ŒOrder çš„å†—é¤˜è³‡æ–™ä¸æœƒåŒæ­¥
- **å»ºè­°**ï¼šç§»é™¤å†—é¤˜ï¼Œæˆ–æ”¹ç‚ºå‹•æ…‹ JOIN

#### 8.4 ç¼ºå°‘é—œéµæ¬„ä½
- âŒ ç¼ºå°‘ `customerId`ï¼ˆå®¢æˆ¶ IDï¼‰
- âŒ ç¼ºå°‘ `notes`ï¼ˆè¨‚å–®å‚™è¨»ï¼‰
- âŒ ç¼ºå°‘ `cancelledAt`ï¼ˆå–æ¶ˆæ™‚é–“ï¼‰
- âŒ ç¼ºå°‘ `cancellationReason`ï¼ˆå–æ¶ˆåŸå› ï¼‰
- âŒ ç¼ºå°‘ `depositAmount`ï¼ˆè¨‚é‡‘é‡‘é¡ï¼‰
- âŒ ç¼ºå°‘ `depositPaidAt`ï¼ˆè¨‚é‡‘ä»˜æ¬¾æ™‚é–“ï¼‰

#### 8.5 åœ˜å“¡è³‡æ–™å•é¡Œ
- âš ï¸ `gender` å’Œ `age` æ‡‰è©²å‹•æ…‹è¨ˆç®—ï¼Œä¸æ‡‰å„²å­˜
- âš ï¸ `isNew` æ¨™è¨˜ç”¨é€”ä¸æ˜ï¼Œæ‡‰ç§»é™¤

#### 8.6 ä»˜æ¬¾é‡‘é¡è¨ˆç®—
- âš ï¸ `remainingAmount` æ‡‰è©²å‹•æ…‹è¨ˆç®—ï¼ˆtotalAmount - paidAmountï¼‰

#### 8.7 Service å±¤é‚è¼¯å•é¡Œ
- âš ï¸ `getOrdersByStatus` ä½¿ç”¨ç¡¬ç·¨ç¢¼ä¸­æ–‡ç‹€æ…‹ï¼ˆ'å·²ç¢ºèª'ã€'å·²å®Œæˆ'ï¼‰
- âš ï¸ `getPendingOrders` ä½¿ç”¨ `status === 'æœªæ”¶æ¬¾'`ï¼Œä½† status ä¸æ˜¯ä»˜æ¬¾ç‹€æ…‹

### 9. ä¿®å¾©å»ºè­°

**å„ªå…ˆä¿®å¾©ï¼ˆP0ï¼‰**ï¼š
1. **çµ±ä¸€ç‹€æ…‹å‘½åç‚ºè‹±æ–‡**ï¼š
   ```typescript
   status: 'pending' | 'confirmed' | 'completed' | 'cancelled'
   paymentStatus: 'unpaid' | 'partial' | 'paid' | 'refunded'
   ```
2. **ä¿®æ­£ PaymentStatus é‡è¤‡å®šç¾©**
3. **ç§»é™¤æˆ–ä¿®æ­£ Service å±¤ç¡¬ç·¨ç¢¼çš„ä¸­æ–‡ç‹€æ…‹**

**æ¬¡è¦ä¿®å¾©ï¼ˆP1ï¼‰**ï¼š
4. æ–°å¢å¿…è¦æ¬„ä½ï¼ˆcustomerId, notes, depositAmount ç­‰ï¼‰
5. ç§»é™¤å†—é¤˜æ¬„ä½ï¼ˆcode, tourNameï¼‰æˆ–æ”¹ç‚º computed
6. `remainingAmount`, `gender`, `age` æ”¹ç‚ºå‹•æ…‹è¨ˆç®—
7. ç§»é™¤ `isNew` æ¨™è¨˜

**æœªä¾†å„ªåŒ–ï¼ˆP2ï¼‰**ï¼š
8. æ”¯æ´è¨‚å–®ç¯„æœ¬
9. æ‰¹æ¬¡åŒ¯å…¥åœ˜å“¡
10. è¨‚å–®è¤‡è£½åŠŸèƒ½
11. æ–‡ä»¶è‡ªå‹•æé†’

### 10. è³‡æ–™è¡¨å»ºè­°ï¼ˆPhase 3ï¼‰

```sql
CREATE TABLE orders (
  id UUID PRIMARY KEY,
  order_number VARCHAR(50) UNIQUE NOT NULL,
  tour_id UUID REFERENCES tours(id) NOT NULL,
  customer_id UUID REFERENCES customers(id),
  contact_person VARCHAR(100) NOT NULL,
  sales_person VARCHAR(100) NOT NULL,
  assistant VARCHAR(100) NOT NULL,
  member_count INTEGER NOT NULL DEFAULT 0,
  status VARCHAR(20) NOT NULL, -- 'pending', 'confirmed', 'completed', 'cancelled'
  payment_status VARCHAR(20) NOT NULL, -- 'unpaid', 'partial', 'paid', 'refunded'
  total_amount DECIMAL(10,2) NOT NULL,
  paid_amount DECIMAL(10,2) NOT NULL DEFAULT 0,
  deposit_amount DECIMAL(10,2),
  deposit_paid_at TIMESTAMP,
  notes TEXT,
  cancellation_reason TEXT,
  cancelled_at TIMESTAMP,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- å‹•æ…‹è¨ˆç®—æ¬„ä½é€é VIEW
CREATE VIEW orders_with_stats AS
SELECT
  o.*,
  o.total_amount - o.paid_amount as remaining_amount,
  t.code as tour_code,
  t.name as tour_name,
  COUNT(m.id) as actual_member_count
FROM orders o
LEFT JOIN tours t ON t.id = o.tour_id
LEFT JOIN members m ON m.order_id = o.id
GROUP BY o.id, t.id;

CREATE TABLE members (
  id UUID PRIMARY KEY,
  order_id UUID REFERENCES orders(id) NOT NULL,
  name VARCHAR(100) NOT NULL,
  name_en VARCHAR(100) NOT NULL,
  birthday DATE NOT NULL,
  passport_number VARCHAR(50) NOT NULL,
  passport_expiry DATE NOT NULL,
  id_number VARCHAR(20) NOT NULL,
  assigned_room VARCHAR(50),
  is_child_no_bed BOOLEAN DEFAULT FALSE,
  reservation_code VARCHAR(50),
  add_ons JSONB,
  refunds JSONB,
  custom_fields JSONB,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- æ€§åˆ¥å’Œå¹´é½¡å‹•æ…‹è¨ˆç®—
CREATE VIEW members_with_computed AS
SELECT
  m.*,
  CASE
    WHEN SUBSTRING(m.id_number, 2, 1) = '1' THEN 'M'
    WHEN SUBSTRING(m.id_number, 2, 1) = '2' THEN 'F'
    ELSE ''
  END as gender,
  EXTRACT(YEAR FROM AGE(t.departure_date, m.birthday)) as age
FROM members m
LEFT JOIN orders o ON o.id = m.order_id
LEFT JOIN tours t ON t.id = o.tour_id;
```

---

## ğŸ’° å ±åƒ¹å–® (Quotes) åŠŸèƒ½è¦æ ¼

### 1. åŸºæœ¬è³‡è¨Š

| é …ç›® | å…§å®¹ |
|------|------|
| **åŠŸèƒ½åç¨±** | å ±åƒ¹å–®ç®¡ç† (Quotes) |
| **è·¯å¾‘** | `/quotes` |
| **ç‹€æ…‹** | âš ï¸ éœ€ä¿®æ­£ï¼ˆç‹€æ…‹ä½¿ç”¨ä¸­æ–‡ã€æ¬„ä½æ··äº‚ï¼‰ |
| **æ›´æ–°æ—¥æœŸ** | 2025-01-07 |

### 2. åŠŸèƒ½èªªæ˜

**ç”¨é€”æè¿°**ï¼š
- æ—…éŠåœ˜å ±åƒ¹å–®å»ºç«‹èˆ‡ç®¡ç†
- å¤šé …è²»ç”¨åˆ†é¡ï¼ˆä½å®¿ã€äº¤é€šã€é¤é£Ÿã€é–€ç¥¨ç­‰ï¼‰
- ç‰ˆæœ¬æ§åˆ¶ï¼ˆææ¡ˆ â†’ æœ€çµ‚ç‰ˆæœ¬ï¼‰
- å ±åƒ¹å–®è¤‡è£½åŠŸèƒ½
- è½‰æ›ç‚ºæ—…éŠåœ˜

**ä¸»è¦ä½¿ç”¨è€…**ï¼š
- æ¥­å‹™äººå“¡ï¼ˆå»ºç«‹å ±åƒ¹å–®ã€å›è¦†å®¢æˆ¶ï¼‰
- æœƒè¨ˆï¼ˆæˆæœ¬æ ¸ç®—ï¼‰

**æ¥­å‹™æµç¨‹**ï¼š
1. å®¢æˆ¶è©¢åƒ¹ï¼Œæ¥­å‹™å»ºç«‹å ±åƒ¹å–®
2. è¼¸å…¥åœ˜é«”è³‡è¨Šï¼ˆäººæ•¸ã€å¤©æ•¸ã€éœ€æ±‚ï¼‰
3. é€é …å¡«å¯«è²»ç”¨æ˜ç´°ï¼ˆä½å®¿ã€äº¤é€šã€é¤é£Ÿç­‰ï¼‰
4. ç³»çµ±è‡ªå‹•è¨ˆç®—ç¸½æˆæœ¬
5. å¯å»ºç«‹å¤šå€‹ç‰ˆæœ¬ï¼ˆä¿®æ”¹å ±åƒ¹ï¼‰
6. å®¢æˆ¶ç¢ºèªå¾Œï¼Œè½‰æ›ç‚ºæ—…éŠåœ˜

### 3. è³‡æ–™æ¨¡å‹

#### 3.1 å ±åƒ¹å–® (Quote)

| æ¬„ä½å | å‹åˆ¥ | å¿…å¡« | èªªæ˜ |
|--------|------|------|------|
| `id` | string (UUID) | âœ… | å ±åƒ¹å–®å”¯ä¸€è­˜åˆ¥ç¢¼ |
| `quoteNumber` | string | âŒ | å ±åƒ¹å–®è™Ÿç¢¼ï¼ˆQUOTE-2025-0001ï¼‰ |
| `name` | string | âœ… | åœ˜é«”åç¨± |
| `status` | 'ææ¡ˆ' \| 'æœ€çµ‚ç‰ˆæœ¬' | âœ… | å ±åƒ¹å–®ç‹€æ…‹ |
| `tourId` | string (UUID) | âŒ | é—œè¯çš„æ—…éŠåœ˜ IDï¼ˆè½‰æ›å¾Œï¼‰ |
| `customerName` | string | âŒ | å®¢æˆ¶åç¨± |
| `contactPerson` | string | âŒ | è¯çµ¡äºº |
| `contactPhone` | string | âŒ | è¯çµ¡é›»è©± |
| `contactEmail` | string | âŒ | Email |
| `groupSize` | number | âœ… | åœ˜é«”äººæ•¸ |
| `accommodationDays` | number | âœ… | ä½å®¿å¤©æ•¸ |
| `requirements` | string | âŒ | éœ€æ±‚èªªæ˜ |
| `budgetRange` | string | âŒ | é ç®—ç¯„åœ |
| `validUntil` | string (ISO 8601) | âŒ | å ±åƒ¹æœ‰æ•ˆæœŸ |
| `paymentTerms` | string | âŒ | ä»˜æ¬¾æ¢ä»¶ |
| `categories` | QuoteCategory[] | âœ… | è²»ç”¨åˆ†é¡ |
| `totalCost` | number | âœ… | ç¸½æˆæœ¬ |
| `version` | number | âŒ | ç‰ˆæœ¬è™Ÿ |
| `versions` | QuoteVersion[] | âŒ | ç‰ˆæœ¬æ­·å² |
| `createdAt` | string (ISO 8601) | âœ… | å»ºç«‹æ™‚é–“ |
| `updatedAt` | string (ISO 8601) | âœ… | æ›´æ–°æ™‚é–“ |

#### 3.2 è²»ç”¨åˆ†é¡ (QuoteCategory)

| æ¬„ä½å | å‹åˆ¥ | å¿…å¡« | èªªæ˜ |
|--------|------|------|------|
| `id` | string (UUID) | âœ… | åˆ†é¡å”¯ä¸€è­˜åˆ¥ç¢¼ |
| `name` | string | âœ… | åˆ†é¡åç¨±ï¼ˆä½å®¿ã€äº¤é€šã€é¤é£Ÿç­‰ï¼‰ |
| `items` | QuoteItem[] | âœ… | è²»ç”¨é …ç›®åˆ—è¡¨ |
| `total` | number | âœ… | åˆ†é¡å°è¨ˆ |

#### 3.3 è²»ç”¨é …ç›® (QuoteItem)

| æ¬„ä½å | å‹åˆ¥ | å¿…å¡« | èªªæ˜ |
|--------|------|------|------|
| `id` | string (UUID) | âœ… | é …ç›®å”¯ä¸€è­˜åˆ¥ç¢¼ |
| `name` | string | âœ… | é …ç›®åç¨± |
| `quantity` | number | âœ… | æ•¸é‡ |
| `unitPrice` | number | âœ… | å–®åƒ¹ |
| `total` | number | âœ… | å°è¨ˆï¼ˆquantity Ã— unitPriceï¼‰ |
| `note` | string | âŒ | å‚™è¨» |
| `day` | number | âŒ | ç¬¬å¹¾å¤©ï¼ˆä½å®¿å°ˆç”¨ï¼‰ |
| `roomType` | string | âŒ | æˆ¿å‹åç¨±ï¼ˆä½å®¿å°ˆç”¨ï¼‰ |
| `isGroupCost` | boolean | âŒ | åœ˜é«”åˆ†æ”¤ï¼ˆäº¤é€šã€å°éŠå°ˆç”¨ï¼‰ |

#### 3.4 ç‰ˆæœ¬æ­·å² (QuoteVersion)

| æ¬„ä½å | å‹åˆ¥ | å¿…å¡« | èªªæ˜ |
|--------|------|------|------|
| `id` | string (UUID) | âœ… | ç‰ˆæœ¬å”¯ä¸€è­˜åˆ¥ç¢¼ |
| `version` | number | âœ… | ç‰ˆæœ¬è™Ÿ |
| `categories` | QuoteCategory[] | âœ… | è²»ç”¨åˆ†é¡å¿«ç…§ |
| `totalCost` | number | âœ… | ç¸½æˆæœ¬å¿«ç…§ |
| `note` | string | âŒ | ä¿®æ”¹èªªæ˜ |
| `createdAt` | string (ISO 8601) | âœ… | å»ºç«‹æ™‚é–“ |

**é—œè¯é—œä¿‚**ï¼š
```
Quote (1) ----< (1) Tour (è½‰æ›)
Quote (1) ----< (N) QuoteCategory
QuoteCategory (1) ----< (N) QuoteItem
Quote (1) ----< (N) QuoteVersion
```

### 4. UI çµ„ä»¶

| çµ„ä»¶åç¨± | æª”æ¡ˆè·¯å¾‘ | èªªæ˜ |
|----------|---------|------|
| QuotesPage | `src/app/quotes/page.tsx` | å ±åƒ¹å–®ä¸»é  |
| QuoteDetailPage | `src/app/quotes/[id]/page.tsx` | å ±åƒ¹å–®è©³æƒ…é  |
| EnhancedTable | `src/components/ui/enhanced-table.tsx` | å ±åƒ¹å–®åˆ—è¡¨ |

### 5. è³‡æ–™å±¤æ¶æ§‹

**ç›®å‰å¯¦ä½œï¼ˆPhase 1ï¼‰**ï¼š
```typescript
// Store å±¤ï¼ˆZustandï¼‰
src/stores/create-store.ts (å·¥å» å‡½æ•¸)
export const useQuoteStore = createStore<Quote>('quotes', 'QT');

// Hook å±¤ï¼ˆæ¥­å‹™é‚è¼¯ï¼‰
src/features/quotes/hooks/useQuotes.ts
- createQuote(data)
- updateQuote(id, data)
- deleteQuote(id)
- loadQuotes()
- duplicateQuote(id): è¤‡è£½å ±åƒ¹å–®
- createNewVersion(id, updates): å»ºç«‹æ–°ç‰ˆæœ¬
- getQuotesByTour(tourId)
- getQuotesByStatus(status)
- calculateTotalCost(quote)

// Service å±¤ï¼ˆè³‡æ–™é©—è­‰ï¼‰
src/features/quotes/services/quote.service.ts
- validate(data): æ¨™é¡Œé•·åº¦ã€ç¸½é‡‘é¡ >= 0
- duplicateQuote(id): è¤‡è£½é‚è¼¯
- createNewVersion(id, updates): ç‰ˆæœ¬æ§åˆ¶é‚è¼¯
- calculateTotalCost(quote): æˆæœ¬è¨ˆç®—
```

**æœªä¾† Phase 3 æ¶æ§‹**ï¼š
```
UI (QuotesPage)
  â†“
Hook (useQuotes)
  â†“
Service (QuoteService)
  â†“
API (/api/quotes)
  â†“
Supabase (quotes, quote_versions è¡¨)
```

### 6. API ç«¯é»ï¼ˆPhase 3ï¼‰

| ç«¯é» | æ–¹æ³• | èªªæ˜ |
|------|------|------|
| `/api/quotes` | GET | å–å¾—å ±åƒ¹å–®åˆ—è¡¨ |
| `/api/quotes` | POST | å»ºç«‹æ–°å ±åƒ¹å–® |
| `/api/quotes/:id` | GET | å–å¾—å ±åƒ¹å–®è©³æƒ… |
| `/api/quotes/:id` | PATCH | æ›´æ–°å ±åƒ¹å–® |
| `/api/quotes/:id` | DELETE | åˆªé™¤å ±åƒ¹å–® |
| `/api/quotes/:id/duplicate` | POST | è¤‡è£½å ±åƒ¹å–® |
| `/api/quotes/:id/version` | POST | å»ºç«‹æ–°ç‰ˆæœ¬ |
| `/api/quotes/:id/convert-tour` | POST | è½‰æ›ç‚ºæ—…éŠåœ˜ |

### 7. æ¬Šé™æ§åˆ¶

| æ“ä½œ | å…è¨±è§’è‰² | èªªæ˜ |
|------|---------|------|
| æŸ¥çœ‹å ±åƒ¹å–® | æ‰€æœ‰äºº | - |
| å»ºç«‹å ±åƒ¹å–® | æ¥­å‹™ã€ç®¡ç†å“¡ | - |
| ç·¨è¼¯å ±åƒ¹å–® | æ¥­å‹™ã€ç®¡ç†å“¡ | - |
| åˆªé™¤å ±åƒ¹å–® | ç®¡ç†å“¡ | éœ€æª¢æŸ¥æœªè½‰æ›ç‚ºæ—…éŠåœ˜ |
| è¤‡è£½å ±åƒ¹å–® | æ¥­å‹™ã€ç®¡ç†å“¡ | - |
| è½‰æ›ç‚ºæ—…éŠåœ˜ | æ¥­å‹™ã€ç®¡ç†å“¡ | - |

### 8. å·²çŸ¥å•é¡Œ

#### 8.1 æ¬„ä½å‘½åå•é¡Œ
- âœ… å¤§éƒ¨åˆ†æ¬„ä½å·²ä½¿ç”¨ camelCase
- âš ï¸ ç„¡ snake_case å•é¡Œ

#### 8.2 ç‹€æ…‹å‘½åå•é¡Œï¼ˆåš´é‡ï¼‰
- âŒ **ç‹€æ…‹ä½¿ç”¨ä¸­æ–‡**ï¼š`'ææ¡ˆ' | 'æœ€çµ‚ç‰ˆæœ¬'`
- **å•é¡Œ**ï¼š
  1. ä¸åˆ©æ–¼åœ‹éš›åŒ–
  2. èªæ„ä¸æ¸…ï¼ˆç¼ºå°‘ã€Œå·²ç¢ºèªã€ã€ã€Œå·²å–æ¶ˆã€ç­‰ç‹€æ…‹ï¼‰

**å»ºè­°æ”¹ç‚º**ï¼š
```typescript
status: 'draft' | 'proposed' | 'revised' | 'approved' | 'converted' | 'rejected'
// draft: è‰ç¨¿
// proposed: å·²ææ¡ˆ
// revised: å·²ä¿®æ”¹
// approved: å·²æ ¸å‡†ï¼ˆæœ€çµ‚ç‰ˆæœ¬ï¼‰
// converted: å·²è½‰æ›ç‚ºæ—…éŠåœ˜
// rejected: å·²æ‹’çµ•
```

#### 8.3 totalCost è¨ˆç®—å•é¡Œ
- âš ï¸ `totalCost` æ‡‰è©²å‹•æ…‹è¨ˆç®—ï¼Œä¸æ‡‰å„²å­˜
- **é¢¨éšª**ï¼šcategories æ›´æ–°æ™‚ï¼ŒtotalCost å¯èƒ½ä¸åŒæ­¥

#### 8.4 ç‰ˆæœ¬æ§åˆ¶é‚è¼¯ä¸å®Œæ•´
- âš ï¸ `version` æ¬„ä½èˆ‡ `status` é—œä¿‚ä¸æ˜ç¢º
- âš ï¸ `versions` é™£åˆ—å„²å­˜æ–¹å¼å†—é¤˜ï¼ˆå®Œæ•´å¿«ç…§ï¼‰
- **å»ºè­°**ï¼šç‰ˆæœ¬æ‡‰ç¨ç«‹è¡¨æ ¼ï¼Œä½¿ç”¨å·®ç•°å„²å­˜

#### 8.5 QuoteItem è¨ˆç®—å•é¡Œ
- âš ï¸ `total` æ‡‰è©²å‹•æ…‹è¨ˆç®—ï¼ˆquantity Ã— unitPriceï¼‰

#### 8.6 ç¼ºå°‘é—œéµæ¬„ä½
- âŒ ç¼ºå°‘ `customerId`ï¼ˆå®¢æˆ¶ IDï¼‰
- âŒ ç¼ºå°‘ `pricePerPerson`ï¼ˆæ¯äººåƒ¹æ ¼ï¼‰
- âŒ ç¼ºå°‘ `profitMargin`ï¼ˆåˆ©æ½¤ç‡ï¼‰
- âŒ ç¼ºå°‘ `convertedAt`ï¼ˆè½‰æ›æ™‚é–“ï¼‰
- âŒ ç¼ºå°‘ `rejectedReason`ï¼ˆæ‹’çµ•åŸå› ï¼‰

#### 8.7 Service å±¤ validate å•é¡Œ
- âš ï¸ validate æª¢æŸ¥ `title` æ¬„ä½ï¼Œä½† Quote æ²’æœ‰ `title` æ¬„ä½ï¼ˆæ‡‰è©²æ˜¯ `name`ï¼‰

### 9. ä¿®å¾©å»ºè­°

**å„ªå…ˆä¿®å¾©ï¼ˆP0ï¼‰**ï¼š
1. **çµ±ä¸€ç‹€æ…‹å‘½åç‚ºè‹±æ–‡**ï¼š
   ```typescript
   status: 'draft' | 'proposed' | 'revised' | 'approved' | 'converted' | 'rejected'
   ```
2. **ä¿®æ­£ Service validate æ¬„ä½åç¨±**ï¼ˆtitle â†’ nameï¼‰
3. **totalCost æ”¹ç‚ºå‹•æ…‹è¨ˆç®—**

**æ¬¡è¦ä¿®å¾©ï¼ˆP1ï¼‰**ï¼š
4. æ–°å¢å¿…è¦æ¬„ä½ï¼ˆcustomerId, pricePerPerson, profitMargin ç­‰ï¼‰
5. å„ªåŒ–ç‰ˆæœ¬æ§åˆ¶é‚è¼¯
6. QuoteItem.total æ”¹ç‚ºå‹•æ…‹è¨ˆç®—

**æœªä¾†å„ªåŒ–ï¼ˆP2ï¼‰**ï¼š
7. æ”¯æ´å ±åƒ¹å–®ç¯„æœ¬
8. PDF åŒ¯å‡ºåŠŸèƒ½
9. Email å¯„é€åŠŸèƒ½
10. å ±åƒ¹æ¯”è¼ƒåŠŸèƒ½

### 10. è³‡æ–™è¡¨å»ºè­°ï¼ˆPhase 3ï¼‰

```sql
CREATE TABLE quotes (
  id UUID PRIMARY KEY,
  quote_number VARCHAR(50) UNIQUE,
  name VARCHAR(255) NOT NULL,
  status VARCHAR(20) NOT NULL, -- 'draft', 'proposed', 'revised', 'approved', 'converted', 'rejected'
  tour_id UUID REFERENCES tours(id),
  customer_id UUID REFERENCES customers(id),
  customer_name VARCHAR(100),
  contact_person VARCHAR(100),
  contact_phone VARCHAR(50),
  contact_email VARCHAR(100),
  group_size INTEGER NOT NULL,
  accommodation_days INTEGER NOT NULL,
  requirements TEXT,
  budget_range VARCHAR(100),
  valid_until DATE,
  payment_terms TEXT,
  categories JSONB NOT NULL,
  profit_margin DECIMAL(5,2),
  converted_at TIMESTAMP,
  rejected_reason TEXT,
  current_version INTEGER DEFAULT 1,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- å‹•æ…‹è¨ˆç®— totalCost
CREATE VIEW quotes_with_cost AS
SELECT
  q.*,
  (SELECT SUM((item->>'total')::numeric)
   FROM jsonb_array_elements(q.categories) cat,
        jsonb_array_elements(cat->'items') item
  ) as total_cost,
  CASE
    WHEN q.group_size > 0 THEN
      (SELECT SUM((item->>'total')::numeric)
       FROM jsonb_array_elements(q.categories) cat,
            jsonb_array_elements(cat->'items') item
      ) / q.group_size
    ELSE 0
  END as price_per_person
FROM quotes q;

-- ç‰ˆæœ¬æ­·å²ç¨ç«‹è¡¨æ ¼
CREATE TABLE quote_versions (
  id UUID PRIMARY KEY,
  quote_id UUID REFERENCES quotes(id) NOT NULL,
  version_number INTEGER NOT NULL,
  categories JSONB NOT NULL,
  total_cost DECIMAL(10,2) NOT NULL,
  note TEXT,
  created_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(quote_id, version_number)
);
```

---

## ğŸ“‹ å¾ŒçºŒåŠŸèƒ½è¦æ ¼ï¼ˆå¾…æ’°å¯«ï¼‰

æ¥ä¸‹ä¾†å°‡ä¾ç…§å„ªå…ˆç´šé€ä¸€å»ºç«‹ä»¥ä¸‹åŠŸèƒ½çš„å®Œæ•´è¦æ ¼ï¼š

### P0 æ ¸å¿ƒåŠŸèƒ½ï¼ˆå„ªå…ˆè™•ç†ï¼‰
1. âœ… **å·¥ä½œå€ (Workspace)** - å·²å®Œæˆ
2. âœ… **å¾…è¾¦äº‹é … (Todos)** - å·²å®Œæˆ
3. âœ… **æ—…éŠåœ˜ (Tours)** - å·²å®Œæˆ
4. âœ… **è¨‚å–® (Orders)** - å·²å®Œæˆ
5. âœ… **å ±åƒ¹å–® (Quotes)** - å·²å®Œæˆ
6. â³ **è²¡å‹™ç®¡ç† (Finance)** - æ ¸å¿ƒæ¥­å‹™
7. â³ **æœƒè¨ˆç³»çµ± (Accounting)** - æ ¸å¿ƒæ¥­å‹™

### P1 é‡è¦åŠŸèƒ½
8. â³ **è¡Œäº‹æ›† (Calendar)**
9. â³ **æ™‚é–“ç›’ (Timebox)**
10. â³ **å®¢æˆ¶ç®¡ç† (Customers)**
11. â³ **äººäº‹ç®¡ç† (HR)**
12. â³ **åŸºç¤è³‡æ–™ (Database)**
13. â³ **æ¨¡æ¿ç³»çµ± (Templates)**

### P2 è¼”åŠ©åŠŸèƒ½
14. â³ **ç°½è­‰ç®¡ç† (Visas)**
15. â³ **æª”æ¡ˆç®¡ç† (Profile)**
16. â³ **å°è¦½ (Guide)**

---

## ğŸ“Œ ä½¿ç”¨æŒ‡å—

### çµ¦ Claude AI çš„æŒ‡ç¤º

**é–‹å§‹è™•ç†æŸå€‹åŠŸèƒ½æ™‚**ï¼š
1. è®€å–è©²åŠŸèƒ½çš„è¦æ ¼è¡¨æ ¼
2. æª¢æŸ¥ã€Œå·²çŸ¥å•é¡Œã€ç« ç¯€
3. ä¾ç…§è³‡æ–™æ¨¡å‹çµ±ä¸€æ¬„ä½å‘½å
4. ç¢ºä¿ UI â†’ Hook â†’ Store â†’ DB æ¶æ§‹å®Œæ•´
5. æ›´æ–°ã€Œå·²çŸ¥å•é¡Œã€ç‹€æ…‹

**å»ºç«‹æ–°åŠŸèƒ½è¦æ ¼æ™‚**ï¼š
1. è¤‡è£½ã€Œå·¥ä½œå€ã€ç¯„æœ¬
2. å¡«å¯« 8 å€‹ç« ç¯€å…§å®¹
3. ç¢ºä¿æ¬„ä½ 100% ä½¿ç”¨ camelCase
4. è¨˜éŒ„æ‰€æœ‰å·²çŸ¥å•é¡Œ

### çµ¦é–‹ç™¼è€…çš„æŒ‡ç¤º

**æŸ¥è©¢åŠŸèƒ½æ¶æ§‹**ï¼š
```bash
# 1. è®€å–åŠŸèƒ½ç¸½è¦½ï¼Œæ‰¾åˆ°ç›®æ¨™åŠŸèƒ½
# 2. æŸ¥çœ‹è©²åŠŸèƒ½çš„å®Œæ•´è¦æ ¼
# 3. å°ç…§ç¨‹å¼ç¢¼ï¼Œä¿®æ­£æ¬„ä½å‘½å
```

**æäº¤æ–°åŠŸèƒ½**ï¼š
```bash
# 1. å…ˆå»ºç«‹åŠŸèƒ½è¦æ ¼æ–‡ä»¶
# 2. ç¶“é Review å¾Œå†é–‹å§‹å¯¦ä½œ
# 3. å¯¦ä½œå®Œæˆå¾Œæ›´æ–°è¦æ ¼æ–‡ä»¶ç‹€æ…‹
```

---

## 5ï¸âƒ£ P0-5: è²¡å‹™ç®¡ç† (Finance)

### 1. åŸºæœ¬è³‡è¨Š

| é …ç›® | å…§å®¹ |
|------|------|
| **è·¯å¾‘** | `/finance/*` (å« 5 å€‹å­æ¨¡çµ„) |
| **ç‹€æ…‹** | âœ… å·²å¯¦ä½œ - å®Œæ•´å¤šå­ç³»çµ± |
| **é–‹ç™¼éšæ®µ** | Phase 1 (IndexedDB) |
| **æœ€å¾Œæ›´æ–°** | 2025-01-06 |

### 2. åŠŸèƒ½èªªæ˜

#### 2.1 ç”¨é€”
**æ—…è¡Œç¤¾è²¡å‹™æ ¸å¿ƒç³»çµ±** - ç®¡ç†æ”¶æ¬¾ã€è«‹æ¬¾ã€å‡ºç´æ”¯å‡ºã€é‡‘æµå°å¸³ï¼Œç¢ºä¿è²¡å‹™è³‡æ–™æº–ç¢ºæ€§ã€‚

#### 2.2 ä½¿ç”¨è€…
- **è²¡å‹™äººå“¡** - æ—¥å¸¸æ”¶æ¬¾ã€è«‹æ¬¾ã€å°å¸³
- **æœƒè¨ˆäººå“¡** - æœˆçµã€å ±è¡¨ç”Ÿæˆ
- **ç®¡ç†å±¤** - è²¡å‹™æ¦‚è¦½ã€åˆ©æ½¤åˆ†æ

#### 2.3 æ¥­å‹™æµç¨‹

**ä¸»è¦æµç¨‹ï¼š**
```
1. æ”¶æ¬¾ç®¡ç† (Payments) â”€â”
2. è«‹æ¬¾ç®¡ç† (Requests) â”€â”¼â”€> å‡ºç´ç®¡ç† (Treasury) â”€> å°å¸³ (Reconciliation)
3. ç›´æ¥æ”¯å‡º (Direct)   â”€â”˜            â”‚
                                    â†“
                              è²¡å‹™å ±è¡¨ (Reports)
```

**å­æ¨¡çµ„èªªæ˜ï¼š**
- **`/finance/payments`** - æ”¶æ¬¾å–®ï¼šå–®è¨‚å–®å¤šä»˜æ¬¾/æ‰¹é‡åˆ†é…æ”¶æ¬¾
- **`/finance/requests`** - è«‹æ¬¾å–®ï¼šæŒ‰æ—…éŠåœ˜è«‹æ¬¾ï¼Œé€±å››å›ºå®šå‡ºå¸³
- **`/finance/treasury/disbursement`** - å‡ºç´æ”¯å‡ºï¼šé€±æœŸæ‰¹æ¬¡æ”¯ä»˜
- **`/finance/reports`** - è²¡å‹™å ±è¡¨ï¼šæ‡‰æ”¶/æ‡‰ä»˜/æ·¨åˆ©çµ±è¨ˆ
- **`/finance/travel-invoice`** - æ—…éŠç™¼ç¥¨ç®¡ç†ï¼ˆæœªå®Œæˆï¼‰

---

### 3. è³‡æ–™æ¨¡å‹

#### 3.1 Payment (æ”¶æ¬¾è¨˜éŒ„)

| æ¬„ä½åç¨± | å‹åˆ¥ | å¿…å¡« | èªªæ˜ | âš ï¸ å•é¡Œ |
|---------|------|------|------|---------|
| `id` | string | âœ… | UUID | |
| `orderId` | string | âœ… | è¨‚å–®ID | |
| `amount` | number | âœ… | é‡‘é¡ | |
| `type` | `'æ”¶æ¬¾' \| 'è«‹æ¬¾' \| 'å‡ºç´'` | âœ… | æ”¯ä»˜é¡å‹ | âš ï¸ **ä¸­æ–‡å€¼** |
| `status` | `'æœªæ”¶æ¬¾' \| 'å·²ç¢ºèª' \| 'å·²å®Œæˆ'` | âœ… | ç‹€æ…‹ | âš ï¸ **ä¸­æ–‡å€¼** |
| `description` | string | âŒ | èªªæ˜ | |
| `createdAt` | string | âœ… | å»ºç«‹æ™‚é–“ | |
| `updatedAt` | string | âœ… | æ›´æ–°æ™‚é–“ | |

#### 3.2 PaymentRequest (è«‹æ¬¾å–®)

| æ¬„ä½åç¨± | å‹åˆ¥ | å¿…å¡« | èªªæ˜ | âš ï¸ å•é¡Œ |
|---------|------|------|------|---------|
| `id` | string | âœ… | UUID | |
| `requestNumber` | string | âœ… | è«‹æ¬¾å–®è™Ÿ (REQ-2025001) | |
| `tourId` | string | âœ… | æ—…éŠåœ˜ID | |
| `tourName` | string | âœ… | åœ˜å | âš ï¸ å†—é¤˜æ¬„ä½ |
| `code` | string | âœ… | åœ˜è™Ÿ | âš ï¸ å†—é¤˜æ¬„ä½ |
| `orderId` | string | âŒ | è¨‚å–®IDï¼ˆå¯é¸ï¼‰ | |
| `orderNumber` | string | âŒ | è¨‚å–®ç·¨è™Ÿ | âš ï¸ å†—é¤˜æ¬„ä½ |
| `requestDate` | string | âŒ | è«‹æ¬¾æ—¥æœŸï¼ˆå›ºå®šé€±å››ï¼‰ | |
| `items` | PaymentRequestItem[] | âœ… | è«‹æ¬¾é …ç›® | |
| `totalAmount` | number | âœ… | ç¸½é‡‘é¡ | âš ï¸ æ‡‰è¨ˆç®—è€Œéå„²å­˜ |
| `status` | `'pending' \| 'processing' \| 'confirmed' \| 'paid'` | âœ… | ç‹€æ…‹ | âœ… ä½¿ç”¨è‹±æ–‡ |
| `note` | string | âŒ | å‚™è¨» | |
| `isSpecialBilling` | boolean | âœ… | æ˜¯å¦ç‰¹æ®Šè«‹æ¬¾ | |
| `disbursementOrderId` | string | âŒ | å‡ºç´å–®ID | |
| `createdBy` | string | âœ… | å»ºç«‹äºº | |
| `confirmedBy` | string | âŒ | ç¢ºèªäºº | |
| `confirmedAt` | string | âŒ | ç¢ºèªæ™‚é–“ | |
| `createdAt` | string | âœ… | å»ºç«‹æ™‚é–“ | |
| `updatedAt` | string | âœ… | æ›´æ–°æ™‚é–“ | |

#### 3.3 PaymentRequestItem (è«‹æ¬¾é …ç›®)

| æ¬„ä½åç¨± | å‹åˆ¥ | å¿…å¡« | èªªæ˜ | âš ï¸ å•é¡Œ |
|---------|------|------|------|---------|
| `id` | string | âœ… | UUID | |
| `requestId` | string | âœ… | è«‹æ¬¾å–®ID | |
| `category` | `'ä½å®¿' \| 'äº¤é€š' \| 'é¤é£Ÿ' \| 'é–€ç¥¨' \| 'å°éŠ' \| 'å…¶ä»–'` | âœ… | è²»ç”¨é¡åˆ¥ | âš ï¸ **ä¸­æ–‡å€¼** |
| `supplierId` | string | âœ… | ä¾›æ‡‰å•†ID | |
| `supplierName` | string | âœ… | ä¾›æ‡‰å•†åç¨± | âš ï¸ å†—é¤˜æ¬„ä½ |
| `description` | string | âŒ | é …ç›®æè¿° | |
| `unitPrice` | number | âœ… | å–®åƒ¹ | |
| `quantity` | number | âœ… | æ•¸é‡ | |
| `subtotal` | number | âœ… | å°è¨ˆ | âš ï¸ æ‡‰è¨ˆç®—è€Œéå„²å­˜ |
| `note` | string | âŒ | å‚™è¨» | |
| `sortOrder` | number | âœ… | æ’åº | |

#### 3.4 DisbursementOrder (å‡ºç´å–®)

| æ¬„ä½åç¨± | å‹åˆ¥ | å¿…å¡« | èªªæ˜ | âš ï¸ å•é¡Œ |
|---------|------|------|------|---------|
| `id` | string | âœ… | UUID | |
| `weekNumber` | string | âœ… | é€±æ¬¡ (2025-W02) | |
| `weekStartDate` | string | âœ… | é€±èµ·å§‹æ—¥ | |
| `weekEndDate` | string | âœ… | é€±çµæŸæ—¥ | |
| `thursdayDate` | string | âœ… | é€±å››å‡ºå¸³æ—¥ | |
| `requestIds` | string[] | âœ… | åŒ…å«çš„è«‹æ¬¾å–®ID | |
| `totalAmount` | number | âœ… | ç¸½é‡‘é¡ | âš ï¸ æ‡‰è¨ˆç®—è€Œéå„²å­˜ |
| `status` | `'draft' \| 'confirmed' \| 'paid'` | âœ… | ç‹€æ…‹ | âœ… ä½¿ç”¨è‹±æ–‡ |
| `note` | string | âŒ | å‚™è¨» | |
| `createdBy` | string | âœ… | å»ºç«‹äºº | |
| `confirmedBy` | string | âŒ | ç¢ºèªäºº | |
| `confirmedAt` | string | âŒ | ç¢ºèªæ™‚é–“ | |
| `paidAt` | string | âŒ | æ”¯ä»˜æ™‚é–“ | |
| `createdAt` | string | âœ… | å»ºç«‹æ™‚é–“ | |
| `updatedAt` | string | âœ… | æ›´æ–°æ™‚é–“ | |

#### 3.5 è³‡æ–™é—œè¯åœ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Order   â”‚â”€â”
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ 1
             â”œâ”€â”€> â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” N
             â”‚    â”‚ Payment  â”‚ (æ”¶æ¬¾è¨˜éŒ„)
             â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ 1
â”‚   Tour   â”‚â”€â”¼â”€â”€> â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” 1
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚ PaymentRequest    â”‚
             â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚              â”‚ 1
             â”‚              â”œâ”€â”€> â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” N
             â”‚              â”‚    â”‚ PaymentRequestItem   â”‚
             â”‚              â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚              â”‚
             â”‚              â”‚ N
             â”‚              â””â”€â”€> â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” 1
             â”‚                   â”‚ DisbursementOrder  â”‚ (å‡ºç´å–®)
             â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ Supplier â”‚â”€â”˜ N (é—œè¯åˆ° PaymentRequestItem)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 4. UI çµ„ä»¶

#### 4.1 ä¸»è¦é é¢

| è·¯å¾‘ | æª”æ¡ˆ | åŠŸèƒ½ |
|------|------|------|
| `/finance` | `src/app/finance/page.tsx` | è²¡å‹™å„€è¡¨æ¿ |
| `/finance/payments` | `src/app/finance/payments/page.tsx` | æ”¶æ¬¾ç®¡ç† |
| `/finance/requests` | `src/app/finance/requests/page.tsx` | è«‹æ¬¾ç®¡ç† |
| `/finance/treasury/disbursement` | `src/app/finance/treasury/disbursement/page.tsx` | å‡ºç´æ”¯å‡º |
| `/finance/reports` | `src/app/finance/reports/page.tsx` | è²¡å‹™å ±è¡¨ |

#### 4.2 é—œéµçµ„ä»¶é‚è¼¯

**æ”¶æ¬¾æ¨¡å¼ï¼ˆPaymentsï¼‰ï¼š**
```typescript
// æ¨¡å¼ 1: å–®ä¸€è¨‚å–®å¤šä»˜æ¬¾
interface PaymentItem {
  paymentMethod: 'ç¾é‡‘' | 'åŒ¯æ¬¾' | 'åˆ·å¡' | 'æ”¯ç¥¨';  // âš ï¸ ä¸­æ–‡
  amount: number;
  transactionDate: string;
  // æ ¹æ“šä»˜æ¬¾æ–¹å¼å‹•æ…‹æ¬„ä½
  handlerName?: string;      // ç¾é‡‘
  accountInfo?: string;       // åŒ¯æ¬¾
  cardLastFour?: string;      // åˆ·å¡
  checkNumber?: string;       // æ”¯ç¥¨
}

// æ¨¡å¼ 2: æ‰¹é‡åˆ†é…å¤šè¨‚å–®
interface OrderAllocation {
  orderId: string;
  allocatedAmount: number;
}
```

**è«‹æ¬¾é€±å››é‚è¼¯ï¼ˆRequestsï¼‰ï¼š**
```typescript
// ç”Ÿæˆæ¥ä¸‹ä¾† 8 é€±çš„é€±å››æ—¥æœŸ
const upcomingThursdays = useMemo(() => {
  const thursdays = []
  const today = new Date()
  const currentDay = today.getDay()

  let daysUntilThursday = (4 - currentDay + 7) % 7
  if (daysUntilThursday === 0 && today.getHours() >= 12) {
    // ä»Šå¤©é€±å››ä¸”å·²éä¸­åˆï¼Œå¾ä¸‹é€±å››é–‹å§‹
    daysUntilThursday = 7
  }

  for (let i = 0; i < 8; i++) {
    const thursdayDate = new Date(today)
    thursdayDate.setDate(today.getDate() + daysUntilThursday + i * 7)
    thursdays.push({
      value: thursdayDate.toISOString().split('T')[0],
      label: `${thursdayDate.toLocaleDateString('zh-TW')} (${thursdayDate.toLocaleDateString('zh-TW', { weekday: 'short' })})`
    })
  }

  return thursdays
}, [])
```

---

### 5. è³‡æ–™å±¤æ¶æ§‹

#### 5.1 Hook Layer

**æª”æ¡ˆ**: `src/features/payments/hooks/usePayments.ts` (84 lines)

```typescript
export const usePayments = () => {
  // === PaymentRequest ç›¸é—œ ===
  const createPaymentRequest = async (data: Partial<PaymentRequest>) => {
    const requestNumber = generateRequestNumber();
    // ...
  };

  const updatePaymentRequest = async (id: string, updates: Partial<PaymentRequest>) => {
    // ...
  };

  const deletePaymentRequest = async (id: string) => {
    // ...
  };

  // å¾å ±åƒ¹å–®å»ºç«‹è«‹æ¬¾å–®
  const createFromQuote = async (tourId: string, quoteId: string, requestDate?: string) => {
    // è®€å– Quote è³‡æ–™
    // è½‰æ›ç‚º PaymentRequest
  };

  // === PaymentRequestItem ç›¸é—œ ===
  const addPaymentItem = async (requestId: string, item: Partial<PaymentRequestItem>) => {
    // ...
  };

  const updatePaymentItem = async (requestId: string, itemId: string, updates: Partial<PaymentRequestItem>) => {
    // ...
  };

  const deletePaymentItem = async (requestId: string, itemId: string) => {
    // ...
  };

  // === DisbursementOrder ç›¸é—œ ===
  const createDisbursementOrder = async (weekNumber: string, requestIds: string[]) => {
    // ...
  };

  const confirmDisbursementOrder = async (id: string, confirmedBy: string) => {
    // ...
  };

  const getCurrentWeekDisbursementOrder = () => {
    // å–å¾—æœ¬é€±å‡ºç´å–®
    const weekNumber = format(new Date(), 'yyyy-\'W\'II');
    return disbursementOrders.find(order => order.weekNumber === weekNumber);
  };

  return {
    // PaymentRequest
    paymentRequests,
    createPaymentRequest,
    updatePaymentRequest,
    deletePaymentRequest,
    createFromQuote,

    // PaymentRequestItem
    addPaymentItem,
    updatePaymentItem,
    deletePaymentItem,

    // DisbursementOrder
    disbursementOrders,
    createDisbursementOrder,
    confirmDisbursementOrder,
    getCurrentWeekDisbursementOrder,
  };
};
```

#### 5.2 Service Layer

**æª”æ¡ˆ**: `src/features/payments/services/payment.service.ts`

```typescript
class PaymentService {
  // ç”Ÿæˆè«‹æ¬¾å–®è™Ÿ (REQ-2025001)
  generateRequestNumber(): string {
    const year = new Date().getFullYear();
    const count = this.paymentRequests.length + 1;
    return `REQ-${year}${count.toString().padStart(3, '0')}`;
  }

  // å–å¾—ä¸‹ä¸€å€‹é€±å››
  getNextThursday(): string {
    const today = new Date();
    const dayOfWeek = today.getDay();
    let daysUntilThursday = (4 - dayOfWeek + 7) % 7;

    if (daysUntilThursday === 0 && today.getHours() >= 12) {
      daysUntilThursday = 7; // ä»Šå¤©é€±å››éä¸­åˆï¼Œå–ä¸‹é€±å››
    }

    const nextThursday = new Date(today);
    nextThursday.setDate(today.getDate() + daysUntilThursday);
    return nextThursday.toISOString().split('T')[0];
  }

  // å¾å ±åƒ¹å–®å‰µå»ºè«‹æ¬¾å–®
  async createFromQuote(tourId: string, quoteId: string, requestDate?: string) {
    const quote = await quoteService.getById(quoteId);
    if (!quote) throw new Error('å ±åƒ¹å–®ä¸å­˜åœ¨');

    // è½‰æ› Quote çš„ categories ç‚º PaymentRequestItems
    const items: PaymentRequestItem[] = [];
    quote.categories.forEach(category => {
      category.items.forEach(quoteItem => {
        items.push({
          id: generateId(),
          requestId: '', // ç¨å¾Œå¡«å…¥
          category: this.mapCategoryToChinese(category.name), // âš ï¸ æ˜ å°„åˆ°ä¸­æ–‡
          supplierId: '', // éœ€è¦å¾å…¶ä»–åœ°æ–¹ç²å–
          supplierName: quoteItem.name,
          description: quoteItem.note || '',
          unitPrice: quoteItem.unitPrice,
          quantity: quoteItem.quantity,
          subtotal: quoteItem.total,
          note: '',
          sortOrder: items.length + 1,
        });
      });
    });

    // å‰µå»º PaymentRequest
    const request: PaymentRequest = {
      id: generateId(),
      requestNumber: this.generateRequestNumber(),
      tourId,
      code: quote.code || '',
      tourName: quote.name || '',
      requestDate: requestDate || this.getNextThursday(),
      items,
      totalAmount: quote.totalCost,
      status: 'pending',
      isSpecialBilling: false,
      createdBy: '1', // æ¨¡æ“¬
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString(),
    };

    return this.paymentRequestStore.add(request);
  }

  // é©—è­‰è«‹æ¬¾å–®
  validate(data: Partial<PaymentRequest>): string[] {
    const errors: string[] = [];

    if (!data.tourId) errors.push('å¿…é ˆé¸æ“‡æ—…éŠåœ˜');
    if (!data.items || data.items.length === 0) errors.push('å¿…é ˆè‡³å°‘æœ‰ä¸€å€‹è«‹æ¬¾é …ç›®');
    if (data.totalAmount && data.totalAmount <= 0) errors.push('ç¸½é‡‘é¡å¿…é ˆå¤§æ–¼ 0');

    return errors;
  }
}
```

#### 5.3 Store Layer

ä½¿ç”¨ Zustand Store Factory Pattern:

```typescript
// Store çµæ§‹ï¼ˆç”± createStore ç”Ÿæˆï¼‰
interface PaymentStore {
  items: Payment[];
  add: (item: Payment) => Promise<Payment>;
  update: (id: string, updates: Partial<Payment>) => Promise<void>;
  remove: (id: string) => Promise<void>;
  getById: (id: string) => Payment | undefined;
}

// å„²å­˜åˆ° IndexedDB
const usePaymentStore = createStore<Payment>('payments', 'payment_');
const usePaymentRequestStore = createStore<PaymentRequest>('paymentRequests', 'req_');
const useDisbursementOrderStore = createStore<DisbursementOrder>('disbursementOrders', 'disb_');
```

---

### 6. API ç«¯é»ï¼ˆPhase 3 è¦åŠƒï¼‰

#### 6.1 æ”¶æ¬¾ API

| æ–¹æ³• | ç«¯é» | èªªæ˜ | Request Body | Response |
|------|------|------|-------------|----------|
| `GET` | `/api/payments` | å–å¾—æ”¶æ¬¾åˆ—è¡¨ | Query: `?orderId=xxx&status=xxx` | `{ data: Payment[] }` |
| `POST` | `/api/payments` | æ–°å¢æ”¶æ¬¾è¨˜éŒ„ | `Payment` | `{ data: Payment }` |
| `PUT` | `/api/payments/:id` | æ›´æ–°æ”¶æ¬¾è¨˜éŒ„ | `Partial<Payment>` | `{ data: Payment }` |
| `DELETE` | `/api/payments/:id` | åˆªé™¤æ”¶æ¬¾è¨˜éŒ„ | - | `{ success: true }` |

#### 6.2 è«‹æ¬¾ API

| æ–¹æ³• | ç«¯é» | èªªæ˜ | Request Body | Response |
|------|------|------|-------------|----------|
| `GET` | `/api/payment-requests` | å–å¾—è«‹æ¬¾å–®åˆ—è¡¨ | Query: `?tourId=xxx&status=xxx` | `{ data: PaymentRequest[] }` |
| `GET` | `/api/payment-requests/:id` | å–å¾—è«‹æ¬¾å–®è©³æƒ… | - | `{ data: PaymentRequest }` |
| `POST` | `/api/payment-requests` | æ–°å¢è«‹æ¬¾å–® | `PaymentRequest` | `{ data: PaymentRequest }` |
| `POST` | `/api/payment-requests/from-quote` | å¾å ±åƒ¹å–®å»ºç«‹è«‹æ¬¾å–® | `{ tourId, quoteId, requestDate? }` | `{ data: PaymentRequest }` |
| `PUT` | `/api/payment-requests/:id` | æ›´æ–°è«‹æ¬¾å–® | `Partial<PaymentRequest>` | `{ data: PaymentRequest }` |
| `DELETE` | `/api/payment-requests/:id` | åˆªé™¤è«‹æ¬¾å–® | - | `{ success: true }` |

#### 6.3 å‡ºç´ API

| æ–¹æ³• | ç«¯é» | èªªæ˜ | Request Body | Response |
|------|------|------|-------------|----------|
| `GET` | `/api/disbursement-orders` | å–å¾—å‡ºç´å–®åˆ—è¡¨ | Query: `?weekNumber=xxx&status=xxx` | `{ data: DisbursementOrder[] }` |
| `GET` | `/api/disbursement-orders/current-week` | å–å¾—æœ¬é€±å‡ºç´å–® | - | `{ data: DisbursementOrder }` |
| `POST` | `/api/disbursement-orders` | æ–°å¢å‡ºç´å–® | `{ weekNumber, requestIds[] }` | `{ data: DisbursementOrder }` |
| `POST` | `/api/disbursement-orders/:id/confirm` | ç¢ºèªå‡ºç´å–® | `{ confirmedBy }` | `{ data: DisbursementOrder }` |

---

### 7. æ¬Šé™æ§åˆ¶

| è§’è‰² | æ”¶æ¬¾ç®¡ç† | è«‹æ¬¾ç®¡ç† | å‡ºç´ç®¡ç† | è²¡å‹™å ±è¡¨ |
|------|---------|---------|---------|---------|
| **ç®¡ç†å“¡** | âœ… å®Œæ•´æ¬Šé™ | âœ… å®Œæ•´æ¬Šé™ | âœ… å®Œæ•´æ¬Šé™ | âœ… å®Œæ•´æ¬Šé™ |
| **è²¡å‹™äººå“¡** | âœ… æ–°å¢/æŸ¥çœ‹/ä¿®æ”¹ | âœ… æ–°å¢/æŸ¥çœ‹/ä¿®æ”¹ | âœ… æ–°å¢/æŸ¥çœ‹ | âœ… æŸ¥çœ‹ |
| **æœƒè¨ˆäººå“¡** | âœ… æŸ¥çœ‹ | âœ… æŸ¥çœ‹ | âœ… ç¢ºèª/æ”¯ä»˜ | âœ… å®Œæ•´æ¬Šé™ |
| **æ¥­å‹™äººå“¡** | âŒ ç„¡ | âœ… æŸ¥çœ‹è‡ªå·±çš„ | âŒ ç„¡ | âŒ ç„¡ |

---

### 8. å·²çŸ¥å•é¡Œ

#### 8.1 æ¬„ä½å‘½åå•é¡Œ

âŒ **Payment ä½¿ç”¨ä¸­æ–‡å€¼**
```typescript
// ç¾ç‹€
type: 'æ”¶æ¬¾' | 'è«‹æ¬¾' | 'å‡ºç´'
status: 'æœªæ”¶æ¬¾' | 'å·²ç¢ºèª' | 'å·²å®Œæˆ'

// å»ºè­°
type: 'receipt' | 'request' | 'disbursement'
status: 'pending' | 'confirmed' | 'completed'
```

âŒ **PaymentRequestItem category ä½¿ç”¨ä¸­æ–‡**
```typescript
// ç¾ç‹€
category: 'ä½å®¿' | 'äº¤é€š' | 'é¤é£Ÿ' | 'é–€ç¥¨' | 'å°éŠ' | 'å…¶ä»–'

// å»ºè­°
category: 'accommodation' | 'transport' | 'meals' | 'tickets' | 'guide' | 'other'
```

âŒ **Payment Method ä½¿ç”¨ä¸­æ–‡**
```typescript
// ç¾ç‹€ (UI å±¤é¢)
paymentMethod: 'ç¾é‡‘' | 'åŒ¯æ¬¾' | 'åˆ·å¡' | 'æ”¯ç¥¨'

// å»ºè­°
paymentMethod: 'cash' | 'transfer' | 'card' | 'check'
```

#### 8.2 å†—é¤˜æ¬„ä½å•é¡Œ

âš ï¸ **PaymentRequest å„²å­˜ Tour å’Œ Order çš„åç¨±**
```typescript
interface PaymentRequest {
  tourId: string;
  tourName: string;  // âŒ æ‡‰å¾ Tour æŸ¥è©¢
  code: string;      // âŒ æ‡‰å¾ Tour æŸ¥è©¢
  orderId?: string;
  orderNumber?: string;  // âŒ æ‡‰å¾ Order æŸ¥è©¢
}
```

âš ï¸ **PaymentRequestItem å„²å­˜ supplierName**
```typescript
interface PaymentRequestItem {
  supplierId: string;
  supplierName: string;  // âŒ æ‡‰å¾ Supplier æŸ¥è©¢
}
```

#### 8.3 è³‡æ–™è¨ˆç®—å•é¡Œ

âš ï¸ **å„²å­˜è¨ˆç®—çµæœè€Œéå‹•æ…‹è¨ˆç®—**
```typescript
// ç¾ç‹€
interface PaymentRequest {
  totalAmount: number;  // âŒ æ‡‰ç”± items.reduce((sum, item) => sum + item.subtotal, 0) è¨ˆç®—
}

interface PaymentRequestItem {
  subtotal: number;  // âŒ æ‡‰ç”± unitPrice * quantity è¨ˆç®—
}

interface DisbursementOrder {
  totalAmount: number;  // âŒ æ‡‰ç”±é—œè¯çš„ PaymentRequest åŠ ç¸½
}
```

#### 8.4 Service å±¤é‚è¼¯å•é¡Œ

âŒ **createFromQuote éœ€è¦æ˜ å°„ä¸­æ–‡é¡åˆ¥**
```typescript
// src/features/payments/services/payment.service.ts
mapCategoryToChinese(name: string): PaymentRequestItem['category'] {
  // ç¡¬ç·¨ç¢¼ä¸­æ–‡æ˜ å°„é‚è¼¯ï¼Œä¸æ˜“ç¶­è­·
  const mapping: Record<string, PaymentRequestItem['category']> = {
    'ä½å®¿': 'ä½å®¿',
    'Accommodation': 'ä½å®¿',
    'äº¤é€š': 'äº¤é€š',
    // ...
  };
  return mapping[name] || 'å…¶ä»–';
}
```

#### 8.5 ç¼ºå°‘é—œéµæ¬„ä½

âŒ **Payment ç¼ºå°‘ paymentMethod**
```typescript
// ç¾ç‹€
interface Payment {
  type: 'æ”¶æ¬¾' | 'è«‹æ¬¾' | 'å‡ºç´';
  // âŒ ç¼ºå°‘ paymentMethod: 'cash' | 'transfer' | 'card' | 'check'
}

// UI å±¤é¢æœ‰ä½¿ç”¨ PaymentItem interfaceï¼Œä½†æ²’æœ‰åŒæ­¥åˆ° Store
```

---

### 9. ä¿®å¾©å»ºè­°

#### 9.1 P0 - å¿…é ˆä¿®æ­£ï¼ˆå½±éŸ¿ç³»çµ±ç©©å®šï¼‰

1. **çµ±ä¸€ Payment status/type ç‚ºè‹±æ–‡**
   - ä¿®æ”¹ `src/stores/types.ts` çš„ Payment interface
   - æ›´æ–°æ‰€æœ‰ Service å±¤çš„ç‹€æ…‹åˆ¤æ–·é‚è¼¯
   - UI å±¤ä½¿ç”¨ mapping é¡¯ç¤ºä¸­æ–‡

2. **çµ±ä¸€ PaymentRequestItem category ç‚ºè‹±æ–‡**
   - ä¿®æ”¹ interface å®šç¾©
   - æ›´æ–° categoryOptions ç‚º `{ value: 'accommodation', label: 'ä½å®¿' }` æ ¼å¼
   - Service å±¤ç§»é™¤ `mapCategoryToChinese` é‚è¼¯

3. **ç§»é™¤ createFromQuote çš„ä¸­æ–‡æ˜ å°„é‚è¼¯**
   - ç›´æ¥ä½¿ç”¨è‹±æ–‡é¡åˆ¥
   - ç¢ºä¿ Quote å’Œ PaymentRequest ä½¿ç”¨ç›¸åŒé¡åˆ¥å®šç¾©

#### 9.2 P1 - æ‡‰è©²ä¿®æ­£ï¼ˆå½±éŸ¿å¯ç¶­è­·æ€§ï¼‰

4. **ç§»é™¤å†—é¤˜æ¬„ä½**
   ```typescript
   // ä¿®æ”¹ PaymentRequest interface
   interface PaymentRequest {
     tourId: string;
     // âŒ ç§»é™¤ tourName, code
     orderId?: string;
     // âŒ ç§»é™¤ orderNumber
   }

   // ä¿®æ”¹ PaymentRequestItem interface
   interface PaymentRequestItem {
     supplierId: string;
     // âŒ ç§»é™¤ supplierName
   }
   ```

5. **æ”¹ç‚ºå‹•æ…‹è¨ˆç®—æ¬„ä½**
   ```typescript
   // ä¿®æ”¹ Service å±¤
   class PaymentService {
     getTotalAmount(request: PaymentRequest): number {
       return request.items.reduce((sum, item) =>
         sum + (item.unitPrice * item.quantity), 0
       );
     }
   }
   ```

6. **Payment interface è£œå…… paymentMethod**
   ```typescript
   interface Payment {
     id: string;
     orderId: string;
     amount: number;
     type: 'receipt' | 'request' | 'disbursement';
     status: 'pending' | 'confirmed' | 'completed';
     paymentMethod?: 'cash' | 'transfer' | 'card' | 'check';  // âœ… æ–°å¢
     description?: string;
     createdAt: string;
     updatedAt: string;
   }
   ```

#### 9.3 P2 - å¯ä»¥å„ªåŒ–ï¼ˆå¢å¼·åŠŸèƒ½ï¼‰

7. **åˆ†é›¢ UI é‚è¼¯çš„ PaymentItem å’Œ Store çš„ Payment**
   - å»ºç«‹ `PaymentDetail` interface ç”¨æ–¼å„²å­˜è©³ç´°ä»˜æ¬¾è³‡è¨Š
   - `Payment` ä¿æŒç°¡æ½”ï¼Œåªå­˜æ ¸å¿ƒè³‡æ–™

8. **å»ºç«‹ Enum çµ±ä¸€ç®¡ç†**
   ```typescript
   export enum PaymentType {
     RECEIPT = 'receipt',
     REQUEST = 'request',
     DISBURSEMENT = 'disbursement'
   }

   export enum PaymentCategory {
     ACCOMMODATION = 'accommodation',
     TRANSPORT = 'transport',
     MEALS = 'meals',
     TICKETS = 'tickets',
     GUIDE = 'guide',
     OTHER = 'other'
   }
   ```

---

### 10. è³‡æ–™è¡¨å»ºè­°ï¼ˆPhase 3ï¼‰

```sql
-- æ”¶æ¬¾è¨˜éŒ„
CREATE TABLE payments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  order_id UUID NOT NULL REFERENCES orders(id),
  amount DECIMAL(12, 2) NOT NULL,
  type VARCHAR(20) NOT NULL CHECK (type IN ('receipt', 'request', 'disbursement')),
  status VARCHAR(20) NOT NULL CHECK (status IN ('pending', 'confirmed', 'completed')),
  payment_method VARCHAR(20) CHECK (payment_method IN ('cash', 'transfer', 'card', 'check')),
  description TEXT,
  created_at TIMESTAMP NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMP NOT NULL DEFAULT NOW()
);

-- è«‹æ¬¾å–®
CREATE TABLE payment_requests (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  request_number VARCHAR(50) UNIQUE NOT NULL,
  tour_id UUID NOT NULL REFERENCES tours(id),
  order_id UUID REFERENCES orders(id),
  request_date DATE,
  status VARCHAR(20) NOT NULL CHECK (status IN ('pending', 'processing', 'confirmed', 'paid')),
  note TEXT,
  is_special_billing BOOLEAN DEFAULT FALSE,
  disbursement_order_id UUID REFERENCES disbursement_orders(id),
  created_by UUID REFERENCES users(id),
  confirmed_by UUID REFERENCES users(id),
  confirmed_at TIMESTAMP,
  created_at TIMESTAMP NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMP NOT NULL DEFAULT NOW()
);

-- è«‹æ¬¾é …ç›®
CREATE TABLE payment_request_items (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  request_id UUID NOT NULL REFERENCES payment_requests(id) ON DELETE CASCADE,
  category VARCHAR(20) NOT NULL CHECK (category IN ('accommodation', 'transport', 'meals', 'tickets', 'guide', 'other')),
  supplier_id UUID NOT NULL REFERENCES suppliers(id),
  description TEXT,
  unit_price DECIMAL(12, 2) NOT NULL,
  quantity INT NOT NULL,
  note TEXT,
  sort_order INT NOT NULL,
  created_at TIMESTAMP NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMP NOT NULL DEFAULT NOW()
);

-- å‡ºç´å–®
CREATE TABLE disbursement_orders (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  week_number VARCHAR(10) NOT NULL,
  week_start_date DATE NOT NULL,
  week_end_date DATE NOT NULL,
  thursday_date DATE NOT NULL,
  status VARCHAR(20) NOT NULL CHECK (status IN ('draft', 'confirmed', 'paid')),
  note TEXT,
  created_by UUID REFERENCES users(id),
  confirmed_by UUID REFERENCES users(id),
  confirmed_at TIMESTAMP,
  paid_at TIMESTAMP,
  created_at TIMESTAMP NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMP NOT NULL DEFAULT NOW(),
  UNIQUE(week_number)
);

-- è¨ˆç®—æ¬„ä½ä½¿ç”¨ VIEW
CREATE VIEW payment_request_summary AS
SELECT
  pr.id,
  pr.request_number,
  pr.tour_id,
  t.code AS tour_code,
  t.name AS tour_name,
  pr.order_id,
  o.order_number,
  pr.request_date,
  SUM(pri.unit_price * pri.quantity) AS total_amount,
  pr.status,
  pr.created_at
FROM payment_requests pr
LEFT JOIN tours t ON pr.tour_id = t.id
LEFT JOIN orders o ON pr.order_id = o.id
LEFT JOIN payment_request_items pri ON pr.id = pri.request_id
GROUP BY pr.id, pr.request_number, pr.tour_id, t.code, t.name,
         pr.order_id, o.order_number, pr.request_date, pr.status, pr.created_at;

-- ç´¢å¼•
CREATE INDEX idx_payments_order_id ON payments(order_id);
CREATE INDEX idx_payments_created_at ON payments(created_at);
CREATE INDEX idx_payment_requests_tour_id ON payment_requests(tour_id);
CREATE INDEX idx_payment_requests_request_date ON payment_requests(request_date);
CREATE INDEX idx_payment_request_items_request_id ON payment_request_items(request_id);
CREATE INDEX idx_disbursement_orders_week_number ON disbursement_orders(week_number);
```

---

**å»ºç«‹æ™‚é–“**: 2025-01-06
**è² è²¬æ¨¡çµ„**: Finance (å« Payments, Requests, Treasury, Reports)
**å„ªå…ˆç´š**: P0
**ç‹€æ…‹**: âœ… è¦æ ¼å·²å®Œæˆ

---

## 6ï¸âƒ£ P0-6: æœƒè¨ˆç³»çµ± (Accounting)

### 1. åŸºæœ¬è³‡è¨Š

| é …ç›® | å…§å®¹ |
|------|------|
| **è·¯å¾‘** | `/accounting` |
| **ç‹€æ…‹** | âœ… å·²å¯¦ä½œ - å€‹äººè¨˜å¸³ç³»çµ± |
| **é–‹ç™¼éšæ®µ** | Phase 1 (IndexedDB) |
| **æœ€å¾Œæ›´æ–°** | 2025-01-06 |

### 2. åŠŸèƒ½èªªæ˜

#### 2.1 ç”¨é€”
**å€‹äººè¨˜å¸³ç³»çµ±** - ç®¡ç†å€‹äººå¸³æˆ¶ã€äº¤æ˜“è¨˜éŒ„ã€é ç®—è¨­å®šï¼Œæä¾›å¿«é€Ÿè¨˜å¸³èˆ‡è²¡å‹™çµ±è¨ˆåŠŸèƒ½ã€‚

#### 2.2 ä½¿ç”¨è€…
- **å€‹äººç”¨æˆ¶** - æ—¥å¸¸è¨˜å¸³ã€è¿½è¹¤æ”¯å‡º
- **è²¡å‹™äººå“¡** - å€‹äººè²¡å‹™ç®¡ç†ã€é ç®—æ§åˆ¶
- **æ‰€æœ‰å“¡å·¥** - å€‹äººè²»ç”¨è¿½è¹¤

#### 2.3 æ¥­å‹™æµç¨‹

**æ ¸å¿ƒæµç¨‹ï¼š**
```
å¸³æˆ¶ç®¡ç† (Accounts) â”€â”
                    â”œâ”€â”€> äº¤æ˜“è¨˜éŒ„ (Transactions) â”€â”€> çµ±è¨ˆåˆ†æ (Stats)
åˆ†é¡ç®¡ç† (Categories) â”€â”˜                              â†“
                                              é ç®—æé†’ (Budgets)
```

**åŠŸèƒ½æ¨¡çµ„ï¼š**
- **å¸³æˆ¶ç®¡ç†** - ç¾é‡‘ã€éŠ€è¡Œã€ä¿¡ç”¨å¡å¸³æˆ¶
- **äº¤æ˜“è¨˜éŒ„** - æ”¶å…¥ã€æ”¯å‡ºã€è½‰å¸³
- **åˆ†é¡ç®¡ç†** - è‡ªè¨‚æ”¶æ”¯åˆ†é¡
- **é ç®—è¨­å®š** - æœˆåº¦é ç®—èˆ‡æé†’
- **çµ±è¨ˆå ±è¡¨** - ç¸½è³‡ç”¢ã€æœˆæ”¶æ”¯ã€åˆ†é¡çµ±è¨ˆ

---

### 3. è³‡æ–™æ¨¡å‹

#### 3.1 Account (å¸³æˆ¶)

| æ¬„ä½åç¨± | å‹åˆ¥ | å¿…å¡« | èªªæ˜ | âš ï¸ å•é¡Œ |
|---------|------|------|------|---------|
| `id` | string | âœ… | UUID | |
| `name` | string | âœ… | å¸³æˆ¶åç¨± | |
| `type` | `'cash' \| 'credit' \| 'bank'` | âœ… | å¸³æˆ¶é¡å‹ | âœ… ä½¿ç”¨è‹±æ–‡ |
| `balance` | number | âœ… | é¤˜é¡ | |
| `currency` | string | âœ… | å¹£åˆ¥ (TWD, USD) | |
| `description` | string | âŒ | æè¿° | |
| `creditLimit` | number | âŒ | ä¿¡ç”¨é¡åº¦ï¼ˆä¿¡ç”¨å¡ç”¨ï¼‰ | |
| `availableCredit` | number | âŒ | å¯ç”¨é¡åº¦ | âš ï¸ æ‡‰è¨ˆç®—è€Œéå„²å­˜ |
| `createdAt` | string | âœ… | å»ºç«‹æ™‚é–“ | |
| `updatedAt` | string | âœ… | æ›´æ–°æ™‚é–“ | |

#### 3.2 Transaction (äº¤æ˜“è¨˜éŒ„)

| æ¬„ä½åç¨± | å‹åˆ¥ | å¿…å¡« | èªªæ˜ | âš ï¸ å•é¡Œ |
|---------|------|------|------|---------|
| `id` | string | âœ… | UUID | |
| `accountId` | string | âœ… | ä¾†æºå¸³æˆ¶ID | |
| `toAccountId` | string | âŒ | ç›®æ¨™å¸³æˆ¶IDï¼ˆè½‰å¸³ç”¨ï¼‰ | |
| `type` | `'income' \| 'expense' \| 'transfer'` | âœ… | äº¤æ˜“é¡å‹ | âœ… ä½¿ç”¨è‹±æ–‡ |
| `categoryId` | string | âœ… | åˆ†é¡ID | |
| `amount` | number | âœ… | é‡‘é¡ | |
| `description` | string | âœ… | æè¿° | |
| `date` | string | âœ… | äº¤æ˜“æ—¥æœŸ (YYYY-MM-DD) | |
| `createdAt` | string | âœ… | å»ºç«‹æ™‚é–“ | |
| `updatedAt` | string | âœ… | æ›´æ–°æ™‚é–“ | |

**ç¼ºå°‘æ¬„ä½ï¼š**
- âŒ ç¼ºå°‘ `currency`: äº¤æ˜“å¹£åˆ¥
- âŒ ç¼ºå°‘ `accountName`, `categoryName`: å†—é¤˜æ¬„ä½ï¼ˆç”¨æ–¼é¡¯ç¤ºï¼‰

#### 3.3 Category (åˆ†é¡)

| æ¬„ä½åç¨± | å‹åˆ¥ | å¿…å¡« | èªªæ˜ | âš ï¸ å•é¡Œ |
|---------|------|------|------|---------|
| `id` | string | âœ… | UUID | |
| `name` | string | âœ… | åˆ†é¡åç¨± | |
| `type` | `'income' \| 'expense'` | âœ… | åˆ†é¡é¡å‹ | âœ… ä½¿ç”¨è‹±æ–‡ |
| `parent` | string | âŒ | çˆ¶åˆ†é¡ID | |
| `color` | string | âŒ | é¡è‰² (#HEX) | |
| `icon` | string | âŒ | åœ–ç¤ºåç¨± | |
| `createdAt` | string | âœ… | å»ºç«‹æ™‚é–“ | |
| `updatedAt` | string | âœ… | æ›´æ–°æ™‚é–“ | |

#### 3.4 Budget (é ç®—)

| æ¬„ä½åç¨± | å‹åˆ¥ | å¿…å¡« | èªªæ˜ | âš ï¸ å•é¡Œ |
|---------|------|------|------|---------|
| `id` | string | âœ… | UUID | |
| `categoryId` | string | âœ… | åˆ†é¡ID | |
| `amount` | number | âœ… | é ç®—é‡‘é¡ | |
| `period` | `'monthly' \| 'yearly'` | âœ… | é€±æœŸ | âœ… ä½¿ç”¨è‹±æ–‡ |
| `startDate` | string | âœ… | é–‹å§‹æ—¥æœŸ | |
| `endDate` | string | âŒ | çµæŸæ—¥æœŸ | |
| `createdAt` | string | âœ… | å»ºç«‹æ™‚é–“ | |
| `updatedAt` | string | âœ… | æ›´æ–°æ™‚é–“ | |

#### 3.5 AccountingStats (çµ±è¨ˆè³‡æ–™)

| æ¬„ä½åç¨± | å‹åˆ¥ | èªªæ˜ |
|---------|------|------|
| `totalAssets` | number | ç¸½è³‡ç”¢ |
| `totalIncome` | number | ç¸½æ”¶å…¥ |
| `totalExpense` | number | ç¸½æ”¯å‡º |
| `monthlyIncome` | number | æœ¬æœˆæ”¶å…¥ |
| `monthlyExpense` | number | æœ¬æœˆæ”¯å‡º |
| `netWorth` | number | æ·¨å€¼ |
| `categoryBreakdown` | Array | åˆ†é¡çµ±è¨ˆ |

**âš ï¸ å…¨éƒ¨ç‚ºå‹•æ…‹è¨ˆç®—æ¬„ä½ï¼Œä¸æ‡‰å„²å­˜æ–¼è³‡æ–™åº«**

#### 3.6 è³‡æ–™é—œè¯åœ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” 1
â”‚ Account  â”‚â”€â”€â”€â”€> â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” N
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚ Transaction  â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚ N
                        â”‚
                        â†“ 1
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚ Category â”‚<â”€â”€â”€â”
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ 1
                        â”‚ 1       â”‚
                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ (parent)
                        â”‚
                        â”‚ N
                        â†“ 1
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚  Budget  â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 4. UI çµ„ä»¶

#### 4.1 ä¸»è¦é é¢

| è·¯å¾‘ | æª”æ¡ˆ | åŠŸèƒ½ |
|------|------|------|
| `/accounting` | `src/app/accounting/page.tsx` | è¨˜å¸³ä¸»é ï¼ˆç¸½è¦½/äº¤æ˜“/å¸³æˆ¶/è¨­å®šï¼‰ |

#### 4.2 çµ„ä»¶æ¸…å–®

| çµ„ä»¶ | æª”æ¡ˆ | åŠŸèƒ½ |
|------|------|------|
| AccountsOverview | `src/components/accounting/accounts-overview.tsx` | å¸³æˆ¶ç¸½è¦½å¡ç‰‡ |
| AccountsManagement | `src/components/accounting/accounts-management.tsx` | å¸³æˆ¶ç®¡ç†åˆ—è¡¨ |
| TransactionList | `src/components/accounting/transaction-list.tsx` | äº¤æ˜“è¨˜éŒ„åˆ—è¡¨ |
| AddAccountDialog | `src/components/accounting/add-account-dialog.tsx` | æ–°å¢å¸³æˆ¶å°è©±æ¡† |
| AddTransactionDialog | `src/components/accounting/add-transaction-dialog.tsx` | æ–°å¢äº¤æ˜“å°è©±æ¡† |

#### 4.3 é—œéµåŠŸèƒ½é‚è¼¯

**å¿«é€Ÿè¨˜å¸³ï¼š**
```typescript
const handleQuickTransaction = useCallback(async () => {
  if (!quickAmount || !quickCategory || !quickAccount) return;

  const categoryData = categories.find(c => c.id === quickCategory);
  const accountData = accounts.find(a => a.id === quickAccount);

  if (!categoryData || !accountData) return;

  const transactionData = {
    accountId: quickAccount,
    accountName: accountData.name,  // âš ï¸ å†—é¤˜æ¬„ä½
    categoryId: quickCategory,
    categoryName: categoryData.name,  // âš ï¸ å†—é¤˜æ¬„ä½
    type: 'expense' as const,
    amount: parseFloat(quickAmount),
    currency: 'TWD',
    description: '',
    date: today,
  };

  addTransaction(transactionData);
  // æ¸…ç©ºè¡¨å–®ä¸¦é¡¯ç¤ºæˆåŠŸå‹•ç•«
}, [quickAmount, quickCategory, quickAccount, categories, accounts, today, addTransaction]);
```

**é¤˜é¡è‡ªå‹•æ›´æ–°ï¼š**
```typescript
// src/stores/accounting-store.ts
updateAccountBalances: (transaction: Transaction) => {
  const { accountId, toAccountId, type, amount } = transaction;

  if (type === 'expense') {
    // æ”¯å‡ºï¼šæ‰£æ¬¾
    const account = get().accounts.find(a => a.id === accountId);
    if (account) {
      get().updateAccount(accountId, { balance: account.balance - amount });
    }
  } else if (type === 'income') {
    // æ”¶å…¥ï¼šå…¥å¸³
    const account = get().accounts.find(a => a.id === accountId);
    if (account) {
      get().updateAccount(accountId, { balance: account.balance + amount });
    }
  } else if (type === 'transfer') {
    // è½‰å¸³ï¼šfrom æ‰£æ¬¾ï¼Œto å…¥å¸³
    const fromAccount = get().accounts.find(a => a.id === accountId);
    const toAccount = get().accounts.find(a => a.id === toAccountId);
    if (fromAccount) {
      get().updateAccount(accountId, { balance: fromAccount.balance - amount });
    }
    if (toAccount) {
      get().updateAccount(toAccountId, { balance: toAccount.balance + amount });
    }
  }
};
```

---

### 5. è³‡æ–™å±¤æ¶æ§‹

#### 5.1 Store Layer

**æª”æ¡ˆ**: `src/stores/accounting-store.ts`

ä½¿ç”¨ **createComplexStore** å·¥å» æ¨¡å¼ï¼ˆå¢å¼·ç‰ˆï¼‰ï¼š

```typescript
export const useAccountingStore = createComplexStore<AccountingEntities>({
  name: 'accounting',

  // å››å€‹å­å¯¦é«”
  entities: {
    accounts: 'accounts',
    categories: 'categories',
    transactions: 'transactions',
    budgets: 'budgets',
  },

  // è‡ªè¨‚æ¥­å‹™æ–¹æ³•ï¼ˆä¿ç•™åŸæœ‰è¤‡é›œé‚è¼¯ï¼‰
  customMethods: (set, get, helpers) => ({
    // çµ±è¨ˆè³‡æ–™
    stats: {
      totalAssets: 0,
      totalIncome: 0,
      totalExpense: 0,
      monthlyIncome: 0,
      monthlyExpense: 0,
      netWorth: 0,
      categoryBreakdown: [],
    } as AccountingStats,

    // æ–°å¢äº¤æ˜“ï¼ˆè¦†å¯«é è¨­çš„ createTransactionï¼‰
    createTransaction: async (transactionData) => {
      // å„²å­˜äº¤æ˜“
      // æ›´æ–°å¸³æˆ¶é¤˜é¡
      get().updateAccountBalances(transaction);
      // é‡æ–°è¨ˆç®—çµ±è¨ˆ
      get().calculateStats();
      // æ¸…é™¤å¿«å–
      helpers.clearCache('transactions');
      helpers.clearCache('accounts');
    },

    // æ›´æ–°å¸³æˆ¶é¤˜é¡
    updateAccountBalances: (transaction: Transaction) => {
      // æ ¹æ“šäº¤æ˜“é¡å‹æ›´æ–°é¤˜é¡é‚è¼¯
    },

    // è¨ˆç®—çµ±è¨ˆè³‡æ–™
    calculateStats: () => {
      const { accounts, transactions, categories } = get();

      // ç¸½è³‡ç”¢
      const totalAssets = accounts.reduce((sum, a) => sum + a.balance, 0);

      // æœ¬æœˆæ”¶æ”¯
      const now = new Date();
      const monthStart = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
      const monthTransactions = transactions.filter(t => t.date >= monthStart);

      const monthlyIncome = monthTransactions
        .filter(t => t.type === 'income')
        .reduce((sum, t) => sum + t.amount, 0);

      const monthlyExpense = monthTransactions
        .filter(t => t.type === 'expense')
        .reduce((sum, t) => sum + t.amount, 0);

      // åˆ†é¡çµ±è¨ˆ
      const categoryBreakdown = categories.map(category => {
        const total = transactions
          .filter(t => t.categoryId === category.id)
          .reduce((sum, t) => sum + t.amount, 0);
        return { categoryId: category.id, categoryName: category.name, total };
      });

      set({
        stats: {
          totalAssets,
          monthlyIncome,
          monthlyExpense,
          netWorth: totalAssets,
          categoryBreakdown,
          // ...
        }
      });
    },

    // å–å¾—å¸³æˆ¶é¤˜é¡
    getAccountBalance: (accountId: string) => {
      const account = get().accounts.find(a => a.id === accountId);
      return account?.balance || 0;
    },

    // å–å¾—åˆ†é¡ç¸½é¡
    getCategoryTotal: (categoryId: string, startDate?: string, endDate?: string) => {
      const transactions = get().transactions.filter(t => {
        const matchCategory = t.categoryId === categoryId;
        const matchDate = (!startDate || t.date >= startDate) &&
                         (!endDate || t.date <= endDate);
        return matchCategory && matchDate;
      });
      return transactions.reduce((sum, t) => sum + t.amount, 0);
    },
  }),
});
```

#### 5.2 Hook Layer

**æª”æ¡ˆ**: `src/features/accounting/hooks/useAccounting.ts` (110 lines)

```typescript
export const useAccounting = () => {
  const store = useAccountingStore();

  return {
    // è³‡æ–™
    accounts: store.accounts,
    categories: store.categories,
    transactions: store.transactions,
    budgets: store.budgets,
    stats: store.stats,

    // Account æ“ä½œ
    createAccount: async (data: Omit<Account, 'id' | 'createdAt' | 'updatedAt'>) => {
      return await store.addAccount(data);
    },
    updateAccount: async (id: string, data: Partial<Account>) => {
      return await store.updateAccount(id, data);
    },
    deleteAccount: async (id: string) => {
      return await store.deleteAccount(id);
    },
    getAccountsByType: (type: Account['type']) => {
      return accountingService.getAccountsByType(type);
    },
    getAccountBalance: (accountId: string) => {
      return accountingService.getAccountBalance(accountId);
    },

    // Category æ“ä½œ
    createCategory: async (data: Omit<Category, 'id' | 'createdAt' | 'updatedAt'>) => {
      return await store.addCategory(data);
    },
    getCategoriesByType: (type: Category['type']) => {
      return categoryService.getCategoriesByType(type);
    },
    getCategoryTotal: (categoryId: string, startDate?: string, endDate?: string) => {
      return accountingService.getCategoryTotal(categoryId, startDate, endDate);
    },

    // Transaction æ“ä½œ
    createTransaction: (data: Omit<Transaction, 'id' | 'createdAt' | 'updatedAt'>) => {
      return accountingService.addTransaction(data);
    },
    getTransactionsByAccount: (accountId: string) => {
      return accountingService.getTransactionsByAccount(accountId);
    },
    getTransactionsByDateRange: (startDate: string, endDate: string) => {
      return accountingService.getTransactionsByDateRange(startDate, endDate);
    },

    // çµ±è¨ˆæ–¹æ³•
    calculateStats: () => {
      accountingService.calculateStats();
    },
    getTotalAssets: () => {
      return accountingService.getTotalAssets();
    },
    getMonthlyIncome: () => {
      return accountingService.getMonthlyIncome();
    },
    getMonthlyExpense: () => {
      return accountingService.getMonthlyExpense();
    },
  };
};
```

#### 5.3 Service Layer

**æª”æ¡ˆ**: `src/features/accounting/services/accounting.service.ts` (145 lines)

```typescript
class AccountingService extends BaseService<Account> {
  protected resourceName = 'accounts';

  protected validate(data: Partial<Account>): void {
    if (data.name && data.name.trim().length === 0) {
      throw new ValidationError('name', 'å¸³æˆ¶åç¨±ä¸èƒ½ç‚ºç©º');
    }
    if (data.balance !== undefined && isNaN(data.balance)) {
      throw new ValidationError('balance', 'é¤˜é¡æ ¼å¼éŒ¯èª¤');
    }
  }

  // æ¥­å‹™é‚è¼¯æ–¹æ³•
  getAccountBalance(accountId: string): number {
    const store = useAccountingStore.getState();
    return store.getAccountBalance(accountId);
  }

  getCategoryTotal(categoryId: string, startDate?: string, endDate?: string): number {
    const store = useAccountingStore.getState();
    return store.getCategoryTotal(categoryId, startDate, endDate);
  }

  calculateStats(): void {
    const store = useAccountingStore.getState();
    store.calculateStats();
  }

  getAccountsByType(type: Account['type']): Account[] {
    const store = useAccountingStore.getState();
    return store.accounts.filter(a => a.type === type);
  }

  // Transaction ç›¸é—œ
  addTransaction(transaction: Omit<Transaction, 'id' | 'createdAt' | 'updatedAt'>): string {
    const store = useAccountingStore.getState();
    return store.addTransaction(transaction);
  }

  getTransactionsByAccount(accountId: string): Transaction[] {
    const store = useAccountingStore.getState();
    return store.transactions.filter(t =>
      t.accountId === accountId || t.toAccountId === accountId
    );
  }

  getTransactionsByDateRange(startDate: string, endDate: string): Transaction[] {
    const store = useAccountingStore.getState();
    return store.transactions.filter(t =>
      t.date >= startDate && t.date <= endDate
    );
  }
}

class CategoryService extends BaseService<Category> {
  protected resourceName = 'categories';

  protected validate(data: Partial<Category>): void {
    if (data.name && data.name.trim().length === 0) {
      throw new ValidationError('name', 'åˆ†é¡åç¨±ä¸èƒ½ç‚ºç©º');
    }
  }

  getCategoriesByType(type: Category['type']): Category[] {
    const store = useAccountingStore.getState();
    return store.categories.filter(c => c.type === type);
  }
}

export const accountingService = new AccountingService();
export const categoryService = new CategoryService();
```

---

### 6. API ç«¯é»ï¼ˆPhase 3 è¦åŠƒï¼‰

#### 6.1 å¸³æˆ¶ API

| æ–¹æ³• | ç«¯é» | èªªæ˜ | Request Body | Response |
|------|------|------|-------------|----------|
| `GET` | `/api/accounts` | å–å¾—å¸³æˆ¶åˆ—è¡¨ | Query: `?type=xxx` | `{ data: Account[] }` |
| `GET` | `/api/accounts/:id` | å–å¾—å¸³æˆ¶è©³æƒ… | - | `{ data: Account }` |
| `POST` | `/api/accounts` | æ–°å¢å¸³æˆ¶ | `Account` | `{ data: Account }` |
| `PUT` | `/api/accounts/:id` | æ›´æ–°å¸³æˆ¶ | `Partial<Account>` | `{ data: Account }` |
| `DELETE` | `/api/accounts/:id` | åˆªé™¤å¸³æˆ¶ | - | `{ success: true }` |
| `GET` | `/api/accounts/:id/balance` | å–å¾—å¸³æˆ¶é¤˜é¡ | - | `{ balance: number }` |

#### 6.2 äº¤æ˜“ API

| æ–¹æ³• | ç«¯é» | èªªæ˜ | Request Body | Response |
|------|------|------|-------------|----------|
| `GET` | `/api/transactions` | å–å¾—äº¤æ˜“åˆ—è¡¨ | Query: `?accountId=xxx&startDate=xxx&endDate=xxx` | `{ data: Transaction[] }` |
| `GET` | `/api/transactions/:id` | å–å¾—äº¤æ˜“è©³æƒ… | - | `{ data: Transaction }` |
| `POST` | `/api/transactions` | æ–°å¢äº¤æ˜“ | `Transaction` | `{ data: Transaction }` |
| `PUT` | `/api/transactions/:id` | æ›´æ–°äº¤æ˜“ | `Partial<Transaction>` | `{ data: Transaction }` |
| `DELETE` | `/api/transactions/:id` | åˆªé™¤äº¤æ˜“ | - | `{ success: true }` |

#### 6.3 åˆ†é¡ API

| æ–¹æ³• | ç«¯é» | èªªæ˜ | Request Body | Response |
|------|------|------|-------------|----------|
| `GET` | `/api/categories` | å–å¾—åˆ†é¡åˆ—è¡¨ | Query: `?type=income/expense` | `{ data: Category[] }` |
| `POST` | `/api/categories` | æ–°å¢åˆ†é¡ | `Category` | `{ data: Category }` |
| `PUT` | `/api/categories/:id` | æ›´æ–°åˆ†é¡ | `Partial<Category>` | `{ data: Category }` |
| `DELETE` | `/api/categories/:id` | åˆªé™¤åˆ†é¡ | - | `{ success: true }` |
| `GET` | `/api/categories/:id/total` | å–å¾—åˆ†é¡ç¸½é¡ | Query: `?startDate=xxx&endDate=xxx` | `{ total: number }` |

#### 6.4 çµ±è¨ˆ API

| æ–¹æ³• | ç«¯é» | èªªæ˜ | Request Body | Response |
|------|------|------|-------------|----------|
| `GET` | `/api/stats` | å–å¾—çµ±è¨ˆè³‡æ–™ | - | `{ data: AccountingStats }` |
| `GET` | `/api/stats/monthly` | å–å¾—æœˆåº¦çµ±è¨ˆ | Query: `?year=2025&month=1` | `{ income: number, expense: number }` |

---

### 7. æ¬Šé™æ§åˆ¶

| è§’è‰² | å¸³æˆ¶ç®¡ç† | äº¤æ˜“ç®¡ç† | åˆ†é¡ç®¡ç† | çµ±è¨ˆæŸ¥çœ‹ |
|------|---------|---------|---------|---------|
| **å€‹äºº** | âœ… å®Œæ•´æ¬Šé™ | âœ… å®Œæ•´æ¬Šé™ | âœ… å®Œæ•´æ¬Šé™ | âœ… å®Œæ•´æ¬Šé™ |
| **ç®¡ç†å“¡** | âœ… æŸ¥çœ‹æ‰€æœ‰äºº | âœ… æŸ¥çœ‹æ‰€æœ‰äºº | âœ… ç³»çµ±é è¨­åˆ†é¡ | âœ… æŸ¥çœ‹æ‰€æœ‰äºº |

**æ³¨æ„**ï¼šPhase 1 ç‚ºå–®ç”¨æˆ¶ç³»çµ±ï¼ŒPhase 3 å¯æ“´å……å¤šç”¨æˆ¶æ”¯æ´ã€‚

---

### 8. å·²çŸ¥å•é¡Œ

#### 8.1 æ¬„ä½å‘½åå•é¡Œ

âœ… **æ•´é«”å‘½åè‰¯å¥½** - Account, Transaction, Category éƒ½ä½¿ç”¨è‹±æ–‡

#### 8.2 å†—é¤˜æ¬„ä½å•é¡Œ

âŒ **Transaction å„²å­˜ accountName å’Œ categoryName**
```typescript
// ç¾ç‹€ (UI å±¤é¢)
const transactionData = {
  accountId: quickAccount,
  accountName: accountData.name,    // âŒ æ‡‰å¾ Account æŸ¥è©¢
  categoryId: quickCategory,
  categoryName: categoryData.name,  // âŒ æ‡‰å¾ Category æŸ¥è©¢
  type: 'expense' as const,
  amount: parseFloat(quickAmount),
  currency: 'TWD',
  description: '',
  date: today,
};

// å»ºè­°ï¼šç§»é™¤ accountName å’Œ categoryName
```

#### 8.3 è³‡æ–™è¨ˆç®—å•é¡Œ

âš ï¸ **Account.availableCredit æ‡‰ç‚ºè¨ˆç®—æ¬„ä½**
```typescript
// ç¾ç‹€
interface Account {
  creditLimit?: number;
  availableCredit?: number;  // âŒ æ‡‰ç”± creditLimit - balance è¨ˆç®—
}

// å»ºè­°
interface Account {
  creditLimit?: number;
  // âŒ ç§»é™¤ availableCredit
}

// Service å±¤æä¾›è¨ˆç®—æ–¹æ³•
getAvailableCredit(accountId: string): number {
  const account = this.getById(accountId);
  if (!account || !account.creditLimit) return 0;
  return account.creditLimit - account.balance;
}
```

âš ï¸ **Stats å…¨éƒ¨ç‚ºå‹•æ…‹è¨ˆç®—ï¼Œä¸æ‡‰å„²å­˜**
```typescript
// ç¾ç‹€ï¼šå­˜åœ¨ Store çš„ state ä¸­
stats: {
  totalAssets: 0,
  totalIncome: 0,
  totalExpense: 0,
  monthlyIncome: 0,
  monthlyExpense: 0,
  netWorth: 0,
  categoryBreakdown: [],
}

// å»ºè­°ï¼šæ”¹ç‚º computed property æˆ–æ¯æ¬¡å¾ transactions è¨ˆç®—
```

#### 8.4 ç¼ºå°‘é—œéµæ¬„ä½

âŒ **Transaction ç¼ºå°‘ currency**
```typescript
// ç¾ç‹€
interface Transaction {
  accountId: string;
  type: 'income' | 'expense' | 'transfer';
  categoryId: string;
  amount: number;
  // âŒ ç¼ºå°‘ currency: string
}

// å»ºè­°ï¼šæ–°å¢ currency æ¬„ä½
interface Transaction {
  accountId: string;
  type: 'income' | 'expense' | 'transfer';
  categoryId: string;
  amount: number;
  currency: string;  // âœ… æ–°å¢
  description: string;
  date: string;
  createdAt: string;
  updatedAt: string;
}
```

#### 8.5 è³‡æ–™é¡å‹å®šç¾©é‡è¤‡

âš ï¸ **accounting-types æª”æ¡ˆæœªè¢«ä½¿ç”¨**
```typescript
// src/stores/types.ts å®šç¾©äº† Account, Transaction, Category
// src/stores/accounting-types.ts ä¹Ÿå®šç¾©äº†ç›¸åŒå‹åˆ¥

// å»ºè­°ï¼šçµ±ä¸€ä½¿ç”¨ accounting-types.ts
```

---

### 9. ä¿®å¾©å»ºè­°

#### 9.1 P0 - å¿…é ˆä¿®æ­£ï¼ˆå½±éŸ¿ç³»çµ±ç©©å®šï¼‰

ç„¡é—œéµå•é¡Œéœ€ç«‹å³ä¿®æ­£ã€‚

#### 9.2 P1 - æ‡‰è©²ä¿®æ­£ï¼ˆå½±éŸ¿å¯ç¶­è­·æ€§ï¼‰

1. **ç§»é™¤å†—é¤˜æ¬„ä½**
   ```typescript
   // ä¿®æ”¹ Transaction interface
   interface Transaction {
     accountId: string;
     // âŒ ç§»é™¤ accountName
     categoryId: string;
     // âŒ ç§»é™¤ categoryName
     type: 'income' | 'expense' | 'transfer';
     amount: number;
     currency: string;  // âœ… æ–°å¢
     description: string;
     date: string;
   }
   ```

2. **æ”¹ç‚ºå‹•æ…‹è¨ˆç®— availableCredit**
   ```typescript
   // ä¿®æ”¹ Account interface
   interface Account {
     id: string;
     name: string;
     type: 'cash' | 'credit' | 'bank';
     balance: number;
     currency: string;
     creditLimit?: number;
     // âŒ ç§»é™¤ availableCredit
   }

   // Service å±¤æä¾›è¨ˆç®—æ–¹æ³•
   class AccountingService {
     getAvailableCredit(accountId: string): number {
       const account = this.getById(accountId);
       if (!account || account.type !== 'credit' || !account.creditLimit) {
         return 0;
       }
       return account.creditLimit - account.balance;
     }
   }
   ```

3. **çµ±ä¸€ä½¿ç”¨ accounting-types.ts**
   ```typescript
   // å°‡ src/stores/types.ts ä¸­çš„ Account, Transaction, Category ç§»é™¤
   // çµ±ä¸€å¾ src/stores/accounting-types.ts åŒ¯å…¥
   ```

#### 9.3 P2 - å¯ä»¥å„ªåŒ–ï¼ˆå¢å¼·åŠŸèƒ½ï¼‰

4. **Stats æ”¹ç‚º Computed Property**
   ```typescript
   // ä¸å„²å­˜åœ¨ stateï¼Œæ”¹ç‚º getter
   get stats(): AccountingStats {
     return this.calculateStats();
   }
   ```

5. **æ–°å¢æ›´å¤šçµ±è¨ˆæ–¹æ³•**
   - å¹´åº¦æ”¶æ”¯çµ±è¨ˆ
   - åˆ†é¡æ’è¡Œæ¦œ
   - æ¶ˆè²»è¶¨å‹¢åˆ†æ
   - é ç®—é”æˆç‡

6. **æ”¯æ´å¤šå¹£åˆ¥**
   - Transaction æ–°å¢ currency
   - åŒ¯ç‡è½‰æ›é‚è¼¯
   - å¤šå¹£åˆ¥ç¸½è³‡ç”¢è¨ˆç®—

---

### 10. è³‡æ–™è¡¨å»ºè­°ï¼ˆPhase 3ï¼‰

```sql
-- å¸³æˆ¶
CREATE TABLE accounts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id),  -- Phase 3 å¤šç”¨æˆ¶æ”¯æ´
  name VARCHAR(100) NOT NULL,
  type VARCHAR(20) NOT NULL CHECK (type IN ('cash', 'credit', 'bank')),
  balance DECIMAL(12, 2) NOT NULL DEFAULT 0,
  currency VARCHAR(10) NOT NULL DEFAULT 'TWD',
  description TEXT,
  credit_limit DECIMAL(12, 2),
  created_at TIMESTAMP NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMP NOT NULL DEFAULT NOW()
);

-- åˆ†é¡
CREATE TABLE categories (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id),  -- NULL è¡¨ç¤ºç³»çµ±é è¨­åˆ†é¡
  name VARCHAR(100) NOT NULL,
  type VARCHAR(20) NOT NULL CHECK (type IN ('income', 'expense')),
  parent_id UUID REFERENCES categories(id),
  color VARCHAR(10),
  icon VARCHAR(50),
  created_at TIMESTAMP NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMP NOT NULL DEFAULT NOW()
);

-- äº¤æ˜“è¨˜éŒ„
CREATE TABLE transactions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  account_id UUID NOT NULL REFERENCES accounts(id),
  to_account_id UUID REFERENCES accounts(id),
  type VARCHAR(20) NOT NULL CHECK (type IN ('income', 'expense', 'transfer')),
  category_id UUID NOT NULL REFERENCES categories(id),
  amount DECIMAL(12, 2) NOT NULL,
  currency VARCHAR(10) NOT NULL DEFAULT 'TWD',
  description TEXT,
  date DATE NOT NULL,
  created_at TIMESTAMP NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMP NOT NULL DEFAULT NOW()
);

-- é ç®—
CREATE TABLE budgets (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id),
  category_id UUID NOT NULL REFERENCES categories(id),
  amount DECIMAL(12, 2) NOT NULL,
  period VARCHAR(20) NOT NULL CHECK (period IN ('monthly', 'yearly')),
  start_date DATE NOT NULL,
  end_date DATE,
  created_at TIMESTAMP NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMP NOT NULL DEFAULT NOW()
);

-- è¨ˆç®—æ¬„ä½ä½¿ç”¨ VIEW
CREATE VIEW account_balances AS
SELECT
  a.id,
  a.name,
  a.type,
  a.balance,
  a.credit_limit,
  CASE
    WHEN a.type = 'credit' AND a.credit_limit IS NOT NULL
    THEN a.credit_limit - a.balance
    ELSE NULL
  END AS available_credit
FROM accounts a;

-- çµ±è¨ˆ VIEW
CREATE VIEW monthly_stats AS
SELECT
  DATE_TRUNC('month', t.date) AS month,
  t.type,
  SUM(t.amount) AS total
FROM transactions t
GROUP BY DATE_TRUNC('month', t.date), t.type;

-- ç´¢å¼•
CREATE INDEX idx_transactions_account_id ON transactions(account_id);
CREATE INDEX idx_transactions_date ON transactions(date);
CREATE INDEX idx_transactions_category_id ON transactions(category_id);
CREATE INDEX idx_accounts_user_id ON accounts(user_id);
CREATE INDEX idx_categories_user_id ON categories(user_id);
CREATE INDEX idx_budgets_user_id ON budgets(user_id);
```

---

**å»ºç«‹æ™‚é–“**: 2025-01-06
**è² è²¬æ¨¡çµ„**: Accounting (å€‹äººè¨˜å¸³ç³»çµ±)
**å„ªå…ˆç´š**: P0
**ç‹€æ…‹**: âœ… è¦æ ¼å·²å®Œæˆ

---

---

## ğŸ”— æ¨¡çµ„é—œè¯åœ–

### 1. æ ¸å¿ƒæ¥­å‹™é—œè¯

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘     æ¥­å‹™æµç¨‹æ ¸å¿ƒè·¯å¾‘      â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

   1. å®¢æˆ¶è©¢åƒ¹
      â†“
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚    Quote    â”‚  å ±åƒ¹å–®
   â”‚   (å ±åƒ¹å–®)  â”‚
   â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                â”‚
        â†“                â†“
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚     Tour     â”‚  â”‚   Itinerary  â”‚
   â”‚   (æ—…éŠåœ˜)   â”‚  â”‚   (è¡Œç¨‹è¡¨)   â”‚
   â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                 (å±•ç¤ºç”¨)
        â”‚
   2. å®¢æˆ¶ç¢ºèªï¼Œé–‹å§‹æˆåœ˜
        â”‚
        â†“
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚    Order    â”‚  è¨‚å–®
   â”‚    (è¨‚å–®)   â”‚
   â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â†“
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚   Member   â”‚  åœ˜å“¡
   â”‚   (åœ˜å“¡)   â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
   3. è²¡å‹™æµç¨‹
        â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                         â”‚
        â†“                         â†“
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ ReceiptOrder  â”‚    â”‚ PaymentRequest â”‚
   â”‚  (æ”¶æ¬¾å–®)    â”‚    â”‚   (è«‹æ¬¾å–®)    â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â†“
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚ DisbursementOrder â”‚
                        â”‚   (å‡ºç´å–®)      â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. æ¨¡çµ„ä¹‹é–“çš„è©³ç´°é—œè¯

#### 2.1 å ±åƒ¹ â†’ é–‹åœ˜ é—œè¯

```
Quote (å ±åƒ¹å–®)
 â”‚
 â”œâ”€â”€> Tour (æ—…éŠåœ˜)          [1:1 è½‰æ›]
 â”‚    - å¸¶å…¥æ—¥æœŸã€äººæ•¸ã€åœ°é»
 â”‚    - å¸¶å…¥æˆæœ¬çµæ§‹ (quote_cost_structure)
 â”‚
 â””â”€â”€> Itinerary (è¡Œç¨‹è¡¨)   [1:N å¤šç‰ˆæœ¬]
      - å¸¶å…¥å¤©æ•¸ (accommodation_days)
      - å¸¶å…¥åœ°é» (country, city)
      - å¸¶å…¥é£¯åº— (å¾ categories çš„ä½å®¿é …)
```

#### 2.2 æ—…éŠåœ˜ â†’ è¨‚å–® é—œè¯

```
Tour (æ—…éŠåœ˜)
 â”‚
 â”œâ”€â”€> Order (è¨‚å–®)           [1:N]
 â”‚    â”‚ - è‡ªå‹•å¸¶å…¥ tour_name, code
 â”‚    â”‚ - è‡ªå‹•å¸¶å…¥ departure_date
 â”‚    â”‚
 â”‚    â””â”€â”€> Member (åœ˜å“¡)       [1:N]
 â”‚         - è‡ªå‹•è¨ˆç®— age (æ ¹æ“š birthday å’Œ tour.departure_date)
 â”‚
 â”œâ”€â”€> TourAddOn (åŠ è³¼)       [1:N]
 â”‚    - Member å¯é¸æ“‡ add_ons[]
 â”‚
 â”œâ”€â”€> TourRefund (é€€è²»)      [1:N]
 â”‚    - é—œè¯ order_id, member_name
 â”‚
 â””â”€â”€> Payment (æ”¶æ¬¾/è«‹æ¬¾)   [1:N]
      - é—œè¯ tour_id, order_id
```

#### 2.3 è¨‚å–® â†’ è²¡å‹™ é—œè¯

```
Order (è¨‚å–®)
 â”‚
 â”œâ”€â”€> ReceiptOrder (æ”¶æ¬¾å–®)   [1:N]
 â”‚    â”‚ - å–®è¨‚å–®å¤šæ¬¡æ”¶æ¬¾
 â”‚    â”‚ - æˆ–æ‰¹é‡åˆ†é…ï¼ˆä¸€ç­†æ¬¾åˆ†å¤šè¨‚å–®ï¼‰
 â”‚    â”‚
 â”‚    â””â”€â”€> ReceiptPaymentItem [1:N]
 â”‚         - ç¾é‡‘/åŒ™æ¬¾/åˆ·å¡/æ”¯ç¥¨
 â”‚
 â””â”€â”€> PaymentRequest (è«‹æ¬¾å–®) [1:N]
      - æ¯é€±å››å‡ºå¸³
      - æ‰¹æ¬¡è«‹æ¬¾ï¼ˆä¾‹å¦‚ä¿éšªåˆ†å¤šè¨‚å–®ï¼‰
```

#### 2.4 è«‹æ¬¾æµç¨‹

```
PaymentRequest (è«‹æ¬¾å–®)
 â”‚
 â”œâ”€â”€> PaymentRequestItem [1:N]
 â”‚    - category: ä½å®¿/äº¤é€š/é¤é£Ÿ/é–€ç¥¨/å°éŠ/å…¶ä»–
 â”‚    - supplier_id é—œè¯ä¾›æ‡‰å•†
 â”‚
 â””â”€â”€> DisbursementOrder (å‡ºç´å–®) [N:1]
      - æ¯é€±å½™ç¸½å¤šç­†è«‹æ¬¾å–®
      - é€±å››çµ±ä¸€æ”¯ä»˜
```

#### 2.5 å¾…è¾¦äº‹é …é—œè¯

```
Todo (å¾…è¾¦äº‹é …)
 â”‚
 â”œâ”€â”€> related_items[]        [å¤šç¨®é—œè¯]
 â”‚    â”œâ”€â”€ type: 'group'  â†’ Tour
 â”‚    â”œâ”€â”€ type: 'quote'  â†’ Quote
 â”‚    â”œâ”€â”€ type: 'order'  â†’ Order
 â”‚    â”œâ”€â”€ type: 'invoice' â†’ PaymentRequest
 â”‚    â””â”€â”€ type: 'receipt' â†’ ReceiptOrder
 â”‚
 â””â”€â”€> enabled_quick_actions[]  [å¿«é€Ÿæ“ä½œ]
      â”œâ”€â”€ 'receipt'  â†’ å¿«é€Ÿæ”¶æ¬¾
      â”œâ”€â”€ 'invoice'  â†’ å¿«é€Ÿè«‹æ¬¾
      â”œâ”€â”€ 'group'    â†’ å¿«é€Ÿåˆ†çµ„
      â”œâ”€â”€ 'quote'    â†’ å¿«é€Ÿå ±åƒ¹
      â””â”€â”€ 'assign'   â†’ å¿«é€ŸæŒ‡æ´¾
```

#### 2.6 ç°½è­‰ç®¡ç†é—œè¯

```
Order (è¨‚å–®)
 â”‚
 â””â”€â”€> Member (åœ˜å“¡)
      â”‚
      â””â”€â”€> Visa (ç°½è­‰)
           - è‡ªå‹•å¸¶å…¥ passport_number
           - è‡ªå‹•å¸¶å…¥ order_id, tour_id
```

### 3. è¼”åŠ©ç³»çµ±é—œè¯

#### 3.1 å·¥ä½œå€ç³»çµ±

```
Workspace (å·¥ä½œå€)
 â”œâ”€â”€> Channel (é »é“)          [1:N]
 â”‚    â””â”€â”€> Message (è¨Šæ¯)       [1:N]
 â”‚
 â”œâ”€â”€> CanvasNote (Canvas ç­†è¨˜) [1:N]
 â”‚
 â””â”€â”€> Todo (ä»»å‹™åˆ—è¡¨)        [å±•ç¤º]
```

#### 3.2 æœƒè¨ˆç³»çµ±

```
Accounting (å€‹äººè¨˜å¸³)
 â”œâ”€â”€> Account (å¸³æˆ¶)          [1:N]
 â”‚    â””â”€â”€> Transaction (äº¤æ˜“)  [1:N]
 â”‚
 â”œâ”€â”€> Category (åˆ†é¡)         [1:N]
 â”‚    â””â”€â”€> Budget (é ç®—)       [1:N]
 â”‚
 â””â”€â”€> AccountingStats (çµ±è¨ˆ)  [è¨ˆç®—å€¼]
```

#### 3.3 äººäº‹ç³»çµ±

```
Employee (å“¡å·¥) = User (ä½¿ç”¨è€…)
 â”œâ”€â”€> personal_info          [å€‹äººè³‡è¨Š]
 â”œâ”€â”€> job_info               [å·¥ä½œè³‡è¨Š]
 â”œâ”€â”€> salary_info            [è–ªè³‡è³‡è¨Š]
 â”œâ”€â”€> attendance             [å‡ºå‹¤è¨˜éŒ„]
 â””â”€â”€> contracts              [åˆç´„è¨˜éŒ„]
```

### 4. è³‡æ–™æµå‘èˆ‡åŒæ­¥

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   Phase 1 (ç•¶å‰)   â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

UI Component
     â†“
Zustand Store (IndexedDB)
     â†“
Local Storage (é›¢ç·šå„ªå…ˆ)

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   Phase 3 (è¦åŠƒ)   â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

UI Component
     â†“
Hook (useXXX)
     â†“
Service (XXXService)
     â†“
API Route (/api/xxx)
     â†“
Supabase PostgreSQL
     â†“
IndexedDB (é›¢ç·šå¿«å–)
```

### 5. æ¨¡çµ„ä¾è³´é—œä¿‚

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  å¿…é ˆå„ªå…ˆå¯¦ä½œ (P0)  â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Auth (ç™»å…¥) â† æ‰€æœ‰æ¨¡çµ„ä¾è³´
  â”‚
  â”œâ”€â”€> User/Employee
  â”‚
  â””â”€â”€> Permissions

Quote â†’ Tour â†’ Order â†’ Member
               â”‚
               â”œâ”€â”€> Payment
               â”‚
               â””â”€â”€> Finance

Workspace + Todos (ç¨ç«‹ä½†é—œè¯å…¶ä»–æ¨¡çµ„)

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  æ¬¡è¦å„ªå…ˆ (P1)      â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Customer â† Order, Quote

Database (ä¾›æ‡‰å•†/é£¯åº—/é¤å»³) â† PaymentRequest, Quote

HR â† Employee

Calendar + Timebox (ç¨ç«‹)

Accounting (å€‹äººè¨˜å¸³ï¼Œç¨ç«‹)

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  è¼”åŠ©åŠŸèƒ½ (P2)      â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Visa â† Member

Profile Manager

Guide (å¹«åŠ©æ–‡ä»¶)

Templates (æ¨¡æ¿ç®¡ç†)
```

### 6. é‡è¦è¨­è¨ˆåŸå‰‡

#### 6.1 é›¢ç·šå„ªå…ˆ (Offline-First)

- æ‰€æœ‰è³‡æ–™å„ªå…ˆå„²å­˜æ–¼ IndexedDB
- Zustand Store ä½œç‚ºä¸­é–“å±¤ç®¡ç†ç‹€æ…‹
- è‡ªå‹•åŒæ­¥æ©Ÿåˆ¶ï¼ˆPhase 3ï¼‰

#### 6.2 è³‡æ–™æ¬„ä½å‡å­˜ (Snapshot)

ç‚ºäº†é›¢ç·šå„ªå…ˆå’Œæ•¸æ“šä¸€è‡´æ€§ï¼Œç•¶å‰è¨­è¨ˆé‡‡ç”¨**æ¬„ä½å‡å­˜**ï¼š

```
Order
  - tour_name â† Tour.name çš„å¿«ç…§
  - code â† Tour.code çš„å¿«ç…§

PaymentRequest
  - tour_name â† Tour.name çš„å¿«ç…§
  - supplier_name â† Supplier.name çš„å¿«ç…§

Tour
  - quote_cost_structure â† Quote.categories çš„å¿«ç…§
```

**Phase 3 å»ºè­°**ï¼šç§»é™¤å‡å­˜ï¼Œæ”¹ç”¨ JOIN æŸ¥è©¢æˆ– VIEW

#### 6.3 ç‹€æ…‹ç®¡ç†

**ç›®å‰å•é¡Œ**ï¼šä¸­è‹±æ–‡ç‹€æ…‹æ··ç”¨

```typescript
// âš ï¸ ç¾ç‹€ (ä¸ä¸€è‡´)
Tour.status: 'ææ¡ˆ' | 'é€²è¡Œä¸­' | 'å¾…çµæ¡ˆ' | 'çµæ¡ˆ'
Order.status: ''é€²è¡Œä¸­' | 'å·²å®Œæˆ' | 'å·²å–æ¶ˆ'
Payment.status: 'å¾…ç¢ºèª' | 'å·²ç¢ºèª' | 'å·²å®Œæˆ'
Quote.status: 'ææ¡ˆ' | 'æœ€çµ‚ç‰ˆæœ¬'
Itinerary.status: 'è‰ç¨¿' | 'å·²ç™¼ä½ˆ'

// âœ… å»ºè­° (çµ±ä¸€è‹±æ–‡)
Tour.status: 'draft' | 'active' | 'pending_close' | 'closed'
Order.status: 'pending' | 'confirmed' | 'completed' | 'cancelled'
Payment.status: 'pending' | 'confirmed' | 'completed'
Quote.status: 'draft' | 'proposed' | 'approved' | 'converted'
Itinerary.status: 'draft' | 'published'
```

#### 6.4 é—œè¯è³‡æ–™è‡ªå‹•å¸¶å…¥

ç•¶å»ºç«‹å­è³‡æ–™æ™‚ï¼Œè‡ªå‹•å¸¶å…¥çˆ¶è³‡æ–™ï¼š

```typescript
// Quote â†’ Tour
createTourFromQuote(quoteId) {
  const quote = getQuote(quoteId);
  return {
    name: quote.name,
    location: quote.country + ' ' + quote.city,
    max_participants: quote.group_size,
    quote_id: quote.id,
    quote_cost_structure: quote.categories  // å‡å­˜
  };
}

// Quote â†’ Itinerary
createItineraryFromQuote(quoteId) {
  const quote = getQuote(quoteId);
  return {
    country: quote.country,
    city: quote.city,
    dailyItinerary: generateDaysFromAccommodation(quote.accommodation_days),
    accommodation: extractHotelsFromQuote(quote.categories)
  };
}

// Tour â†’ Order
createOrder(tourId) {
  const tour = getTour(tourId);
  return {
    tour_id: tourId,
    code: tour.code,              // å‡å­˜
    tour_name: tour.name,         // å‡å­˜
    total_amount: tour.price * memberCount
  };
}

// Member è‡ªå‹•è¨ˆç®—
createMember(data, orderId) {
  const order = getOrder(orderId);
  const tour = getTour(order.tour_id);
  return {
    ...data,
    age: calculateAge(data.birthday, tour.departure_date),
    gender: inferGenderFromId(data.id_number)
  };
}
```

---

**æœ€å¾Œæ›´æ–°**ï¼š2025-01-07
**ç¶­è­·è€…**ï¼šClaude AI
**æ–‡ä»¶ç‰ˆæœ¬**ï¼š1.1.0
