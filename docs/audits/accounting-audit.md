# æœƒè¨ˆæ¨¡çµ„å¯©è¨ˆå ±å‘Š

**å¯©è¨ˆæ—¥æœŸ**: 2025-02-01  
**å¯©è¨ˆç¯„åœ**: `/accounting` å€‹äººè¨˜å¸³æ¨¡çµ„ã€`/erp-accounting` ä¼æ¥­æœƒè¨ˆæ¨¡çµ„

---

## ğŸ“‹ æ¨¡çµ„æ¦‚è¦½

ç³»çµ±åŒ…å«å…©å€‹æœƒè¨ˆç›¸é—œæ¨¡çµ„ï¼š

| æ¨¡çµ„ | è·¯å¾‘ | ç”¨é€” |
|------|------|------|
| å€‹äººè¨˜å¸³ | `/accounting` | å“¡å·¥å€‹äººæ”¶æ”¯ç®¡ç† |
| ERP æœƒè¨ˆ | `/erp-accounting` | ä¼æ¥­ç´šè¤‡å¼ç°¿è¨˜ç³»çµ± |

---

## âœ… å·²å®ŒæˆåŠŸèƒ½

### 1. å€‹äººè¨˜å¸³æ¨¡çµ„ (`/accounting`)

- âœ… å¿«é€Ÿè¨˜å¸³ï¼ˆæ‰‹æ©Ÿç‰ˆï¼‰
- âœ… æ–°å¢æ”¶å…¥/æ”¯å‡ºè¨˜éŒ„
- âœ… å¸³æˆ¶ç®¡ç†ï¼ˆç¾é‡‘ã€éŠ€è¡Œã€ä¿¡ç”¨å¡ç­‰ï¼‰
- âœ… åˆ†é¡ç®¡ç†ï¼ˆæ”¯æ´æ–°å¢è‡ªè¨‚åˆ†é¡ï¼‰
- âœ… ä»Šæ—¥äº¤æ˜“åˆ—è¡¨
- âœ… æœ¬æœˆçµ±è¨ˆï¼ˆæ”¶å…¥/æ”¯å‡º/æ·¨å€¼ï¼‰
- âœ… å¸³æˆ¶é¤˜é¡è‡ªå‹•è¨ˆç®—ï¼ˆä½¿ç”¨ RPC atomic transactionï¼‰

### 2. ERP æœƒè¨ˆæ¨¡çµ„ (`/erp-accounting`)

#### å‚³ç¥¨åŠŸèƒ½
- âœ… å‚³ç¥¨åˆ—è¡¨é¡¯ç¤º
- âœ… å‚³ç¥¨ç‹€æ…‹ç®¡ç†ï¼ˆè‰ç¨¿/å·²éå¸³/å·²åæ²–/å·²é–å®šï¼‰
- âœ… å‚³ç¥¨æ˜ç´°æª¢è¦–ï¼ˆå«åˆ†éŒ„ï¼‰
- âœ… å‚³ç¥¨åæ²–åŠŸèƒ½
- âœ… å€Ÿè²¸å¹³è¡¡æª¢æŸ¥

#### è‡ªå‹•éå¸³
- âœ… å®¢æˆ¶æ”¶æ¬¾éå¸³ï¼ˆç¾é‡‘/åŒ¯æ¬¾/åˆ·å¡å«æ‰‹çºŒè²»è™•ç†ï¼‰
- âœ… ä¾›æ‡‰å•†ä»˜æ¬¾éå¸³
- âœ… çµåœ˜éå¸³ï¼ˆå«è¡Œæ”¿è²»ã€ç¨…é‡‘ã€çé‡‘åˆ†éŒ„ï¼‰
- âœ… å‚³ç¥¨ç·¨è™Ÿè‡ªå‹•ç”Ÿæˆï¼ˆJV + å¹´æœˆ + æµæ°´è™Ÿï¼‰

#### å ±è¡¨åŠŸèƒ½
- âœ… ç¸½å¸³å ±è¡¨ï¼ˆGeneral Ledgerï¼‰
- âœ… è©¦ç®—è¡¨ï¼ˆTrial Balanceï¼‰
- âœ… æç›Šè¡¨ï¼ˆIncome Statementï¼‰
- âœ… è³‡ç”¢è² å‚µè¡¨ï¼ˆBalance Sheetï¼‰
- âœ… ç¾é‡‘æµé‡è¡¨ï¼ˆCash Flow Statementï¼‰
- âœ… å ±è¡¨åŒ¯å‡º CSV

#### æœŸæœ«çµç®—
- âœ… æœˆ/å­£/å¹´çµé è¦½
- âœ… æç›Šç§‘ç›®é¤˜é¡çµè½‰
- âœ… çµè½‰æ­·å²è¨˜éŒ„
- âœ… é‡è¤‡çµè½‰é˜²è­·

#### è¨­å®š
- âœ… æœƒè¨ˆç§‘ç›®ç®¡ç† (`/erp-accounting/settings/accounts`)
- âœ… éŠ€è¡Œå¸³æˆ¶ç®¡ç† (`/erp-accounting/settings/banks`)

---

## âš ï¸ ç™¼ç¾çš„å•é¡Œ

### ğŸ”´ é«˜å„ªå…ˆç´š

#### 1. å€‹äººè¨˜å¸³ï¼šäº¤æ˜“ç·¨è¼¯åŠŸèƒ½ä¸å®Œæ•´
**ä½ç½®**: `src/app/(main)/accounting/page.tsx`
```tsx
<Button variant="ghost" size="iconSm">
  <Edit3 size={16} />  // åƒ…æœ‰åœ–æ¨™ï¼Œç„¡å¯¦éš›åŠŸèƒ½
</Button>
```
**å•é¡Œ**: ç·¨è¼¯æŒ‰éˆ•å­˜åœ¨ä½†æœªç¶å®šä»»ä½•äº‹ä»¶è™•ç†å‡½æ•¸  
**å»ºè­°**: å¯¦ä½œ `EditTransactionDialog` ä¸¦ç¶å®šåˆ°ç·¨è¼¯æŒ‰éˆ•

#### 2. å€‹äººè¨˜å¸³ï¼šäº¤æ˜“åˆªé™¤åŠŸèƒ½ç¼ºå¤±
**ä½ç½®**: `src/stores/accounting-store.ts`
```typescript
deleteTransaction: async id => {
  // Note: Deleting a transaction should also be an RPC to revert balance changes.
  const { error } = await supabase
    .from('accounting_transactions')
    .delete()
    .eq('id', id)
    .eq('user_id', user.id)
  // é¤˜é¡å›æ»¾é‚è¼¯æœªå¯¦ä½œ
}
```
**å•é¡Œ**: åˆªé™¤äº¤æ˜“æ™‚æœªä½¿ç”¨ RPC ä¾†å›æ»¾å¸³æˆ¶é¤˜é¡ï¼Œå¯èƒ½å°è‡´é¤˜é¡ä¸ä¸€è‡´  
**å»ºè­°**: å»ºç«‹ `delete_atomic_transaction` RPC å‡½æ•¸

#### 3. å€‹äººè¨˜å¸³ï¼šäº¤æ˜“æ›´æ–°æœªåŸå­åŒ–
**ä½ç½®**: `src/stores/accounting-store.ts`  
**å•é¡Œ**: `updateTransaction` ç›´æ¥æ›´æ–°è³‡æ–™è¡¨ï¼Œæœªè€ƒæ…®é¤˜é¡èª¿æ•´  
**å»ºè­°**: å»ºç«‹ `update_atomic_transaction` RPC å‡½æ•¸

### ğŸŸ¡ ä¸­å„ªå…ˆç´š

#### 4. æœŸæœ«çµè½‰ï¼šä¿ç•™ç›ˆé¤˜ç§‘ç›®æœªå¯¦ä½œ
**ä½ç½®**: `src/features/accounting/hooks/usePeriodClosing.ts`
```typescript
// æœ¬æœŸæç›Šç§‘ç›®ï¼ˆéœ€è¦æœ‰ä¿ç•™ç›ˆé¤˜ç§‘ç›®ï¼‰
// é€™è£¡ç°¡åŒ–è™•ç†ï¼Œç›´æ¥ç”¨å·®é¡è¡¨ç¤º
// å¯¦éš›æ‡‰ç”¨ä¸­æ‡‰è©²è½‰å…¥ã€Œä¿ç•™ç›ˆé¤˜ã€æˆ–ã€Œæœ¬æœŸæç›Šã€ç§‘ç›®
```
**å•é¡Œ**: æœŸæœ«çµè½‰æœªå°‡æ·¨åˆ©/æ·¨æè½‰å…¥ä¿ç•™ç›ˆé¤˜ç§‘ç›®  
**å»ºè­°**: åœ¨çµè½‰åˆ†éŒ„ä¸­åŠ å…¥ä¿ç•™ç›ˆé¤˜ï¼ˆ3XXX ç§‘ç›®ï¼‰çš„å€Ÿ/è²¸æ–¹

#### 5. ç¾é‡‘æµé‡è¡¨ï¼šåˆ†é¡éæ–¼ç°¡åŒ–
**ä½ç½®**: `src/features/accounting/hooks/useAccountingReports.ts`
```typescript
// ç°¡åŒ–ç‰ˆï¼šå°‡æ‰€æœ‰ç¾é‡‘è®Šå‹•æ­¸é¡ç‚ºç‡Ÿæ¥­æ´»å‹•
// å®Œæ•´ç‰ˆæ‡‰æ ¹æ“šå°æ‡‰ç§‘ç›®åˆ†é¡
```
**å•é¡Œ**: æ‰€æœ‰ç¾é‡‘è®Šå‹•éƒ½æ­¸é¡ç‚ºç‡Ÿæ¥­æ´»å‹•ï¼Œç¼ºå°‘æŠ•è³‡/èè³‡åˆ†é¡  
**å»ºè­°**: æ ¹æ“šå°æ‡‰ç§‘ç›®é¡å‹è‡ªå‹•åˆ†é¡ï¼ˆå¦‚å›ºå®šè³‡ç”¢ç›¸é—œ â†’ æŠ•è³‡æ´»å‹•ï¼‰

#### 6. å¸³æˆ¶ç®¡ç†ï¼šç¼ºå°‘ç·¨è¼¯åŠŸèƒ½
**ä½ç½®**: `src/components/accounting/accounts-management-dialog.tsx`  
**å•é¡Œ**: å¸³æˆ¶ç®¡ç†å°è©±æ¡†æœ‰åˆªé™¤æŒ‰éˆ•ä½†ç„¡ç·¨è¼¯æŒ‰éˆ•  
**å»ºè­°**: åŠ å…¥ç·¨è¼¯å¸³æˆ¶åŠŸèƒ½

#### 7. æç›Šè¡¨å ±è¡¨ï¼šuseEffect ä¾è³´è­¦å‘Š
**ä½ç½®**: `src/features/accounting/components/reports/IncomeStatementReport.tsx`
```typescript
useEffect(() => {
  if (startDate && endDate) {
    handleSearch()
  }
}, [])  // ç¼ºå°‘ handleSearch ä¾è³´
```
**å»ºè­°**: åŠ å…¥æ­£ç¢ºçš„ä¾è³´é™£åˆ—æˆ–ä½¿ç”¨ `useCallback`

### ğŸŸ¢ ä½å„ªå…ˆç´š

#### 8. ç§‘ç›®è¡¨ï¼šç¼ºå°‘æ¬Šç›Šç§‘ç›®
**ä½ç½®**: `src/types/accounting.types.ts`
```typescript
export const DEFAULT_ACCOUNTS = [
  // ç„¡æ¬Šç›Šé¡ç§‘ç›®ï¼ˆ3XXXï¼‰
]
```
**å•é¡Œ**: é è¨­ç§‘ç›®è¡¨ç¼ºå°‘è‚¡æœ¬ã€ä¿ç•™ç›ˆé¤˜ç­‰æ¬Šç›Šç§‘ç›®  
**å»ºè­°**: åŠ å…¥ `3100 è‚¡æœ¬`ã€`3200 ä¿ç•™ç›ˆé¤˜`ã€`3300 æœ¬æœŸæç›Š` ç­‰ç§‘ç›®

#### 9. å‚³ç¥¨é é¢ï¼šç¼ºå°‘æ–°å¢å‚³ç¥¨åŠŸèƒ½
**ä½ç½®**: `src/features/erp-accounting/components/VouchersPage.tsx`  
**å•é¡Œ**: ç›®å‰åªèƒ½æŸ¥çœ‹å’Œåæ²–å‚³ç¥¨ï¼Œç„¡æ³•æ‰‹å‹•æ–°å¢å‚³ç¥¨  
**å»ºè­°**: åŠ å…¥ã€Œæ–°å¢å‚³ç¥¨ã€æŒ‰éˆ•åŠå°è©±æ¡†

#### 10. ReverseVoucherDialogï¼šAPI è·¯å¾‘ä¸ä¸€è‡´
**ä½ç½®**: `src/features/erp-accounting/components/ReverseVoucherDialog.tsx`
```typescript
const response = await fetch('/api/accounting/reverse', {
  body: JSON.stringify({
    workspace_id: user.workspace_id,  // å¯¦éš›ä¸Š API å¾ session å–å¾—
    user_id: user.id,                  // åŒä¸Š
    voucher_id: voucher.id,
    reason: reason.trim(),
  }),
})
```
**å•é¡Œ**: å‰ç«¯å‚³é€ `workspace_id` å’Œ `user_id`ï¼Œä½†å¾Œç«¯å¾ session å–å¾—ï¼Œé€ æˆå†—é¤˜  
**å»ºè­°**: å‰ç«¯åªéœ€å‚³é€ `voucher_id` å’Œ `reason`

---

## ğŸ“Š åŠŸèƒ½å®Œæ•´åº¦è©•ä¼°

| åŠŸèƒ½å€å¡Š | å®Œæˆåº¦ | å‚™è¨» |
|----------|--------|------|
| å€‹äººè¨˜å¸³ - æ–°å¢ | 100% | âœ… å®Œæ•´ |
| å€‹äººè¨˜å¸³ - ç·¨è¼¯ | 20% | âš ï¸ UI å­˜åœ¨ï¼ŒåŠŸèƒ½æœªå¯¦ä½œ |
| å€‹äººè¨˜å¸³ - åˆªé™¤ | 50% | âš ï¸ åŠŸèƒ½å­˜åœ¨ä½†é¤˜é¡æœªå›æ»¾ |
| å€‹äººè¨˜å¸³ - åˆ†é¡ç®¡ç† | 90% | ğŸ”§ ç¼ºå°‘ç·¨è¼¯åˆ†é¡ |
| å‚³ç¥¨ç®¡ç† | 80% | ğŸ”§ ç¼ºå°‘æ–°å¢å‚³ç¥¨ |
| è‡ªå‹•éå¸³ | 95% | âœ… å¹¾ä¹å®Œæ•´ |
| æœƒè¨ˆå ±è¡¨ | 85% | ğŸ”§ ç¾é‡‘æµé‡åˆ†é¡ç°¡åŒ– |
| æœŸæœ«çµè½‰ | 75% | âš ï¸ ä¿ç•™ç›ˆé¤˜æœªå¯¦ä½œ |
| æœƒè¨ˆç§‘ç›®è¨­å®š | 90% | ğŸ”§ ç¼ºå°‘æ¬Šç›Šç§‘ç›® |

---

## ğŸ”§ å»ºè­°å„ªåŒ–äº‹é …

### çŸ­æœŸï¼ˆ1-2 é€±ï¼‰
1. å¯¦ä½œå€‹äººè¨˜å¸³çš„ç·¨è¼¯/åˆªé™¤åŠŸèƒ½
2. å»ºç«‹ `delete_atomic_transaction` å’Œ `update_atomic_transaction` RPC
3. æ–°å¢ä¿ç•™ç›ˆé¤˜ç§‘ç›®ä¸¦ä¿®æ­£æœŸæœ«çµè½‰é‚è¼¯

### ä¸­æœŸï¼ˆ1 å€‹æœˆï¼‰
4. å¯¦ä½œæ‰‹å‹•æ–°å¢å‚³ç¥¨åŠŸèƒ½
5. å„ªåŒ–ç¾é‡‘æµé‡è¡¨åˆ†é¡é‚è¼¯
6. åŠ å…¥å¸³æˆ¶ç·¨è¼¯åŠŸèƒ½

### é•·æœŸ
7. åŠ å…¥å‚³ç¥¨å¯©æ‰¹æµç¨‹
8. å¯¦ä½œå¤šå¹£åˆ¥æ”¯æ´
9. åŠ å…¥æœƒè¨ˆæœŸé–“é–å®šåŠŸèƒ½

---

## ğŸ“ ç›¸é—œæª”æ¡ˆæ¸…å–®

```
src/app/(main)/accounting/
â”œâ”€â”€ layout.tsx
â””â”€â”€ page.tsx                          # å€‹äººè¨˜å¸³ä¸»é 

src/app/(main)/erp-accounting/
â”œâ”€â”€ layout.tsx
â”œâ”€â”€ page.tsx                          # ERP æœƒè¨ˆé¦–é 
â”œâ”€â”€ vouchers/page.tsx                 # å‚³ç¥¨åˆ—è¡¨
â”œâ”€â”€ period-closing/page.tsx           # æœŸæœ«çµè½‰
â”œâ”€â”€ reports/
â”‚   â”œâ”€â”€ page.tsx                      # å ±è¡¨ä¸­å¿ƒ
â”‚   â”œâ”€â”€ general-ledger/page.tsx
â”‚   â”œâ”€â”€ trial-balance/page.tsx
â”‚   â”œâ”€â”€ income-statement/page.tsx
â”‚   â”œâ”€â”€ balance-sheet/page.tsx
â”‚   â””â”€â”€ cash-flow/page.tsx
â””â”€â”€ settings/
    â”œâ”€â”€ accounts/page.tsx             # æœƒè¨ˆç§‘ç›®è¨­å®š
    â””â”€â”€ banks/page.tsx                # éŠ€è¡Œå¸³æˆ¶è¨­å®š

src/features/accounting/
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ PeriodEndClosing.tsx
â”‚   â””â”€â”€ reports/
â”‚       â”œâ”€â”€ IncomeStatementReport.tsx
â”‚       â”œâ”€â”€ GeneralLedgerReport.tsx
â”‚       â”œâ”€â”€ TrialBalanceReport.tsx
â”‚       â”œâ”€â”€ BalanceSheetReport.tsx
â”‚       â””â”€â”€ CashFlowStatementReport.tsx
â””â”€â”€ hooks/
    â”œâ”€â”€ usePeriodClosing.ts
    â””â”€â”€ useAccountingReports.ts

src/features/erp-accounting/
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ VouchersPage.tsx
â”‚   â”œâ”€â”€ VoucherDetailDialog.tsx
â”‚   â”œâ”€â”€ ReverseVoucherDialog.tsx
â”‚   â”œâ”€â”€ AccountDialog.tsx
â”‚   â”œâ”€â”€ AccountsPage.tsx
â”‚   â”œâ”€â”€ BankAccountDialog.tsx
â”‚   â””â”€â”€ BankAccountsPage.tsx
â”œâ”€â”€ hooks/index.ts                    # createCloudHook åŒ…è£
â””â”€â”€ services/
    â””â”€â”€ posting-service.ts            # éå¸³æœå‹™

src/stores/accounting-store.ts        # å€‹äººè¨˜å¸³ Zustand Store
src/types/accounting.types.ts         # æœƒè¨ˆé¡å‹å®šç¾©

src/app/api/accounting/
â”œâ”€â”€ post/
â”‚   â”œâ”€â”€ customer-receipt/route.ts
â”‚   â”œâ”€â”€ supplier-payment/route.ts
â”‚   â””â”€â”€ group-settlement/route.ts
â””â”€â”€ reverse/route.ts
```

---

**å¯©è¨ˆäºº**: Claude (AI Assistant)  
**å¯©è¨ˆå·¥å…·**: ç¨‹å¼ç¢¼éœæ…‹åˆ†æ
