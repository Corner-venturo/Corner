# æ‰‹å†Šè¨­è¨ˆæ¨¡çµ„å¯©è¨ˆå ±å‘Š

**å¯©è¨ˆæ—¥æœŸ**: 2025-02-02  
**å¯©è¨ˆç¯„åœ**: `src/app/(main)/brochure/` åŠç›¸é—œæ¨¡çµ„  
**å¯©è¨ˆè€…**: Claude (AI Assistant)

---

## æ¦‚è¿°

æ‰‹å†Šè¨­è¨ˆæ¨¡çµ„æ˜¯ä¸€å€‹åŠŸèƒ½è±å¯Œçš„è¨­è¨ˆå·¥å…·ï¼Œä½¿ç”¨ Fabric.js ä½œç‚º Canvas ç·¨è¼¯å¼•æ“ã€‚ä¸»è¦æª”æ¡ˆ `page.tsx` åŒ…å«ç´„ 3,129 è¡Œç¨‹å¼ç¢¼ï¼ˆ120KBï¼‰ï¼Œè² è²¬æ•´å€‹ç·¨è¼¯å™¨çš„é‚è¼¯ã€‚

---

## 1. æŒ‰éˆ•åŠŸèƒ½æª¢æŸ¥

### 1.1 é¸æ“‡åœ˜ âœ… æ­£å¸¸
- **ä½ç½®**: `DesignTypeSelector` çµ„ä»¶
- **å¯¦ç¾**: `handleBrochureStart` å›èª¿
- **è³‡æ–™æµ**: 
  - å¾ Supabase `tours` è¡¨è®€å–åœ˜è³‡æ–™
  - æ”¯æ´ `locked_itinerary_id` é—œè¯è¡Œç¨‹è¡¨
- **å•é¡Œ**: ç„¡æ˜é¡¯å•é¡Œ

### 1.2 é¸æ“‡ç¯„æœ¬ âœ… æ­£å¸¸
- **ä½ç½®**: `TemplateSelector` çµ„ä»¶ï¼ˆå·²æ•´åˆåˆ° DesignTypeSelectorï¼‰
- **å¯¦ç¾**: é¢¨æ ¼ç³»åˆ—é¸æ“‡ (`styleSeries`)
- **è³‡æ–™æµ**:
  - ç›®å‰æœ‰ 2 ç¨®é¢¨æ ¼ï¼šã€Œæ—¥ç³»é¢¨æ ¼ã€å’Œã€ŒCorner Travel å®˜æ–¹ã€
  - æ¯ç¨®é¢¨æ ¼å®šç¾©å®Œæ•´çš„é é¢æ¨¡æ¿ï¼ˆå°é¢ã€ç›®éŒ„ã€æ¯æ—¥è¡Œç¨‹ç­‰ï¼‰
- **å•é¡Œ**: ç„¡æ˜é¡¯å•é¡Œ

### 1.3 é é¢ç·¨è¼¯ âœ… æ­£å¸¸
- **ä½ç½®**: `useBrochureEditorV2` hook
- **å¯¦ç¾**: Fabric.js Canvas æ“ä½œ
- **åŠŸèƒ½**: 
  - æ–‡å­—ç·¨è¼¯ï¼ˆé›™å‘ç¶å®šåˆ° templateDataï¼‰
  - å½¢ç‹€ç¹ªè£½ï¼ˆçŸ©å½¢ã€åœ“å½¢ã€æ©¢åœ“ã€ä¸‰è§’å½¢ã€ç·šæ¢ï¼‰
  - åœ–ç‰‡æ’å…¥èˆ‡é®ç½©
  - è²¼ç´™å’Œåœ–æ¨™
  - æ™‚é–“è»¸å…ƒç´ 
  - Undo/Redoï¼ˆæ¯é ç¨ç«‹æ­·å²ï¼‰
- **å•é¡Œ**: ç„¡æ˜é¡¯å•é¡Œ

### 1.4 é è¦½åŠŸèƒ½ âœ… æ­£å¸¸
- **ä½ç½®**: `DualPagePreview` çµ„ä»¶
- **å¯¦ç¾**: é›™é è·¨é é è¦½æ¨¡å¼
- **å•é¡Œ**: ç„¡æ˜é¡¯å•é¡Œ

### 1.5 ä¸‹è¼‰ PDF âš ï¸ éƒ¨åˆ†å•é¡Œ
- **ä½ç½®**: `lib/pdf/brochure-pdf-generator.ts`
- **å¯¦ç¾**: jsPDF å‘é‡ PDF ç”Ÿæˆ
- **ç™¼ç¾çš„å•é¡Œ**:

#### å•é¡Œ 1: åœ–æ¨™æ¸²æŸ“ä¸å®Œæ•´
```typescript
// brochure-pdf-generator.ts:228-238
function renderIcon(doc: jsPDF, el: IconElement): void {
  // ...
  // å˜—è©¦ç¹ªè£½ç°¡å–®çš„ä½”ä½ç¬¦ï¼ˆå¯¦éš›éœ€è¦è§£æ pathï¼‰
  doc.rect(x, y, size, size, 'F')  // âŒ åªç¹ªè£½çŸ©å½¢ï¼Œåœ–æ¨™å…§å®¹éºå¤±
}
```
**å½±éŸ¿**: PDF ä¸­çš„åœ–æ¨™æœƒé¡¯ç¤ºç‚ºç´”è‰²çŸ©å½¢  
**å»ºè­°**: å¯¦ä½œ SVG Path è§£æï¼Œæˆ–å°‡åœ–æ¨™å…‰æŸµåŒ–å¾ŒåµŒå…¥

#### å•é¡Œ 2: è²¼ç´™æ¸²æŸ“ä¸å®Œæ•´
```typescript
// brochure-pdf-generator.ts:268-277
function renderSticker(doc: jsPDF, el: StickerElement): void {
  // ç°¡åŒ–è™•ç†ï¼šç¹ªè£½çŸ©å½¢ä½”ä½ç¬¦
  doc.rect(x, y, width, height, 'F')  // âŒ åªç¹ªè£½çŸ©å½¢
}
```
**å½±éŸ¿**: PDF ä¸­çš„è²¼ç´™æœƒé¡¯ç¤ºç‚ºç´”è‰²çŸ©å½¢  
**å»ºè­°**: åŒä¸Š

#### å•é¡Œ 3: æ¼¸å±¤å½¢ç‹€æœªè™•ç†
```typescript
// brochure-pdf-generator.ts:173-176
if (el.gradient) {
  logger.warn('[PDF] Gradient shapes will be rasterized for now')
  // TODO: æ¼¸å±¤å½¢ç‹€éœ€è¦å…‰æŸµåŒ–è™•ç†
}
```
**å½±éŸ¿**: æœ‰æ¼¸å±¤çš„å½¢ç‹€ä¸æœƒæ­£ç¢ºé¡¯ç¤º  
**å»ºè­°**: å°‡æ¼¸å±¤å½¢ç‹€å…‰æŸµåŒ–ç‚ºåœ–ç‰‡å¾ŒåµŒå…¥ PDF

---

## 2. é é¢æµç¨‹æª¢æŸ¥

### 2.1 `/brochure` æ‰‹å†Šè¨­è¨ˆä¸»é  âœ… æ­£å¸¸
- **è¼‰å…¥æµç¨‹**:
  1. æª¢æŸ¥ URL åƒæ•¸ (`tour_id`, `package_id`, `itinerary_id`)
  2. å¦‚æœ‰ entityIdï¼Œå˜—è©¦è¼‰å…¥ç¾æœ‰å­˜æª”
  3. ç„¡å­˜æª”å‰‡é¡¯ç¤ºè¨­è¨ˆé¡å‹é¸æ“‡å™¨
- **å•é¡Œ**: ç„¡æ˜é¡¯å•é¡Œ

### 2.2 ç¯„æœ¬é¸æ“‡é‚è¼¯ âœ… æ­£å¸¸
- **æµç¨‹**:
  1. é¸æ“‡è¨­è¨ˆé¡å‹ï¼ˆA5/A4 æ‰‹å†Šã€IG åœ–æ–‡ç­‰ï¼‰
  2. æ‰‹å†Šé¡å‹éœ€é¸æ“‡åœ˜/è¡Œç¨‹/é¢¨æ ¼
  3. ç”Ÿæˆå°é¢é é€²å…¥ç·¨è¼¯å™¨
- **å•é¡Œ**: ç„¡æ˜é¡¯å•é¡Œ

### 2.3 é é¢ç·¨è¼¯å™¨ âš ï¸ ç¨‹å¼ç¢¼çµæ§‹å•é¡Œ
- **å•é¡Œ**: `page.tsx` æª”æ¡ˆéå¤§ï¼ˆ3,129 è¡Œï¼‰
- **å»ºè­°**: æ‹†åˆ†ç‚ºå¤šå€‹æ¨¡çµ„ï¼š
  - `hooks/useBrochureEditor.ts` - ç·¨è¼¯å™¨æ ¸å¿ƒé‚è¼¯
  - `hooks/usePageManagement.ts` - é é¢ç®¡ç†é‚è¼¯
  - `hooks/useTemplateData.ts` - ç¯„æœ¬è³‡æ–™åŒæ­¥é‚è¼¯
  - `components/BrochureEditorToolbar.tsx` - å·¥å…·åˆ—
  - `components/BrochureEditorSidebar.tsx` - å´é‚Šæ¬„

---

## 3. è³‡æ–™æµæª¢æŸ¥

### 3.1 è¡Œç¨‹è³‡æ–™è®€å– âœ… æ­£å¸¸
- **ä¾†æº**: Supabase `itineraries` è¡¨
- **è½‰æ›**: `itineraryToTemplateData()` å‡½æ•¸
- **æ”¯æ´æ¬„ä½**:
  - åŸºæœ¬è³‡è¨Šï¼ˆæ¨™é¡Œã€å‰¯æ¨™é¡Œã€åœ˜è™Ÿï¼‰
  - æ—¥æœŸè³‡è¨Šï¼ˆå‡ºç™¼æ—¥ã€å›ç¨‹æ—¥ã€å¤©æ•¸ï¼‰
  - èˆªç­è³‡è¨Šï¼ˆå»ç¨‹ã€å›ç¨‹ï¼‰
  - é ˜éšŠ/é›†åˆè³‡è¨Š
  - æ¯æ—¥è¡Œç¨‹ï¼ˆæ´»å‹•ã€é¤é£Ÿã€ä½å®¿ï¼‰

### 3.2 ç¯„æœ¬æ¸²æŸ“ âœ… æ­£å¸¸
- **å¼•æ“**: `templates/engine/index.ts`
- **æµç¨‹**:
  1. æ ¹æ“š templateId å–å¾—ç¯„æœ¬å®šç¾©
  2. åŸ·è¡Œ `generateElements()` ç”Ÿæˆè¨­è¨ˆå°ºå¯¸å…ƒç´ 
  3. ç¸®æ”¾åˆ°è¼¸å‡ºå°ºå¯¸ï¼ˆ300 DPI + å‡ºè¡€ï¼‰
- **å•é¡Œ**: ç„¡æ˜é¡¯å•é¡Œ

### 3.3 PDF ç”Ÿæˆ âš ï¸ è¦‹ä¸Šæ–¹ 1.5

---

## 4. é‚Šç•Œæƒ…æ³æª¢æŸ¥

### 4.1 ç©ºè¡Œç¨‹è™•ç† âš ï¸ éƒ¨åˆ†è™•ç†
```typescript
// templates/engine/index.ts:369-383
const totalDays = calculateTotalDays()
if (totalDays > 0) {
  dailyItineraries = Array.from({ length: totalDays }, (_, index) => { ... })
} else if (dailyItineraryData && dailyItineraryData.length > 0) {
  // ä½¿ç”¨ç¾æœ‰è³‡æ–™
} 
// âŒ å¦‚æœéƒ½æ²’æœ‰ï¼ŒdailyItineraries æœƒæ˜¯ç©ºé™£åˆ—
```
**å½±éŸ¿**: å®Œå…¨æ²’æœ‰è¡Œç¨‹è³‡æ–™çš„æƒ…æ³ä¸‹ï¼Œæ‰‹å†Šæœƒç¼ºå°‘æ¯æ—¥è¡Œç¨‹é   
**å»ºè­°**: åŠ å…¥é è¨­å€¼æˆ–æç¤ºç”¨æˆ¶

### 4.2 é•·æ–‡å­—è™•ç† âœ… æ­£å¸¸
```typescript
// renderer.ts:239
splitByGrapheme: true, // ä¸­æ–‡å­—å…ƒåˆ†å‰²
```
- Fabric.js Textbox æœ‰è¨­å®š `splitByGrapheme` æ”¯æ´ä¸­æ–‡æ›è¡Œ
- ä½†æœªè¨­å®š `maxHeight` æˆ–æ–‡å­—æº¢å‡ºè™•ç†

### 4.3 å¤§å‹è¡Œç¨‹æ¸²æŸ“ âš ï¸ æ•ˆèƒ½é¢¨éšª
- **å•é¡Œ**: æ¯æ¬¡ `templateData` è®Šæ›´éƒ½æœƒè§¸ç™¼å¤§é‡æ¢ä»¶æª¢æŸ¥
- **ä½ç½®**: `handleTemplateDataChange` å‡½æ•¸ï¼ˆç´„ 400 è¡Œï¼‰
- **å»ºè­°**: ä½¿ç”¨ `useMemo` æˆ– `React.memo` å„ªåŒ–ï¼Œæˆ–æ”¹ç”¨ç‹€æ…‹ç®¡ç†åº«

---

## 5. æ•ˆèƒ½å•é¡Œ

### 5.1 æ­·å²è¨˜éŒ„æ•ˆèƒ½ âš ï¸
```typescript
// useBrochureEditorV2.ts:166
const json = JSON.stringify(canvas.toJSON())
```
- æ¯æ¬¡æ“ä½œéƒ½æœƒåºåˆ—åŒ–æ•´å€‹ Canvas
- å¤§å‹è¨­è¨ˆå¯èƒ½å°è‡´è¨˜æ†¶é«”å£“åŠ›
- **å»ºè­°**: è€ƒæ…®å¢é‡æ­·å²æˆ–ä½¿ç”¨ Web Worker

### 5.2 é é¢åˆ‡æ›æ•ˆèƒ½ âš ï¸
```typescript
// page.tsx:685-720
const handleSelectPage = useCallback(async (index: number) => {
  // å…ˆä¿å­˜ç•¶å‰é é¢çš„ç•«å¸ƒè³‡æ–™
  const currentCanvasData = exportCanvasData() as Record<string, unknown>
  // ...
})
```
- æ¯æ¬¡åˆ‡æ›é é¢éƒ½æœƒå®Œæ•´åºåˆ—åŒ–ç•¶å‰é é¢
- **å»ºè­°**: åªåœ¨çœŸæ­£éœ€è¦æ™‚ä¿å­˜ï¼ˆå¦‚æœ‰è®Šæ›´ï¼‰

### 5.3 åœ–ç‰‡è¼‰å…¥ âœ… æ­£å¸¸
- ä½¿ç”¨ Promise é è¼‰åœ–ç‰‡
- æœ‰ crossOrigin è™•ç†
- æœ‰éŒ¯èª¤è™•ç†ç¹ªè£½ç°è‰²ä½”ä½ç¬¦

---

## 6. éŒ¯èª¤è™•ç†

### 6.1 PDF ç”ŸæˆéŒ¯èª¤ âš ï¸ ç”¨æˆ¶é«”é©—ä¸ä½³
```typescript
// page.tsx:1591-1592
} catch (error) {
  alert('PDF åŒ¯å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦')  // âŒ ä½¿ç”¨ alert
}
```
**å»ºè­°**: ä½¿ç”¨ Toast é€šçŸ¥æˆ–å°è©±æ¡†ï¼Œä¸¦é¡¯ç¤ºå…·é«”éŒ¯èª¤

### 6.2 æ–‡ä»¶è¼‰å…¥éŒ¯èª¤ âœ… æ­£å¸¸
```typescript
// page.tsx:2502-2511
if (error) {
  return (
    <div className="fixed inset-0 flex items-center justify-center bg-background">
      <div className="text-center">
        <p className="text-morandi-red mb-4">{error}</p>
        <Button onClick={() => window.location.reload()}>é‡æ–°è¼‰å…¥</Button>
      </div>
    </div>
  )
}
```

---

## 7. å®‰å…¨æ€§

### 7.1 XSS é¢¨éšª âš ï¸ ä½é¢¨éšª
- Fabric.js æœ¬èº«æœƒå°æ–‡å­—å…§å®¹é€²è¡Œè½‰ç¾©
- ä½† SVG Path è§£æå¯èƒ½å­˜åœ¨é¢¨éšª
- **å»ºè­°**: ç¢ºä¿æ‰€æœ‰ç”¨æˆ¶è¼¸å…¥ç¶“éæ¸…ç†

### 7.2 CORS è™•ç† âœ… æ­£å¸¸
```typescript
// renderer.ts:286-289
if (!el.src.startsWith('data:') && !el.src.startsWith('blob:')) {
  htmlImg.crossOrigin = 'anonymous'
}
```

---

## 8. å»ºè­°å„ªå…ˆç´š

### ğŸ”´ é«˜å„ªå…ˆç´š
1. **ä¿®å¾© PDF åœ–æ¨™/è²¼ç´™æ¸²æŸ“** - å½±éŸ¿ç”¨æˆ¶ç›´æ¥è¼¸å‡ºå“è³ª
2. **å¯¦ä½œæ¼¸å±¤å½¢ç‹€çš„ PDF è¼¸å‡º** - åŒä¸Š

### ğŸŸ¡ ä¸­å„ªå…ˆç´š
3. **æ‹†åˆ† page.tsx** - æé«˜å¯ç¶­è­·æ€§
4. **å„ªåŒ– handleTemplateDataChange** - æ•ˆèƒ½æ”¹é€²
5. **æ”¹å–„ PDF åŒ¯å‡ºéŒ¯èª¤æç¤º** - ç”¨æˆ¶é«”é©—

### ğŸŸ¢ ä½å„ªå…ˆç´š
6. **æ­·å²è¨˜éŒ„æ•ˆèƒ½å„ªåŒ–** - é•·æœŸæ”¹é€²
7. **ç©ºè¡Œç¨‹é‚Šç•Œè™•ç†** - é‚Šç·£æƒ…æ³
8. **æ–‡å­—æº¢å‡ºè™•ç†** - é‚Šç·£æƒ…æ³

---

## é™„éŒ„ï¼šæª”æ¡ˆçµæ§‹

```
src/app/(main)/brochure/
â”œâ”€â”€ page.tsx                    # ä¸»é é¢ï¼ˆ3,129 è¡Œï¼‰
â””â”€â”€ components/                 # ç©ºç›®éŒ„

src/features/designer/
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ core/
â”‚   â”‚   â”œâ”€â”€ renderer.ts         # Canvas æ¸²æŸ“å¼•æ“
â”‚   â”‚   â”œâ”€â”€ icon-paths.ts       # åœ–æ¨™ SVG Path
â”‚   â”‚   â””â”€â”€ sticker-paths.ts    # è²¼ç´™ SVG Path
â”‚   â”œâ”€â”€ TemplateSelector.tsx    # ç¯„æœ¬é¸æ“‡å™¨
â”‚   â”œâ”€â”€ PageListSidebar.tsx     # é é¢åˆ—è¡¨
â”‚   â”œâ”€â”€ PropertiesPanel.tsx     # å±¬æ€§é¢æ¿
â”‚   â””â”€â”€ ...
â”œâ”€â”€ hooks/
â”‚   â”œâ”€â”€ useBrochureEditorV2.ts  # ç·¨è¼¯å™¨ Hook
â”‚   â””â”€â”€ useMaskEditMode.ts      # é®ç½©ç·¨è¼¯æ¨¡å¼
â”œâ”€â”€ templates/
â”‚   â”œâ”€â”€ engine/
â”‚   â”‚   â””â”€â”€ index.ts            # ç¯„æœ¬å¼•æ“
â”‚   â””â”€â”€ definitions/            # ç¯„æœ¬å®šç¾©
â””â”€â”€ utils/
    â”œâ”€â”€ scaling.ts              # å°ºå¯¸ç¸®æ”¾å·¥å…·
    â””â”€â”€ page-number.ts          # é ç¢¼è¨ˆç®—

src/lib/pdf/
â””â”€â”€ brochure-pdf-generator.ts   # PDF ç”Ÿæˆå™¨
```

---

*å ±å‘ŠçµæŸ*
