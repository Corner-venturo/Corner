# 會計模組最終確認流程

> **最後更新**：2025-01-17
> **狀態**：✅ 已與使用者確認，準備實作

---

## 🎯 核心概念

### 會計科目（關鍵）

- **預收團費** (2102) - 負債科目，客戶先付的錢
- **預付團費** (1104) - 資產科目，先付給供應商的錢
- **團費收入** (4101) - 收入科目，結團時認列
- **旅遊成本** (5101~5106) - 費用科目，結團時認列

### 業務流程（三階段）

```
Phase 1: 出團前收款
客戶付款 → 借：銀行存款 / 貸：預收團費

Phase 2: 出團前付款
付供應商 → 借：預付團費 / 貸：銀行存款

Phase 3: 結團
轉列收入 → 借：預收團費 / 貸：團費收入
轉列成本 → 借：旅遊成本 / 貸：預付團費
```

---

## 📊 完整會計分錄範例

### 案例：北海道 5 日遊（HKD250115）

#### **2025/01/05 - 客戶付訂金 $30,000**
```
傳票 V202501001（自動拋轉）
日期：2025/01/05
──────────────────────────────
借：銀行存款 (1102)    $30,000
貸：預收團費 (2102)    $30,000
摘要：訂單 O202501001 訂金
──────────────────────────────
觸發：訂單收款時
```

#### **2025/01/10 - 客戶付尾款 $70,000**
```
傳票 V202501002（自動拋轉）
日期：2025/01/10
──────────────────────────────
借：銀行存款 (1102)    $70,000
貸：預收團費 (2102)    $70,000
摘要：訂單 O202501001 尾款
──────────────────────────────
觸發：訂單收款時
```

**此時科目餘額**：
- 銀行存款：+$100,000
- 預收團費：+$100,000（負債）

---

#### **2025/01/08 - 付飯店訂金 $40,000**
```
傳票 V202501003（自動拋轉）
日期：2025/01/08
──────────────────────────────
借：預付團費 (1104)    $40,000
貸：銀行存款 (1102)    $40,000
摘要：請款單 PR202501001 - 喜來登飯店
──────────────────────────────
觸發：請款單 status 變成 'paid'（會計確認付款）
```

#### **2025/01/12 - 付遊覽車費 $20,000**
```
傳票 V202501004（自動拋轉）
日期：2025/01/12
──────────────────────────────
借：預付團費 (1104)    $20,000
貸：銀行存款 (1102)    $20,000
摘要：請款單 PR202501002 - 國光遊覽車
──────────────────────────────
觸發：請款單 status 變成 'paid'
```

#### **2025/01/14 - 付餐廳訂金 $15,000**
```
傳票 V202501005（自動拋轉）
日期：2025/01/14
──────────────────────────────
借：預付團費 (1104)    $15,000
貸：銀行存款 (1102)    $15,000
摘要：請款單 PR202501003 - 王品餐飲
──────────────────────────────
觸發：請款單 status 變成 'paid'
```

**此時科目餘額**：
- 銀行存款：+$25,000（$100,000 - $75,000）
- 預收團費：+$100,000（負債）
- 預付團費：+$75,000（資產）

---

#### **2025/01/20 - 團體結團**

**傳票 1：轉列收入**
```
傳票 V202501006（自動拋轉）
日期：2025/01/20
──────────────────────────────
借：預收團費 (2102)            $100,000
貸：團費收入 (4101)            $100,000
摘要：團體 HKD250115 結團 - 收入認列
──────────────────────────────
觸發：團體 closing_status 變成 'closed'
```

**傳票 2：轉列成本**
```
傳票 V202501007（自動拋轉）
日期：2025/01/20
──────────────────────────────
借：旅遊成本-住宿 (5102)        $40,000
借：旅遊成本-交通 (5101)        $20,000
借：旅遊成本-餐飲 (5103)        $15,000
貸：預付團費 (1104)             $75,000
摘要：團體 HKD250115 結團 - 成本認列
──────────────────────────────
觸發：團體 closing_status 變成 'closed'
```

**結團後科目餘額**：
- 銀行存款：+$25,000（現金）
- 預收團費：$0（已轉收入）
- 預付團費：$0（已轉成本）
- 團費收入：+$100,000
- 旅遊成本：+$75,000

**本團損益**：
- 收入：$100,000
- 成本：$75,000
- **毛利：$25,000**

---

## 🔄 自動拋轉觸發點

### 觸發點 1：訂單收款

**位置**：`src/stores/order-store.ts` 或收款功能

**觸發條件**：訂單 `paid_amount` 增加時

**拋轉邏輯**：
```typescript
借：銀行存款 (1102)  $收款金額
貸：預收團費 (2102)  $收款金額
```

---

### 觸發點 2：請款單付款

**位置**：`src/stores/payment-request-store.ts`

**觸發條件**：請款單 `status` 從 `confirmed` → `paid`

**拋轉邏輯**：
```typescript
借：預付團費 (1104)  $請款金額
貸：銀行存款 (1102)  $請款金額
```

**說明**：
- 請款單建立 → 不拋轉傳票
- 請款單確認（進入出納單）→ 不拋轉傳票
- 會計確認已付款 → **拋轉傳票**

---

### 觸發點 3：團體結團

**位置**：`src/app/tours/[id]/close-tour-action.ts` 或結團功能

**觸發條件**：團體 `closing_status` 變成 `closed`

**拋轉邏輯**：

**傳票 1（轉收入）**：
```typescript
借：預收團費 (2102)  $該團所有收款總額
貸：團費收入 (4101)  $該團所有收款總額
```

**傳票 2（轉成本）**：
```typescript
借：旅遊成本-交通 (5101)  $交通費總額
借：旅遊成本-住宿 (5102)  $住宿費總額
借：旅遊成本-餐飲 (5103)  $餐飲費總額
借：旅遊成本-門票 (5104)  $門票費總額
借：旅遊成本-保險 (5105)  $保險費總額
借：旅遊成本-其他 (5106)  $其他費總額
貸：預付團費 (1104)      $該團所有付款總額
```

---

## 🗂️ 資料表需求

### tours 表格需新增欄位

```sql
ALTER TABLE public.tours
ADD COLUMN closing_status VARCHAR(20) DEFAULT 'open' CHECK (closing_status IN ('open', 'closing', 'closed')),
ADD COLUMN closing_date DATE;

COMMENT ON COLUMN public.tours.closing_status IS '結團狀態：open(進行中), closing(結團中), closed(已結團)';
COMMENT ON COLUMN public.tours.closing_date IS '結團日期';
```

### payment_requests 表格確認欄位

需確保有以下欄位：
- `supplier_type` - 供應商類型（transportation, accommodation, meal, ticket, insurance, other）
- `status` - 狀態（pending, confirmed, paid）
- `paid_at` - 付款日期

---

## 📋 實作清單

### Phase 1：資料表準備
- [x] 更新 Migration（預收團費、預付團費科目）
- [ ] 執行 Migration
- [ ] 新增 tours.closing_status 和 closing_date 欄位

### Phase 2：TypeScript 型別
- [ ] 建立 `src/types/accounting-pro.types.ts`
- [ ] 更新 `src/types/tour.types.ts`（新增 closing 欄位）

### Phase 3：Stores
- [ ] `useAccountingSubjectStore`
- [ ] `useVoucherStore`
- [ ] `useGeneralLedgerStore`

### Phase 4：自動拋轉 Service
- [ ] `VoucherAutoGenerator.generateFromPayment()` - 收款拋轉
- [ ] `VoucherAutoGenerator.generateFromPaymentRequest()` - 付款拋轉
- [ ] `VoucherAutoGenerator.generateTourRevenue()` - 結團收入
- [ ] `VoucherAutoGenerator.generateTourCosts()` - 結團成本

### Phase 5：整合現有功能
- [ ] 訂單收款功能整合
- [ ] 請款單付款功能整合
- [ ] 團體結團功能整合

### Phase 6：UI 頁面
- [ ] 會計科目表頁面
- [ ] 傳票查詢頁面
- [ ] 手工傳票輸入頁面
- [ ] 總帳查詢頁面
- [ ] 財務報表頁面

---

## ⚠️ 重要注意事項

1. **借貸平衡檢查**
   - 每張傳票必須 `total_debit === total_credit`
   - 自動拋轉時由程式保證平衡

2. **傳票狀態**
   - `draft` - 草稿（可修改、可刪除）
   - `posted` - 已過帳（不可修改、計入總帳）
   - `void` - 作廢（保留紀錄）

3. **結團檢查**
   - 結團前應確認所有請款單都已付款
   - 結團後不可再修改收款/付款
   - 建議增加「結團前檢查」功能

4. **權限控制**
   - 一般員工：可建立傳票
   - 會計主管：可過帳傳票
   - Super Admin：可作廢傳票

---

## 🎯 下一步

1. 執行 Migration（建立資料表）
2. 建立 TypeScript 型別定義
3. 建立 Stores
4. 實作自動拋轉 Service
5. 整合現有功能（收款、付款、結團）

---

**文檔建立日期**：2025-01-17
**確認者**：William Chien
**狀態**：✅ 流程已確認，準備實作
