# Venturo Realtime åŒæ­¥æ”¹é€ åˆ†æå ±å‘Š

> **æ—¥æœŸ**: 2025-10-30
> **ç›®æ¨™**: å…¨ç«™å¯¦ä½œ Supabase Realtime å³æ™‚åŒæ­¥

---

## ğŸ“Š ç³»çµ±ç¾æ³æƒæ

### è³‡æ–™åº«çµæ§‹

- **ç¸½è³‡æ–™è¡¨æ•¸**: 36 å€‹ (IndexedDB schemas)
- **Store æª”æ¡ˆæ•¸**: 16 å€‹
- **ä½¿ç”¨ Zustand persist**: 9 å€‹ stores

### æ ¸å¿ƒè³‡æ–™è¡¨åˆ†é¡

#### ğŸ”´ é«˜å„ªå…ˆç´šï¼ˆéœ€è¦å³æ™‚åŒæ­¥ï¼‰

é€™äº›è³‡æ–™è¡¨çš„è®Šæ›´éœ€è¦ç«‹å³åæ˜ åœ¨æ‰€æœ‰è£ç½®ï¼š

1. **Workspace ç›¸é—œ** (å³æ™‚å”ä½œ)
   - `channels` - é »é“åˆ—è¡¨
   - `messages` - èŠå¤©è¨Šæ¯
   - `channel_groups` - é »é“ç¾¤çµ„
   - `bulletins` - å…¬å‘Š
   - `advance_lists` - ä»£å¢Šæ¸…å–®
   - `shared_order_lists` - åˆ†äº«è¨‚å–®æ¸…å–®

2. **æ¥­å‹™æ ¸å¿ƒ** (å¤šäººå”ä½œ)
   - `tours` - æ—…éŠåœ˜
   - `orders` - è¨‚å–®
   - `members` - åœ˜å“¡
   - `todos` - å¾…è¾¦äº‹é …

3. **äººå“¡ç®¡ç†** (å³æ™‚ç‹€æ…‹)
   - `employees` - å“¡å·¥è³‡æ–™

#### ğŸŸ¡ ä¸­å„ªå…ˆç´šï¼ˆå»ºè­°åŒæ­¥ï¼‰

é€™äº›è³‡æ–™è®Šæ›´é »ç‡è¼ƒä½ï¼Œä½†ä»éœ€åŒæ­¥ï¼š

4. **å ±åƒ¹èˆ‡è²¡å‹™**
   - `quotes` - å ±åƒ¹å–®
   - `quote_items` - å ±åƒ¹é …ç›®
   - `payments` - ä»˜æ¬¾è¨˜éŒ„
   - `payment_requests` - è«‹æ¬¾å–®
   - `disbursement_orders` - å‡ºç´å–®
   - `receipt_orders` - æ”¶æ¬¾å–®

5. **å®¢æˆ¶èˆ‡ä¾›æ‡‰å•†**
   - `customers` - å®¢æˆ¶
   - `suppliers` - ä¾›æ‡‰å•†

#### ğŸŸ¢ ä½å„ªå…ˆç´šï¼ˆå¯é¸åŒæ­¥ï¼‰

é€™äº›è³‡æ–™å¾ˆå°‘è®Šæ›´ï¼Œå¯ä»¥å»¶é²åŒæ­¥ï¼š

6. **åŸºç¤è³‡æ–™** (å¹¾ä¹ä¸è®Š)
   - `countries` - åœ‹å®¶
   - `regions` - åœ°å€
   - `cities` - åŸå¸‚
   - `templates` - æ¨¡æ¿

7. **å€‹äººè³‡æ–™** (ä¸éœ€è·¨è£ç½®åŒæ­¥)
   - `calendar_events` - è¡Œäº‹æ›†
   - `timebox_*` - æ™‚é–“ç®±
   - `accounts` / `categories` / `transactions` / `budgets` - è¨˜å¸³

---

## ğŸš¨ ç¾æœ‰å•é¡Œè¨ºæ–·

### 1. åŒæ­¥æ©Ÿåˆ¶ç¼ºé™·

#### channels-store.ts (Line 174-278)

```typescript
// âŒ å•é¡Œï¼šä½¿ç”¨ setTimeout å»¶é²åŒæ­¥
setTimeout(async () => {
  const { data } = await supabase.from('channels').select('*')
  // èƒŒæ™¯åŒæ­¥ï¼Œå¯èƒ½è¢«å¿½ç•¥
}, 0)
```

**å½±éŸ¿**:

- å¿«é€Ÿåˆ‡æ›é é¢æ™‚åŒæ­¥æœªå®Œæˆ
- è³‡æ–™å¯èƒ½è¢« persist è¦†è“‹

#### chat-store.ts (Line 60-92)

```typescript
// âŒ åŒæ¨£å•é¡Œï¼šsetTimeout å»¶é²åŒæ­¥
setTimeout(async () => {
  const { data } = await supabase.from('messages').select('*')
}, 0)
```

### 2. å¿«å–ç­–ç•¥å•é¡Œ

#### ä¸‰å±¤å¿«å–æ¶æ§‹

```
L1 (Memory)       â† Zustand state
L2 (SessionStorage) â† Zustand persist
L3 (IndexedDB)    â† localDB
```

**å•é¡Œ**:

- channels-store ä½¿ç”¨ persist â†’ èˆŠè³‡æ–™æ®˜ç•™
- IndexedDB å¿«å–å„ªå…ˆæ–¼ Supabase â†’ è³‡æ–™ä¸åŒæ­¥
- æ²’æœ‰å¤±æ•ˆæ©Ÿåˆ¶ â†’ åˆªé™¤çš„è³‡æ–™ä»é¡¯ç¤º

### 3. æ²’æœ‰ Realtime è¨‚é–±

- âŒ æ•´å€‹å°ˆæ¡ˆå®Œå…¨æ²’æœ‰ä½¿ç”¨ Supabase Realtime
- âŒ è³‡æ–™è®Šæ›´å¾Œå…¶ä»–è£ç½®ä¸æœƒæ”¶åˆ°é€šçŸ¥
- âŒ éœ€è¦æ‰‹å‹•é‡æ–°æ•´ç† (F5) æ‰èƒ½åŒæ­¥

---

## ğŸ¯ æ”¹é€ è¨ˆåŠƒ

### Phase 1: å»ºç«‹ Realtime åŸºç¤è¨­æ–½ (2-3 å°æ™‚)

#### 1.1 å‰µå»ºçµ±ä¸€çš„ Realtime Manager

```
src/lib/realtime/
â”œâ”€â”€ realtime-manager.ts    # çµ±ä¸€ç®¡ç†æ‰€æœ‰ Realtime é€£ç·š
â”œâ”€â”€ subscription-manager.ts # è¨‚é–±ç”Ÿå‘½é€±æœŸç®¡ç†
â”œâ”€â”€ types.ts               # å‹åˆ¥å®šç¾©
â””â”€â”€ hooks/
    â””â”€â”€ useRealtimeSubscription.ts # React Hook
```

**åŠŸèƒ½**:

- âœ… çµ±ä¸€è¨‚é–±ç®¡ç†ï¼ˆé˜²æ­¢é‡è¤‡è¨‚é–±ï¼‰
- âœ… è‡ªå‹•é‡é€£æ©Ÿåˆ¶
- âœ… é€£ç·šç‹€æ…‹ç›£æ§
- âœ… è¨˜æ†¶é«”æ´©æ¼é˜²è­·

#### 1.2 è¨­è¨ˆ Realtime äº‹ä»¶è™•ç†å™¨

```typescript
interface RealtimeHandler<T> {
  onInsert?: (record: T) => void
  onUpdate?: (record: T) => void
  onDelete?: (oldRecord: T) => void
}
```

### Phase 2: æ”¹é€ æ ¸å¿ƒ Stores (3-4 å°æ™‚)

#### 2.1 channels-store.ts

- âœ… ç§»é™¤ `setTimeout` å»¶é²åŒæ­¥
- âœ… ç§»é™¤ Zustand `persist` (channels ä¸æ‡‰æŒä¹…åŒ–)
- âœ… åŠ å…¥ Realtime è¨‚é–±
- âœ… ç°¡åŒ–å¿«å–é‚è¼¯ï¼ˆå„ªå…ˆ Supabaseï¼‰

#### 2.2 chat-store.ts

- âœ… ç§»é™¤ `setTimeout` å»¶é²åŒæ­¥
- âœ… åŠ å…¥ Realtime è¨‚é–±ï¼ˆå³æ™‚æ”¶ç™¼è¨Šæ¯ï¼‰
- âœ… å„ªåŒ–è¨Šæ¯åˆ—è¡¨æ›´æ–°é‚è¼¯

#### 2.3 å…¶ä»– stores

- `workspace/members-store.ts` - æˆå“¡ç‹€æ…‹å³æ™‚åŒæ­¥
- `workspace/widgets-store.ts` - å°å·¥å…·å³æ™‚æ›´æ–°

### Phase 3: æ¥­å‹™è³‡æ–™è¡¨åŒæ­¥ (2-3 å°æ™‚)

#### 3.1 å»ºç«‹é€šç”¨ Store Factory

```typescript
// è‡ªå‹•ç”¢ç”Ÿæ”¯æ´ Realtime çš„ store
createRealtimeStore<T>({
  tableName: 'tours',
  enableRealtime: true,
  handlers: { ... }
});
```

#### 3.2 æ”¹é€ æ¥­å‹™ Stores

- ä½¿ç”¨ lazy-store æ¶æ§‹
- å¥—ç”¨ Realtime æ”¯æ´
- æ¸¬è©¦å¤šè£ç½®åŒæ­¥

### Phase 4: æ¸…ç†èˆ‡å„ªåŒ– (1-2 å°æ™‚)

#### 4.1 ç§»é™¤å†—é¤˜æ©Ÿåˆ¶

- âŒ ç§»é™¤ `setTimeout(..., 0)` æ‰€æœ‰å»¶é²åŒæ­¥
- âŒ æª¢æŸ¥ä¸¦ç§»é™¤ä¸å¿…è¦çš„ persist
- âŒ ç°¡åŒ–ä¸‰å±¤å¿«å–é‚è¼¯

#### 4.2 é€£ç·šå„ªåŒ–

```typescript
// æ™ºæ…§è¨‚é–±ï¼šåªåœ¨éœ€è¦æ™‚é€£ç·š
useEffect(() => {
  if (isWorkspacePage) {
    subscription.subscribe()
  }
  return () => subscription.unsubscribe()
}, [isWorkspacePage])
```

### Phase 5: æ¸¬è©¦èˆ‡é©—è­‰ (1-2 å°æ™‚)

#### 5.1 åŠŸèƒ½æ¸¬è©¦

- âœ… å…¬å¸é›»è…¦åˆªé™¤ â†’ å®¶è£¡ç«‹å³æ¶ˆå¤±
- âœ… æ–°å¢è¨Šæ¯ â†’ æ‰€æœ‰è£ç½®å³æ™‚é¡¯ç¤º
- âœ… å¤šäººåŒæ™‚ç·¨è¼¯ â†’ ç„¡è¡çª

#### 5.2 æ•ˆèƒ½æ¸¬è©¦

- âœ… é€£ç·šæ•¸ç›£æ§ï¼ˆ< 200 ä¸Šé™ï¼‰
- âœ… æµé‡ç›£æ§ï¼ˆ< 5 GB/æœˆï¼‰
- âœ… è¨˜æ†¶é«”æ´©æ¼æª¢æŸ¥

---

## ğŸ“‹ å¯¦ä½œæª¢æŸ¥æ¸…å–®

### é«˜å„ªå…ˆç´š (ä»Šå¤©å®Œæˆ)

- [ ] å‰µå»º Realtime Manager
- [ ] æ”¹é€  channels-store (åŠ å…¥ Realtime)
- [ ] æ”¹é€  chat-store (åŠ å…¥ Realtime)
- [ ] ç§»é™¤ channels çš„ persist
- [ ] ç§»é™¤æ‰€æœ‰ setTimeout å»¶é²åŒæ­¥
- [ ] æ¸¬è©¦è·¨è£ç½®åŒæ­¥

### ä¸­å„ªå…ˆç´š (å¾ŒçºŒå®Œæˆ)

- [ ] æ”¹é€  tours / orders / members stores
- [ ] æ”¹é€  todos store
- [ ] å¯¦ä½œé€šç”¨ Realtime Store Factory
- [ ] å„ªåŒ–é€£ç·šç®¡ç†

### ä½å„ªå…ˆç´š (å¯é¸)

- [ ] åŸºç¤è³‡æ–™è¡¨çš„ Realtime (countries, regions, cities)
- [ ] å€‹äººè³‡æ–™çš„ Realtime (calendar, timebox)

---

## ğŸ¯ é æœŸæ•ˆæœ

### Before (ç›®å‰)

```
å…¬å¸åˆªé™¤é »é“
    â†“
å®¶è£¡ 3 å°æ™‚å¾Œæ‰çŸ¥é“ï¼ˆæ‰‹å‹• F5ï¼‰
```

### After (å¯¦ä½œå¾Œ)

```
å…¬å¸åˆªé™¤é »é“
    â†“
å®¶è£¡ 0.1 ç§’å¾Œè‡ªå‹•æ¶ˆå¤±ï¼ˆä¸éœ€ F5ï¼‰
```

### é‡åŒ–æŒ‡æ¨™

- **åŒæ­¥å»¶é²**: 3 å°æ™‚ â†’ < 0.1 ç§’
- **éœ€è¦æ“ä½œ**: æ‰‹å‹•åˆ·æ–° â†’ è‡ªå‹•åŒæ­¥
- **ä½¿ç”¨é«”é©—**: 2010 å¹´ä»£ â†’ 2025 å¹´ä»£

---

## ğŸ’° æˆæœ¬è©•ä¼°

### å…è²»é¡åº¦

- Realtime é€£ç·š: 200 å€‹
- è³‡æ–™å‚³è¼¸: 5 GB/æœˆ

### é ä¼°ä½¿ç”¨

- å°–å³°é€£ç·šæ•¸: 40 å€‹ (20 äºº Ã— 2 è£ç½®)
- æ¯æœˆæµé‡: ~100 MB

### çµè«–

âœ… **å®Œå…¨åœ¨å…è²»é¡åº¦å…§ï¼Œç„¡éœ€ä»˜è²»**

---

## ğŸš€ é–‹å§‹æ™‚é–“

æº–å‚™å¥½äº†å—ï¼Ÿæˆ‘å€‘å¾ Phase 1 é–‹å§‹ï¼
