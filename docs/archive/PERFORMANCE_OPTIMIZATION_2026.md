# 效能優化計畫 - 2026

> **注意**：這些是「預防性」優化項目，目前系統尚未上線，資料量小，這些問題不會發生。
>
> 建議：等系統實際運作 6-12 個月，資料累積到一定量後，再評估是否需要優化。

---

## 📅 建立日期
2025-10-21

## 🎯 何時需要優化？

**觸發條件（符合任一即可考慮優化）：**

1. **資料量達到門檻**
   - 旅遊團 > 1,000 筆
   - 訂單 > 3,000 筆
   - 客戶 > 2,000 人
   - 會員 > 10,000 筆

2. **使用者抱怨速度**
   - 新增資料超過 2 秒
   - 列表載入超過 1 秒
   - 搜尋有明顯延遲
   - 離線同步很慢

3. **實際測量到效能問題**
   - 用 Chrome DevTools 測量
   - 用真實資料測試
   - 確認是這些問題造成的

---

## 🔴 高優先級優化項目

### 1. 編號生成的全表掃描

**問題描述：**
每次產生新編號（如 T20250001）時，會掃描所有資料找最大編號。

**影響：**
- 資料少時（< 1,000 筆）：0.3 秒（還好）
- 資料多時（> 5,000 筆）：1.5 秒（會被抱怨）

**優化方案：**
```typescript
// 方法 1：只查最大編號（不要全部讀取）
const { data } = await supabase
  .from(tableName)
  .select('code')
  .like('code', `${prefix}%`)
  .order('code', { ascending: false })
  .limit(1);

// 方法 2：使用 Supabase Sequence（更好）
// 在 Supabase 建立自動編號 trigger
```

**位置：**
- `src/stores/create-store.ts` 第 71-93 行

**預估效果：**
- 從 1.5 秒 → 0.05 秒
- 快 30 倍

---

### 2. 批次操作的 N+1 問題

**問題描述：**
批次新增資料時，逐筆等待而不是並行或批次處理。

**影響：**
- 新增 10 筆：1.6 秒（還好）
- 新增 50 筆：8 秒（會抱怨）
- 新增 100 筆：16 秒（無法接受）

**何時會發生？**
- 匯入大量客戶資料
- 批次建立會員
- 資料遷移

**優化方案：**
```typescript
// 方法 1：並行處理
const results = await Promise.all(
  dataArray.map(data => get().create(data))
);

// 方法 2：真正的批次插入（更好）
const { data } = await supabase
  .from(tableName)
  .insert(dataArray)  // 一次插入全部
  .select();
```

**位置：**
- `src/stores/create-store.ts` 第 586-595 行

**預估效果：**
- 從 16 秒 → 0.2 秒
- 快 80 倍

---

### 3. 離線同步的逐筆上傳

**問題描述：**
重新上線後，逐筆上傳待同步資料，而不是批次上傳。

**影響：**
- 同步 5 筆：0.8 秒（還好）
- 同步 20 筆：3 秒（稍慢）
- 同步 50 筆：7.5 秒（會抱怨）

**何時會發生？**
- 外出時網路不穩
- 展場或活動現場
- 行動辦公

**優化方案：**
```typescript
// 批次上傳而不是逐筆
const { data } = await supabase
  .from(tableName)
  .insert(tbcItems)  // 全部一起上傳
  .select();
```

**位置：**
- `src/lib/sync/background-sync-service.ts` 第 73-169 行

**預估效果：**
- 從 7.5 秒 → 0.15 秒
- 快 50 倍

---

## 🟡 中優先級優化項目

### 4. React 組件渲染優化

**問題描述：**
列表過濾、搜尋等沒有使用 `useMemo` 快取，每次渲染都重新計算。

**影響：**
- 資料少時：無感
- 資料多時（> 500 筆）：滾動或展開會有卡頓

**優化方案：**
```typescript
// 加上 useMemo
const filteredTours = React.useMemo(() => {
  return tours.filter(...);
}, [tours, searchQuery, activeTab]);
```

**位置：**
- `src/app/tours/page.tsx` 第 160-174 行
- `src/app/orders/page.tsx` 第 51-99 行

**預估效果：**
- 減少 70% 不必要的重新計算
- 滾動更順暢

---

### 5. 訂單待辦事項的 O(n²) 查詢

**問題描述：**
計算待辦事項時，每個訂單都要搜尋一次旅遊團列表。

**影響：**
- 100 訂單 × 100 團：10ms（無感）
- 500 訂單 × 500 團：125ms（稍有感）

**優化方案：**
```typescript
// 先建立快速查詢表
const tourMap = new Map(tours.map(t => [t.id, t]));

orders.forEach(order => {
  const tour = tourMap.get(order.tour_id);  // O(1) 查詢
  // ...
});
```

**位置：**
- `src/app/orders/page.tsx` 第 56-58 行

**預估效果：**
- 從 125ms → 5ms
- 快 25 倍

---

## 🟢 低優先級優化項目

### 6. 背景同步的三重查詢

**問題描述：**
同步時對每個表格查詢 3 次 IndexedDB，應該只要 1 次。

**影響：**
- 22 個表格 × 3 = 66 次查詢
- 實際應該只需 22 次
- 但因為是本地資料庫，速度影響小

**優化方案：**
合併三次查詢為一次，在記憶體中過濾。

**位置：**
- `src/lib/sync/background-sync-service.ts` 第 55-66 行

---

### 7. 其他 React 最佳實踐

- 為事件處理函數加 `useCallback`
- 為大型列表實作虛擬滾動
- 優化圖片載入

---

## 📊 優化優先順序建議

### 第一階段（資料量 > 3,000 筆時）
1. 編號生成優化
2. React 組件加 `useMemo`

### 第二階段（需要批次匯入時）
3. 批次操作優化
4. 離線同步優化

### 第三階段（資料量 > 10,000 筆時）
5. O(n²) 查詢優化
6. 虛擬滾動實作

---

## 🧪 優化前的檢查清單

**不要盲目優化！先確認：**

- [ ] 用 Chrome DevTools Performance 測量實際速度
- [ ] 確認是這個問題導致的慢（不是網路或其他原因）
- [ ] 用真實資料量測試（不要用 10 筆資料測試）
- [ ] 詢問使用者是否真的覺得慢
- [ ] 評估優化的工作量 vs 改善效果

**記住：過早優化是萬惡之源**

---

## 📝 測量方法

### 如何測量速度？

```javascript
// 在 Chrome DevTools Console 中執行

// 測試新增資料速度
console.time('create');
await createTour(data);
console.timeEnd('create');

// 測試列表載入速度
console.time('fetchAll');
await fetchAllTours();
console.timeEnd('fetchAll');

// 測試搜尋速度
console.time('search');
const results = filteredTours;
console.timeEnd('search');
```

### 什麼速度算慢？

| 操作 | 可接受 | 稍慢 | 需優化 |
|------|--------|------|--------|
| 新增單筆 | < 0.5 秒 | 0.5-1 秒 | > 1 秒 |
| 載入列表 | < 1 秒 | 1-2 秒 | > 2 秒 |
| 搜尋過濾 | < 0.1 秒 | 0.1-0.3 秒 | > 0.3 秒 |
| 批次匯入 50 筆 | < 2 秒 | 2-5 秒 | > 5 秒 |

---

## 🎯 2026 年的優化策略

### Q1 2026（系統上線 3 個月後）
- 收集使用者反饋
- 監控實際資料量增長
- 測量關鍵操作速度

### Q2 2026（系統上線 6 個月後）
- 如果資料量達標 → 開始優化編號生成
- 如果有批次匯入需求 → 優化批次操作

### Q3-Q4 2026（系統上線 1 年後）
- 根據實際狀況決定是否需要其他優化
- 可能完全不需要優化（如果都很順）

---

## 💡 重要提醒

1. **不要現在就優化**
   - 系統還沒上線
   - 資料量還很小
   - 浪費時間

2. **等真的遇到問題再說**
   - 使用者抱怨慢
   - 實測確實慢
   - 確定是這些原因

3. **優先修 Bug 和加功能**
   - 效能優化可以等
   - 功能完整度更重要
   - 使用者體驗更重要

4. **可能永遠不需要優化**
   - 如果資料量一直很小
   - 如果速度一直夠快
   - 就不用管這份文件

---

**最後更新**：2025-10-21
**下次檢視**：2026-03-01（系統上線 3 個月後）
