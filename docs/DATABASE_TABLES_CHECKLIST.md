# è³‡æ–™åº«è¡¨æ ¼æª¢æŸ¥æ¸…å–®

> **æœ€å¾Œæ›´æ–°**: 2025-11-17
> **æª¢æŸ¥é …ç›®**: RLS ç‹€æ…‹ã€workspace_id æ¬„ä½ã€ç´¢å¼•

---

## âœ… æª¢æŸ¥æ¨™æº–

æ‰€æœ‰è¡¨æ ¼å¿…é ˆç¬¦åˆï¼š
1. **ç¦ç”¨ RLS** (`DISABLE ROW LEVEL SECURITY`)
2. **æœ‰ workspace_id æ¬„ä½**ï¼ˆæ¥­å‹™è¡¨æ ¼ï¼‰
3. **workspace_id ä¸å¯ç‚º NULL**ï¼ˆå·²å¡«å…¥é è¨­å€¼ï¼‰
4. **å»ºç«‹ workspace_id ç´¢å¼•**ï¼ˆæ•ˆèƒ½å„ªåŒ–ï¼‰

---

## ğŸ“Š ç³»çµ±æ ¸å¿ƒè¡¨æ ¼

### ä½¿ç”¨è€…èˆ‡æ¬Šé™
| è¡¨æ ¼ | RLS | workspace_id | ç´¢å¼• | èªªæ˜ |
|------|-----|--------------|------|------|
| `employees` | âœ… ç¦ç”¨ | âœ… å¿…å¡« | âœ… æ˜¯ | å“¡å·¥è³‡æ–™ |
| `workspaces` | âœ… ç¦ç”¨ | âŒ N/A | âŒ N/A | å·¥ä½œç©ºé–“æœ¬èº« |
| `user_roles` | âœ… ç¦ç”¨ | âŒ N/A | âŒ N/A | ä½¿ç”¨è€…è§’è‰² |

### Workspace å”ä½œ
| è¡¨æ ¼ | RLS | workspace_id | ç´¢å¼• | èªªæ˜ |
|------|-----|--------------|------|------|
| `channels` | âœ… ç¦ç”¨ | âœ… å¿…å¡« | âœ… æ˜¯ | é »é“ |
| `channel_members` | âœ… ç¦ç”¨ | âŒ N/A | âŒ N/A | é »é“æˆå“¡ï¼ˆç¹¼æ‰¿ channelï¼‰ |
| `messages` | âœ… ç¦ç”¨ | âŒ N/A | âŒ N/A | è¨Šæ¯ï¼ˆç¹¼æ‰¿ channelï¼‰ |

---

## ğŸ« æ—…éŠæ¥­å‹™æ ¸å¿ƒ

### æ—…éŠåœ˜ç®¡ç†
| è¡¨æ ¼ | RLS | workspace_id | ç´¢å¼• | èªªæ˜ |
|------|-----|--------------|------|------|
| `tours` | âœ… ç¦ç”¨ | âœ… å¿…å¡« | âœ… æ˜¯ | æ—…éŠåœ˜ä¸»è¡¨ |
| `orders` | âœ… ç¦ç”¨ | âœ… å¿…å¡« | âœ… æ˜¯ | è¨‚å–® |
| `order_members` | âœ… ç¦ç”¨ | âœ… å¿…å¡« | âœ… æ˜¯ | æ—…å®¢è³‡æ–™ |
| `quotes` | âœ… ç¦ç”¨ | âœ… å¿…å¡« | âœ… æ˜¯ | å ±åƒ¹å–® |
| `quick_quotes` | âœ… ç¦ç”¨ | âœ… å¿…å¡« | âœ… æ˜¯ | å¿«é€Ÿå ±åƒ¹ |
| `quick_quote_items` | âœ… ç¦ç”¨ | âŒ N/A | âŒ N/A | å¿«é€Ÿå ±åƒ¹é …ç›®ï¼ˆç¹¼æ‰¿ quoteï¼‰ |
| `itineraries` | âœ… ç¦ç”¨ | âœ… å¿…å¡« | âœ… æ˜¯ | è¡Œç¨‹è¡¨ |
| `itinerary_days` | âœ… ç¦ç”¨ | âŒ N/A | âŒ N/A | è¡Œç¨‹å¤©æ•¸ï¼ˆç¹¼æ‰¿ itineraryï¼‰ |

### åœ˜å‹™ç®¡ç†
| è¡¨æ ¼ | RLS | workspace_id | ç´¢å¼• | èªªæ˜ |
|------|-----|--------------|------|------|
| `tour_member_fields` | âœ… ç¦ç”¨ | âŒ N/A | âŒ N/A | åœ˜å“¡è‡ªè¨‚æ¬„ä½ï¼ˆç¹¼æ‰¿ tourï¼‰ |
| `tour_departure_data` | âœ… ç¦ç”¨ | âŒ N/A | âŒ N/A | å‡ºåœ˜è³‡æ–™ä¸»è¡¨ï¼ˆç¹¼æ‰¿ tourï¼‰ |
| `tour_departure_meals` | âœ… ç¦ç”¨ | âŒ N/A | âŒ N/A | å‡ºåœ˜é¤é£Ÿè¡¨ |
| `tour_departure_accommodations` | âœ… ç¦ç”¨ | âŒ N/A | âŒ N/A | å‡ºåœ˜ä½å®¿è¡¨ |
| `tour_departure_activities` | âœ… ç¦ç”¨ | âŒ N/A | âŒ N/A | å‡ºåœ˜æ´»å‹•è¡¨ |
| `tour_departure_others` | âœ… ç¦ç”¨ | âŒ N/A | âŒ N/A | å‡ºåœ˜å…¶ä»–è²»ç”¨ |

### å®¢æˆ¶èˆ‡ä¾›æ‡‰å•†
| è¡¨æ ¼ | RLS | workspace_id | ç´¢å¼• | èªªæ˜ |
|------|-----|--------------|------|------|
| `customers` | âœ… ç¦ç”¨ | âœ… å¿…å¡« | âœ… æ˜¯ | å®¢æˆ¶è³‡æ–™ |
| `suppliers` | âœ… ç¦ç”¨ | âœ… å¿…å¡« | âœ… æ˜¯ | ä¾›æ‡‰å•†è³‡æ–™ |

---

## ğŸ’° è²¡å‹™æ¨¡çµ„

### æ”¶ä»˜æ¬¾
| è¡¨æ ¼ | RLS | workspace_id | ç´¢å¼• | èªªæ˜ |
|------|-----|--------------|------|------|
| `payments` | âœ… ç¦ç”¨ | âœ… å¿…å¡« | âœ… æ˜¯ | ä»˜æ¬¾ç´€éŒ„ |
| `receipts` | âœ… ç¦ç”¨ | âœ… å¿…å¡« | âœ… æ˜¯ | æ”¶æ“š |
| `payment_requests` | âœ… ç¦ç”¨ | âœ… å¿…å¡« | âœ… æ˜¯ | è«‹æ¬¾å–® |
| `link_pay_logs` | âœ… ç¦ç”¨ | âŒ N/A | âŒ N/A | ä»˜æ¬¾é€£çµç´€éŒ„ï¼ˆç¹¼æ‰¿ paymentï¼‰ |

### æœƒè¨ˆæ¨¡çµ„ï¼ˆæ–°ï¼‰
| è¡¨æ ¼ | RLS | workspace_id | ç´¢å¼• | èªªæ˜ |
|------|-----|--------------|------|------|
| `accounting_accounts` | âœ… ç¦ç”¨ | âŒ N/A | âŒ N/A | æœƒè¨ˆç§‘ç›®è¡¨ï¼ˆå…¨å…¬å¸å…±ç”¨ï¼‰ |
| `accounting_vouchers` | âœ… ç¦ç”¨ | âœ… å¿…å¡« | âœ… æ˜¯ | æœƒè¨ˆå‚³ç¥¨ |
| `accounting_voucher_items` | âœ… ç¦ç”¨ | âŒ N/A | âŒ N/A | å‚³ç¥¨æ˜ç´°ï¼ˆç¹¼æ‰¿ voucherï¼‰ |

---

## ğŸ“ è¼”åŠ©åŠŸèƒ½

### å¾…è¾¦èˆ‡è¡Œäº‹æ›†
| è¡¨æ ¼ | RLS | workspace_id | ç´¢å¼• | èªªæ˜ |
|------|-----|--------------|------|------|
| `todos` | âœ… ç¦ç”¨ | âœ… å¿…å¡« | âœ… æ˜¯ | å¾…è¾¦äº‹é … |
| `calendar_events` | âœ… ç¦ç”¨ | âœ… å¿…å¡« | âœ… æ˜¯ | è¡Œäº‹æ›†äº‹ä»¶ |

### ç°½è­‰èˆ‡é›»è©±å¡
| è¡¨æ ¼ | RLS | workspace_id | ç´¢å¼• | èªªæ˜ |
|------|-----|--------------|------|------|
| `visas` | âœ… ç¦ç”¨ | âœ… å¿…å¡« | âœ… æ˜¯ | ç°½è­‰ |
| `esims` | âœ… ç¦ç”¨ | âœ… å¿…å¡« | âœ… æ˜¯ | eSIM é›»è©±å¡ |

### åˆç´„
| è¡¨æ ¼ | RLS | workspace_id | ç´¢å¼• | èªªæ˜ |
|------|-----|--------------|------|------|
| `contracts` | âœ… ç¦ç”¨ | âœ… å¿…å¡« | âœ… æ˜¯ | åˆç´„ |
| `contract_items` | âœ… ç¦ç”¨ | âŒ N/A | âŒ N/A | åˆç´„é …ç›®ï¼ˆç¹¼æ‰¿ contractï¼‰ |

---

## ğŸ—ºï¸ åœ°å€èˆ‡åŸºç¤è³‡æ–™

| è¡¨æ ¼ | RLS | workspace_id | ç´¢å¼• | èªªæ˜ |
|------|-----|--------------|------|------|
| `countries` | âœ… ç¦ç”¨ | âŒ N/A | âŒ N/A | åœ‹å®¶ï¼ˆå…¨å…¬å¸å…±ç”¨ï¼‰ |
| `cities` | âœ… ç¦ç”¨ | âŒ N/A | âŒ N/A | åŸå¸‚ï¼ˆå…¨å…¬å¸å…±ç”¨ï¼‰ |
| `airports` | âœ… ç¦ç”¨ | âŒ N/A | âŒ N/A | æ©Ÿå ´ï¼ˆå…¨å…¬å¸å…±ç”¨ï¼‰ |
| `bank_codes` | âœ… ç¦ç”¨ | âŒ N/A | âŒ N/A | éŠ€è¡Œä»£ç¢¼ï¼ˆå…¨å…¬å¸å…±ç”¨ï¼‰ |

---

## ğŸ’µ åƒ¹æ ¼èˆ‡æ¨¡æ¿

| è¡¨æ ¼ | RLS | workspace_id | ç´¢å¼• | èªªæ˜ |
|------|-----|--------------|------|------|
| `cost_templates` | âœ… ç¦ç”¨ | âœ… å¿…å¡« | âœ… æ˜¯ | æˆæœ¬ç¯„æœ¬ |
| `price_lists` | âœ… ç¦ç”¨ | âœ… å¿…å¡« | âœ… æ˜¯ | åƒ¹æ ¼è¡¨ |
| `transportation_rates` | âœ… ç¦ç”¨ | âŒ N/A | âŒ N/A | è»Šè³‡è¡¨ï¼ˆå…¨å…¬å¸å…±ç”¨ï¼‰ |

---

## ğŸš— PNRï¼ˆæ–°ï¼‰

| è¡¨æ ¼ | RLS | workspace_id | ç´¢å¼• | èªªæ˜ |
|------|-----|--------------|------|------|
| `pnrs` | âœ… ç¦ç”¨ | âœ… å¿…å¡« | âœ… æ˜¯ | èˆªç­è¨‚ä½ç´€éŒ„ |

---

## ğŸ”§ Migration æª”æ¡ˆ

### RLS ç¦ç”¨
- `20251115060000_final_disable_all_rls.sql` - ç¦ç”¨æ‰€æœ‰è¡¨æ ¼çš„ RLS

### Workspace ID ä¿®æ­£
- `20251115050000_fix_missing_workspace_ids.sql` - ä¿®æ­£ç¼ºå°‘çš„ workspace_id
- `20251115070000_fill_all_null_workspace_ids.sql` - å¡«å…¥ NULL çš„ workspace_id

### ä»Šæ—¥æ–°å¢è¡¨æ ¼ï¼ˆ2025-11-17ï¼‰
- `20251117140000_add_tour_closing_fields.sql` - tours è¡¨æ ¼çµåœ˜æ¬„ä½
- `20251117140100_create_tour_member_fields.sql` - åœ˜å“¡è‡ªè¨‚æ¬„ä½
- `20251117150000_add_bonus_to_payment_requests.sql` - è«‹æ¬¾å–® bonus é¡å‹
- `20251117160000_create_tour_departure_data.sql` - å‡ºåœ˜è³‡æ–™è¡¨ï¼ˆ5 å€‹è¡¨æ ¼ï¼‰

---

## âœ… æª¢æŸ¥çµè«–

### å·²å®Œæˆ
- âœ… æ‰€æœ‰è¡¨æ ¼å·²ç¦ç”¨ RLS
- âœ… æ‰€æœ‰æ¥­å‹™è¡¨æ ¼éƒ½æœ‰ workspace_id æ¬„ä½
- âœ… workspace_id å·²å¡«å…¥é è¨­å€¼ï¼ˆç„¡ NULLï¼‰
- âœ… å·²å»ºç«‹ workspace_id ç´¢å¼•

### æ³¨æ„äº‹é …
1. **ç¹¼æ‰¿å¼è¨­è¨ˆ**: å­è¡¨æ ¼ï¼ˆå¦‚ messages, contract_itemsï¼‰ä¸éœ€è¦ workspace_idï¼Œé€éçˆ¶è¡¨æ ¼ï¼ˆchannel, contractï¼‰ç¹¼æ‰¿
2. **å…±ç”¨è³‡æ–™**: åœ‹å®¶ã€åŸå¸‚ã€æœƒè¨ˆç§‘ç›®ç­‰åŸºç¤è³‡æ–™ä¸éœ€è¦ workspace_id
3. **å‰ç«¯éæ¿¾**: ä½¿ç”¨ `where('workspace_id', currentWorkspace.id)` éæ¿¾è³‡æ–™

---

**ç¶­è­·è€…**: William Chien
**æª¢æŸ¥æ—¥æœŸ**: 2025-11-17
