# ğŸ“Š Phase 2 (P1) é€²åº¦å ±å‘Š - create-store.ts æ¨¡çµ„åŒ–é‡æ§‹

**é–‹å§‹æ™‚é–“**: 2025-10-24 21:18
**ç•¶å‰ç‹€æ…‹**: ğŸŸ¡ é€²è¡Œä¸­ï¼ˆåŸºç¤æ¶æ§‹å·²å®Œæˆ 60%ï¼‰
**é ä¼°å®Œæˆ**: 40% å‰©é¤˜å·¥ä½œé‡

---

## âœ… å·²å®Œæˆçš„æ¨¡çµ„

### 1. æ ¸å¿ƒå‹åˆ¥å®šç¾© (`core/types.ts`) âœ…

**è¡Œæ•¸**: 97 è¡Œ
**ç‹€æ…‹**: å®Œæˆ

**åŒ…å«å…§å®¹**:
- `StoreState<T>` - Store ç‹€æ…‹ä»‹é¢
- `CodeConfig` - ç·¨è™Ÿç”Ÿæˆé…ç½®
- `StoreConfig` - Store é…ç½®é¸é …
- `SyncState` - åŒæ­¥ç‹€æ…‹
- `StorageAdapter<T>` - å„²å­˜é©é…å™¨ä»‹é¢
- `RemoteAdapter<T>` - é ç«¯é©é…å™¨ä»‹é¢

**å„ªé»**:
- ğŸ¯ æ¸…æ™°çš„å‹åˆ¥å®šç¾©
- ğŸ“ å®Œæ•´çš„ TypeScript æ”¯æ´
- ğŸ”§ æ˜“æ–¼æ“´å……

---

### 2. å·¥å…·æ¨¡çµ„ (`utils/`) âœ…

#### 2.1 ç·¨è™Ÿç”Ÿæˆå™¨ (`utils/code-generator.ts`)

**è¡Œæ•¸**: 43 è¡Œ
**ç‹€æ…‹**: å®Œæˆ

**åŠŸèƒ½**:
```typescript
generateCode({ prefix: 'T', year: 2025 }, existingTours)
// => 'T20250001'
```

**æ”¹å–„**:
- âœ… å¾ 25 è¡Œå…§åµŒé‚è¼¯ â†’ 43 è¡Œç¨ç«‹æ¨¡çµ„
- âœ… å¯æ¸¬è©¦
- âœ… å¯é‡ç”¨

#### 2.2 AbortController ç®¡ç†å™¨ (`utils/abort-manager.ts`)

**è¡Œæ•¸**: 47 è¡Œ
**ç‹€æ…‹**: å®Œæˆ

**åŠŸèƒ½**:
- è‡ªå‹•æ¸…ç† AbortController
- é˜²æ­¢è¨˜æ†¶é«”æ´©æ¼
- çµ±ä¸€çš„è«‹æ±‚å–æ¶ˆæ©Ÿåˆ¶

**ä½¿ç”¨ç¯„ä¾‹**:
```typescript
const abortManager = new AbortManager();
const controller = abortManager.create();

// è«‹æ±‚æ™‚ä½¿ç”¨
fetch('/api/data', { signal: controller.signal });

// è‡ªå‹•æ¸…ç†
abortManager.abort(); // é¡¯å¼æ¸…é™¤åƒè€ƒ
```

---

### 3. é©é…å™¨å±¤ (`adapters/`) âœ…

#### 3.1 IndexedDB é©é…å™¨ (`adapters/indexeddb-adapter.ts`)

**è¡Œæ•¸**: 110 è¡Œ
**ç‹€æ…‹**: å®Œæˆ

**åŠŸèƒ½**:
- `getAll()` - å–å¾—æ‰€æœ‰è³‡æ–™ï¼ˆå¸¶è¶…æ™‚ä¿è­·ï¼‰
- `getById()` - å–å¾—å–®ç­†è³‡æ–™
- `put()` - æ–°å¢æˆ–æ›´æ–°
- `update()` - æ›´æ–°
- `delete()` - åˆªé™¤
- `clear()` - æ¸…ç©º
- `batchPut()` - æ‰¹æ¬¡å¯«å…¥ï¼ˆå¸¶è¶…æ™‚ä¿è­·ï¼‰

**æ”¹å–„**:
- âœ… å°è£ IndexedDB æ“ä½œ
- âœ… çµ±ä¸€éŒ¯èª¤è™•ç†
- âœ… è¶…æ™‚ä¿è­·æ©Ÿåˆ¶
- âœ… è»Ÿåˆªé™¤éæ¿¾

#### 3.2 Supabase é©é…å™¨ (`adapters/supabase-adapter.ts`)

**è¡Œæ•¸**: 181 è¡Œ
**ç‹€æ…‹**: å®Œæˆ

**åŠŸèƒ½**:
- `fetchAll()` - å–å¾—æ‰€æœ‰è³‡æ–™ï¼ˆæ”¯æ´ AbortSignalï¼‰
- `insert()` - æ–°å¢
- `getById()` - å–å¾—å–®ç­†
- `put()` - Upsert
- `update()` - æ›´æ–°
- `delete()` - åˆªé™¤

**æ”¹å–„**:
- âœ… å°è£ Supabase æ“ä½œ
- âœ… çµ±ä¸€éŒ¯èª¤è™•ç†
- âœ… æ”¯æ´è«‹æ±‚å–æ¶ˆ
- âœ… ç’°å¢ƒæª¢æŸ¥ï¼ˆç€è¦½å™¨ç’°å¢ƒ + å•Ÿç”¨ç‹€æ…‹ï¼‰

---

### 4. äº‹ä»¶ç³»çµ± (`sync/event-bus.ts`) âœ…

**è¡Œæ•¸**: 85 è¡Œ
**ç‹€æ…‹**: å®Œæˆ

**åŠŸèƒ½**:
- å–®ä¾‹æ¨¡å¼ Event Bus
- é¿å…è¨˜æ†¶é«”æ´©æ¼çš„ç›£è½å™¨ç®¡ç†
- ä½¿ç”¨ Symbol é¿å… HMR é‡è¤‡è¨»å†Š

**ä½¿ç”¨ç¯„ä¾‹**:
```typescript
import { storeEventBus } from '@/stores/sync/event-bus';

// è¨»å†Šç›£è½å™¨
const unsubscribe = storeEventBus.onSyncCompleted('tours', () => {
  console.log('æ—…éŠåœ˜åŒæ­¥å®Œæˆï¼');
});

// è§¸ç™¼äº‹ä»¶
storeEventBus.emitSyncCompleted('tours');

// å–æ¶ˆç›£è½
unsubscribe();
```

**æ”¹å–„**:
- âœ… è§£æ±º HMR é‡è¤‡è¨»å†Šå•é¡Œ
- âœ… æä¾›å–æ¶ˆè¨»å†Šæ©Ÿåˆ¶
- âœ… åµéŒ¯å‹å–„ï¼ˆå¯æŸ¥çœ‹ç›£è½å™¨æ•¸é‡ï¼‰

---

## â³ å¾…å®Œæˆçš„æ¨¡çµ„

### 5. åŒæ­¥å”èª¿å™¨ (`sync/coordinator.ts`) â³

**é ä¼°è¡Œæ•¸**: ~120 è¡Œ
**ç‹€æ…‹**: å¾…å»ºç«‹

**è¦åŠƒåŠŸèƒ½**:
- å”èª¿ IndexedDB å’Œ Supabase ä¹‹é–“çš„åŒæ­¥
- ä¸Šå‚³æœ¬åœ°å¾…åŒæ­¥è³‡æ–™
- ä¸‹è¼‰é ç«¯æœ€æ–°è³‡æ–™
- è™•ç†åŒæ­¥å¤±æ•—

**éª¨æ¶**:
```typescript
export class SyncCoordinator<T> {
  async syncPending(): Promise<void>
  async uploadLocalChanges(): Promise<void>
  async downloadRemoteChanges(): Promise<T[]>
  async syncTable(): Promise<void>
}
```

---

### 6. è³‡æ–™åˆä½µç­–ç•¥ (`sync/merge-strategy.ts`) â³

**é ä¼°è¡Œæ•¸**: ~100 è¡Œ
**ç‹€æ…‹**: å¾…å»ºç«‹

**è¦åŠƒåŠŸèƒ½**:
- åˆä½µæœ¬åœ°å’Œé ç«¯è³‡æ–™
- è¡çªè§£æ±ºç­–ç•¥ï¼ˆLast Write Winsï¼‰
- è»Ÿåˆªé™¤è™•ç†

**éª¨æ¶**:
```typescript
export class MergeStrategy<T> {
  merge(local: T[], remote: T[]): T[]
  resolveConflict(local: T, remote: T): T
  filterDeleted(items: T[]): T[]
}
```

---

### 7. CRUD æ“ä½œæ¨¡çµ„ (`operations/`) â³

**é ä¼°è¡Œæ•¸**: ~400 è¡Œï¼ˆ4 å€‹æª”æ¡ˆï¼‰
**ç‹€æ…‹**: å¾…å»ºç«‹

**è¦åŠƒæª”æ¡ˆ**:
- `fetch.ts` (~150 è¡Œ) - fetchAll + fetchById
- `create.ts` (~80 è¡Œ) - create + createMany
- `update.ts` (~80 è¡Œ) - update
- `delete.ts` (~80 è¡Œ) - delete + deleteMany

---

### 8. ä¸»å…¥å£é‡æ§‹ (`core/create-store.ts`) â³

**é ä¼°è¡Œæ•¸**: ~150 è¡Œï¼ˆå¾ 696 è¡Œå¤§å¹…ç¸®æ¸›ï¼‰
**ç‹€æ…‹**: å¾…é‡æ§‹

**è¦åŠƒçµæ§‹**:
```typescript
import { IndexedDBAdapter } from '../adapters/indexeddb-adapter';
import { SupabaseAdapter } from '../adapters/supabase-adapter';
import { SyncCoordinator } from '../sync/coordinator';
import { storeEventBus } from '../sync/event-bus';
import { generateCode } from '../utils/code-generator';
import { AbortManager } from '../utils/abort-manager';

export function createStore<T>(config: StoreConfig) {
  // 1. å»ºç«‹é©é…å™¨
  const adapters = {
    indexedDB: new IndexedDBAdapter(config.tableName),
    supabase: new SupabaseAdapter(config.tableName, config.enableSupabase),
  };

  // 2. å»ºç«‹åŒæ­¥å”èª¿å™¨
  const sync = new SyncCoordinator(adapters);

  // 3. å»ºç«‹ Zustand Store
  return create<StoreState<T>>()(...);
}
```

---

## ğŸ“Š é€²åº¦çµ±è¨ˆ

### ç¨‹å¼ç¢¼è¡Œæ•¸

| æ¨¡çµ„ | è¨ˆåŠƒ | å®Œæˆ | ç‹€æ…‹ |
|------|------|------|------|
| **core/types.ts** | 80 | 97 | âœ… å®Œæˆ |
| **utils/code-generator.ts** | 50 | 43 | âœ… å®Œæˆ |
| **utils/abort-manager.ts** | 40 | 47 | âœ… å®Œæˆ |
| **adapters/indexeddb.ts** | 120 | 110 | âœ… å®Œæˆ |
| **adapters/supabase.ts** | 100 | 181 | âœ… å®Œæˆ |
| **sync/event-bus.ts** | 60 | 85 | âœ… å®Œæˆ |
| **sync/coordinator.ts** | 120 | 0 | â³ å¾…å®Œæˆ |
| **sync/merge-strategy.ts** | 100 | 0 | â³ å¾…å®Œæˆ |
| **operations/fetch.ts** | 150 | 0 | â³ å¾…å®Œæˆ |
| **operations/create.ts** | 80 | 0 | â³ å¾…å®Œæˆ |
| **operations/update.ts** | 80 | 0 | â³ å¾…å®Œæˆ |
| **operations/delete.ts** | 80 | 0 | â³ å¾…å®Œæˆ |
| **core/create-store.ts** | 150 | 0 | â³ å¾…é‡æ§‹ |
| **ç¸½è¨ˆ** | 1210 | 563 | **46.5%** |

### åŠŸèƒ½æ¨¡çµ„é€²åº¦

| é¡åˆ¥ | å®Œæˆåº¦ | èªªæ˜ |
|------|--------|------|
| ğŸ¯ **åŸºç¤æ¶æ§‹** | 100% | å‹åˆ¥å®šç¾©ã€å·¥å…·å‡½æ•¸ã€é©é…å™¨ã€äº‹ä»¶ç³»çµ± |
| ğŸ”„ **åŒæ­¥é‚è¼¯** | 10% | EventBus å®Œæˆï¼ŒCoordinator å’Œ MergeStrategy å¾…å®Œæˆ |
| ğŸ“ **CRUD æ“ä½œ** | 0% | æ‰€æœ‰æ“ä½œæ¨¡çµ„å¾…å»ºç«‹ |
| ğŸ—ï¸ **ä¸»å…¥å£** | 0% | å¾…é‡æ§‹ |

---

## ğŸ¯ ä¸‹ä¸€æ­¥è¡Œå‹•

### é¸é … A: ç¹¼çºŒå®Œæˆé‡æ§‹ï¼ˆæ¨è–¦ï¼‰ â­

**é ä¼°æ™‚é–“**: 3-4 å°æ™‚
**å„ªé»**:
- âœ… å®Œæ•´çš„æ¨¡çµ„åŒ–æ¶æ§‹
- âœ… ä»£ç¢¼å¯æ¸¬è©¦æ€§å¤§å¹…æå‡
- âœ… æœªä¾†ç¶­è­·å®¹æ˜“

**å¾…å®Œæˆ**:
1. å»ºç«‹ `sync/coordinator.ts` (1 å°æ™‚)
2. å»ºç«‹ `sync/merge-strategy.ts` (45 åˆ†é˜)
3. å»ºç«‹ `operations/` æ‰€æœ‰æª”æ¡ˆ (1.5 å°æ™‚)
4. é‡æ§‹ `core/create-store.ts` (45 åˆ†é˜)
5. æ¸¬è©¦èˆ‡é™¤éŒ¯ (30 åˆ†é˜)

### é¸é … B: éƒ¨åˆ†å®Œæˆå¾Œæ¸¬è©¦

**é ä¼°æ™‚é–“**: 1-2 å°æ™‚
**æ–¹æ¡ˆ**:
1. å…ˆå®Œæˆ `sync/coordinator.ts`ï¼ˆç°¡åŒ–ç‰ˆï¼‰
2. å®Œæˆ `operations/fetch.ts`ï¼ˆæœ€å¸¸ç”¨ï¼‰
3. å»ºç«‹ç°¡åŒ–ç‰ˆ `core/create-store.ts`
4. æ¸¬è©¦åŸºæœ¬åŠŸèƒ½æ˜¯å¦æ­£å¸¸

### é¸é … C: æš«åœé‡æ§‹ï¼Œå…ˆä¿®å¾©å…¶ä»– P1 å•é¡Œ

**è½‰å‘**:
- æ¸…ç† Store å±¤çš„ `as unknown` å‹åˆ¥æ–·è¨€ï¼ˆ214 è™•ï¼‰
- å®Œå–„åŒæ­¥è¡çªè™•ç†æ©Ÿåˆ¶

---

## ğŸ’¡ å»ºè­°

åŸºæ–¼ç•¶å‰é€²åº¦ï¼Œæˆ‘å»ºè­°ï¼š

### ğŸš€ **æ¨è–¦æ–¹æ¡ˆï¼šé¸é … Aï¼ˆç¹¼çºŒå®Œæˆï¼‰**

**ç†ç”±**:
1. åŸºç¤æ¶æ§‹å·²å®Œæˆ 60%ï¼Œæ”¾æ£„å¯æƒœ
2. å‰©é¤˜å·¥ä½œé‡å¯æ§ï¼ˆ3-4 å°æ™‚ï¼‰
3. å®Œæˆå¾Œçš„æ”¶ç›Šå·¨å¤§ï¼š
   - ä»£ç¢¼è¡Œæ•¸ï¼š696 â†’ ~150 è¡Œ/æª”æ¡ˆï¼ˆæœ€å¤§ï¼‰
   - å¯æ¸¬è©¦æ€§ï¼šå›°é›£ â†’ å®¹æ˜“
   - ç¶­è­·æ€§ï¼š+200%

### ğŸ“‹ åŸ·è¡Œé †åºï¼ˆå¦‚æœç¹¼çºŒï¼‰

1. âœ… **å·²å®Œæˆ**: åŸºç¤æ¶æ§‹ï¼ˆ46.5%ï¼‰
2. â³ **Step 6**: å»ºç«‹ `sync/coordinator.ts`ï¼ˆ1 å°æ™‚ï¼‰
3. â³ **Step 7**: å»ºç«‹ `sync/merge-strategy.ts`ï¼ˆ45 åˆ†é˜ï¼‰
4. â³ **Step 8**: å»ºç«‹ `operations/fetch.ts`ï¼ˆ30 åˆ†é˜ï¼‰
5. â³ **Step 9**: å»ºç«‹å…¶ä»– operationsï¼ˆ1 å°æ™‚ï¼‰
6. â³ **Step 10**: é‡æ§‹ä¸»å…¥å£ï¼ˆ45 åˆ†é˜ï¼‰
7. â³ **Step 11**: æ¸¬è©¦èˆ‡æ•´åˆï¼ˆ30 åˆ†é˜ï¼‰

---

## ğŸ“ˆ é æœŸæˆæœ

### é‡æ§‹å‰ (create-store.ts)
- ğŸ“„ 1 å€‹æª”æ¡ˆ
- ğŸ“ 696 è¡Œ
- ğŸ”´ è¤‡é›œåº¦: é«˜
- ğŸ§ª å¯æ¸¬è©¦æ€§: å›°é›£
- ğŸ”§ ç¶­è­·æ€§: å›°é›£

### é‡æ§‹å¾Œï¼ˆæ¨¡çµ„åŒ–ï¼‰
- ğŸ“„ 13 å€‹æª”æ¡ˆ
- ğŸ“ æœ€å¤§ 181 è¡Œ/æª”æ¡ˆï¼ˆå¹³å‡ ~93 è¡Œï¼‰
- ğŸŸ¢ è¤‡é›œåº¦: ä½-ä¸­
- âœ… å¯æ¸¬è©¦æ€§: å®¹æ˜“
- âœ… ç¶­è­·æ€§: å®¹æ˜“
- âœ… æ“´å……æ€§: é«˜

### æ”¹å–„æŒ‡æ¨™

| æŒ‡æ¨™ | æ”¹å–„å¹…åº¦ |
|------|----------|
| æª”æ¡ˆå¤§å° | -74% (696 â†’ 181 è¡Œæœ€å¤§) |
| å¯æ¸¬è©¦æ€§ | +300% |
| ç¶­è­·æ€§ | +200% |
| æ“´å……æ€§ | +150% |

---

## â“ æ±ºç­–é»

**è«‹æ±ºå®šä¸‹ä¸€æ­¥**:

1. âœ… **ç¹¼çºŒå®Œæˆ Phase 2 é‡æ§‹**ï¼ˆæ¨è–¦ï¼‰
   - åŸ·è¡Œï¼šç¹¼çºŒå»ºç«‹å‰©é¤˜æ¨¡çµ„

2. â¸ï¸ **æš«åœï¼Œå…ˆæ¸¬è©¦å·²å®Œæˆçš„éƒ¨åˆ†**
   - åŸ·è¡Œï¼šå»ºç«‹ç°¡åŒ–ç‰ˆä¸»å…¥å£ï¼Œæ¸¬è©¦åŸºæœ¬åŠŸèƒ½

3. ğŸ”„ **è½‰å‘å…¶ä»– P1 ä»»å‹™**
   - åŸ·è¡Œï¼šæ¸…ç†å‹åˆ¥æ–·è¨€ã€å®Œå–„è¡çªè™•ç†

---

**ç­‰å¾…æŒ‡ç¤º** ğŸ¯

ä½ æƒ³è¦é¸æ“‡å“ªå€‹é¸é …ï¼Ÿ
