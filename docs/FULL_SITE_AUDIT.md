# Venturo ERP 全站審計報告

> **審計日期**：2026-02-02
> **審計方式**：按業務生命週期，逐一檢視每個頁面的按鈕與互動
> **審計覆蓋**：9 個主要模組

---

## 🎯 業務生命週期

```
提案階段          開團階段          訂單階段         交接階段          執行階段
    │                │                │               │                │
    ↓                ↓                ↓               ↓                ↓
┌────────┐      ┌────────┐      ┌────────┐      ┌────────┐      ┌────────┐
│ 報價單  │  →   │  開團   │  →   │  訂單   │  →   │ 確認單  │  →   │ Online │
│ quotes │      │ tours  │      │ orders │      │ confirm │      │  App   │
└────────┘      └────────┘      └────────┘      └────────┘      └────────┘
```

---

## 📊 總體評估

| 模組 | 健康度 | 嚴重問題 | 中等問題 | 備註 |
|------|--------|----------|----------|------|
| 🟢 報價單 | 良好 | 0 | 5 | 核心功能正常 |
| 🟢 開團 | 良好 | 0 | 3 | 元件略大但功能完整 |
| 🟡 手冊設計 | 可用 | 0 | 3 | PDF 渲染有小問題 |
| 🟡 確認單 | 需注意 | 2 | 3 | 鎖定機制薄弱 |
| 🟢 日曆排程 | 良好 | 1 | 3 | 甘特圖效能問題 |
| 🟢 資料庫 | 良好 | 0 | 3 | CRUD 完整 |
| 🟡 會計 | 可用 | 3 | 2 | 個人記帳功能不完整 |
| 🟡 合約 | 需注意 | 2 | 4 | XSS 風險 |
| 🟢 顧客 | 良好 | 2 | 2 | 功能齊全 |

---

## 🔴 嚴重問題清單（P0 優先修復）

### 1. 確認單：後端鎖定機制缺失
**位置**：`src/features/tour-confirmation/`
**問題**：交接後只有前端 CSS 鎖定，無後端驗證
**風險**：已交接的資料可能被修改
**建議**：
```typescript
// API 層級保護
if (sheet.status === 'completed') {
  return errorResponse('此行程已交接，無法修改', 403)
}
```

### 2. 確認單：交接前驗證不足
**問題**：可能交接空白確認單
**建議**：加入最低項目檢查（行程表、交通、住宿）

### 3. 合約：XSS 風險
**位置**：`src/features/contracts/components/ContractDialog.tsx`
**問題**：
```typescript
template = template.replace(regex, value || '')  // ⚠️ 沒有轉義！
```
**建議**：使用 `escapeHtml()` 處理用戶輸入

### 4. 會計：交易編輯/刪除功能缺失
**位置**：`/accounting` 個人記帳模組
**問題**：只能新增，無法編輯或刪除
**影響**：用戶無法修正錯誤記錄

### 5. 排程：甘特圖效能問題
**位置**：`src/features/scheduling/components/RequirementGanttChart.tsx`
**問題**：大量需求時 DOM 過多
**建議**：使用虛擬滾動

### 6. 顧客：類型強轉
**位置**：`src/app/(main)/customers/page.tsx`
**問題**：`as Customer[]` 可能導致 runtime 錯誤

---

## 🟡 中等問題清單（P1 建議修復）

### 架構問題
1. **TourDetailDialog 過大**（700+ 行）→ 拆分子對話框狀態到 hook
2. **合約範本映射不一致** → 統一 ContractType
3. **PNR 功能分散** → 統一到 useTourPnr hook

### 資料處理
4. **syncToOnline 錯誤處理不完整** → 團員同步失敗時應回傳錯誤
5. **需求單直接查詢資料庫** → 改用 SWR hook
6. **生日事件不支援跨年** → 根據視圖日期動態計算

### UI/UX
7. **報價單複製欄位不完整** → 增加 selling_price_details
8. **PDF 圖標渲染不完整** → 使用 SVG 轉換
9. **顧客缺少統計資訊** → 顯示訂單數/消費總額

---

## 🟢 運作正常的功能

### 核心流程
- ✅ 報價單建立、複製、刪除、預覽
- ✅ 開團、編輯、封存、結案
- ✅ 日曆視圖切換、事件拖放
- ✅ 手冊設計、範本選擇、頁面編輯
- ✅ 資料庫 CRUD（景點、供應商、車隊、領隊）
- ✅ 確認單自動建立、項目管理

### 進階功能
- ✅ Realtime 同步（日曆事件）
- ✅ 衝突檢查（車輛/領隊排程）
- ✅ 多幣別支援（會計）
- ✅ 合約範本填充
- ✅ 圖片上傳與裁切

---

## 📈 改進優先級建議

### 本週（P0）
1. 修復確認單後端鎖定機制
2. 修復合約 XSS 風險
3. 補充確認單交接前驗證

### 本月（P1）
4. 補充會計交易編輯/刪除功能
5. 甘特圖虛擬滾動
6. TourDetailDialog 重構

### 持續改進（P2）
7. 統一錯誤處理方式
8. 清理未使用的 import
9. 文檔與實作同步

---

## 📁 詳細審計報告

| 報告 | 位置 |
|------|------|
| 報價單 | `docs/audits/quotes-audit.md` |
| 開團 | `docs/audits/tours-audit.md` |
| 手冊設計 | `docs/audits/brochure-audit.md` |
| 確認單 | `docs/audits/confirmation-audit.md` |
| 日曆排程 | `docs/audits/calendar-audit.md` |
| 資料庫 | `docs/audits/database-audit.md` |
| 會計 | `docs/audits/accounting-audit.md` |
| 合約 | `docs/audits/contracts-audit.md` |
| 顧客 | `docs/audits/customers-audit.md` |

---

## 💡 結論

整體而言，Venturo ERP 的核心業務流程運作正常，主要問題集中在：

1. **安全性**：確認單鎖定機制、合約 XSS
2. **完整性**：會計功能不完整
3. **效能**：甘特圖大量資料
4. **維護性**：部分元件過大

建議優先處理安全相關問題，再逐步改善使用者體驗和程式碼品質。

---

*審計完成時間：2026-02-02 19:25 JST*
