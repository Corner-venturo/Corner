'use client'

import React, { useEffect, useMemo } from 'react'
import Link from 'next/link'
import { ResponsiveHeader } from '@/components/layout/responsive-header'
import { Card } from '@/components/ui/card'
import { Button } from '@/components/ui/button'
import { EnhancedTable, TableColumn } from '@/components/ui/enhanced-table'
import { CurrencyCell, DateCell } from '@/components/table-cells'
import { useAccountingStore } from '@/stores/accounting-store'
import type { Transaction } from '@/stores/accounting-store'
import {
  CreditCard,
  TrendingUp,
  TrendingDown,
  DollarSign,
  Wallet,
  BarChart3,
  AlertTriangle,
  Loader2,
} from 'lucide-react'

export default function FinancePage() {
  const {
    transactions,
    stats,
    isLoading,
    initialize,
    fetchTransactions,
    transactionsPage,
    transactionsPageSize,
    transactionsCount,
  } = useAccountingStore()

  useEffect(() => {
    initialize()
  }, [initialize])

  // Re-calculate stats that were in the original UI but not in the store's `stats` object
  const totalReceivable = stats.total_income
  const totalPayable = stats.total_expense
  const netProfit = totalReceivable - totalPayable
  // Placeholder for pending payments as this data is not in the accounting store
  const pendingPayments = 0 

  const transactionColumns: TableColumn<Transaction>[] = useMemo(
    () => [
      {
        key: 'type',
        label: '類型',
        sortable: true,
        render: (_value, transaction) => {
          const typeIcons: Record<string, React.ReactNode> = {
            income: <TrendingUp size={16} className="text-morandi-green" />,
            expense: <TrendingDown size={16} className="text-morandi-red" />,
            transfer: <DollarSign size={16} className="text-morandi-gold" />,
          }
          const typeLabels: Record<string, string> = {
            income: '收入',
            expense: '支出',
            transfer: '轉帳',
          }
          return (
            <div className="flex items-center space-x-2">
              {typeIcons[transaction.type]}
              <span className="text-sm">{typeLabels[transaction.type] || transaction.type}</span>
            </div>
          )
        },
      },
      {
        key: 'description',
        label: '說明',
        sortable: true,
        render: (_value, transaction) => (
          <span className="text-sm text-morandi-primary">{transaction.description}</span>
        ),
      },
      {
        key: 'amount',
        label: '金額',
        sortable: true,
        render: (_value, transaction) => (
          <CurrencyCell
            amount={transaction.amount}
            variant={transaction.type === 'income' ? 'income' : 'expense'}
            showSign
          />
        ),
      },
      {
        key: 'date',
        label: '日期',
        sortable: true,
        render: (_value, transaction) => (
          <DateCell date={transaction.date} showIcon={false} />
        ),
      },
    ],
    []
  )

  const financeModules = [
    {
      title: '財務管理',
      description: '管理所有收款和請款記錄',
      icon: CreditCard,
      href: '/finance/payments',
      stats: `${transactionsCount} 筆記錄`,
      color: 'text-morandi-green',
      bgColor: 'bg-morandi-green/10',
    },
    {
      title: '出納管理',
      description: '日常收支與現金流管理',
      icon: Wallet,
      href: '/finance/treasury',
      stats: '即時現金流',
      color: 'text-morandi-gold',
      bgColor: 'bg-morandi-gold/10',
    },
    {
      title: '報表管理',
      description: '財務分析與統計報表',
      icon: BarChart3,
      href: '/finance/reports',
      stats: '即時財務分析',
      color: 'text-morandi-primary',
      bgColor: 'bg-morandi-primary/10',
    },
  ]
  
  const totalPages = Math.ceil(transactionsCount / transactionsPageSize);

  if (isLoading && transactions.length === 0) {
    return (
       <div className="h-full flex flex-col items-center justify-center">
        <Loader2 className="w-12 h-12 animate-spin text-morandi-gold" />
        <p className="mt-4 text-morandi-secondary">正在載入財務資料...</p>
      </div>
    )
  }

  return (
    <div className="h-full flex flex-col">
      <ResponsiveHeader title="財務管理中心" />

      <div className="flex-1 overflow-auto p-6">
        <div className="space-y-6">
                    {/* 財務總覽 - Enhanced UI */}
                    <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4">
                      <Card className="p-4 bg-morandi-green/10 shadow-sm hover:shadow-md transition-shadow">
                        <div className="flex items-center justify-between">
                          <div>
                            <p className="text-sm text-morandi-secondary mb-1">總收入</p>
                            <p className="text-2xl font-bold text-morandi-green">
                              NT$ {totalReceivable.toLocaleString()}
                            </p>
                          </div>
                          <TrendingUp size={24} className="text-morandi-green" />
                        </div>
                      </Card>
          
                      <Card className="p-4 bg-morandi-red/10 shadow-sm hover:shadow-md transition-shadow">
                        <div className="flex items-center justify-between">
                          <div>
                            <p className="text-sm text-morandi-secondary mb-1">總支出</p>
                            <p className="text-2xl font-bold text-morandi-red">
                              NT$ {totalPayable.toLocaleString()}
                            </p>
                          </div>
                          <TrendingDown size={24} className="text-morandi-red" />
                        </div>
                      </Card>
          
                      <Card className="p-4 bg-morandi-primary/10 shadow-sm hover:shadow-md transition-shadow">
                        <div className="flex items-center justify-between">
                          <div>
                            <p className="text-sm text-morandi-secondary mb-1">淨利潤</p>
                            <p className={`text-2xl font-bold ${netProfit >= 0 ? 'text-morandi-primary' : 'text-morandi-red'}`}>
                              NT$ {netProfit.toLocaleString()}
                            </p>
                          </div>
                          <DollarSign size={24} className={'text-morandi-primary'} />
                        </div>
                      </Card>
          
                      <Card className="p-4 bg-morandi-gold/10 shadow-sm hover:shadow-md transition-shadow">
                        <div className="flex items-center justify-between">
                          <div>
                            <p className="text-sm text-morandi-secondary mb-1">待確認款項</p>
                            <p className="text-2xl font-bold text-morandi-gold">
                              NT$ {pendingPayments.toLocaleString()}
                            </p>
                          </div>
                          <AlertTriangle size={24} className="text-morandi-gold" />
                        </div>
                      </Card>
                    </div>

          {/* 功能模組 - Restored */}
          <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
            {financeModules.map((module, index) => (
              <Link key={index} href={module.href}>
                <Card className="p-6 border border-border hover:shadow-lg transition-shadow cursor-pointer">
                  <div className="flex items-start justify-between">
                    <div className="flex-1">
                      <div className="flex items-center mb-3">
                        <div className={`p-2 rounded-lg ${module.bgColor} mr-3`}>
                          <module.icon size={24} className={module.color} />
                        </div>
                        <div>
                          <h4 className="font-semibold text-morandi-primary">{module.title}</h4>
                          <p className="text-sm text-morandi-secondary">{module.description}</p>
                        </div>
                      </div>
                      <div className="text-sm text-morandi-secondary">{module.stats}</div>
                    </div>
                  </div>
                </Card>
              </Link>
            ))}
          </div>

          {/* 交易紀錄 */}
          <div className="space-y-4">
            <h3 className="text-lg font-semibold text-morandi-primary">交易紀錄</h3>
            <EnhancedTable columns={transactionColumns as TableColumn[]} data={transactions} />
            
            {/* Pagination Controls */}
            <div className="flex items-center justify-between pt-4">
              <div className="text-sm text-morandi-secondary">
                共 {transactionsCount} 筆交易，目前在第 {transactionsPage} / {totalPages} 頁
              </div>
              <div className="flex gap-2">
                <Button
                  onClick={() => fetchTransactions(transactionsPage - 1)}
                  disabled={transactionsPage <= 1 || isLoading}
                >
                  上一頁
                </Button>
                <Button
                  onClick={() => fetchTransactions(transactionsPage + 1)}
                  disabled={transactionsPage >= totalPages || isLoading}
                >
                  下一頁
                </Button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  )
}
