'use client'

import React from 'react'
import { Loader2 } from 'lucide-react'
import { cn } from '@/lib/utils'
import { EnhancedTableProps, RowData, TableColumn, SelectionConfig, ExpandableConfig } from './types'
import { useTableState } from './useTableState'
import { TableHeader } from './TableHeader'
import { TableBody } from './TableBody'
import { TablePagination } from './TablePagination'

export function EnhancedTable<T extends RowData = RowData>({
  columns,
  data,
  loading = false,
  error = null,
  onSort,
  onFilter,
  onRowClick,
  onRowDoubleClick,
  className,
  showFilters: defaultShowFilters = false,
  searchableFields = [] as readonly string[],
  initialPageSize = 15,
  searchTerm: externalSearchTerm = '',
  emptyState,
  emptyMessage,
  selection,
  expandable,
  actions,
  actionsWidth,
  rowClassName,
  striped = false,
  hoverable = true,
  isLoading,
}: EnhancedTableProps<T>) {
  // 將泛型 props 轉換為 RowData 類型以便內部使用
  const typedColumns = columns as unknown as TableColumn<RowData>[]
  const typedData = data as unknown as RowData[]
  const typedSelection = selection as unknown as SelectionConfig<RowData> | undefined
  const typedExpandable = expandable as unknown as ExpandableConfig<RowData> | undefined
  const typedActions = actions as unknown as ((row: RowData) => React.ReactNode) | undefined
  const typedRowClassName = rowClassName as unknown as ((row: RowData) => string) | undefined
  const typedOnRowClick = onRowClick as unknown as ((row: RowData, rowIndex?: number) => void) | undefined
  const typedOnRowDoubleClick = onRowDoubleClick as unknown as ((row: RowData, rowIndex: number) => void) | undefined
  // Handle loading aliases
  const actualLoading = loading || isLoading || false
  const {
    sortColumn,
    sortDirection,
    filters,
    showFilters,
    setShowFilters,
    currentPage,
    setCurrentPage,
    pageSize,
    setPageSize,
    processedData,
    paginatedData,
    totalPages,
    startIndex,
    handleSort,
    updateFilter,
  } = useTableState<RowData>({
    data: typedData,
    searchTerm: externalSearchTerm,
    searchableFields: searchableFields as (keyof RowData)[],
    initialPageSize,
  })

  // Helper functions for selection and expandable
  const getRowId = (row: RowData, index: number): string => {
    if (typedSelection?.getRowId) return typedSelection.getRowId(row, index)
    if (typedExpandable?.getRowId) return typedExpandable.getRowId(row, index)
    return ((row as Record<string, unknown>).id as string) || ((row as Record<string, unknown>)._id as string) || index.toString()
  }

  const isRowSelected = (row: RowData, index: number): boolean => {
    if (!typedSelection) return false
    const rowId = getRowId(row, index)
    return typedSelection.selected.includes(rowId)
  }

  const isRowExpanded = (row: RowData, index: number): boolean => {
    if (!typedExpandable) return false
    const rowId = getRowId(row, index)
    return typedExpandable.expanded.includes(rowId)
  }

  const toggleSelection = (row: RowData, index: number) => {
    if (!typedSelection) return
    const rowId = getRowId(row, index)
    const isSelected = typedSelection.selected.includes(rowId)

    if (isSelected) {
      typedSelection.onChange(typedSelection.selected.filter(id => id !== rowId))
    } else {
      typedSelection.onChange([...typedSelection.selected, rowId])
    }
  }

  const toggleSelectAll = () => {
    if (!typedSelection) return
    const allRowIds = paginatedData.map((row, index) => getRowId(row, startIndex + index))
    const allSelected = allRowIds.every(id => typedSelection.selected.includes(id))

    if (allSelected) {
      // Deselect all visible rows
      typedSelection.onChange(typedSelection.selected.filter(id => !allRowIds.includes(id)))
    } else {
      // Select all visible rows
      const newSelected = [...typedSelection.selected]
      allRowIds.forEach(id => {
        if (!newSelected.includes(id)) {
          newSelected.push(id)
        }
      })
      typedSelection.onChange(newSelected)
    }
  }

  // Calculate if all visible rows are selected
  const allVisibleSelected = typedSelection
    ? paginatedData.length > 0 &&
      paginatedData.every((row, index) => isRowSelected(row, startIndex + index))
    : false
  const someVisibleSelected = typedSelection
    ? paginatedData.some((row, index) => isRowSelected(row, startIndex + index))
    : false

  const handleSortWrapper = (columnKey: string) => {
    handleSort(columnKey)
    onSort?.(columnKey, sortColumn === columnKey && sortDirection === 'asc' ? 'desc' : 'asc')
  }

  const handleFilterChange = (key: string, value: string) => {
    updateFilter(key, value)
    const newFilters = { ...filters, [key]: value === '__all__' ? '' : value }
    onFilter?.(newFilters)
  }

  // Error state (loading state now handled in TableBody to keep table structure visible)
  if (error) {
    return (
      <div
        className={cn(
          'border border-border rounded-xl overflow-hidden bg-card shadow-sm',
          className
        )}
      >
        <div className="flex items-center justify-center py-8 text-status-danger">
          <span>錯誤: {error}</span>
        </div>
      </div>
    )
  }

  return (
    <div
      className={cn(
        'border border-border rounded-xl overflow-hidden bg-card shadow-sm flex flex-col h-full',
        className
      )}
    >
      <div className="overflow-auto flex-1">
        <table className="w-full" style={{ tableLayout: 'fixed' }}>
          <TableHeader
            columns={typedColumns}
            sortColumn={sortColumn}
            sortDirection={sortDirection}
            filters={filters}
            showFilters={showFilters}
            selection={typedSelection}
            actions={typedActions}
            actionsWidth={actionsWidth}
            allVisibleSelected={allVisibleSelected}
            someVisibleSelected={someVisibleSelected}
            onSort={handleSortWrapper}
            onFilterChange={handleFilterChange}
            onToggleFilters={() => setShowFilters(!showFilters)}
            onToggleSelectAll={toggleSelectAll}
          />
          <TableBody
            columns={typedColumns}
            paginatedData={paginatedData}
            startIndex={startIndex}
            emptyState={emptyState}
            selection={typedSelection}
            expandable={typedExpandable}
            actions={typedActions}
            rowClassName={typedRowClassName}
            striped={striped}
            hoverable={hoverable}
            loading={actualLoading}
            onRowClick={typedOnRowClick}
            onRowDoubleClick={typedOnRowDoubleClick}
            getRowId={getRowId}
            isRowSelected={isRowSelected}
            isRowExpanded={isRowExpanded}
            toggleSelection={toggleSelection}
          />
        </table>
      </div>

      <TablePagination
        currentPage={currentPage}
        totalPages={totalPages}
        pageSize={pageSize}
        startIndex={startIndex}
        totalItems={processedData.length}
        onPageChange={setCurrentPage}
        onPageSizeChange={setPageSize}
      />
    </div>
  )
}
