'use client'

import { getTodayString } from '@/lib/utils/format-date'

import { useState } from 'react'
import { DollarSign, Calendar, X, Save } from 'lucide-react'
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select'
import { Input } from '@/components/ui/input'
import { Textarea } from '@/components/ui/textarea'
import { createReceiptOrder } from '@/data'
import type { ReceiptOrder } from '@/types'
import { alert } from '@/lib/ui/alert-dialog'
import { DatePicker } from '@/components/ui/date-picker'
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogFooter,
} from '@/components/ui/dialog'
import { CurrencyCell } from '@/components/table-cells'

interface CreateReceiptDialogProps {
  order: {
    id: string
    order_number: string | null
    contact_person: string
    total_amount: number
    paid_amount: number
    gap: number
  }
  open: boolean
  onClose: () => void
  onSuccess: (receiptId: string) => void
}

export function CreateReceiptDialog({ order, open, onClose, onSuccess }: CreateReceiptDialogProps) {

  const [receiptDate, setReceiptDate] = useState(getTodayString())
  const [paymentMethod, setPaymentMethod] = useState<'現金' | '匯款' | '刷卡' | '支票'>('匯款')
  const [amount, setAmount] = useState(order.gap.toString())
  const [note, setNote] = useState('')

  const handleCreate = async () => {
    try {
      const paymentMethodMap: Record<string, string> = {
        現金: 'cash',
        匯款: 'transfer',
        刷卡: 'card',
        支票: 'check',
      }

      const receiptData = {
        code: '',
        order_id: order.id,
        receipt_date: receiptDate,
        payment_method: paymentMethodMap[paymentMethod] || 'transfer',
        amount: parseFloat(amount),
        notes: note,
        handled_by: null,
      }

      const receipt = await createReceiptOrder(receiptData as Omit<ReceiptOrder, 'id' | 'created_at' | 'updated_at'>)
      onSuccess(receipt.id)
      onClose()
    } catch (error) {
      const errorMessage = error instanceof Error ? error.message : String(error)
      void alert(`建立收款單失敗：${errorMessage}`, 'error')
    }
  }

  return (
    <Dialog open={open} onOpenChange={(isOpen) => !isOpen && onClose()}>
      <DialogContent className="max-w-[500px]">
        <DialogHeader className="pb-3 border-b border-morandi-gold/20">
          <DialogTitle className="flex items-center gap-2">
            <DollarSign className="text-morandi-gold" size={20} />
            <span>建立收款單</span>
          </DialogTitle>
        </DialogHeader>

        {/* 內容 */}
        <div className="space-y-4 my-4">
          {/* 訂單資訊 */}
          <div className="bg-morandi-container/5 rounded-lg p-3 border border-morandi-gold/20">
            <div className="text-sm font-medium text-morandi-secondary mb-2">訂單資訊：</div>
            <div className="space-y-1">
              <div className="flex items-center justify-between text-sm">
                <span className="text-morandi-secondary">訂單號：</span>
                <span className="font-medium text-morandi-primary">{order.order_number || '-'}</span>
              </div>
              <div className="flex items-center justify-between text-sm">
                <span className="text-morandi-secondary">客戶：</span>
                <span className="text-morandi-primary">{order.contact_person}</span>
              </div>
              <div className="flex items-center justify-between text-sm">
                <span className="text-morandi-secondary">總額：</span>
                <CurrencyCell amount={order.total_amount} className="text-morandi-primary" />
              </div>
              <div className="flex items-center justify-between text-sm">
                <span className="text-morandi-secondary">已收：</span>
                <CurrencyCell amount={order.paid_amount} className="text-morandi-primary" />
              </div>
              <div className="flex items-center justify-between text-sm pt-2 border-t border-morandi-gold/20">
                <span className="text-morandi-secondary">待收金額：</span>
                <CurrencyCell amount={order.gap} variant="expense" className="text-lg font-semibold" />
              </div>
            </div>
          </div>

          {/* 收款日期 */}
          <div>
            <label className="block text-sm font-medium text-morandi-primary mb-2">
              收款日期
            </label>
            <div className="relative">
              <DatePicker
                value={receiptDate}
                onChange={date => setReceiptDate(date)}
                placeholder="選擇日期"
                className="pl-10"
              />
              <Calendar
                className="absolute left-3 top-1/2 -translate-y-1/2 text-morandi-secondary pointer-events-none"
                size={16}
              />
            </div>
          </div>

          {/* 收款方式 */}
          <div>
            <label className="block text-sm font-medium text-morandi-primary mb-2">
              收款方式
            </label>
            <Select
              value={paymentMethod}
              onValueChange={value => {
                if (value === '現金' || value === '匯款' || value === '刷卡' || value === '支票') {
                  setPaymentMethod(value)
                }
              }}
            >
              <SelectTrigger className="w-full">
                <SelectValue />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="現金">現金</SelectItem>
                <SelectItem value="匯款">匯款</SelectItem>
                <SelectItem value="刷卡">刷卡</SelectItem>
                <SelectItem value="支票">支票</SelectItem>
              </SelectContent>
            </Select>
          </div>

          {/* 收款金額 */}
          <div>
            <label className="block text-sm font-medium text-morandi-primary mb-2">
              收款金額
            </label>
            <Input
              type="number"
              value={amount}
              onChange={e => setAmount(e.target.value)}
              placeholder="輸入收款金額"
            />
          </div>

          {/* 備註 */}
          <div>
            <label className="block text-sm font-medium text-morandi-primary mb-2">
              備註（選填）
            </label>
            <Textarea
              value={note}
              onChange={e => setNote(e.target.value)}
              rows={3}
              placeholder="輸入備註..."
            />
          </div>
        </div>

        {/* 底部操作按鈕 */}
        <DialogFooter className="pt-3 border-t border-morandi-gold/20">
          <button className="btn-morandi-secondary !py-2 !px-4 flex items-center gap-2" onClick={onClose}>
            <X size={16} />
            取消
          </button>
          <button
            className="btn-morandi-primary !py-2 !px-4 flex items-center gap-2"
            onClick={handleCreate}
            disabled={!amount || parseFloat(amount) <= 0}
          >
            <Save size={16} />
            建立收款單
          </button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  )
}
