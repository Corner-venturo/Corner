'use client'

import React, { useState, useEffect } from 'react'
import { Button } from '@/components/ui/button'
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogDescription,
  DialogFooter,
} from '@/components/ui/dialog'
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'
import { Sparkles, Loader2, AlertCircle, Check, X, Plus, Trash2, GripVertical } from 'lucide-react'
import { toast } from 'sonner'
import { useCities, type City } from '@/data'
import type { DailyItinerary, FlightInfo } from '../../types'
import type { AccommodationPlan, ItineraryStyle } from '@/lib/itinerary-generator/types'
import { COMP_EDITOR_LABELS } from '../../../constants/labels'

interface AutoGenerateDialogProps {
  open: boolean
  onOpenChange: (open: boolean) => void
  onGenerate: (dailyItinerary: DailyItinerary[]) => void
  // ç¾æœ‰è³‡æ–™ï¼ˆç”¨æ–¼é å¡«ï¼‰
  currentCity?: string
  currentDepartureDate?: string
  currentOutboundFlight?: FlightInfo
  currentReturnFlight?: FlightInfo
  currentDays?: number
}

// é¢¨æ ¼é¸é …
const STYLE_OPTIONS: { value: ItineraryStyle; label: string; icon: string; description: string }[] = [
  { value: 'relax', label: COMP_EDITOR_LABELS.æ‚ é–’æ…¢æ´», icon: 'ğŸŒ¿', description: COMP_EDITOR_LABELS.æ”¾æ…¢è…³æ­¥_æ¯å¤©_2_3_å€‹æ™¯é» },
  { value: 'adventure', label: COMP_EDITOR_LABELS.å†’éšªæ¢ç´¢, icon: 'ğŸ”ï¸', description: COMP_EDITOR_LABELS.æ·±åº¦é«”é©—_æ¢ç´¢éš±è—æ™¯é» },
  { value: 'culture', label: COMP_EDITOR_LABELS.æ–‡åŒ–å·¡ç¦®, icon: 'ğŸ›ï¸', description: COMP_EDITOR_LABELS.æ­·å²å¤è¹Ÿ_åšç‰©é¤¨ç‚ºä¸» },
  { value: 'food', label: COMP_EDITOR_LABELS.ç¾é£Ÿä¹‹æ—…, icon: 'ğŸœ', description: COMP_EDITOR_LABELS.åœ¨åœ°ç¾é£Ÿ_å¸‚å ´å·¡ç¦® },
]

export function AutoGenerateDialog({
  open,
  onOpenChange,
  onGenerate,
  currentCity,
  currentDepartureDate,
  currentOutboundFlight,
  currentReturnFlight,
  currentDays,
}: AutoGenerateDialogProps) {
  // ç‹€æ…‹
  const [cityId, setCityId] = useState<string>('')
  const [numDays, setNumDays] = useState(currentDays || 5)
  const [departureDate, setDepartureDate] = useState(currentDepartureDate || '')
  const [arrivalTime, setArrivalTime] = useState(currentOutboundFlight?.arrivalTime || '11:00')
  const [departureTime, setDepartureTime] = useState(currentReturnFlight?.departureTime || '14:00')
  const [isGenerating, setIsGenerating] = useState(false)
  const [result, setResult] = useState<{
    success: boolean
    stats?: { totalAttractions: number; attractionsInDb: number }
    warnings?: string[]
  } | null>(null)

  // æ–°å¢ï¼šä½å®¿å®‰æ’
  const [accommodations, setAccommodations] = useState<AccommodationPlan[]>([])
  const [style, setStyle] = useState<ItineraryStyle>('relax')

  // è¼‰å…¥åŸå¸‚è³‡æ–™ (SWR è‡ªå‹•è¼‰å…¥)
  const { items: cities, loading: citiesLoading } = useCities()

  // ç•¶ currentCity è®ŠåŒ–æ™‚ï¼Œå˜—è©¦æ‰¾åˆ°å°æ‡‰çš„ cityId
  useEffect(() => {
    if (currentCity && cities.length > 0) {
      const matchedCity = cities.find(
        (c: City) => c.name === currentCity || c.name?.includes(currentCity)
      )
      if (matchedCity) {
        setCityId(matchedCity.id)
      }
    }
  }, [currentCity, cities])

  // é å¡«èˆªç­æ™‚é–“
  useEffect(() => {
    if (currentOutboundFlight?.arrivalTime) {
      setArrivalTime(currentOutboundFlight.arrivalTime)
    }
    if (currentReturnFlight?.departureTime) {
      setDepartureTime(currentReturnFlight.departureTime)
    }
  }, [currentOutboundFlight, currentReturnFlight])

  // é‡ç½®ç‹€æ…‹
  const handleClose = () => {
    setResult(null)
    onOpenChange(false)
  }

  // ä½å®¿å®‰æ’ï¼šæ–°å¢åŸå¸‚
  const addAccommodation = () => {
    setAccommodations([...accommodations, { cityId: '', cityName: '', nights: 1 }])
  }

  // ä½å®¿å®‰æ’ï¼šç§»é™¤åŸå¸‚
  const removeAccommodation = (index: number) => {
    setAccommodations(accommodations.filter((_, i) => i !== index))
  }

  // ä½å®¿å®‰æ’ï¼šæ›´æ–°åŸå¸‚
  const updateAccommodation = (index: number, field: keyof AccommodationPlan, value: string | number) => {
    const newAccommodations = [...accommodations]
    if (field === 'cityId') {
      const city = cities.find((c: City) => c.id === value)
      newAccommodations[index] = {
        ...newAccommodations[index],
        cityId: value as string,
        cityName: city?.name || '',
      }
    } else {
      newAccommodations[index] = { ...newAccommodations[index], [field]: value }
    }
    setAccommodations(newAccommodations)
  }

  // è¨ˆç®—ä½å®¿ç¸½æ™šæ•¸
  const totalNights = accommodations.reduce((sum, a) => sum + a.nights, 0)
  const expectedNights = numDays - 1 // å¤©æ•¸ - 1 = å¤œæ•¸

  // åŸ·è¡Œç”Ÿæˆ
  const handleGenerate = async () => {
    if (!cityId) {
      toast.error(COMP_EDITOR_LABELS.è«‹é¸æ“‡åŸå¸‚)
      return
    }
    if (!departureDate) {
      toast.error(COMP_EDITOR_LABELS.è«‹é¸æ“‡å‡ºç™¼æ—¥æœŸ)
      return
    }
    if (!arrivalTime || !departureTime) {
      toast.error(COMP_EDITOR_LABELS.è«‹å¡«å¯«èˆªç­æ™‚é–“)
      return
    }

    setIsGenerating(true)
    setResult(null)

    try {
      const response = await fetch('/api/itineraries/generate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          cityId,
          numDays,
          departureDate,
          outboundFlight: { arrivalTime },
          returnFlight: { departureTime },
          // æ–°å¢ï¼šä½å®¿å®‰æ’å’Œé¢¨æ ¼
          accommodations: accommodations.length > 0 ? accommodations : undefined,
          style,
        }),
      })

      const data = await response.json()

      if (!response.ok) {
        throw new Error(data.error || COMP_EDITOR_LABELS.ç”Ÿæˆå¤±æ•—)
      }

      if (data.success) {
        setResult({
          success: true,
          stats: data.data.stats,
          warnings: data.warnings,
        })

        // è½‰æ›ç‚ºå‰ç«¯æ ¼å¼
        const dailyItinerary = data.data.dailyItinerary.map((day: DailyItinerary) => ({
          ...day,
          isAlternative: false,
        }))

        onGenerate(dailyItinerary)
        toast.success(`æˆåŠŸç”Ÿæˆ ${numDays} å¤©è¡Œç¨‹ï¼`)

        // å»¶é²é—œé–‰ï¼Œè®“ä½¿ç”¨è€…çœ‹åˆ°çµæœ
        setTimeout(() => {
          handleClose()
        }, 1500)
      } else {
        throw new Error(COMP_EDITOR_LABELS.ç”Ÿæˆå¤±æ•—)
      }
    } catch (error) {
      toast.error(error instanceof Error ? error.message : COMP_EDITOR_LABELS.ç”Ÿæˆå¤±æ•—_è«‹ç¨å¾Œå†è©¦)
      setResult({ success: false })
    } finally {
      setIsGenerating(false)
    }
  }

  return (
    <Dialog open={open} onOpenChange={handleClose}>
      <DialogContent level={1} className="sm:max-w-lg">
        <DialogHeader>
          <DialogTitle className="flex items-center gap-2">
            <Sparkles className="text-morandi-gold" size={20} />
            ä¸€éµç”Ÿæˆè¡Œç¨‹
          </DialogTitle>
          <DialogDescription>
            æ ¹æ“šæ‚¨çš„èˆªç­æ™‚é–“å’Œç›®çš„åœ°ï¼Œè‡ªå‹•å¾è³‡æ–™åº«è¦åŠƒæœ€ä½³è¡Œç¨‹
          </DialogDescription>
        </DialogHeader>

        <div className="space-y-4 py-4">
          {/* åŸå¸‚é¸æ“‡ */}
          <div className="space-y-2">
            <Label>ç›®çš„åœ°åŸå¸‚</Label>
            <Select value={cityId} onValueChange={setCityId}>
              <SelectTrigger>
                <SelectValue placeholder={citiesLoading ? COMP_EDITOR_LABELS.è¼‰å…¥ä¸­ : COMP_EDITOR_LABELS.é¸æ“‡åŸå¸‚} />
              </SelectTrigger>
              <SelectContent>
                {cities.map((city: City) => (
                  <SelectItem key={city.id} value={city.id}>
                    {city.name}
                  </SelectItem>
                ))}
              </SelectContent>
            </Select>
          </div>

          {/* å¤©æ•¸å’Œæ—¥æœŸ */}
          <div className="grid grid-cols-2 gap-4">
            <div className="space-y-2">
              <Label>è¡Œç¨‹å¤©æ•¸</Label>
              <Input
                type="number"
                value={numDays}
                onChange={e => setNumDays(Math.max(1, Math.min(30, parseInt(e.target.value) || 1)))}
                min={1}
                max={30}
              />
            </div>
            <div className="space-y-2">
              <Label>å‡ºç™¼æ—¥æœŸ</Label>
              <Input
                type="date"
                value={departureDate}
                onChange={e => setDepartureDate(e.target.value)}
              />
            </div>
          </div>

          {/* èˆªç­æ™‚é–“ */}
          <div className="grid grid-cols-2 gap-4">
            <div className="space-y-2">
              <Label>å»ç¨‹æŠµé”æ™‚é–“</Label>
              <Input
                type="time"
                value={arrivalTime}
                onChange={e => setArrivalTime(e.target.value)}
                placeholder="11:00"
              />
              <p className="text-xs text-morandi-secondary">
                æŠµé” 1 å°æ™‚å¾Œé–‹å§‹è¡Œç¨‹
              </p>
            </div>
            <div className="space-y-2">
              <Label>å›ç¨‹èµ·é£›æ™‚é–“</Label>
              <Input
                type="time"
                value={departureTime}
                onChange={e => setDepartureTime(e.target.value)}
                placeholder="14:00"
              />
              <p className="text-xs text-morandi-secondary">
                èµ·é£›å‰ 2 å°æ™‚çµæŸè¡Œç¨‹
              </p>
            </div>
          </div>

          {/* è¡Œç¨‹é¢¨æ ¼ */}
          <div className="space-y-2">
            <Label>è¡Œç¨‹é¢¨æ ¼</Label>
            <div className="grid grid-cols-2 gap-2">
              {STYLE_OPTIONS.map((option) => (
                <button
                  key={option.value}
                  type="button"
                  onClick={() => setStyle(option.value)}
                  className={`p-3 rounded-lg border text-left transition-all ${
                    style === option.value
                      ? 'border-morandi-gold bg-morandi-gold/10'
                      : 'border-border hover:border-morandi-gold/50'
                  }`}
                >
                  <div className="flex items-center gap-2">
                    <span className="text-lg">{option.icon}</span>
                    <span className="font-medium text-sm">{option.label}</span>
                  </div>
                  <p className="text-xs text-morandi-secondary mt-1">{option.description}</p>
                </button>
              ))}
            </div>
          </div>

          {/* ä½å®¿å®‰æ’ */}
          <div className="space-y-3">
            <div className="flex items-center justify-between">
              <Label>ä½å®¿å®‰æ’ï¼ˆé¸å¡«ï¼‰</Label>
              <Button
                type="button"
                variant="outline"
                size="sm"
                onClick={addAccommodation}
                className="h-7 text-xs gap-1"
              >
                <Plus size={14} />
                æ–°å¢åŸå¸‚
              </Button>
            </div>
            <p className="text-xs text-morandi-secondary">
              æŒ‡å®šä½å®¿åŸå¸‚å¯è®“è¡Œç¨‹æ›´ç²¾æº–ã€‚ä¾‹å¦‚ï¼šå¤§é˜ªé€²ä½†ä½äº¬éƒ½ï¼Œæœƒå„ªå…ˆå®‰æ’äº¬éƒ½æ™¯é»ã€‚
            </p>

            {accommodations.length > 0 && (
              <div className="space-y-2">
                {accommodations.map((acc, index) => (
                  <div key={index} className="flex items-center gap-2 p-2 bg-muted rounded-lg">
                    <GripVertical size={14} className="text-morandi-secondary cursor-grab" />
                    <div className="flex-1 grid grid-cols-2 gap-2">
                      <Select
                        value={acc.cityId}
                        onValueChange={(value) => updateAccommodation(index, 'cityId', value)}
                      >
                        <SelectTrigger className="h-8 text-sm">
                          <SelectValue placeholder={COMP_EDITOR_LABELS.é¸æ“‡åŸå¸‚} />
                        </SelectTrigger>
                        <SelectContent>
                          {cities.map((city: City) => (
                            <SelectItem key={city.id} value={city.id}>
                              {city.name}
                            </SelectItem>
                          ))}
                        </SelectContent>
                      </Select>
                      <div className="flex items-center gap-2">
                        <Input
                          type="number"
                          value={acc.nights}
                          onChange={(e) => updateAccommodation(index, 'nights', Math.max(1, parseInt(e.target.value) || 1))}
                          min={1}
                          max={numDays - 1}
                          className="h-8 text-sm w-16"
                        />
                        <span className="text-sm text-morandi-secondary">æ™š</span>
                      </div>
                    </div>
                    <Button
                      type="button"
                      variant="ghost"
                      size="sm"
                      onClick={() => removeAccommodation(index)}
                      className="h-8 w-8 p-0 text-morandi-red hover:text-morandi-red hover:bg-morandi-red/10"
                    >
                      <Trash2 size={14} />
                    </Button>
                  </div>
                ))}

                {/* å¤œæ•¸æª¢æŸ¥ */}
                {totalNights > 0 && (
                  <div className={`text-xs p-2 rounded ${
                    totalNights === expectedNights
                      ? 'bg-green-50 text-green-700'
                      : totalNights > expectedNights
                      ? 'bg-red-50 text-red-700'
                      : 'bg-amber-50 text-amber-700'
                  }`}>
                    {totalNights === expectedNights ? (
                      <span className="flex items-center gap-1">
                        <Check size={12} />
                        ä½å®¿å®‰æ’å®Œæˆï¼š{totalNights} æ™š
                      </span>
                    ) : totalNights > expectedNights ? (
                      <span className="flex items-center gap-1">
                        <AlertCircle size={12} />
                        ä½å®¿æ™šæ•¸ï¼ˆ{totalNights}ï¼‰è¶…éè¡Œç¨‹å¤œæ•¸ï¼ˆ{expectedNights}ï¼‰
                      </span>
                    ) : (
                      <span className="flex items-center gap-1">
                        <AlertCircle size={12} />
                        é‚„æœ‰ {expectedNights - totalNights} æ™šæœªå®‰æ’ä½å®¿
                      </span>
                    )}
                  </div>
                )}
              </div>
            )}
          </div>

          {/* çµæœé¡¯ç¤º */}
          {result && (
            <div className={`p-4 rounded-lg ${result.success ? 'bg-green-50' : 'bg-red-50'}`}>
              {result.success ? (
                <div className="space-y-2">
                  <div className="flex items-center gap-2 text-green-700">
                    <Check size={18} />
                    <span className="font-medium">ç”ŸæˆæˆåŠŸï¼</span>
                  </div>
                  {result.stats && (
                    <p className="text-sm text-green-600">
                      ä½¿ç”¨äº† {result.stats.totalAttractions} å€‹æ™¯é»
                      ï¼ˆè³‡æ–™åº«å…± {result.stats.attractionsInDb} å€‹ï¼‰
                    </p>
                  )}
                  {result.warnings && result.warnings.length > 0 && (
                    <div className="mt-2 text-sm text-amber-600">
                      {result.warnings.map((w, i) => (
                        <p key={i}>âš ï¸ {w}</p>
                      ))}
                    </div>
                  )}
                </div>
              ) : (
                <div className="flex items-center gap-2 text-red-700">
                  <AlertCircle size={18} />
                  <span>ç”Ÿæˆå¤±æ•—ï¼Œè«‹é‡è©¦</span>
                </div>
              )}
            </div>
          )}
        </div>

        <DialogFooter>
          <Button variant="outline" className="gap-1" onClick={handleClose} disabled={isGenerating}>
            <X size={16} />
            å–æ¶ˆ
          </Button>
          <Button
            onClick={handleGenerate}
            disabled={isGenerating || !cityId}
            className="bg-morandi-gold hover:bg-morandi-gold-hover text-white gap-2"
          >
            {isGenerating ? (
              <>
                <Loader2 size={16} className="animate-spin" />
                ç”Ÿæˆä¸­...
              </>
            ) : (
              <>
                <Sparkles size={16} />
                é–‹å§‹ç”Ÿæˆ
              </>
            )}
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  )
}
