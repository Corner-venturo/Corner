'use client'
import React from 'react'
import { TourFormData, CityOption, CoverStyleType } from '../../types'
import { Combobox } from '@/components/ui/combobox'
import { Input } from '@/components/ui/input'
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select'
import { Popover, PopoverContent, PopoverTrigger } from '@/components/ui/popover'
import { Calendar } from '@/components/ui/calendar'
import { Button } from '@/components/ui/button'
import { cn } from '@/lib/utils'
import { toHalfWidth } from '@/lib/utils/text'
import { RichTextInput } from '@/components/ui/rich-text-input'
import { CalendarIcon, Loader2 } from 'lucide-react'
import { COMP_EDITOR_LABELS } from '../../../constants/labels'

interface CoverInfoFormProps {
  data: TourFormData
  selectedCountry: string
  setSelectedCountry: (country: string) => void
  setSelectedCountryCode: (code: string) => void
  allDestinations: CityOption[]
  availableCities: CityOption[]
  countryNameToCode: Record<string, string>
  updateField: (field: string, value: unknown) => void
  updateCity: (city: string) => void
  onChange: (data: TourFormData) => void
  coverStyleOptions: Array<{
    value: CoverStyleType
    label: string
    description: string
    color: string
    previewImage?: string
  }>
  onCoverStyleChange: (style: CoverStyleType) => void
  templatesLoading: boolean
}

export function CoverInfoForm({
  data,
  selectedCountry,
  setSelectedCountry,
  setSelectedCountryCode,
  allDestinations,
  availableCities,
  countryNameToCode,
  updateField,
  updateCity,
  onChange,
  coverStyleOptions,
  onCoverStyleChange,
  templatesLoading,
}: CoverInfoFormProps) {
  return (
    <div className="space-y-4">
      {/* 主題風格選擇器 */}
      <div>
        <label className="block text-sm font-medium text-morandi-primary mb-2">{COMP_EDITOR_LABELS.LABEL_1339}</label>
        {templatesLoading ? (
          <div className="flex items-center justify-center py-4">
            <Loader2 className="w-5 h-5 animate-spin text-morandi-gold" />
          </div>
        ) : (
          <Select
            value={data.coverStyle || 'original'}
            onValueChange={(value) => onCoverStyleChange(value as CoverStyleType)}
          >
            <SelectTrigger className="w-full">
              <SelectValue placeholder={COMP_EDITOR_LABELS.選擇主題風格} />
            </SelectTrigger>
            <SelectContent>
              {coverStyleOptions.map((option) => (
                <SelectItem key={option.value} value={option.value}>
                  {option.label}
                </SelectItem>
              ))}
            </SelectContent>
          </Select>
        )}
      </div>

      {/* 基本資訊 */}
      <div className="space-y-3">
        <div>
          <label className="block text-sm font-medium text-morandi-primary mb-1">
            {COMP_EDITOR_LABELS.LABEL_1694}
            <span className="ml-2 text-xs text-morandi-secondary font-normal">{COMP_EDITOR_LABELS.LABEL_4233}</span>
          </label>
          <RichTextInput
            value={data.tagline || ''}
            onChange={value => updateField('tagline', value)}
            placeholder={COMP_EDITOR_LABELS.Venturo_Travel_2025_秋季精選}
          />
        </div>

        <div className="grid grid-cols-2 gap-3">
          <div>
            <label className="block text-sm font-medium text-morandi-primary mb-1">{COMP_EDITOR_LABELS.LABEL_147}</label>
            <RichTextInput
              value={data.title || ''}
              onChange={value => updateField('title', value)}
              placeholder={COMP_EDITOR_LABELS.漫遊福岡}
            />
          </div>
          <div>
            <label className="block text-sm font-medium text-morandi-primary mb-1">{COMP_EDITOR_LABELS.副標題}</label>
            <RichTextInput
              value={data.subtitle || ''}
              onChange={value => updateField('subtitle', value)}
              placeholder={data.coverStyle === 'art' ? 'Odyssey' : COMP_EDITOR_LABELS.半自由行}
            />
            {data.coverStyle === 'art' && !data.subtitle && (
              <p className="text-xs text-morandi-secondary mt-1">
                {COMP_EDITOR_LABELS.LABEL_463}
              </p>
            )}
          </div>
        </div>

        <div>
          <label className="block text-sm font-medium text-morandi-primary mb-1">{COMP_EDITOR_LABELS.LABEL_3951}</label>
          <RichTextInput
            value={data.description || ''}
            onChange={value => updateField('description', value)}
            placeholder={COMP_EDITOR_LABELS._2日市區自由活動_保證入住溫泉飯店_柳川遊船_阿蘇火山}
            singleLine={false}
          />
        </div>

        <div className="grid grid-cols-2 gap-3">
          <div>
            <label className="block text-sm font-medium text-morandi-primary mb-1">{COMP_EDITOR_LABELS.LABEL_5040}</label>
            <Combobox
              value={selectedCountry}
              onChange={newCountry => {
                setSelectedCountry(newCountry)
                const code = countryNameToCode[newCountry]
                setSelectedCountryCode(code || '')
                onChange({
                  ...data,
                  country: newCountry,
                  city: '',
                })
              }}
              options={allDestinations.map(dest => ({ value: dest.name, label: dest.name }))}
              placeholder={COMP_EDITOR_LABELS.搜尋或選擇國家}
              showSearchIcon
              showClearButton
            />
          </div>
          <div>
            <label className="block text-sm font-medium text-morandi-primary mb-1">{COMP_EDITOR_LABELS.LABEL_5461}</label>
            <Combobox
              value={data.city || ''}
              onChange={value => updateCity(value)}
              options={availableCities.map(city => ({ value: city.code, label: city.name }))}
              placeholder={COMP_EDITOR_LABELS.搜尋或選擇城市}
              showSearchIcon
              showClearButton
              disabled={!selectedCountry}
            />
          </div>
        </div>

        <div className="grid grid-cols-2 gap-3">
          <div>
            <label className="block text-sm font-medium text-morandi-primary mb-1">{COMP_EDITOR_LABELS.LABEL_4513}</label>
            <Popover>
              <PopoverTrigger asChild>
                <Button
                  variant="outline"
                  className={cn(
                    'w-full h-9 justify-start text-left font-normal',
                    !data.departureDate && 'text-muted-foreground'
                  )}
                >
                  <CalendarIcon className="mr-2 h-4 w-4" />
                  {data.departureDate || COMP_EDITOR_LABELS.選擇日期}
                </Button>
              </PopoverTrigger>
              <PopoverContent className="w-auto p-0" align="start">
                <Calendar
                  mode="single"
                  selected={data.departureDate ? new Date(data.departureDate.replace(/\//g, '-')) : undefined}
                  onSelect={(date) => {
                    if (date && date instanceof Date) {
                      const formatted = `${date.getFullYear()}/${String(date.getMonth() + 1).padStart(2, '0')}/${String(date.getDate()).padStart(2, '0')}`
                      updateField('departureDate', formatted)
                    }
                  }}
                  defaultMonth={data.departureDate ? new Date(data.departureDate.replace(/\//g, '-')) : new Date()}
                />
              </PopoverContent>
            </Popover>
          </div>
          <div>
            <label className="block text-sm font-medium text-morandi-primary mb-1">{COMP_EDITOR_LABELS.LABEL_1470}</label>
            <Input
              type="text"
              value={data.tourCode || ''}
              onChange={e => updateField('tourCode', e.target.value)}
              placeholder="25JFO21CIG"
              className="h-9"
            />
          </div>
        </div>

        <div className="grid grid-cols-2 gap-3">
          <div>
            <label className="block text-sm font-medium text-morandi-primary mb-1">{COMP_EDITOR_LABELS.價格}</label>
            <Input
              type="text"
              value={data.price || ''}
              onChange={e => {
                const halfWidthValue = toHalfWidth(e.target.value)
                const rawValue = halfWidthValue.replace(/[^\d]/g, '')
                const formattedValue = rawValue ? Number(rawValue).toLocaleString('en-US') : ''
                updateField('price', formattedValue)
              }}
              placeholder="39,800"
              className="h-9"
            />
          </div>
          <div>
            <label className="block text-sm font-medium text-morandi-primary mb-1">{COMP_EDITOR_LABELS.LABEL_9062}</label>
            <Select value={data.priceNote || COMP_EDITOR_LABELS.人} onValueChange={(value) => updateField('priceNote', value)}>
              <SelectTrigger className="h-9">
                <SelectValue placeholder={COMP_EDITOR_LABELS.選擇單位} />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value={COMP_EDITOR_LABELS.人}>/人</SelectItem>
                <SelectItem value={COMP_EDITOR_LABELS.起}>起</SelectItem>
                <SelectItem value={COMP_EDITOR_LABELS.人起}>/人起</SelectItem>
                <SelectItem value="__hidden__">(不顯示)</SelectItem>
              </SelectContent>
            </Select>
          </div>
        </div>
      </div>
    </div>
  )
}
