'use client'

import { useState } from 'react'
import { logger } from '@/lib/utils/logger'
import { supabase } from '@/lib/supabase/client'
import type { Customer } from '@/types/customer.types'
import type { OrderMember } from '@/features/orders/types/order-member.types'
import { COMP_ORDERS_LABELS } from '../constants/labels'

export type MatchType = 'name' | 'id_number'

export function useCustomerMatch(
  customers: Customer[],
  members: OrderMember[],
  setMembers: (members: OrderMember[]) => void
) {
  const [showCustomerMatchDialog, setShowCustomerMatchDialog] = useState(false)
  const [matchedCustomers, setMatchedCustomers] = useState<Customer[]>([])
  const [matchType, setMatchType] = useState<MatchType>('name')
  const [pendingMemberIndex, setPendingMemberIndex] = useState<number | null>(null)
  const [pendingMemberData, setPendingMemberData] = useState<Partial<OrderMember> | null>(null)

  // 根據姓名搜尋顧客（2字以上觸發）
  const checkCustomerMatchByName = (
    name: string,
    memberIndex: number,
    memberData: Partial<OrderMember>
  ) => {
    logger.log('checkCustomerMatchByName called:', {
      name,
      memberIndex,
      customersCount: customers.length,
    })
    if (!name || name.length < 2) {
      logger.log('Name too short, skipping search')
      return
    }

    // 模糊搜尋：顧客姓名包含輸入的字串
    const nameMatches = customers.filter(
      c => c.name?.includes(name) || name.includes(c.name || '')
    )
    logger.log('Name matches found:', nameMatches.length)

    if (nameMatches.length > 0) {
      setMatchedCustomers(nameMatches)
      setMatchType('name')
      setPendingMemberIndex(memberIndex)
      setPendingMemberData(memberData)
      setShowCustomerMatchDialog(true)
    }
  }

  // 根據身分證字號搜尋顧客（5字以上觸發）
  const checkCustomerMatchByIdNumber = (
    idNumber: string,
    memberIndex: number,
    memberData: Partial<OrderMember>
  ) => {
    if (!idNumber || idNumber.length < 5) {
      return
    }

    // 雙向匹配身分證字號（輸入包含顧客ID 或 顧客ID包含輸入）
    const normalizedInput = idNumber.toUpperCase().trim()
    const idMatches = customers.filter(c => {
      if (!c.national_id) return false
      const normalizedCustomerId = c.national_id.toUpperCase().trim()
      // 前綴匹配或完全匹配
      return (
        normalizedCustomerId.startsWith(normalizedInput) ||
        normalizedInput.startsWith(normalizedCustomerId) ||
        normalizedCustomerId === normalizedInput
      )
    })

    if (idMatches.length > 0) {
      setMatchedCustomers(idMatches)
      setMatchType('id_number')
      setPendingMemberIndex(memberIndex)
      setPendingMemberData(memberData)
      setShowCustomerMatchDialog(true)
    }
  }

  // 選擇顧客後帶入資料
  const handleSelectCustomer = async (customer: Customer) => {
    if (pendingMemberIndex === null) return

    const member = members[pendingMemberIndex]
    if (!member) return

    // 更新本地狀態
    const updatedMember = {
      ...member,
      chinese_name: customer.name || member.chinese_name,
      passport_name: customer.passport_name || member.passport_name,
      birth_date: customer.birth_date || member.birth_date,
      gender: customer.gender || member.gender,
      id_number: customer.national_id || member.id_number,
      passport_number: customer.passport_number || member.passport_number,
      passport_expiry: customer.passport_expiry || member.passport_expiry,
      passport_image_url: customer.passport_image_url || member.passport_image_url,
      customer_id: customer.id,
      customer_verification_status: customer.verification_status,
    }

    setMembers(members.map((m, i) => (i === pendingMemberIndex ? updatedMember : m)))

    // 儲存到資料庫
    try {
      await supabase
        .from('order_members')
        .update({
          chinese_name: updatedMember.chinese_name,
          passport_name: updatedMember.passport_name,
          birth_date: updatedMember.birth_date,
          gender: updatedMember.gender,
          id_number: updatedMember.id_number,
          passport_number: updatedMember.passport_number,
          passport_expiry: updatedMember.passport_expiry,
          passport_image_url: updatedMember.passport_image_url,
          customer_id: updatedMember.customer_id,
        })
        .eq('id', member.id)
    } catch (error) {
      logger.error(COMP_ORDERS_LABELS.更新成員資料失敗, error)
    }

    // 關閉對話框
    setShowCustomerMatchDialog(false)
    setPendingMemberIndex(null)
    setPendingMemberData(null)
  }

  const closeCustomerMatchDialog = () => {
    setShowCustomerMatchDialog(false)
    setPendingMemberIndex(null)
    setPendingMemberData(null)
  }

  return {
    showCustomerMatchDialog,
    setShowCustomerMatchDialog,
    matchedCustomers,
    matchType,
    pendingMemberIndex,
    pendingMemberData,
    checkCustomerMatchByName,
    checkCustomerMatchByIdNumber,
    handleSelectCustomer,
    closeCustomerMatchDialog,
  }
}
